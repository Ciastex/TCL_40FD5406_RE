(function e$$0(ea,ra,K){function q(g,b){if(!ra[g]){if(!ea[g]){var h="function"==typeof require&&require;if(!b&&h)return h(g,!0);if(y)return y(g,!0);h=Error("Cannot find module '"+g+"'");throw h.code="MODULE_NOT_FOUND",h;}h=ra[g]={exports:{}};ea[g][0].call(h.exports,function(a){var b=ea[g][1][a];return q(b?b:a)},h,h.exports,e$$0,ea,ra,K)}return ra[g].exports}for(var y="function"==typeof require&&require,E=0;E<K.length;E++)q(K[E]);return q})({1:[function(U,ea,ra){function K(a,b){return nrdp.gibbon.setTimeout(a,
b||0,!0)}function q(a){nrdp.gibbon.clearTimeout(a)}function y(a,b){return nrdp.gibbon.setTimeout(a,b||0,!1)}function E(a){nrdp.gibbon.clearTimeout(a)}function g(){this.setTimeout=K;this.clearTimeout=q;this.setInterval=y;this.clearInterval=E}function b(a,b){if(a)throw b;}function h(a,b){if(a)return b(a)}function a(a,b){return b(a)}function A(a,b){this.name="ProvisionError";this.message=a||"";b&&(this.message+=" ("+b+")",this.biepCode=b);this.stack=null}function D(a,b){this.name="AppBootExplicitError";
this.message=a+" : "+JSON.stringify(b);this.error=b&&L.isObject(b)?b:{error:b};this.stack=null}function ha(a){this.name="AppBootServerRetry";this.message="Server-requested retry ("+a+"s)";this.biepCode="sr"+a;this.stack=null}function la(a){this.name="BadResponseError";this.message=a;this.stack=null}function sa(a){this.name="NasVerifyFailedError";this.message=a;this.stack=null}function ya(){this.name="NoBiepError";this.stack=null}function k(a){var b,d={url:a.url},c=ka.appboot_extra_params;nrdp.options.ui_request&&
nrdp.options.ui_request.url?(d.url=nrdp.options.ui_request.url,d.headers=nrdp.options.ui_request.headers):nrdp.options.ui_url?d.url=nrdp.options.ui_url:(b=a.hashvalue||"",a=a.hashalgorithm||"",b.length&&a.length&&(d.headers={"X-Gibbon-Hash":a+"="+b}));c&&d.url&&(d.url+=(0<d.url.indexOf("?")?"&":"?")+decodeURIComponent(c));return d}function P(a){var d=this,c=a.url,f=a.headers;return(new Y(function(a){b(!c,"SNH: Request object has no URL");N.info("Starting UI download with:","\nurl:       ",c,"\nheaders:   ",
f,"\nUI tries:  ",d.uiTryCount,"\nAB retries:",d.appBootRetryCount);++d.uiTryCount;nrdp.gibbon.load({url:c,headers:f,format:"arraybuffer"},a)})).delay(ka.appboot_ui_delay).then(function(a){var b=a.statusCode,f=a.data,ua;ua="Finished UI download with:\nrequest url:  "+c+"\nresponse url: "+a.url+"\nfinal url:    "+a.finalURL+"\nstate:        "+a.state+"\nstatus:       "+b+"\nsource:       "+!!f+"\nUI tries:     "+d.uiTryCount+"\nAB retries:   "+d.appBootRetryCount;f=200<=b&&300>b&&f&&(f.byteLength||
/^file:/.test(a.finalURL));h(!f,function(){N.warn(ua);var f={appid:nrdp.log.appid,url:c,errorCode:a.errorcode,errorGroup:a.errorGroup,nativeErrorCode:a.nativeerrorCode,serverIp:a.serverIp,statusCode:b,retryCount:""+d.uiTryCount,timeElapsed:""+(nrdp.mono()-nrdp.started)};nrdp.log.error("UI download failed","BOOT","networkerror",f,!0,!0);throw a;});N.info(ua);return a}).fail(function(b){var f=d.uiTryCount+d.appBootRetryCount;if(f>=ka.appboot_total_retries)throw N.warn("Total retry count",ka.appboot_total_retries,
"exceeded by UI download"),b;if(a.stop)N.log("UI download for",c,"stopped");else return b=1E3*f,N.warn("Retrying UI download in",b,"ms"),Y.resolve().delay(b).then(function(){if(a.stop)N.log("UI download for",c,"stopped");else return P.call(d,a)})})}function Pa(a){return new Y(function(b,d){var c=nrdp.mono();if(!(a&&L.isObject(a)&&L.isString(a.hash)&&a.hash.length&&L.isString(a.data)&&a.data.length))return d(new A("Invalid operator vault: "+JSON.stringify(a),"ov1"));N.trace("Installing operator vault",
a);nrdp.system.installOperatorVault(a.data,function(a){var h=nrdp.storage;if(!a||!a.success)return N.error("Failed to install stored operator vault, removing it"),h.removeItem(h.NO_DEVICE_ACCOUNT,f),d(new A("Failed to install operator vault, result = "+JSON.stringify(a),"ov2"));N.warn("Operator vault installed in",nrdp.mono()-c,"ms");b()})})}function pa(){var a=this,b=nrdp.storage,d=b.getItem(b.NO_DEVICE_ACCOUNT,f);d?(N.trace("Loaded existing operator vault from storage :",d),L.isObject(d)&&L.isString(d.hash)&&
d.hash.length||(N.warn("Operator vault invalid or missing hash, removing from storage"),b.removeItem(b.NO_DEVICE_ACCOUNT,f),d=null)):N.trace("No existing operator vault");if(d)return N.log("Have existing operator vault in secure store"),Pa(d).then(function(){a.request[u]={hash:d.hash}}).fail(function(b){N.warn("Failed to install operator vault",b);a.makingClearRequest=!0;a.request[u]={}});a.makingClearRequest=!0;a.request[u]={}}function na(){var a=this;N.warn("Device requires online DRM provisioning");
return(new Y(function(a){nrdp.drmsystem.prepareDrmProvisioning(a)})).then(function(b){if(!b.success)throw N.error("prepareDrmProvisioning failed",b),new A("prepareDrmProvisioning failed with "+JSON.stringify(b),"p1");if(b.needed){b=b.challenge;if(!(b&&b instanceof ArrayBuffer)||0===b.byteLength)throw new A("DRM provisioning challenge is invalid","p2");b=nrdp.btoa(b);N.trace("DRM provisioning required, challenge is",b);a.noKeyExchange=!0;a.request[Aa]={challenge:b};a.requestedProvisioning=!0}else N.trace("DRM provisioning not needed")})}
function Sa(a,b){var d=va.toString(b);this.errorParameters={ERROR_ACTIONID:"",ERROR_BCP47:"",ERROR_CATEGORY:"AppBoot",ERROR_CODE:"",ERROR_DESCRIPTION:d,ERROR_FRAME_URL:this.location,ERROR_GROUP:"",ERROR_STAGE:this.stage,ERROR_STATUS_CODE:"",ERROR_TEXT:"",ERROR_URL:"",NATIVE_ERROR_CODE:"",SERVER_IP:""};b&&b.biepCode&&(this.errorParameters.ERROR_ACTIONID=""+b.biepCode);N.error(a,":",d)}function ga(){cb.call(this)}g();var Y=U("../nrdjs_modules/nf-promise"),L=U("nf-underscore"),Oa=U("nf-mixin");ea=U("../nrdjs_modules/nf-console");
var Qa=U("../nrdjs_modules/nf-promise-state-machine"),vb=U("../config-loader"),ka=U("nf-streaming-config"),cb=U("events").EventEmitter,va=U("../errors"),Ia=U("../clients/msl"),Eb=Ia.TimeoutError,db=Ia.MslException,Ua=Ia.MslEncodingException,wb=Ia.MslIoException,c=Ia.MslCryptoException,M=Ia.MslConstants$ResponseCode,N=new ea("BOOT","ui|gibbon");ka.declare({appboot_key:["appboot_key",""],appboot_extra_params:["appboot_extra_params",""],appboot_milestone_timeout:["appboot_milestone_timeout",2E4],appboot_milestone_url:["appboot_milestone_url",
"http://ichnaea.netflix.com/log"],appboot_ui_delay:["appboot_ui_delay",0],appboot_no_reuse:["appboot_no_reuse",!1],appboot_no_speculative_ui:["appboot_no_speculative_ui",!1],appboot_sd_url:["appboot_sd_url",""],appboot_max_retries:["appboot_max_retries",5],appboot_ignore_retrycontrol:["appboot_ignore_retrycontrol",!1],appboot_total_retries:["appboot_total_retries",6],appboot_fail_nas_verify:["appboot_fail_nas_verify",!1],appboot_test_response:["appboot_test_response",""],appboot_install_opvault:["appboot_install_opvault",
!0],appboot_action_id:["appboot_action_id",0],appboot_request_instr:["appboot_request_instr",!1],appboot_keep_critical_messages:["appboot_keep_critical_messages",!1]});var Wa={start:[function(){var a=this,b=nrdp.storage;a.stage=1;return(new Y(function(a){nrdp.gibbon.init(a)})).then(function(){nrdp.gibbon._loadSplash(b.getItem("s",Va));N.warn("BOOT version","v2.21.55","(new)");(new vb).initialize(null,{ignoreSetConfigData:!0});a.stage++;a.location=nrdp.gibbon.location;a.request={};L.isNumber(a.maxRetryCount)||
(a.maxRetryCount=ka.appboot_max_retries)})},"speculative-download"],"speculative-download":[function(){var a;b(ka.appboot_no_speculative_ui,"SD is turned off");b(this.uiDownload,"Already have SD in progress");ka.appboot_sd_url?a={url:ka.appboot_sd_url}:(a=nrdp.storage.getItem("s",Ta))?a=k(a):(a=k({}),b(!a.url,"No previous URL found for SD"),N.log("SD is for UI from options"));N.trace("Starting SD");this.uiDownloadRequest=a;this.uiDownload=P.call(this,a)},"log-startup"],"log-startup":[function(){var a=
nrdp.device,d;b(this.appBootRetryCount,"In a retry");b(nrdp.storage.transientData,"Have transient data");b(this.fromBIEP,"Called from BIEP");d={appid:nrdp.log.appid,boot_version:"v2.21.55",nrdlib_version:""+a.SDKVersion.components.nrdlib,nrdapp_version:""+a.SDKVersion.components.nrdapp,mdxlib_version:""+a.SDKVersion.components.mdxlib,sdk_version:""+a.SDKVersion.components.platform.platformVersion,timeElapsed:""+(nrdp.mono()-nrdp.started)};(a=a.startupTags)&&L.isObject(a)&&L.each(a,function(a,b){d[b]=
a});nrdp.log.info("","BOOT","startup",d,!0,!0)},"get-critical-messages"],"get-critical-messages":[function(){var a=this;a.criticalMessagesToDelete=[];a.criticalMessages=new Y(function(b){if(a.excludeCriticalMessages)return N.warn("Excluding critical messages"),a.excludeCriticalMessages=!1,b([]);N.trace("Asking for critical messages");nrdp.log.addEventListener("criticalMsgsReady",function Ea(a){a=a.data;nrdp.log.removeEventListener("criticalMsgsReady",Ea);if(a&&a.length)return N.trace("Got",a.length,
"critical message(s)"),b(a);N.trace("No critical messages");b([])});nrdp.log.getCriticalMessages()})},"provision"],provision:[function(){return ka.appboot_install_opvault&&nrdp.system&&L.isFunction(nrdp.system.installOperatorVault)?pa.call(this):nrdp.device.capability.supportOnlineDrmProvisioning?na.call(this):"No provisioning required"},"create-msl-client","pre-provision-failed"],"create-msl-client":[function(){var a=this,b=ka,d=nrdp.storage.transientData;d&&d.appboot&&d.appboot.msltruststore&&(delete d.appboot.msltruststore,
N.trace("Deleted previous MSL trust store"));a.makingClearRequest?(N.info("Creating MSL client for clear request"),b=Object.create(b),b.unauth=!0,b.mslClear=!0):a.noKeyExchange&&(N.info("Configuring MSL client for no key exchange"),b=Object.create(b),b.nokeyx=!0);return Ia(b).then(function(b){a.mslClient=b})},"send-request","create-msl-client-failed"],"send-request":[function(){var b=this,c=nrdp.device,f=nrdp.options,g=nrdp.storage,k=nrdp.gibbon.location,u=c.UILanguages,q=c.SDKVersion.components.platform||
{},A=b.request,E=nrdp.trustStoreHash,D={},y=[];b.stage++;delete b.request;A.aid=nrdp.log.appid;A.retrystrategy=1;A.client_info={boot_version:"v2.21.55",certification_version:""+c.certificationVersion,nrdlib_version:""+c.SDKVersion.components.nrdlib,nrdapp_version:""+c.SDKVersion.components.nrdapp,mdxlib_version:""+c.SDKVersion.components.mdxlib,sdk_version:""+c.SDKVersion.components.nrdlib,sw_version:""+c.softwareVersion,languages:0>u.indexOf(c.language)?u.concat(c.language):u};A.ui={app:"gibbontvui",
query_params:{dw:""+f.ui_width,dh:""+f.ui_height,dar:""+f.ui_aspect_ratio,reg:""+c.registered,q:""+nrdp.uiQueryString}};(0<k.indexOf("?")?k.replace(/[^?]*\?/,"").split("&"):[]).concat(f.appboot_params.split(/[&,]/)).forEach(function(a){a&&(a=a.split("="),A.ui.query_params[a[0]]=1<a.length?decodeURIComponent(a[1]):!0)});b.makingClearRequest||(A.ui.cookies=nrdp.gibbon.cookie.split("; ").map(function(a){return a.split("=")}).reduce(function(a,b){a[b[0]]=b[1];return a},{}));A.ssltruststore=E?{hash:E}:
{};A.msltruststore={};h(nrdp.nova&&nrdp.nova.wiiu&&nrdp.nova.wiiu.nasToken,function(a){L.isString(a)&&(N.log("NAS token is",a),A.nas_token=a,b.usingNasToken=!0)});A.responseparams=["loglevel","retrycontrol","loginterval","maxlogsize","testdriveripaddr"];ka.appboot_request_instr&&A.responseparams.push("instrumentationparams");L.each(q,function(a,b){L.isString(b)&&L.isString(a)&&(D[b]=a)});y.push(Oa(D,{level:"info",type:"appboot",esn:c.ESN,appid:nrdp.log.appid,msg:"appboot request made "+(b.useSSL?
"with":"without")+" SSL",ssl:!!b.useSSL,clienttime:Date().toString(),app_uptime:""+(nrdp.mono()-nrdp.started),retrycount:b.appBootRetryCount}));b.makingClearRequest||(g.getItem(g.NO_DEVICE_ACCOUNT,d)||[]).forEach(function(a){y.push(Oa(D,{level:"error",type:"networkerror",msg:"Appboot displayed BIEP",esn:c.ESN,appid:a.appid,description:a.description,stage:a.stage,clienttime:a.clienttime,url:a.url,device:a.device}))});return Y.resolve().then(function(){if(!b.makingClearRequest)return b.criticalMessages.then(function(a){a.forEach(function(a){a.sendtoappboot&&
(a.sendtoichnaea||L.each(D,function(b,d){a[d]||(a[d]=b)}),a.sendtoichnaea&&"milestone"===a.logtype&&(a.type="milestone",a.level="info",a.tags&&a.tags.appid&&(a.appid=a.tags.appid)),y.push(a),b.criticalMessagesToDelete.push({criticalId:a.criticalId}))})})}).then(function(){var d=null;b.url=a(f.appboot_url,function(a){b.redirect&&(a=b.redirect);"/"!=a[a.length-1]&&(a+="/");a+=encodeURIComponent(c.ESNPrefix);if(nrdp.suspended||nrdp.resources&&!nrdp.resources.visibility)a+="?suspended";return b.redirect?
a:b.useSSL?a.replace(/^http:/,"https:"):a.replace(/^https:/,"http:")});A.log=y;b.makingClearRequest||(d=g.getItem(g.NO_DEVICE_ACCOUNT,v)||null);N.log("Making appboot request to",b.url,"with user",d,":",A);return b.mslClient.request(b.url,d,JSON.stringify(A),2E4).then(function(a){return JSON.parse(nrdp.utf8toa(a.body))})})},"handle-response","request-failed"],"handle-response":[function(b){var c=this,f=nrdp.storage;c.stage++;c.response=b;h(ka.appboot_test_response,function(a){nrdp.gibbon.load({url:a,
async:!1,format:"json"},function(a){L.isObject(a.json)?(Oa(a.json,b),N.warn("Modified response"),N.log(JSON.stringify(b,null," "))):N.error("Failed to load test appboot response",a)})});h(f.transientData||{},function(a){a.appboot=b;f.transientData=a});f.removeItem(f.NO_DEVICE_ACCOUNT,d);h(c.criticalMessagesToDelete.length,function(a){var d=!1,f=c.criticalMessagesToDelete;c.criticalMessagesToDelete=[];h(b.responseparams,function(a){d=!!a.keepcriticalmessages});(d=d||ka.appboot_keep_critical_messages)?
N.warn("Keeping",a,"critical message(s)"):(N.log("Deleting",a,"critical message(s)"),nrdp.log.deleteCriticalMessages(f))});h(ka.appboot_action_id,function(a){throw new D("Simulated action ID",{actionid:a});});h(b.retry,function(a){var b=L.isObject(a)&&a.delay||30;h(f.transientData||{},function(a){a.biep||(N.error("Received retry response, will load BIEP with initial",b,"second delay"),a.biep={exponentialBackOffTime:b},f.transientData=a)});throw new ha(b);});h(b.error,function(a){throw new D("Top-level response error",
a);});h(c.usingNasToken,function(){var a=ka.appboot_fail_nas_verify?{success:!1,reason:"Synthetic failure"}:b.nas_token_response;if(a&&L.isObject(a)&&a.success)N.info("NAS token verified");else throw N.error("NAS token was not verified, response was",a),L.isFunction(nrdp.nova.wiiu.nasVerifyFailed)&&nrdp.nova.wiiu.nasVerifyFailed(),new sa("Response was: "+JSON.stringify(a));});h(b.tls_cipher_suites,function(a){L.isString(a)&&nrdp.hasOwnProperty("cipherList")&&(N.info("Setting TLS cipher list",a),nrdp.cipherList=
a)});h(b.servertime_seconds,function(a){var b=Math.floor(nrdp.now()/1E3),d=Math.floor(Date.now()/1E3);L.isNumber(a)&&(N.info("AppBoot server time",a),N.info("nrdp.now           ",b,":",b-a),N.info("Date.now           ",d,":",d-a),nrdp.setServerTime(a))});h(b.responseparams,function(a){var b=a.loglevel,d=a.testdriveripaddr,f=a.instrumentationparams;a=a.retrycontrol;L.isNumber(b)?nrdp.log.level=b:L.isString(b)&&(nrdp.log.level=nrdp.log.levels[b]);d&&nrdp.setTestDriverIpAddress(d);f&&nrdp.instrumentation.setParams(f.enabled,
f.events);L.isNumber(a)&&a!==c.maxRetryCount&&!ka.appboot_ignore_retrycontrol&&(N.info("Max retry count set to",a,"by retrycontrol response"),c.maxRetryCount=a)});h(b.ssltruststore,function(a){var b=a.error;b?N.error("AppBoot server returned an error for 'ssltruststore' :",b):(N.info("Updating app trust store"),nrdp.setTrustStore(a.data))});c.stage++;a(b.msltruststore,function(a){var b=a&&a.error;if(!a)throw new la("Response is missing 'msltruststore'");if(b)throw new D("AppBoot server returned an error for 'msltruststore'",
b);N.trace("MSL trust store seems OK")})},"provision-response","response-failed"],"provision-response":[function(){var a=this.response,b=a[u],d=a[Aa];if(b)return Pa(b).then(function(){var a=nrdp.storage;N.log("Saving operator vault");a.setItem(a.NO_DEVICE_ACCOUNT,f,b)});if(this.requestedProvisioning){if(!d)throw new A("Response missing provisioning","p3");N.trace("Got DRM provisioning data",d);h(d.error,function(a){throw new A("Provisioning server returned an error","ps"+a);});h(!d.message,function(){throw new A("Provisioning data missing message",
"p4");});return(new Y(function(a){nrdp.drmsystem.provideDrmProvisioningResponse(d,a)})).then(function(a){if(!a.success)throw N.error("provideDrmProvisioningResponse failed",a),new A("Failed to provide DRM provisioning response : "+JSON.stringify(a),"p5");N.trace("DRM provisioning completed with",a)})}return"No provisioning"},"load-ui","post-provision-failed"],"load-ui":[function(){var a=this,b=a.response.ui,d;a.stage++;h(!b,function(){throw new la("'ui' element is missing from AppBoot response");
});h(b.error,function(a){if(2==a)throw new D("ui: Error 2",2);throw new D("AppBoot server returned an error for 'ui'",a);});h(b.splash,function(a){nrdp.storage.setItem("s",Va,a);delete b.splash});nrdp.storage.setItem("s",Ta,b);d=k(b);return Y.resolve().then(function(){var b=a.uiDownloadRequest,c=a.uiDownload;delete a.uiDownloadRequest;delete a.uiDownload;if(b){if(b.url===d.url)return N.trace("SD hit"),c;N.log("SD URL is not the same as the one from AppBoot, discarding");b.stop=!0}a.uiTryCount=0;return P.call(a,
d)}).then(function(b){var c=a.fromBIEP||ka.appboot_no_reuse?!1:!0,f=b.finalURL;delete nrdp.js;delete nrdp.boot;nrdp._init=!1;d.url!=b.url&&(N.warn("Using request URL because finalURL points to a cached response"),f=d.url);N.info("Setting location with reuse =",c,"to",f);nrdp.gibbon.location={url:f,headers:d.headers,source:b.data,reuse:c}})},"set-location","load-ui-failed"],"set-location":[function(){}],"request-failed":[function(a){var d=this,f={};Sa.call(d,"AppBoot request failed",a);try{throw h(a instanceof
wb&&a.cause instanceof c,function(){N.warn("Request *may* have failed because the payload was too large :","retrying without critical messages");d.excludeCriticalMessages=!0;throw f;}),h(a instanceof wb,function(){d.errorParameters.ERROR_CATEGORY="Network";d.errorParameters.ERROR_CODE=a.errorCode;d.errorParameters.ERROR_DESCRIPTION=a.mesg;d.errorParameters.ERROR_FRAME_URL=a.finalUrl;d.errorParameters.ERROR_GROUP=a.errorGroup;d.errorParameters.ERROR_STATUS_CODE=a.httpCode;d.errorParameters.ERROR_URL=
a.url;d.errorParameters.NATIVE_ERROR_CODE=a.nativeerrorCode;d.errorParameters.SERVER_IP=a.serverIp;if((a.errorCode===nrdp.network.ERRORCODE.TIMEOUTERROR||"TIMED_OUT_ERROR"===a.mesg)&&0<d.appBootRetryCount)throw N.warn("Second timeout - will not retry"),"Second timeout";d.useSSL=!d.useSSL;throw f;}),b(a instanceof Ua,f),b(a instanceof Eb&&!d.appBootRetryCount,f),h(a instanceof db&&a.error,function(){var b=a.error;d.errorParameters.MSL_INTERNAL_CODE=b.internalCode;d.errorParameters.MSL_MESSAGE=b.message;
d.errorParameters.MSL_RESPONSE_CODE=b.responseCode;switch(b.responseCode){case M.FAIL:case M.ENTITY_REAUTH:case M.ENTITYDATA_REAUTH:case M.KEYX_REQUIRED:case M.EXPIRED:case M.REPLAYED:throw"Non-retryable MSL error";case M.USER_REAUTH:case M.USERDATA_REAUTH:if(d.appBootRetryCount)throw"Already retried MSL user error";N.warn("Will retry without a user ID")}throw f;}),N.error("\n***************************************"),N.error("Unrecognized error, PLEASE REPORT THIS!"),N.error(a),N.error("***************************************\n"),
"Unrecognized error";}catch(g){b(g!==f,g)}},"should-retry","to-biep"],"response-failed":[function(a){var d=this,c={};Sa.call(d,"AppBoot response had error",a);b(a instanceof sa,new ya);b(a instanceof ha,a);b(a instanceof la,a);try{h(a instanceof D&&a.error,function(f){var g=f.actionid;b(2===g,c);h(7===g&&f.appbootendpoint,function(a){N.error("AppBoot server requested redirect to",a);d.redirect=a;throw c;});h(13===g,function(){N.error("AppBoot server requested factory reset");nrdp.device.factoryReset(function(){nrdp.log.error("appboot factory reset device due to actionid 13",
"BOOT","appboot",void 0,!0,!0);nrdp.gibbon.location=nrdp.bootURL});throw new ya;});L.isUndefined(g)||(d.errorParameters.ERROR_ACTIONID=g);h(f.usertextgroup,function(a){d.errorParameters.ERROR_TEXT=a.text;d.errorParameters.ERROR_BCP47=a.bcp47});throw a;})}catch(f){b(f!==c,f)}},"should-retry","to-biep"],"pre-provision-failed":[function(a){Sa.call(this,"AppBoot pre-provision failed",a)},"to-biep"],"create-msl-client-failed":[function(a){Sa.call(this,"AppBoot failed to create MSL client",a)},"should-retry"],
"post-provision-failed":[function(a){Sa.call(this,"AppBoot post-provision failed",a)},"to-biep"],"load-ui-failed":[function(a){var b=this;Sa.call(b,"AppBoot failed to load UI",a);h(!(a instanceof Error),function(){b.errorParameters.ERROR_CATEGORY="Network";b.errorParameters.ERROR_DESCRIPTION="AppBoot client failed to download UI";b.errorParameters.ERROR_URL=a.url;b.errorParameters.ERROR_CODE=a.errorcode;b.errorParameters.ERROR_GROUP=a.errorgroup;b.errorParameters.NATIVE_ERROR_CODE=a.nativeerrorCode;
b.errorParameters.ERROR_FRAME_URL=a.finalURL;b.errorParameters.SERVER_IP=a.serverIp;b.errorParameters.ERROR_STATUS_CODE=a.statusCode;throw"Download failed";});return"AppBoot UI response error"},"should-retry","to-biep"],"should-retry":[function(){var a=this,b;nrdp.storage.removeItem(nrdp.storage.NO_DEVICE_ACCOUNT,v);N.trace("Try",a.appBootRetryCount,"of",a.maxRetryCount);a.appBootRetryCount++;h(a.appBootRetryCount>a.maxRetryCount,function(){var b=a.errorParameters.ERROR_DESCRIPTION;a.errorParameters.ERROR_DESCRIPTION=
b?"Retry count exceeded, last error: "+b:"Retry count exceeded";N.warn("Retry count",a.maxRetryCount,"exceeded");throw"Retry count exceeded";});b=1E3*a.appBootRetryCount;N.log("Retrying AppBoot request in",b,"ms...");nrdp.gibbon.setTimeout(function(){nrdp.boot.makeAppbootRequest({maxRetryCount:a.maxRetryCount,appBootRetryCount:a.appBootRetryCount,uiTryCount:a.uiTryCount,uiDownload:a.uiDownload,uiDownloadRequest:a.uiDownloadRequest,useSSL:a.useSSL,fromBIEP:a.fromBIEP,redirect:a.redirect,excludeCriticalMessages:a.excludeCriticalMessages})},
b,!0);return"Retrying"},"retrying","to-biep"],retrying:[function(){}],"to-biep":[function(a){h(this.uiDownloadRequest,function(a){a.stop=!0});b(a instanceof ya,a)},"send-milestones-to-ichnea","no-biep"],"send-milestones-to-ichnea":[function(){this.criticalMessages.then(function(a){var b=nrdp.started,d=nrdp.device.SDKVersion.components.platform,c;a=a.filter(function(a){return a.sendtoichnaea});a.length?(N.trace("Have",a.length,"message(s) for Ichnaea :",a),c=a.map(function(a){return{version:a.platformVersion,
elapsedTime:a.monotime-(a.basemonotime||b),msg:a.msg,tags:a.tags}}),d=JSON.stringify({events:[{name:"nrdp",data:{source:"netflixApp",type:"milestone",esn:nrdp.device.ESN,platformVersion:d.platformVersion,softwareVersion:nrdp.device.softwareVersion,elapsedTime:nrdp.mono()-b,appid:nrdp.log.appid,milestones:c}}]}),N.trace("Sending to Ichnaea :",d),d={url:ka.appboot_milestone_url,headers:{"X-Netflix.Ichnaea.Request.Type":"IchnaeaRequest","X-Gibbon-Cache-Control":"no-cache"},body:d,async:!0,timeout:ka.appboot_milestone_timeout},
N.trace("Ichnaea request :",d),nrdp.gibbon.load(d,function(b){var d=b?b.statusCode:0;N.log("Ichnaea response :",b);200<=d&&300>d&&(N.log("Ichnaea success, deleting",a.length,"critical message(s)"),nrdp.log.deleteCriticalMessages(a))})):N.log("No critical messages to send to Ichnaea")}).done()},"store-errors"],"store-errors":[function(){var a=nrdp.storage,b;b=a.getItem(a.NO_DEVICE_ACCOUNT,d)||[];b.push({description:this.errorParameters.ERROR_DESCRIPTION,stage:this.errorParameters.ERROR_STAGE,appid:nrdp.log.appid,
clienttime:Date().toString(),url:this.url});10<b.length&&(N.warn("Dropping oldest error, have",b.length),b.shift());a.setItem(a.NO_DEVICE_ACCOUNT,d,b);N.trace("Stored",b.length,"error(s)")},"load-biep"],"load-biep":[function(){var a="http://localcontrol.netflix.com/js/error.js",b="?";N.warn("Error parameters for BIEP:\n"+JSON.stringify(this.errorParameters,null,"  "));if(this.fromBIEP)throw nrdp.boot.sendBIEPNotification(this.errorParameters),"Notifying BIEP";L.each(this.errorParameters,function(d,
c){L.isString(d)&&(d=d.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,"\\n"));a+=b+c+"="+encodeURIComponent(d);b="&"});nrdp.js={options:ka,init:function(a){a&&a()}};nrdp.gibbon.loadScript({url:a});g();return"Loading BIEP"}],"no-biep":[function(){}]},Va="appsplash",Ta="appbootui",v="AppbootUserId",d="AppbootErrors",f="AppbootOperatorVault",u="prmopvault",Aa="provision";A.prototype=Error();A.prototype.constructor=A;D.prototype=Error();D.prototype.constructor=D;ha.prototype=
Error();ha.prototype.constructor=ha;la.prototype=Error();la.prototype.constructor=la;sa.prototype=Error();sa.prototype.constructor=sa;ya.prototype=Error();ya.prototype.constructor=ya;ga.prototype=Object.create(cb.prototype);ga.prototype.addEventListener=cb.prototype.addListener;ga.prototype.removeEventListener=cb.prototype.removeListener;ga.prototype.sendBIEPNotification=function(a){this.emit("appreloadfailed",{errorparams:a})};ga.prototype.makeAppbootRequest=function(a){g();a=Oa(a||{},{appBootRetryCount:0,
uiTryCount:0,useSSL:!1,fromBIEP:!0});N.info("Making AppBoot request with",a);a.console=N;Qa(a,Wa,"start").done()};(function(){var a=!!(this.application&&L.isObject(this.application)&&this.application.isErrorPage);N.info("AppBoot loaded");g();nrdp.boot=new ga;a||nrdp.boot.makeAppbootRequest({fromBIEP:!1})})()},{"../clients/msl":2,"../config-loader":4,"../errors":6,"../nrdjs_modules/nf-console":15,"../nrdjs_modules/nf-promise":17,"../nrdjs_modules/nf-promise-state-machine":16,events:7,"nf-mixin":11,
"nf-streaming-config":12,"nf-underscore":13}],2:[function(U,ea,ra){var K;function q(a,b){if(a===b)return!0;if(!a||!b||a.length!=b.length)return!1;for(var d=0;d<a.length;++d)if(a[d]!=b[d])return!1;return!0}function y(a){if(!(a&&a.constructor==Uint8Array||Array.isArray(a)))throw new TypeError("Cannot compute the hash code of "+a);for(var b=1,d=0;d<a.length;++d){var c=a[d];if("number"!==typeof c)throw new TypeError("Cannot compute the hash code over non-numeric elements: "+c);b=31*b+c&4294967295}return b}
function E(a,b){if(a===b)return!0;if(!a||!b)return!1;b instanceof Array||(b=[b]);for(var d=0;d<b.length;++d){for(var c=b[d],f=!1,h=0;h<a.length;++h){var g=a[h];if(c.equals&&"function"===typeof c.equals&&c.equals(g)||c==g){f=!0;break}}if(!f)return!1}return!0}function g(a,b){return E(a,b)&&(a.length==b.length||E(b,a))}function b(a,b,d){var c;d&&(c=d);if("object"!==typeof a||"function"!==typeof a.result||"function"!==typeof a.error)throw new TypeError("callback must be an object with function properties 'result' and 'error'.");
try{var f=b.call(c,a);void 0!==f&&a.result(f)}catch(h){try{a.error(h)}catch(g){}}}function h(a,d,c){if("object"!==typeof a||"function"!==typeof a.timeout)throw new TypeError("callback must be an object with function properties 'result', 'timeout', and 'error'.");b(a,d,c)}function a(a,b,d){1E5>a&&(a=1E5+a);Object.defineProperties(this,{internalCode:{value:a,writable:!1,configurable:!1},responseCode:{value:b,writable:!1,configurable:!1},message:{value:d,writable:!1,configurable:!1}})}function A(a){this.name=
"TimeoutError";this.message=a||"Operation timed out";this.errorCode=nrdp.network.ERRORCODE.TIMEOUTERROR;this.mesg="TIMED_OUT_ERROR";try{throw Error();}catch(b){this.stack=b.stack}}setTimeout=function(a,b){return nrdp.gibbon.setTimeout(a,b||0)};clearTimeout=function(a){nrdp.gibbon.clearTimeout(a)};setInterval=function(a,b){return nrdp.gibbon.setTimeout(a,b||0,!1)};clearInterval=function(a){nrdp.gibbon.clearTimeout(a)};var D=nrdp.btoa,ha=nrdp.atob,la=nrdp.utf8toa,sa=nrdp.atoutf8,ya=U("../../nrdjs_modules/nf-promise"),
k;(function(){function a(b){if(!b)throw new c;}function b(l,n){function d(a){a.hash&&!a.params&&(a.params={hash:a.hash.name})}if(102==l)return{process:function(a,b,l){m.exportKey(b.key,b.format,l)}};if(106==l)return{process:function(a,b,l){"raw"==b.format?m.aesUnwrap(b.buffer,b.algorithm,b.key,b.usages,l):"rsa"==b.format?m.rsaUnwrap(b.buffer,b.algorithm,b.key,b.usages,l):m.unwrapJwe(b.buffer,b.key,b.algorithm,b.extractable,b.usages,l)}};if(105==l)return{process:function(a,b,l){m.wrapJwe(b.wrappingKey,
b.key,b.algorithm,m.A128GCM,l)}};if(101==l)return{process:function(a,b,l){m.importKey(b.buffer,b.format,b.algorithm,b.extractable,b.usages,l)}};if(500==l)return{process:function(a,b,l){m.getKeyByName(b.name,l)}};if(600==l)return{process:function(a,b,l){m.getKeyInfo(b.handle,l)}};switch(n.toUpperCase()){case "AES-CBC":return{process:function(a,b,l){switch(a){case 2:a=b.algorithm.params?b.algorithm.params.iv:b.algorithm.iv;m.aesEncrypt(b.key,a,b.buffer,l);break;case 3:a=b.algorithm.params?b.algorithm.params.iv:
b.algorithm.iv;m.aesDecrypt(b.key,a,b.buffer,l);break;case 103:m.symKeyGen(b.algorithm,b.extractable,b.usages,l);break;default:throw new c;}}};case "SHA-1":case "SHA-224":case "SHA-256":case "SHA-384":case "SHA-512":return{process:function(a,b,l){switch(a){case 1:m.digest(b.buffer,b.algorithm,l);break;default:throw new c;}}};case "RSASSA-PKCS1-V1_5":return{process:function(a,b,l){switch(a){case 4:d(b.algorithm);m.rsaSign(b.key,b.buffer,b.algorithm,l);break;case 5:d(b.algorithm);m.rsaVerify(b.key,
b.buffer,b.algorithm,b.signature,l);break;case 103:m.rsaKeyGen(b.algorithm,b.extractable,b.usages,l);break;default:throw new c;}}};case "RSA-OAEP":case "RSAES-PKCS1-V1_5":return{process:function(a,b,l){switch(a){case 2:m.rsaEncrypt(b.key,b.buffer,l);break;case 3:m.rsaDecrypt(b.key,b.buffer,l);break;case 103:m.rsaKeyGen(b.algorithm,b.extractable,b.usages,l);break;default:throw new c;}}};case "HMAC":return{process:function(a,b,l){switch(a){case 4:d(b.algorithm);m.hmac(b.key,b.buffer,b.algorithm,l);
break;case 5:d(b.algorithm);m.hmacVerify(b.key,b.buffer,b.algorithm,b.signature,l);break;case 103:m.symKeyGen(b.algorithm,b.extractable,b.usages,l);break;default:throw new c;}}};case "DH":return{process:function(a,b,l){switch(a){case 103:m.dhKeyGen(b.algorithm,b.extractable,b.usages,l);break;case 104:m.dhDerive(b.key,b.algorithm.params["public"],b.derivedAlgorithm,b.extractable,b.usages,l);break;default:throw new c;}}};case "NFLX-DH":return{process:function(b,l,n){switch(b){case 103:m.dhKeyGen(l.algorithm,
l.extractable,l.usages,n);break;case 104:a(m.nflxDhDerive);m.nflxDhDerive(l.key,l.algorithm.params["public"],Ga(l.algorithm.params.kd),function(a){function b(a,m){var l;a&&"object"===typeof a&&(l=a.algorithm,!l||"object"===typeof l&&!l.name)&&(p.warn("Patching algorithm for",a),a.algorithm=m,p.warn("  Key is now          ",a));return a}b(a.encryptionKey,{name:"AES-CBC"});b(a.hmacKey,{name:"HMAC",params:{hash:"SHA-256"}});b(a.wrappingKey,{name:"AES-KW"});n(a)});break;default:throw new c;}}};case "AES-KW":return{process:function(a,
b,l){switch(a){case 103:m.symKeyGen(b.algorithm,b.extractable,b.usages,l);break;default:throw new c;}}};case "NFLX-CDM-WIDEVINE":case "NFLX-CDM-JWELE":return{process:function(b,l,n){switch(b){case 103:m.symKeyGen(l.algorithm,l.extractable,l.usages,n);break;case 104:a(m.cdmDerive);m.cdmDerive(l.key,l.algorithm.params.cdmProvisionResponseData,l.algorithm.params.keKeyId,l.algorithm.params.khKeyId,n);break;default:throw new c;}}};case "ECC":case "ECDSA":return{process:function(b,l,n){switch(b){case 4:a(m.eccSign);
d(l.algorithm);m.eccSign(l.key,l.buffer,l.algorithm,n);break;case 5:a(m.eccVerify);d(l.algorithm);m.eccVerify(l.key,l.buffer,l.algorithm,l.signature,n);break;default:throw new c;}}};case "NAGRA":return{process:function(b,l,n){switch(b){case 103:a(m.cdmKeyGen);m.cdmKeyGen(l.algorithm,l.extractable,l.usages,n);break;case 104:a(m.cdmDerive);m.cdmDerive(l.key,l.algorithm.params.cdmResponseData,l.algorithm.params.keKeyId,l.algorithm.params.khKeyId,n);break;case 4:a(m.cdmSign);d(l.algorithm);m.cdmSign(l.algorithm,
l.buffer,n);break;default:throw new c;}}};case "CMAC":return{process:function(b,l,n){switch(b){case 4:a(m.cmac);d(l.algorithm);m.cmac(l.key,l.algorithm,l.buffer,n);break;case 5:a(m.cmacVerify);d(l.algorithm);m.cmacVerify(l.key,l.algorithm,l.buffer,l.signature,n);break;default:throw new c;}}}}}function d(a){this.name="InvalidAlgorithmError";this.message=a||"Invalid algorithm"}function c(a){this.name="NotSupportedError";this.message=a||"Not supported"}function f(a){this.name="NotImplementedError";this.message=
a||"Not implemented yet"}function h(a,l){var m,n,t;if("string"==typeof l)return h(a,{name:l});if(l&&"object"==typeof l){m=l.name;if("string"!=typeof m)throw new d("Algorithm has bad or missing name");n=b(a,m);if(!n)throw p.error("Invalid WebCrypto algorithm",m),new d('Invalid algorithm "'+l.name+'"');t=l.params;if(void 0!==t&&(null===t||"object"!=typeof t))throw new d('Invalid algorithm parameters for "'+l.name+'", expecting undefined or an object');return{algorithm:{name:m,params:t},process:n.process}}throw new d("Invalid algorithm : "+
JSON.stringify(l));}function g(a){var b=w[a];if(void 0===b)throw new SyntaxError('Invalid key format "'+a+'"');return b}function v(a){return Array.isArray(a)?a.map(function(a){var b=z[a];if(void 0===b)throw new SyntaxError('Invalid key usage "'+a+'"');return b}):[]}function Ga(a){if(a&&"object"==typeof a&&1<=a.handle)return a.handle;throw new SyntaxError("Invalid key");}function xa(a){if("string"==typeof a&&0<=a.length||a&&"object"==typeof a&&a.buffer&&0<=a.byteLength)return a;throw new SyntaxError("Invalid buffer or key data");
}function Ra(a,b,l,m){a._listeners=[];a._result=null;a._operation=b;a._args=l;a._info=m;switch(b){case 1:a._name="DIGEST";break;case 2:a._name="ENCRYPT";break;case 3:a._name="DECRYPT";break;case 4:a._name="SIGN";break;case 5:a._name="VERIFY";break;case 101:a._name="IMPORT_KEY";break;case 102:a._name="EXPORT_KEY";break;case 103:a._name="GENERATE_KEY";break;case 104:a._name="DERIVE_KEY";break;case 105:a._name="WRAP_KEY";break;case 106:a._name="UNWRAP_KEY";break;case 500:a._name="GET_KEY";break;case 600:a._name=
"KEY_INFO"}}function ma(a,b,l){Ra(this,a,b,l)}function F(a,b,l){Ra(this,a,b,l)}function l(a){function b(a,l){var m=l;"object"==typeof l&&l&&l.byteLength?(m="["+l.byteLength+" bytes]",g&&(m+="("+nrdp.btoa(l)+")")):"string"==typeof l&&"data"==a&&(m="["+l.length+" chars]",g&&(m+="("+l+")"));return m}function l(b,m){var n,d=a._listeners.slice(0),p=d.length,t;for(n=0;n<p;++n)t=d[n],t.type==b&&t.callback(m)}function d(a){var b={handle:a.handle,extractable:a.extractable,algorithm:a.algorithm,name:a.name};
switch(a.type){case m.SECRET:b.type="secret";break;case m.PUBLIC:b.type="public";break;case m.PRIVATE:b.type="private"}b.keyUsage=a.usage.map(function(a){switch(a){case m.ENCRYPT:return"encrypt";case m.DECRYPT:return"decrypt";case m.SIGN:return"sign";case m.VERIFY:return"verify";case m.DERIVE:return"derive";case m.WRAP:return"wrap";case m.UNWRAP:return"unwrap"}});b._info=a;b.keyUsages=b.keyUsage;(a=b.algorithm)&&"object"===typeof a&&"HMAC"===a.name&&!a.params&&(p.warn("Changing HMAC algorithm for",
b),a.params={hash:"SHA-256"},p.warn("  Key is now",b));return b}function c(a){switch(F){case 1:case 2:case 3:case 4:case 102:case 105:return a.data instanceof ArrayBuffer?new Uint8Array(a.data):n(a.data,!0);case 5:return a.verified?!0:!1;case 101:case 106:case 103:case 104:return a.key?d(a.key):a.encryptionKey&&a.hmacKey?{encryptionKey:d(a.encryptionKey),hmacKey:d(a.hmacKey),wrappingKey:a.wrappingKey?d(a.wrappingKey):void 0}:{publicKey:d(a.publickey),privateKey:d(a.privatekey)};case 500:case 600:return a.key?
d(a.key):null;default:throw new f;}}function w(a){p.error("FAILED "+z+"\n"+a);ma.error=a;setTimeout(l.bind(null,"error",ma),0)}var z=a._name,F=a._operation,B=a._info,Ra=a._args,ma={target:a},h=nrdp.mono(),g=S.webcryptoVerbose,xa=g||t.isDebug();G&&(G=!1,m.setBinary&&m.setBinary(!0));xa&&p.trace("STARTING "+z+": "+JSON.stringify(Ra,b));a._result=null;try{B.process(F,Ra,function(m){try{p.trace("FINISHED "+z+" IN "+(nrdp.mono()-h)+" ms: ");xa&&p.trace(JSON.stringify(m,b));if(!m.success)throw Error("WebCrypto operation "+
z+" failed");a._result=c(m);xa&&p.trace("RESULT: "+JSON.stringify(a._result,b));l("complete",ma)}catch(n){w(n)}})}catch(R){w(R)}return a}var m=nrdp.webcrypto,n=nrdp.atob,t=U("../../nrdjs_modules/nf-console"),p=new t("CRYPTO"),S=U("nf-streaming-config"),G=!0,w={raw:m.RAW,pkcs8:m.PKCS8,spki:m.SPKI,jwk:m.JWK},z={encrypt:m.ENCRYPT,decrypt:m.DECRYPT,sign:m.SIGN,verify:m.VERIFY,derive:m.DERIVE,deriveKey:m.DERIVE,wrap:m.WRAP,unwrap:m.UNWRAP};S.declare({webcryptoVerbose:["webcryptoVerbose",!1]});d.prototype=
Error();d.prototype.constructor=d;c.prototype=Error();c.prototype.constructor=c;f.prototype=Error();f.prototype.constructor=f;ma.prototype.constructor=ma;ma.prototype.addEventListener=function(a,b){this._listeners.push({type:a,callback:b})};ma.prototype.removeEventListener=function(a,b){this._listeners=this._listeners.filter(function(l){return!(l.type==a&&l.callback==b)})};Object.defineProperties(ma.prototype,{result:{enumerable:!0,get:function(){return this._result}},onerror:{enumerable:!0,configurable:!1,
set:function(a){this.addEventListener("error",a)}},oncomplete:{enumerable:!0,configurable:!0,set:function(a){this.addEventListener("complete",a)}}});F.prototype=new ma;F.prototype.constructor=F;F.prototype.process=function(a){throw new f("process not supported on CryptoOperation");};F.prototype.finish=function(){throw new f("finish not supported on CryptoOperation");};F.prototype.abort=function(){throw new f("abort not supported on CryptoOperation");};Object.defineProperties(F.prototype,{algorithm:{enumerable:!0,
get:function(){return this._args.algorithm}},key:{enumerable:!0,get:function(){return this._args.key||null}},onabort:{enumerable:!0,configurable:!1,set:function(a){this.addEventListener("abort",a)}},onprogress:{enumerable:!0,configurable:!1,set:function(a){this.addEventListener("progress",a)}}});k={getRandomValues:function(a){nrdp.random(a);return a},getKeyByName:function(a){var m=b(500);return l(new ma(500,{name:a},m))},getKeyInfo:function(a){var m=b(600);return l(new ma(600,{handle:a},m))},digest:function(a,
b){var m=h(1,a),n={algorithm:a,buffer:xa(b)};return l(new F(1,n,m))},encrypt:function(a,b,m){var n=h(2,a);a={algorithm:a,key:Ga(b),buffer:xa(m)};return l(new F(2,a,n))},decrypt:function(a,b,m){var n=h(3,a);a={algorithm:a,key:Ga(b),buffer:xa(m)};return l(new F(3,a,n))},sign:function(a,b,m){var n=h(4,a);a={algorithm:a,key:Ga(b),buffer:xa(m)};return l(new F(4,a,n))},verify:function(a,b,m,n){var d=h(5,a);a={algorithm:a,key:Ga(b),signature:xa(m),buffer:xa(n)};return l(new F(5,a,d))},importKey:function(a,
b,m,n,d){var p=h(101,m);a={format:g(a),buffer:xa(b),algorithm:m,extractable:n?!0:!1,usages:v(d)};return l(new ma(101,a,p))},exportKey:function(a,m){var n=b(102),d={format:g(a),key:Ga(m)};return l(new ma(102,d,n))},generateKey:function(a,b,m){var n=h(103,a);a={algorithm:a,extractable:b?!0:!1,usages:v(m)};return l(new ma(103,a,n))},deriveKey:function(a,b,m,n,d){var p=h(104,a);a={algorithm:a,key:Ga(b),derivedAlgorithm:m,extractable:n,usages:v(d)};return l(new ma(104,a,p))},wrapKey:function(a,b,m){var n=
h(105,m);a={algorithm:m,key:Ga(a),wrappingKey:Ga(b)};return l(new ma(105,a,n))},unwrapKey:function(a,m,n,d,p,t){var c=b(106);a={algorithm:m,buffer:xa(a),key:Ga(n),extractable:d?!0:!1,usages:v(p),format:t};return l(new ma(106,a,c))}};k.subtle=k})();var P=function(a){return ha(a,!0)},Pa=k.subtle,pa=function(a,b){if(!b||"utf-8"===b)return la(a);throw Error("unsupported encoding");},na=function(a,b){if(!b||"utf-8"===b)return sa(a);throw Error("unsupported encoding");},Sa=function(a){return nrdp.compress(a,
"gzip",!0)},ga=function(a){return nrdp.uncompress(a,"gzip",!0)},Y,L,Oa,Qa,vb,ka,cb,va,Ia,Eb,db,Ua,wb,c;(function(){Y="utf-8";L=9007199254740992;Oa=12;var a=Qa={GZIP:"GZIP",LZW:"LZW"};Object.freeze(Qa);vb=function(b){for(var d=[a.GZIP,a.LZW],c=0;c<d.length&&0<b.length;++c)for(var f=d[c],h=0;h<b.length;++h)if(b[h]==f)return f;return null};var b=ka={AES:"AES"};Object.freeze(ka);cb=function(a){var d=a;"string"===typeof a&&(d=a.toLowerCase());"object"===typeof a&&"string"===typeof a.name&&(d=a.name.toLowerCase());
return ca.AES_CBC.name.toLowerCase()==d?b.AES:b[a]};va=function(a){if(b.AES==a)return ca.AES_CBC};var d=Ia={AES_CBC_PKCS5Padding:"AES/CBC/PKCS5Padding",AESWrap:"AESWrap",RSA_ECB_PKCS1Padding:"RSA/ECB/PKCS1Padding"};Object.freeze(Ia);Eb=function(a){return d.AES_CBC_PKCS5Padding==a?d.AES_CBC_PKCS5Padding:d.RSA_ECB_PKCS1Padding==a?d.RSA_ECB_PKCS1Padding:d[a]};var f=db={HmacSHA256:"HmacSHA256",SHA256withRSA:"SHA256withRSA",AESCmac:"AESCmac"};Object.freeze(db);Ua=function(a){var b=a;"string"===typeof a&&
(b=a.toLowerCase());"object"===typeof a&&"string"===typeof a.name&&(b=a.name.toLowerCase());var d=void 0;"object"===typeof a.hash&&(d=a.hash.name.toLowerCase());return ca.HMAC_SHA256.name.toLowerCase()==b&&ca.HMAC_SHA256.hash.name.toLowerCase()==d?f.HmacSHA256:ca.RSASSA_SHA256.name.toLowerCase()==b&&ca.RSASSA_SHA256.hash.name.toLowerCase()==d?f.SHA256withRSA:ca.AES_CMAC.name.toLowerCase()==b?f.AESCmac:f[a]};wb=function(a){if(f.HmacSHA256==a)return ca.HMAC_SHA256;if(f.SHA256withRSA==a)return ca.SHA256withRSA;
if(f.AESCmac==a)return ca.AES_CMAC};c={FAIL:1,TRANSIENT_FAILURE:2,ENTITY_REAUTH:3,USER_REAUTH:4,KEYX_REQUIRED:5,ENTITYDATA_REAUTH:6,USERDATA_REAUTH:7,EXPIRED:8,REPLAYED:9,SSOTOKEN_REJECTED:10};Object.freeze(c)})();var M={isObjectLiteral:function(a){return null!==a&&"object"===typeof a&&a.constructor===Object},extendDeep:function(){var a=arguments[0],b=1,d=arguments.length,c=!1,f,h,g,k;"boolean"===typeof a&&(c=a,a=arguments[1],b=2);for(;b<d;b++)if(null!=(f=arguments[b]))for(h in f)c&&h in a||(k=f[h],
a!==k&&void 0!==k&&(g=a[h],a[h]=null!==g&&null!==k&&"object"===typeof g&&"object"===typeof k?M.extendDeep(c,{},g,k):k));return a}};(function(){function a(b,d){return function(){var a=b.base,c;b.base=d;c=b.apply(this,arguments);b.base=a;return c}}function b(d,c,f){var h,F,l,m;f=f||k;m=!!f.extendAll;for(h in c)F=c.__lookupGetter__(h),l=c.__lookupSetter__(h),F||l?(F&&d.__defineGetter__(h,F),l&&d.__defineSetter__(h,l)):(F=c[h],l=d[h],"function"===typeof F&&"function"===typeof l&&F!==l?(F.base!==Function.prototype.base&&
(F=a(F,l)),F.base=l):(m||f[h])&&M.isObjectLiteral(F)&&M.isObjectLiteral(l)&&(F=M.extendDeep({},l,F)),d[h]=F)}function d(){var a=Array.prototype.slice,b=a.call(arguments,1);return this.extend({init:function ma(){var d=a.call(arguments,0);ma.base.apply(this,b.concat(d))}})}function c(a,d){var f=new this(g);b(f,a,d);return h(f)}function f(a,d){b(this.prototype,a,d);return this}function h(a){var b=function(){var a=this.init;a&&arguments[0]!==g&&a.apply(this,arguments)};a&&(b.prototype=a);b.prototype.constructor=
b;b.extend=c;b.bind=d;b.mixin=f;return b}var g={},k={actions:!0};Function.prototype.base=function(){};M.Class={create:h,mixin:b,extend:function(a,b){var d=h();d.prototype=new a;return d.extend(b)}};M.mixin=function(){M.log&&M.log.warn("util.mixin is deprecated.  Please change your code to use util.Class.mixin()");b.apply(null,arguments)}})();(function(){function a(b,d){return function(){var a=b.base,c;b.base=d;c=b.apply(this,arguments);b.base=a;return c}}function b(d,c,f){var F,l,m,n;f=f||k;n=!!f.extendAll;
for(F in c)l=c.__lookupGetter__(F),m=c.__lookupSetter__(F),l||m?(l&&d.__defineGetter__(F,l),m&&d.__defineSetter__(F,m)):(l=c[F],m=d[F],"function"===typeof l&&"function"===typeof m&&l!==m?(l.base!==Ga&&(l=a(l,m)),l.base=m):(n||f[F])&&M.isObjectLiteral(l)&&M.isObjectLiteral(m)&&(l=M.extendDeep({},m,l)),d[F]=l)}function d(){var a=Array.prototype.slice,b=a.call(arguments,1);return this.extend({init:function F(){var l=a.call(arguments,0);F.base.apply(this,b.concat(l))}})}function c(a,d){var f=new this(g);
b(f,a,d);return h(f)}function f(a,d){b(this.prototype,a,d);return this}function h(a){var b=function(){var a=this.init;a&&arguments[0]!==g&&a.apply(this,arguments)};a&&(b.prototype=a);b.prototype.constructor=b;b.extend=c;b.bind=d;b.mixin=f;return b}var g={},k={actions:!0},Ga=function(){};Function.prototype.base=Ga;M.Class={create:h,mixin:b,extend:function(a,b){var d=h();d.prototype=new a;return d.extend(b)}};M.mixin=function(){M.log&&M.log.warn("util.mixin is deprecated.  Please change your code to use util.Class.mixin()");
b.apply(null,arguments)}})();var N;(function(){function a(b){return b==L?1:b+1}function b(d){if(0===Object.keys(d._waiters).length)return 0;for(var c=a(d._nextWaiter);!d._waiters[c];)c=a(c);return c}N=M.Class.create({init:function(){Object.defineProperties(this,{_queue:{value:[],writable:!1,enumerable:!1,configurable:!1},_waiters:{value:{},writable:!1,enumerable:!1,configurable:!1},_nextWaiter:{value:0,writable:!0,enumerable:!1,configurable:!1},_lastWaiter:{value:0,writable:!0,enumerable:!1,configurable:!1}})},
cancel:function(a){if(this._waiters[a]){var d=this._waiters[a];delete this._waiters[a];a==this._nextWaiter&&(this._nextWaiter=b(this));d.call(this,void 0)}},cancelAll:function(){for(;0!==this._nextWaiter;)this.cancel(this._nextWaiter)},poll:function(d,c){var f=this,g=a(this._lastWaiter);this._lastWaiter=g;h(c,function(){if(0<this._queue.length){var a=this._queue.shift();setTimeout(function(){c.result(a)},0)}else{var h;-1!=d&&(h=setTimeout(function(){delete f._waiters[g];g==f._nextWaiter&&(f._nextWaiter=
b(f));c.timeout()},d));this._waiters[g]=function(a){clearTimeout(h);setTimeout(function(){c.result(a)},0)};this._nextWaiter||(this._nextWaiter=g)}},f);return g},add:function(a){if(this._nextWaiter){var d=this._waiters[this._nextWaiter];delete this._waiters[this._nextWaiter];this._nextWaiter=b(this);d.call(this,a)}else this._queue.push(a)}})})();var Wa,Va;(function(){var a=0-L,b;"undefined"!==typeof window&&(b=window.msCrypto||window.crypto);Va=function(a){b=a};Wa=M.Class.create({nextBoolean:function(){var a=
new Uint8Array(1);b.getRandomValues(a);return a[0]&1?!0:!1},nextInt:function(a){if(null!==a&&void 0!==a){if("number"!==typeof a)throw new TypeError("n must be of type number");if(1>a)throw new RangeError("n must be greater than zero");--a;var d=new Uint8Array(4);b.getRandomValues(d);return Math.floor(((d[3]&127)<<24|d[2]<<16|d[1]<<8|d[0])/2147483648*(a-0+1)+0)}a=new Uint8Array(4);b.getRandomValues(a);d=(a[3]&127)<<24|a[2]<<16|a[1]<<8|a[0];return a[3]&128?-d:d},nextLong:function(){for(var d=a;d==a;){d=
new Uint8Array(7);b.getRandomValues(d);var c=16777216*((d[6]&31)<<24|d[5]<<16|d[4]<<8|d[3])+(d[2]<<16|d[1]<<8|d[0]),d=d[6]&128?-c-1:c}return d},nextBytes:function(a){for(var d=0;;){var c=Math.min(65536,a.length-d);if(0==c)break;var f=new Uint8Array(c);b.getRandomValues(f);a.set(f,d);d+=c}}})})();var Ta;(function(){function a(b){return b==L?1:b+1}function b(d){if(0===Object.keys(d._waitingReaders).length)return 0;for(var c=a(d._nextReader);!d._waitingReaders[c];)c=a(c);return c}function d(b){if(0===
Object.keys(b._waitingWriters).length)return 0;for(var c=a(b._nextWriter);!b._waitingWriters[c];)c=a(c);return c}Ta=M.Class.create({init:function(){Object.defineProperties(this,{_readers:{value:{},writable:!1,enumerable:!1,configurable:!1},_waitingReaders:{value:{},writable:!1,enumerable:!1,configurable:!1},_writer:{value:null,writable:!0,enumerable:!1,configurable:!1},_waitingWriters:{value:{},writable:!1,enumerable:!1,configurable:!1},_nextReader:{value:0,writable:!0,enumerable:!1,configurable:!1},
_nextWriter:{value:0,writable:!0,enumerable:!1,configurable:!1},_lastNumber:{value:0,writable:!0,enumerable:!1,configurable:!1}})},cancel:function(a){if(this._waitingReaders[a]){var c=this._waitingReaders[a];delete this._waitingReaders[a];a==this._nextReader&&(this._nextReader=b(this));c.call(this,!0)}this._waitingWriters[a]&&(c=this._waitingWriters[a],delete this._waitingWriters[a],a==this._nextWriter&&(this._nextWriter=d(this)),c.call(this,!0))},cancelAll:function(){for(;0!==this._nextWriter;)this.cancel(this._nextWriter);
for(;0!==this._nextReader;)this.cancel(this._nextReader)},readLock:function(d,c){var f=this,g=a(this._lastNumber);this._lastNumber=g;h(c,function(){if(!this._writer&&0===Object.keys(this._waitingWriters).length)return this._readers[g]=!0,g;var a;-1!=d&&(a=setTimeout(function(){delete f._waitingReaders[g];g==f._nextReader&&(f._nextReader=b(f));c.timeout()},d));this._waitingReaders[g]=function(b){clearTimeout(a);b?setTimeout(function(){c.result(void 0)},0):(f._readers[g]=!0,setTimeout(function(){c.result(g)},
0))};this._nextReader||(this._nextReader=g)},f);return g},writeLock:function(b,c){var f=this,g=a(this._lastNumber);this._lastNumber=g;h(c,function(){if(0===Object.keys(this._readers).length&&0===Object.keys(this._waitingReaders).length&&!this._writer)return this._writer=g;var a;-1!=b&&(a=setTimeout(function(){delete f._waitingWriters[g];g==f._nextWriter&&(f._nextWriter=d(f));c.timeout()},b));this._waitingWriters[g]=function(b){clearTimeout(a);b?setTimeout(function(){c.result(void 0)},0):(f._writer=
g,setTimeout(function(){c.result(g)},0))};this._nextWriter||(this._nextWriter=g)},f);return g},unlock:function(b){if(b==this._writer)this._writer=null;else{if(!this._readers[b])throw new C("There is no reader or writer with ticket number "+b+".");delete this._readers[b]}if(this._nextWriter)0<Object.keys(this._readers).length||(b=this._waitingWriters[this._nextWriter],delete this._waitingWriters[this._nextWriter],this._nextWriter=d(this),b.call(this,!1));else{for(var c=this._nextReader;0<Object.keys(this._waitingReaders).length;c=
a(c))this._waitingReaders[c]&&(b=this._waitingReaders[c],delete this._waitingReaders[c],b.call(this,!1));this._nextReader=0}}})})();M.Class.mixin(a,{JSON_PARSE_ERROR:new a(0,c.FAIL,"Error parsing JSON."),JSON_ENCODE_ERROR:new a(1,c.FAIL,"Error encoding JSON."),ENVELOPE_HASH_MISMATCH:new a(2,c.FAIL,"Computed hash does not match envelope hash."),INVALID_PUBLIC_KEY:new a(3,c.FAIL,"Invalid public key provided."),INVALID_PRIVATE_KEY:new a(4,c.FAIL,"Invalid private key provided."),PLAINTEXT_ILLEGAL_BLOCK_SIZE:new a(5,
c.FAIL,"Plaintext is not a multiple of the block size."),PLAINTEXT_BAD_PADDING:new a(6,c.FAIL,"Plaintext contains incorrect padding."),CIPHERTEXT_ILLEGAL_BLOCK_SIZE:new a(7,c.FAIL,"Ciphertext is not a multiple of the block size."),CIPHERTEXT_BAD_PADDING:new a(8,c.FAIL,"Ciphertext contains incorrect padding."),ENCRYPT_NOT_SUPPORTED:new a(9,c.FAIL,"Encryption not supported."),DECRYPT_NOT_SUPPORTED:new a(10,c.FAIL,"Decryption not supported."),ENVELOPE_KEY_ID_MISMATCH:new a(11,c.FAIL,"Encryption envelope key ID does not match crypto context key ID."),
CIPHERTEXT_ENVELOPE_PARSE_ERROR:new a(12,c.FAIL,"Error parsing ciphertext envelope."),CIPHERTEXT_ENVELOPE_ENCODE_ERROR:new a(13,c.FAIL,"Error encoding ciphertext envelope."),SIGN_NOT_SUPPORTED:new a(14,c.FAIL,"Sign not supported."),VERIFY_NOT_SUPPORTED:new a(15,c.FAIL,"Verify not suppoprted."),SIGNATURE_ERROR:new a(16,c.FAIL,"Signature not initialized or unable to process data/signature."),HMAC_ERROR:new a(17,c.FAIL,"Error computing HMAC."),ENCRYPT_ERROR:new a(18,c.FAIL,"Error encrypting plaintext."),
DECRYPT_ERROR:new a(19,c.FAIL,"Error decrypting ciphertext."),INSUFFICIENT_CIPHERTEXT:new a(20,c.FAIL,"Insufficient ciphertext for decryption."),SESSION_KEY_CREATION_FAILURE:new a(21,c.FAIL,"Error when creating session keys."),INVALID_SYMMETRIC_KEY:new a(24,c.FAIL,"Invalid symmetric key provided."),INVALID_ENCRYPTION_KEY:new a(25,c.FAIL,"Invalid encryption key."),INVALID_HMAC_KEY:new a(26,c.FAIL,"Invalid HMAC key."),WRAP_NOT_SUPPORTED:new a(27,c.FAIL,"Wrap not supported."),UNWRAP_NOT_SUPPORTED:new a(28,
c.FAIL,"Unwrap not supported."),UNIDENTIFIED_JWK_TYPE:new a(29,c.FAIL,"Unidentified JSON web key type."),UNIDENTIFIED_JWK_USAGE:new a(30,c.FAIL,"Unidentified JSON web key usage."),UNIDENTIFIED_JWK_ALGORITHM:new a(31,c.FAIL,"Unidentified JSON web key algorithm."),WRAP_ERROR:new a(32,c.FAIL,"Error wrapping plaintext."),UNWRAP_ERROR:new a(33,c.FAIL,"Error unwrapping ciphertext."),INVALID_JWK:new a(34,c.FAIL,"Invalid JSON web key."),INVALID_JWK_KEYDATA:new a(35,c.FAIL,"Invalid JSON web key keydata."),
UNSUPPORTED_JWK_ALGORITHM:new a(36,c.FAIL,"Unsupported JSON web key algorithm."),WRAP_KEY_CREATION_FAILURE:new a(37,c.FAIL,"Error when creating wrapping key."),INVALID_WRAP_CIPHERTEXT:new a(38,c.FAIL,"Invalid wrap ciphertext."),UNSUPPORTED_JWE_ALGORITHM:new a(39,c.FAIL,"Unsupported JSON web encryption algorithm."),JWE_ENCODE_ERROR:new a(40,c.FAIL,"Error encoding JSON web encryption header."),JWE_PARSE_ERROR:new a(41,c.FAIL,"Error parsing JSON web encryption header."),INVALID_ALGORITHM_PARAMS:new a(42,
c.FAIL,"Invalid algorithm parameters."),JWE_ALGORITHM_MISMATCH:new a(43,c.FAIL,"JSON web encryption header algorithms mismatch."),KEY_IMPORT_ERROR:new a(44,c.FAIL,"Error importing key."),KEY_EXPORT_ERROR:new a(45,c.FAIL,"Error exporting key."),DIGEST_ERROR:new a(46,c.FAIL,"Error in digest."),UNSUPPORTED_KEY:new a(47,c.FAIL,"Unsupported key type or algorithm."),UNSUPPORTED_JWE_SERIALIZATION:new a(48,c.FAIL,"Unsupported JSON web encryption serialization."),INVALID_WRAPPING_KEY:new a(51,c.FAIL,"Invalid wrapping key."),
UNIDENTIFIED_CIPHERTEXT_ENVELOPE:new a(52,c.FAIL,"Unidentified ciphertext envelope version."),UNIDENTIFIED_SIGNATURE_ENVELOPE:new a(53,c.FAIL,"Unidentified signature envelope version."),UNSUPPORTED_CIPHERTEXT_ENVELOPE:new a(54,c.FAIL,"Unsupported ciphertext envelope version."),UNSUPPORTED_SIGNATURE_ENVELOPE:new a(55,c.FAIL,"Unsupported signature envelope version."),UNIDENTIFIED_CIPHERSPEC:new a(56,c.FAIL,"Unidentified cipher specification."),UNIDENTIFIED_ALGORITHM:new a(57,c.FAIL,"Unidentified algorithm."),
SIGNATURE_ENVELOPE_PARSE_ERROR:new a(58,c.FAIL,"Error parsing signature envelope."),SIGNATURE_ENVELOPE_ENCODE_ERROR:new a(59,c.FAIL,"Error encoding signature envelope."),INVALID_SIGNATURE:new a(60,c.FAIL,"Invalid signature."),DERIVEKEY_ERROR:new a(61,c.FAIL,"Error deriving key."),UNIDENTIFIED_JWK_KEYOP:new a(62,c.FAIL,"Unidentified JSON web key key operation."),GENERATEKEY_ERROR:new a(63,c.FAIL,"Error generating key."),INVALID_IV:new a(64,c.FAIL,"Invalid initialization vector."),INVALID_CIPHERTEXT:new a(65,
c.FAIL,"Invalid ciphertext."),MASTERTOKEN_UNTRUSTED:new a(1E3,c.ENTITY_REAUTH,"Master token is not trusted."),MASTERTOKEN_KEY_CREATION_ERROR:new a(1001,c.ENTITY_REAUTH,"Unable to construct symmetric keys from master token."),MASTERTOKEN_EXPIRES_BEFORE_RENEWAL:new a(1002,c.ENTITY_REAUTH,"Master token expiration timestamp is before the renewal window opens."),MASTERTOKEN_SESSIONDATA_MISSING:new a(1003,c.ENTITY_REAUTH,"No master token session data found."),MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_RANGE:new a(1004,
c.ENTITY_REAUTH,"Master token sequence number is out of range."),MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(1005,c.ENTITY_REAUTH,"Master token serial number is out of range."),MASTERTOKEN_TOKENDATA_INVALID:new a(1006,c.ENTITY_REAUTH,"Invalid master token data."),MASTERTOKEN_SIGNATURE_INVALID:new a(1007,c.ENTITY_REAUTH,"Invalid master token signature."),MASTERTOKEN_SESSIONDATA_INVALID:new a(1008,c.ENTITY_REAUTH,"Invalid master token session data."),MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_SYNC:new a(1009,
c.ENTITY_REAUTH,"Master token sequence number does not have the expected value."),MASTERTOKEN_TOKENDATA_MISSING:new a(1010,c.ENTITY_REAUTH,"No master token data found."),MASTERTOKEN_TOKENDATA_PARSE_ERROR:new a(1011,c.ENTITY_REAUTH,"Error parsing master token data."),MASTERTOKEN_SESSIONDATA_PARSE_ERROR:new a(1012,c.ENTITY_REAUTH,"Error parsing master token session data."),MASTERTOKEN_IDENTITY_REVOKED:new a(1013,c.ENTITY_REAUTH,"Master token entity identity is revoked."),MASTERTOKEN_REJECTED_BY_APP:new a(1014,
c.ENTITY_REAUTH,"Master token is rejected by the application."),USERIDTOKEN_MASTERTOKEN_MISMATCH:new a(2E3,c.USER_REAUTH,"User ID token master token serial number does not match master token serial number."),USERIDTOKEN_NOT_DECRYPTED:new a(2001,c.USER_REAUTH,"User ID token is not decrypted or verified."),USERIDTOKEN_MASTERTOKEN_NULL:new a(2002,c.USER_REAUTH,"User ID token requires a master token."),USERIDTOKEN_EXPIRES_BEFORE_RENEWAL:new a(2003,c.USER_REAUTH,"User ID token expiration timestamp is before the renewal window opens."),
USERIDTOKEN_USERDATA_MISSING:new a(2004,c.USER_REAUTH,"No user ID token user data found."),USERIDTOKEN_MASTERTOKEN_NOT_FOUND:new a(2005,c.USER_REAUTH,"User ID token is bound to an unknown master token."),USERIDTOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(2006,c.USER_REAUTH,"User ID token master token serial number is out of range."),USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(2007,c.USER_REAUTH,"User ID token serial number is out of range."),USERIDTOKEN_TOKENDATA_INVALID:new a(2008,c.USER_REAUTH,
"Invalid user ID token data."),USERIDTOKEN_SIGNATURE_INVALID:new a(2009,c.USER_REAUTH,"Invalid user ID token signature."),USERIDTOKEN_USERDATA_INVALID:new a(2010,c.USER_REAUTH,"Invalid user ID token user data."),USERIDTOKEN_IDENTITY_INVALID:new a(2011,c.USER_REAUTH,"Invalid user ID token user identity."),RESERVED_2012:new a(2012,c.USER_REAUTH,"The entity is not associated with the user."),USERIDTOKEN_IDENTITY_NOT_FOUND:new a(2013,c.USER_REAUTH,"The user identity was not found."),USERIDTOKEN_PASSWORD_VERSION_CHANGED:new a(2014,
c.USER_REAUTH,"The user identity must be reauthenticated because the password version changed."),USERIDTOKEN_USERAUTH_DATA_MISMATCH:new a(2015,c.USER_REAUTH,"The user ID token and user authentication data user identities do not match."),USERIDTOKEN_TOKENDATA_MISSING:new a(2016,c.USER_REAUTH,"No user ID token data found."),USERIDTOKEN_TOKENDATA_PARSE_ERROR:new a(2017,c.USER_REAUTH,"Error parsing user ID token data."),USERIDTOKEN_USERDATA_PARSE_ERROR:new a(2018,c.USER_REAUTH,"Error parsing user ID token user data."),
USERIDTOKEN_REVOKED:new a(2019,c.USER_REAUTH,"User ID token is revoked."),USERIDTOKEN_REJECTED_BY_APP:new a(2020,c.USERDATA_REAUTH,"User ID token is rejected by the application."),SERVICETOKEN_MASTERTOKEN_MISMATCH:new a(3E3,c.FAIL,"Service token master token serial number does not match master token serial number."),SERVICETOKEN_USERIDTOKEN_MISMATCH:new a(3001,c.FAIL,"Service token user ID token serial number does not match user ID token serial number."),SERVICETOKEN_SERVICEDATA_INVALID:new a(3002,
c.FAIL,"Service token data invalid."),SERVICETOKEN_MASTERTOKEN_NOT_FOUND:new a(3003,c.FAIL,"Service token is bound to an unknown master token."),SERVICETOKEN_USERIDTOKEN_NOT_FOUND:new a(3004,c.FAIL,"Service token is bound to an unknown user ID token."),SERVICETOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(3005,c.FAIL,"Service token master token serial number is out of range."),SERVICETOKEN_USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(3006,c.FAIL,"Service token user ID token serial number is out of range."),
SERVICETOKEN_TOKENDATA_INVALID:new a(3007,c.FAIL,"Invalid service token data."),SERVICETOKEN_SIGNATURE_INVALID:new a(3008,c.FAIL,"Invalid service token signature."),SERVICETOKEN_TOKENDATA_MISSING:new a(3009,c.FAIL,"No service token data found."),UNIDENTIFIED_ENTITYAUTH_SCHEME:new a(4E3,c.FAIL,"Unable to identify entity authentication scheme."),ENTITYAUTH_FACTORY_NOT_FOUND:new a(4001,c.FAIL,"No factory registered for entity authentication scheme."),X509CERT_PARSE_ERROR:new a(4002,c.ENTITYDATA_REAUTH,
"Error parsing X.509 certificate data."),X509CERT_ENCODE_ERROR:new a(4003,c.ENTITYDATA_REAUTH,"Error encoding X.509 certificate data."),X509CERT_VERIFICATION_FAILED:new a(4004,c.ENTITYDATA_REAUTH,"X.509 certificate verification failed."),ENTITY_NOT_FOUND:new a(4005,c.FAIL,"Entity not recognized."),INCORRECT_ENTITYAUTH_DATA:new a(4006,c.FAIL,"Entity used incorrect entity authentication data type."),RSA_PUBLICKEY_NOT_FOUND:new a(4007,c.ENTITYDATA_REAUTH,"RSA public key not found."),UNSUPPORTED_ENTITYAUTH_DATA:new a(4023,
c.FAIL,"Unsupported entity authentication data."),ENTITY_REVOKED:new a(4025,c.FAIL,"Entity is revoked."),ENTITY_REJECTED_BY_APP:new a(4026,c.ENTITYDATA_REAUTH,"Entity is rejected by the application."),X509CERT_EXPIRED:new a(4028,c.ENTITYDATA_REAUTH,"X.509 certificate is expired."),X509CERT_NOT_YET_VALID:new a(4029,c.ENTITYDATA_REAUTH,"X.509 certificate is not yet valid."),X509CERT_INVALID:new a(4030,c.ENTITYDATA_REAUTH,"X.509 certificate is invalid."),RSA_PRIVATEKEY_NOT_FOUND:new a(4031,c.ENTITYDATA_REAUTH,
"RSA private key not found."),ENTITYAUTH_MASTERTOKEN_NOT_DECRYPTED:new a(4032,c.FAIL,"Entity authentication data master token is not decrypted or verified."),ENTITYAUTH_SIGNATURE_INVALID:new a(4033,c.ENTITYDATA_REAUTH,"Invalid entity authentication data siganture."),ENTITYAUTH_CIPHERTEXT_INVALID:new a(4034,c.ENTITYDATA_REAUTH,"Invalid entity authentication data ciphertext."),ENTITYAUTH_VERIFICATION_FAILED:new a(4035,c.ENTITYDATA_REAUTH,"Entity authentication data signature verification failed."),
ENTITYAUTH_MASTERTOKEN_INVALID:new a(4036,c.FAIL,"Invalid entity authentication data master token."),ECC_PUBLICKEY_NOT_FOUND:new a(4037,c.ENTITYDATA_REAUTH,"ECC public key not found."),ECC_PRIVATEKEY_NOT_FOUND:new a(4038,c.ENTITYDATA_REAUTH,"ECC private key not found."),UNIDENTIFIED_USERAUTH_SCHEME:new a(5003,c.FAIL,"Unable to identify user authentication scheme."),USERAUTH_FACTORY_NOT_FOUND:new a(5004,c.FAIL,"No factory registered for user authentication scheme."),EMAILPASSWORD_BLANK:new a(5005,
c.USERDATA_REAUTH,"Email or password is blank."),EMAILPASSWORD_INCORRECT:new a(5007,c.USERDATA_REAUTH,"Email or password is incorrect."),UNSUPPORTED_USERAUTH_DATA:new a(5008,c.FAIL,"Unsupported user authentication data."),USERAUTH_USERIDTOKEN_INVALID:new a(5011,c.USERDATA_REAUTH,"User authentication data user ID token is invalid."),UNIDENTIFIED_USERAUTH_MECHANISM:new a(5013,c.FAIL,"Unable to identify user authentication mechanism."),UNSUPPORTED_USERAUTH_MECHANISM:new a(5014,c.FAIL,"Unsupported user authentication mechanism."),
USERAUTH_MASTERTOKEN_MISSING:new a(5016,c.USERDATA_REAUTH,"User authentication required master token is missing."),USERAUTH_USERIDTOKEN_NOT_DECRYPTED:new a(5021,c.USERDATA_REAUTH,"User authentication data user ID token is not decrypted or verified."),USERAUTH_MASTERTOKEN_INVALID:new a(5024,c.USERDATA_REAUTH,"User authentication data master token is invalid."),USERAUTH_MASTERTOKEN_NOT_DECRYPTED:new a(5025,c.USERDATA_REAUTH,"User authentication data master token is not decrypted or verified."),USERAUTH_USERIDTOKEN_MISSING:new a(5030,
c.USERDATA_REAUTH,"User authentication required user ID token is missing."),USERAUTH_ENTITY_MISMATCH:new a(5032,c.USERDATA_REAUTH,"User authentication data does not match entity identity."),USERAUTH_ENTITY_INCORRECT_DATA:new a(5033,c.FAIL,"Entity used incorrect user authentication data type."),USER_REJECTED_BY_APP:new a(5037,c.USERDATA_REAUTH,"User is rejected by the application."),USERIDTOKEN_IDENTITY_NOT_ASSOCIATED_WITH_ENTITY:new a(5040,c.USER_REAUTH,"The entity is not associated with the user."),
USERAUTH_ENTITYUSER_INCORRECT_DATA:new a(5041,c.USERDATA_REAUTH,"Entity and user combination used incorrect user authentication data type."),UNSUPPORTED_COMPRESSION:new a(6E3,c.FAIL,"Unsupported compression algorithm."),COMPRESSION_ERROR:new a(6001,c.FAIL,"Error compressing data."),UNCOMPRESSION_ERROR:new a(6002,c.FAIL,"Error uncompressing data."),MESSAGE_ENTITY_NOT_FOUND:new a(6003,c.FAIL,"Message header entity authentication data or master token not found."),PAYLOAD_MESSAGE_ID_MISMATCH:new a(6004,
c.FAIL,"Payload chunk message ID does not match header message ID ."),PAYLOAD_SEQUENCE_NUMBER_MISMATCH:new a(6005,c.FAIL,"Payload chunk sequence number does not match expected sequence number."),PAYLOAD_VERIFICATION_FAILED:new a(6006,c.FAIL,"Payload chunk payload signature verification failed."),MESSAGE_DATA_MISSING:new a(6007,c.FAIL,"No message data found."),MESSAGE_FORMAT_ERROR:new a(6008,c.FAIL,"Malformed message data."),MESSAGE_VERIFICATION_FAILED:new a(6009,c.FAIL,"Message header/error data signature verification failed."),
HEADER_DATA_MISSING:new a(6010,c.FAIL,"No header data found."),PAYLOAD_DATA_MISSING:new a(6011,c.FAIL,"No payload data found in non-EOM payload chunk."),PAYLOAD_DATA_CORRUPT:new a(6012,c.FAIL,"Corrupt payload data found in non-EOM payload chunk."),UNIDENTIFIED_COMPRESSION:new a(6013,c.FAIL,"Unidentified compression algorithm."),MESSAGE_EXPIRED:new a(6014,c.EXPIRED,"Message expired and not renewable. Rejected."),MESSAGE_ID_OUT_OF_RANGE:new a(6015,c.FAIL,"Message ID is out of range."),INTERNAL_CODE_NEGATIVE:new a(6016,
c.FAIL,"Error header internal code is negative."),UNEXPECTED_RESPONSE_MESSAGE_ID:new a(6017,c.FAIL,"Unexpected response message ID. Possible replay."),RESPONSE_REQUIRES_ENCRYPTION:new a(6018,c.KEYX_REQUIRED,"Message response requires encryption."),PAYLOAD_SEQUENCE_NUMBER_OUT_OF_RANGE:new a(6019,c.FAIL,"Payload chunk sequence number is out of range."),PAYLOAD_MESSAGE_ID_OUT_OF_RANGE:new a(6020,c.FAIL,"Payload chunk message ID is out of range."),MESSAGE_REPLAYED:new a(6021,c.REPLAYED,"Non-replayable message replayed."),
INCOMPLETE_NONREPLAYABLE_MESSAGE:new a(6022,c.FAIL,"Non-replayable message sent without a master token."),HEADER_SIGNATURE_INVALID:new a(6023,c.FAIL,"Invalid Header signature."),HEADER_DATA_INVALID:new a(6024,c.FAIL,"Invalid header data."),PAYLOAD_INVALID:new a(6025,c.FAIL,"Invalid payload."),PAYLOAD_SIGNATURE_INVALID:new a(6026,c.FAIL,"Invalid payload signature."),RESPONSE_REQUIRES_MASTERTOKEN:new a(6027,c.KEYX_REQUIRED,"Message response requires a master token."),RESPONSE_REQUIRES_USERIDTOKEN:new a(6028,
c.USER_REAUTH,"Message response requires a user ID token."),REQUEST_REQUIRES_USERAUTHDATA:new a(6029,c.FAIL,"User-associated message requires user authentication data."),UNEXPECTED_MESSAGE_SENDER:new a(6030,c.FAIL,"Message sender is equal to the local entity or not the master token entity."),NONREPLAYABLE_MESSAGE_REQUIRES_MASTERTOKEN:new a(6031,c.FAIL,"Non-replayable message requires a master token."),NONREPLAYABLE_ID_OUT_OF_RANGE:new a(6032,c.FAIL,"Non-replayable message non-replayable ID is out of range."),
MESSAGE_SERVICETOKEN_MISMATCH:new a(6033,c.FAIL,"Service token master token or user ID token serial number does not match the message token serial numbers."),MESSAGE_PEER_SERVICETOKEN_MISMATCH:new a(6034,c.FAIL,"Peer service token master token or user ID token serial number does not match the message peer token serial numbers."),RESPONSE_REQUIRES_INTEGRITY_PROTECTION:new a(6035,c.KEYX_REQUIRED,"Message response requires integrity protection."),HANDSHAKE_DATA_MISSING:new a(6036,c.FAIL,"Handshake message is not renewable or does not contain key request data."),
MESSAGE_RECIPIENT_MISMATCH:new a(6037,c.FAIL,"Message recipient does not match local identity."),MESSAGE_ENTITYDATABASED_VERIFICATION_FAILED:new a(6038,c.ENTITYDATA_REAUTH,"Message header entity-based signature verification failed."),MESSAGE_MASTERTOKENBASED_VERIFICATION_FAILED:new a(6039,c.ENTITY_REAUTH,"Message header master token-based signature verification failed."),MESSAGE_REPLAYED_UNRECOVERABLE:new a(6040,c.ENTITY_REAUTH,"Non-replayable message replayed with a sequence number that is too far out of sync to recover."),
UNIDENTIFIED_KEYX_SCHEME:new a(7E3,c.FAIL,"Unable to identify key exchange scheme."),KEYX_FACTORY_NOT_FOUND:new a(7001,c.FAIL,"No factory registered for key exchange scheme."),KEYX_REQUEST_NOT_FOUND:new a(7002,c.FAIL,"No key request found matching header key response data."),UNIDENTIFIED_KEYX_KEY_ID:new a(7003,c.FAIL,"Unable to identify key exchange key ID."),UNSUPPORTED_KEYX_KEY_ID:new a(7004,c.FAIL,"Unsupported key exchange key ID."),UNIDENTIFIED_KEYX_MECHANISM:new a(7005,c.FAIL,"Unable to identify key exchange mechanism."),
UNSUPPORTED_KEYX_MECHANISM:new a(7006,c.FAIL,"Unsupported key exchange mechanism."),KEYX_RESPONSE_REQUEST_MISMATCH:new a(7007,c.FAIL,"Key exchange response does not match request."),KEYX_PRIVATE_KEY_MISSING:new a(7008,c.FAIL,"Key exchange private key missing."),UNKNOWN_KEYX_PARAMETERS_ID:new a(7009,c.FAIL,"Key exchange parameters ID unknown or invalid."),KEYX_MASTER_TOKEN_MISSING:new a(7010,c.FAIL,"Master token required for key exchange is missing."),KEYX_INVALID_PUBLIC_KEY:new a(7011,c.FAIL,"Key exchange public key is invalid."),
KEYX_PUBLIC_KEY_MISSING:new a(7012,c.FAIL,"Key exchange public key missing."),KEYX_WRAPPING_KEY_MISSING:new a(7013,c.FAIL,"Key exchange wrapping key missing."),KEYX_WRAPPING_KEY_ID_MISSING:new a(7014,c.FAIL,"Key exchange wrapping key ID missing."),KEYX_INVALID_WRAPPING_KEY:new a(7015,c.FAIL,"Key exchange wrapping key is invalid."),KEYX_INCORRECT_DATA:new a(7016,c.FAIL,"Entity used incorrect key exchange data type."),KEYX_INCORRECT_MECHANISM:new a(7017,c.FAIL,"Entity used incorrect key exchange mecahnism."),
KEYX_DERIVATION_KEY_MISSING:new a(7018,c.FAIL,"Key exchange derivation key missing."),KEYX_INVALID_ENCRYPTION_KEY:new a(7019,c.FAIL,"Key exchange encryption key is invalid."),KEYX_INVALID_HMAC_KEY:new a(7020,c.FAIL,"Key exchange HMAC key is invalid."),KEYX_INVALID_WRAPDATA:new a(7021,c.FAIL,"Key exchange wrap data is invalid."),UNSUPPORTED_KEYX_SCHEME:new a(7022,c.FAIL,"Unsupported key exchange scheme."),INTERNAL_EXCEPTION:new a(9E3,c.TRANSIENT_FAILURE,"Internal exception."),MSL_COMMS_FAILURE:new a(9001,
c.FAIL,"Error communicating with MSL entity."),NONE:new a(9999,c.FAIL,"Special unit test error.")});Object.freeze(a);var v;(function(){v=M.Class.create(Error());v.mixin({init:function(a,b,d){function c(){if(h)return h;if(this.cause&&this.cause instanceof v)return this.cause.messageId}Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var f=a.message;b&&(f+=" ["+b+"]");var h,g=this.stack;Object.defineProperties(this,{message:{value:f,writable:!1,configurable:!0},error:{value:a,
writable:!1,configurable:!0},cause:{value:d,writable:!1,configurable:!0},name:{value:"MslException",writable:!1,configurable:!0},masterToken:{value:null,writable:!0,configurable:!1},entityAuthenticationData:{value:null,writable:!0,configurable:!1},userIdToken:{value:null,writable:!0,configurable:!1},userAuthenticationData:{value:null,writable:!0,configurable:!1},messageId:{get:c,set:function(a){if(0>a||a>L)throw new RangeError("Message ID "+a+" is outside the valid range.");c()||(h=a)},configurable:!0},
stack:{get:function(){var a=this.toString();g&&(a+="\n"+g);d&&d.stack&&(a+="\nCaused by "+d.stack);return a},configurable:!0}})},setMasterToken:function(a){!a||this.masterToken||this.entityAuthenticationData||(this.masterToken=a);return this},setEntityAuthenticationData:function(a){!a||this.masterToken||this.entityAuthenticationData||(this.entityAuthenticationData=a);return this},setUserIdToken:function(a){!a||this.userIdToken||this.userAuthenticationData||(this.userIdToken=a);return this},setUserAuthenticationData:function(a){!a||
this.userIdToken||this.userAuthenticationData||(this.userAuthenticationData=a);return this},setMessageId:function(a){this.messageId=a;return this},toString:function(){return this.name+": "+this.message}})})();var d=v.extend({init:function ie(a,b,d){ie.base.call(this,a,b,d);Object.defineProperties(this,{name:{value:"MslCryptoException",writable:!1,configurable:!0}})}}),f=v.extend({init:function je(a,b,d){je.base.call(this,a,b,d);Object.defineProperties(this,{name:{value:"MslEncodingException",writable:!1,
configurable:!0}})}}),u=v.extend({init:function ke(a,b,d){ke.base.call(this,a,b,d);Object.defineProperties(this,{name:{value:"MslEntityAuthException",writable:!1,configurable:!0}})}}),Aa;(function(){Aa=M.Class.create(Error());Aa.mixin({init:function(a,b,d){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var c=this.stack;Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},cause:{value:b,writable:!1,configurable:!1},requestCause:{value:d,writable:!1,configurable:!1},
name:{value:"MslErrorResponseException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();c&&(a+="\n"+c);b&&b.stack&&(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var ua;(function(){ua=M.Class.create(Error());ua.mixin({init:function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var d=this.stack;Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},cause:{value:b,
writable:!1,configurable:!1},name:{value:"MslIoException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();d&&(a+="\n"+d);b&&b.stack&&(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var C;(function(){C=M.Class.create(Error());C.mixin({init:function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var d=this.stack;Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},
cause:{value:b,writable:!1,configurable:!1},name:{value:"MslInternalException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();d&&(a+="\n"+d);b&&b.stack&&(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var aa=v.extend({init:function le(a,b,d){le.base.call(this,a,b,d);Object.defineProperties(this,{name:{value:"MslKeyExchangeException",writable:!1,configurable:!0}})}}),Ea=v.extend({init:function me(a,b){me.base.call(this,
a);Object.defineProperties(this,{masterToken:{value:b,writable:!1,configurable:!1},name:{value:"MslMasterTokenException",writable:!1,configurable:!0}})}}),fa=v.extend({init:function ne(a,b,d){ne.base.call(this,a,b,d);Object.defineProperties(this,{name:{value:"MslMessageException",writable:!1,configurable:!0}})}}),da=v.extend({init:function oe(a,b,d){oe.base.call(this,a,b,d);Object.defineProperties(this,{name:{value:"MslUserAuthException",writable:!1,configurable:!0}})}}),Na;(function(){Na=M.Class.create(Error());
Na.mixin({init:function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var d=this.stack;Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},cause:{value:b,writable:!1,configurable:!1},name:{value:"MslInterruptedException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();d&&(a+="\n"+d);b&&b.stack&&(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var Fa;
(function(){Fa={RAW:"raw",JWK:"jwk",SPKI:"spki",PKCS8:"pkcs8",normalizePubkeyInput:function(b,c){if(c==Fa.SPKI)try{b="string"===typeof b?P(b):b}catch(f){throw new d(a.INVALID_PUBLIC_KEY,c+" "+b,f);}else if(c==Fa.JWK)try{if(b="string"===typeof b?JSON.parse(b):b,"object"!==typeof b||b.constructor!==Object)throw"JWK key is not JSON format";}catch(f){throw new d(a.INVALID_PUBLIC_KEY,c+" "+b,f);}else throw new d(a.INVALID_PUBLIC_KEY,"Invalid format '"+c+"'",e);return b},normalizePrivkeyInput:function(b,
c){if(c==Fa.PKCS8)try{b="string"===typeof b?P(b):b}catch(f){throw new d(a.INVALID_PRIVATE_KEY,c+" "+b,f);}else if(c==Fa.JWK)try{if(b="string"===typeof b?JSON.parse(b):b,"object"!==typeof b||b.constructor!==Object)throw"JWK key is not JSON format";}catch(f){throw new d(a.INVALID_PRIVATE_KEY,c+" "+b,f);}else throw new d(a.INVALID_PRIVATE_KEY,"Invalid format '"+c+"'",e);return b}}})();var oa,Fb,Nb,Sc;(function(){function a(b){return"undefined"===typeof b?!1:b}function b(a){if(a&&a.length){if(f===c.V2014_02||
f===c.V2014_02_SAFARI)a=a.map(function(a){return"wrap"==a?"wrapKey":"unwrap"==a?"unwrapKey":a});return a}return f===c.V2014_02||f===c.V2014_02_SAFARI?"encrypt decrypt sign verify deriveKey wrapKey unwrapKey".split(" "):"encrypt decrypt sign verify deriveKey wrap unwrap".split(" ")}function d(a){return a.then?a:new ya(function(b,d){a.oncomplete=function(a){b(a.target.result)};a.onerror=function(a){d(a)}})}var c=Fb={LEGACY:1,V2014_01:2,V2014_02:3,V2014_02_SAFARI:4,LATEST:3};Object.freeze(Fb);var f=
c.LATEST;Nb=function(a){f=a};var F;"undefined"!==typeof window&&(window.msCrypto?(F=window.msCrypto.subtle,Nb(Fb.LEGACY)):window.crypto&&(window.crypto.webkitSubtle?(F=window.crypto.webkitSubtle,Nb(Fb.V2014_02_SAFARI)):window.crypto.subtle&&(F=window.crypto.subtle)));Sc=function(a){F=a};oa={encrypt:function(a,b,n){switch(f){case c.LEGACY:case c.V2014_01:case c.V2014_02:case c.V2014_02_SAFARI:return a=F.encrypt(a,b,n),d(a);default:throw Error("Unsupported Web Crypto version "+f+".");}},decrypt:function(a,
b,n){switch(f){case c.LEGACY:case c.V2014_01:case c.V2014_02:case c.V2014_02_SAFARI:return a=F.decrypt(a,b,n),d(a);default:throw Error("Unsupported Web Crypto version "+f+".");}},sign:function(a,b,n){switch(f){case c.LEGACY:case c.V2014_01:case c.V2014_02:case c.V2014_02_SAFARI:return a=F.sign(a,b,n),d(a);default:throw Error("Unsupported Web Crypto version "+f+".");}},verify:function(a,b,n,t){switch(f){case c.LEGACY:case c.V2014_01:case c.V2014_02:case c.V2014_02_SAFARI:return a=F.verify(a,b,n,t),
d(a);default:throw Error("Unsupported Web Crypto version "+f+".");}},digest:function(a,b){switch(f){case c.LEGACY:case c.V2014_01:case c.V2014_02:case c.V2014_02_SAFARI:var n=F.digest(a,b);return d(n);default:throw Error("Unsupported Web Crypto version "+f+".");}},generateKey:function(l,m,n){m=a(m);n=b(n);switch(f){case c.LEGACY:case c.V2014_01:case c.V2014_02:case c.V2014_02_SAFARI:return l=F.generateKey(l,m,n),d(l);default:throw Error("Unsupported Web Crypto version "+f+".");}},deriveKey:function(l,
m,n,t,p){t=a(t);p=b(p);switch(f){case c.LEGACY:case c.V2014_01:case c.V2014_02:case c.V2014_02_SAFARI:return l=F.deriveKey(l,m,n,t,p),d(l);default:throw Error("Unsupported Web Crypto version "+f+".");}},importKey:function(l,m,n,t,p){var S=a(t),G=b(p);switch(f){case c.LEGACY:case c.V2014_01:case c.V2014_02:return l=F.importKey(l,m,n,S,G),d(l);case c.V2014_02_SAFARI:if(l==Fa.SPKI||l==Fa.PKCS8)return ya.resolve().then(function(){var a=ASN1.webCryptoAlgorithmToJwkAlg(n),b=ASN1.webCryptoUsageToJwkKeyOps(G),
a=ASN1.rsaDerToJwk(m,a,b,S);if(!a)throw Error("Could not make valid JWK from DER input");a=JSON.stringify(a);return F.importKey(Fa.JWK,sa(a),n,S,G)});l=F.importKey(l,m,n,S,G);return d(l);default:throw Error("Unsupported Web Crypto version "+f+".");}},exportKey:function(a,b){switch(f){case c.LEGACY:case c.V2014_01:case c.V2014_02:var n=F.exportKey(a,b);return d(n);case c.V2014_02_SAFARI:if(a==Fa.SPKI||a==Fa.PKCS8)return n=F.exportKey(Fa.JWK,b),d(n).then(function(a){a=JSON.parse(la(new Uint8Array(a)));
a=ASN1.jwkToRsaDer(a);if(!a)throw Error("Could not make valid DER from JWK input");return a.getDer().buffer});n=F.exportKey(a,b);return d(n);default:throw Error("Unsupported Web Crypto version "+f+".");}},wrapKey:function(a,b,n,t){switch(f){case c.LEGACY:a=F.wrapKey(b,n,t);break;case c.V2014_01:case c.V2014_02:case c.V2014_02_SAFARI:a=F.wrapKey(a,b,n,t);break;default:throw Error("Unsupported Web Crypto version "+f+".");}return d(a)},unwrapKey:function(l,m,n,t,p,S,G){switch(f){case c.LEGACY:l=F.unwrapKey(m,
p,n);break;case c.V2014_01:case c.V2014_02:case c.V2014_02_SAFARI:S=a(S);G=b(G);l=F.unwrapKey(l,m,n,t,p,S,G);break;default:throw Error("Unsupported Web Crypto version "+f+".");}return d(l)}}})();var ob=["encrypt","decrypt"],Gb=["wrap","unwrap"],Tc=["wrap"],pb=["sign","verify"],re=["deriveKey"],ca={A128KW:{name:"AES-KW"},AES_CBC:{name:"AES-CBC"},DIFFIE_HELLMAN:{name:"DH"},HMAC_SHA256:{name:"HMAC",hash:{name:"SHA-256"}},RSA_OAEP:{name:"RSA-OAEP",hash:{name:"SHA-1"}},RSAES:{name:"RSAES-PKCS1-v1_5"},
RSASSA:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},AES_CMAC:{name:"AES-CMAC"},ECDSA_SHA256:{name:"ECDSA",hash:{name:"SHA-256"}},RSASSA_SHA1:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},RSASSA_SHA256:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},AUTHENTICATED_DH:{name:"NFLX-DH"},SHA_256:{name:"SHA-256"},SHA_384:{name:"SHA-384"}},pc,Ha,eb;(function(){pc=M.Class.create({init:function(c,f,h){function g(a){b(f,function(){var b=a?D(a):void 0;Object.defineProperties(ma,{algorithm:{value:c.algorithm,
writable:!1,configurable:!1},rawKey:{value:c,writable:!1,configurable:!1},keyData:{value:a,writable:!1,configurable:!1},keyDataB64:{value:b,writable:!1,configurable:!1}});return this},ma)}var ma=this;b(f,function(){if("object"!==typeof c)throw new d(a.INVALID_SYMMETRIC_KEY);!h&&c.extractable?oa.exportKey("raw",c).then(function(a){g(new Uint8Array(a))},function(b){f.error(new d(a.KEY_EXPORT_ERROR,"raw"))}):g(h)},ma)},size:function(){return this.keyData.length},toByteArray:function(){return this.keyData},
toBase64:function(){return this.keyDataB64}});Ha=function(a,b){new pc(a,b)};eb=function(c,f,h,g){b(g,function(){try{c="string"==typeof c?P(c):c}catch(b){throw new d(a.INVALID_SYMMETRIC_KEY,"keydata "+c,b);}oa.importKey("raw",c,f,!0,h).then(function(a){new pc(a,g,c)},function(b){g.error(new d(a.INVALID_SYMMETRIC_KEY))})})}})();var Ob,qb,qc;(function(){Ob=M.Class.create({init:function(c,f,h){function g(a){b(f,function(){Object.defineProperties(ma,{rawKey:{value:c,writable:!1,configurable:!1},encoded:{value:a,
writable:!1,configurable:!1}});return this},ma)}var ma=this;b(f,function(){if("object"!==typeof c||"public"!=c.type)throw new TypeError("Only original public crypto keys are supported.");!h&&c.extractable?oa.exportKey(Fa.SPKI,c).then(function(a){g(new Uint8Array(a))},function(b){f.error(new d(a.KEY_EXPORT_ERROR,Fa.SPKI))}):g(h)})},getEncoded:function(){return this.encoded}});qb=function(a,b){new Ob(a,b)};qc=function(c,f,h,g,ma){b(ma,function(){c=Fa.normalizePubkeyInput(c,g);oa.importKey(g,c,f,!0,
h).then(function(a){new Ob(a,ma,c)},function(b){ma.error(new d(a.INVALID_PUBLIC_KEY))})})}})();var fc,fb;(function(){fc=M.Class.create({init:function(c,f,h){function g(a){b(f,function(){Object.defineProperties(ma,{rawKey:{value:c,writable:!1,configurable:!1},encoded:{value:a,writable:!1,configurable:!1}});return this},ma)}var ma=this;b(f,function(){if("object"!==typeof c||"private"!=c.type)throw new TypeError("Only original private crypto keys are supported.");!h&&c.extractable?oa.exportKey(Fa.PKCS8,
c).then(function(a){g(new Uint8Array(a))},function(b){f.error(new d(a.KEY_EXPORT_ERROR,Fa.PKCS8))}):g(h)})},getEncoded:function(){return this.encoded}});fb=function(a,b){new fc(a,b)}})();var gb,Pb,gc,hc;(function(){var c=hc={V1:1,V2:2};gb=M.Class.create({init:function(a,b,d){var f;switch(a){case c.V1:f=d;break;case c.V2:f={};f.version=a;f.algorithm=b;f.signature=D(d);f=na(JSON.stringify(f),Y);break;default:throw new C("Signature envelope version "+a+" encoding unsupported.");}Object.defineProperties(this,
{version:{value:a,writable:!1,enumerable:!1,configurable:!1},algorithm:{value:b,writable:!1,configurable:!1},signature:{value:d,writable:!1,configurable:!1},bytes:{value:f,writable:!1,configurable:!1}})}});Pb=function(){var a,d,f,h;2==arguments.length?(a=c.V1,d=arguments[0],f=null,h=arguments[1]):3==arguments.length&&(a=c.V2,f=arguments[0],d=arguments[1],h=arguments[2]);b(h,function(){return new gb(a,f,d)})};gc=function(h,g,k){b(k,function(){if(g)switch(g){case c.V1:return new gb(c.V1,null,h);case c.V2:try{var b=
pa(h,Y),F=JSON.parse(b),l=parseInt(F.version),m=F.algorithm,n=F.signature;if("number"!==typeof l||l!=l||"string"!==typeof m||"string"!==typeof n)throw new f(a.JSON_PARSE_ERROR,"signature envelope "+D(h));if(c.V2!=l)throw new d(a.UNSUPPORTED_SIGNATURE_ENVELOPE,"signature envelope "+D(h));var t=Ua(m);if(!t)throw new d(a.UNIDENTIFIED_ALGORITHM,"signature envelope "+D(h));var p=P(n);if(!p)throw new d(a.INVALID_SIGNATURE,"signature envelope "+D(h));return new gb(c.V2,t,p)}catch(S){if(S instanceof SyntaxError)throw new f(a.JSON_PARSE_ERROR,
"signature envelope "+D(h),S);throw S;}default:throw new d(a.UNSUPPORTED_SIGNATURE_ENVELOPE,"signature envelope "+D(h));}try{b=pa(h,Y),F=JSON.parse(b)}catch(S){F=null}if(F&&F.version){if(b=F.version,"number"!==typeof b||b!==b)b=c.V1}else b=c.V1;switch(b){case c.V1:return new gb(b,null,h);case c.V2:t=F.algorithm;n=F.signature;if("string"!==typeof t||"string"!==typeof n)return new gb(c.V1,null,h);t=Ua(t);if(!t)return new gb(c.V1,null,h);try{p=P(n)}catch(S){return new gb(c.V1,null,h)}return new gb(b,
t,p);default:throw new d(a.UNSUPPORTED_SIGNATURE_ENVELOPE,"signature envelope "+h);}})}})();var rc,sc,tc,uc;(function(){var c=uc={V1:1,V2:2};rc=M.Class.create({init:function(a,d,f,h){b(h,function(){var b=c.V1,l=a,m=null,n;for(n in Ia)if(Ia[n]==a){b=c.V2;l=null;m=a;break}Object.defineProperties(this,{version:{value:b,writable:!1,enumerable:!1,configurable:!1},keyId:{value:l,writable:!1,configurable:!1},cipherSpec:{value:m,writable:!1,configurable:!1},iv:{value:d,writable:!1,configurable:!1},ciphertext:{value:f,
writable:!1,configurable:!1}});return this},this)},toJSON:function(){var a={};switch(this.version){case c.V1:a.keyid=this.keyId;this.iv&&(a.iv=D(this.iv));a.ciphertext=D(this.ciphertext);a.sha256="AA==";break;case c.V2:a.version=this.version;a.cipherspec=this.cipherSpec;this.iv&&(a.iv=D(this.iv));a.ciphertext=D(this.ciphertext);break;default:throw new C("Ciphertext envelope version "+this.version+" encoding unsupported.");}return a}});sc=function(a,b,d,c){new rc(a,b,d,c)};tc=function(h,g,k){b(k,function(){var b=
h.keyid,F=h.cipherspec,l=h.iv,m=h.ciphertext,n=h.sha256;if(!g)if(g=h.version,"number"!==typeof g||g!==g)g=c.V1;else{var t=!1,p;for(p in c)if(c[p]==g){t=!0;break}if(!t)throw new d(a.UNIDENTIFIED_CIPHERTEXT_ENVELOPE,"ciphertext envelope "+JSON.stringify(h));}switch(g){case c.V1:if("string"!==typeof b||l&&"string"!==typeof l||"string"!==typeof m||"string"!==typeof n)throw new f(a.JSON_PARSE_ERROR,"ciphertext envelope "+JSON.stringify(h));break;case c.V2:p=h.version;if(p!=c.V2)throw new d(a.UNIDENTIFIED_CIPHERTEXT_ENVELOPE,
"ciphertext envelope "+JSON.stringify(h));if("string"!==typeof F||l&&"string"!==typeof l||"string"!==typeof m)throw new f(a.JSON_PARSE_ERROR,"ciphertext envelope "+JSON.stringify(h));F=Eb(F);if(!F)throw new d(a.UNIDENTIFIED_CIPHERSPEC,"ciphertext envelope "+JSON.stringify(h));b=F;break;default:throw new d(a.UNSUPPORTED_CIPHERTEXT_ENVELOPE,"ciphertext envelope "+JSON.stringify(h));}try{l&&(l=P(l)),m=P(m)}catch(S){throw new d(a.CIPHERTEXT_ENVELOPE_PARSE_ERROR,"encryption envelope "+JSON.stringify(h),
S);}new rc(b,l,m,k)})}})();var hb=M.Class.create({encrypt:function(a,b){},decrypt:function(a,b){},wrap:function(a,b){},unwrap:function(a,b,d,c){},sign:function(a,b){},verify:function(a,b,d){}}),Qb=hb.extend({encrypt:function(a,b){b.result(a)},decrypt:function(a,b){b.result(a)},wrap:function(a,b){b.result(a)},unwrap:function(a,b,d,c){c.result(a)},sign:function(a,b){b.result(new Uint8Array(0))},verify:function(a,b,d){d.result(!0)}}),Rb,Sb;(function(){var c=Sb={ENCRYPT_DECRYPT_OAEP:1,ENCRYPT_DECRYPT_PKCS1:2,
WRAP_UNWRAP_OAEP:3,WRAP_UNWRAP_PKCS1:4,SIGN_VERIFY:5};Rb=hb.extend({init:function xa(a,b,d,l,m){xa.base.call(this);d&&(d=d.rawKey);l&&(l=l.rawKey);Object.defineProperties(this,{id:{value:b,writable:!1,enumerable:!1,configurable:!1},privateKey:{value:d,writable:!1,enumerable:!1,configurable:!1},publicKey:{value:l,writable:!1,enumerable:!1,configurable:!1},transform:{value:m==c.ENCRYPT_DECRYPT_PKCS1?ca.RSAES:m==c.ENCRYPT_DECRYPT_OAEP?ca.RSA_OAEP:"nullOp",writable:!1,enumerable:!1,configurable:!1},wrapTransform:{value:m==
c.WRAP_UNWRAP_PKCS1?ca.RSAES:m==c.WRAP_UNWRAP_OAEP?ca.RSA_OAEP:"nullOp",writable:!1,enumerable:!1,configurable:!1},algo:{value:m==c.SIGN_VERIFY?ca.RSASSA_SHA256:"nullOp",writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(c,f){var h=this;b(f,function(){if("nullOp"==this.transform)return c;if(!this.publicKey)throw new d(a.ENCRYPT_NOT_SUPPORTED,"no public key");if(0==c.length)return c;oa.encrypt(h.transform,h.publicKey,c).then(function(b){sc(h.id,null,new Uint8Array(b),{result:function(b){try{var m=
JSON.stringify(b);f.result(na(m,Y))}catch(c){f.error(new d(a.ENCRYPT_ERROR,null,c))}},error:function(b){b instanceof v||(b=new d(a.ENCRYPT_ERROR,null,b));f.error(b)}})},function(b){f.error(new d(a.ENCRYPT_ERROR))})},this)},decrypt:function(c,h){var g=this;b(h,function(){if("nullOp"==this.transform)return c;if(!this.privateKey)throw new d(a.DECRYPT_NOT_SUPPORTED,"no private key");if(0==c.length)return c;var b;try{var l=pa(c,Y);b=JSON.parse(l)}catch(m){if(m instanceof SyntaxError)throw new d(a.CIPHERTEXT_ENVELOPE_PARSE_ERROR,
null,m);throw new d(a.DECRYPT_ERROR,null,m);}tc(b,uc.V1,{result:function(b){try{if(b.keyId!=g.id)throw new d(a.ENVELOPE_KEY_ID_MISMATCH);oa.decrypt(g.transform,g.privateKey,b.ciphertext).then(function(a){h.result(new Uint8Array(a))},function(b){h.error(new d(a.DECRYPT_ERROR))})}catch(l){l instanceof v?h.error(l):h.error(new d(a.DECRYPT_ERROR,null,l))}},error:function(b){b instanceof f&&(b=new d(a.CIPHERTEXT_ENVELOPE_ENCODE_ERROR,null,b));b instanceof v||(b=new d(a.DECRYPT_ERROR,null,b));h.error(b)}})},
this)},wrap:function(c,f){b(f,function(){if("nullOp"==this.wrapTransform||!this.publicKey)throw new d(a.WRAP_NOT_SUPPORTED,"no public key");oa.wrapKey("jwk",c.rawKey,this.publicKey,this.wrapTransform).then(function(a){f.result(new Uint8Array(a))},function(b){f.error(new d(a.WRAP_ERROR))})},this)},unwrap:function(c,f,h,F){function l(m){b(F,function(){switch(m.type){case "secret":Ha(m,F);break;case "public":qb(m,F);break;case "private":fb(m,F);break;default:throw new d(a.UNSUPPORTED_KEY,"type: "+m.type);
}})}b(F,function(){if("nullOp"==this.wrapTransform||!this.privateKey)throw new d(a.UNWRAP_NOT_SUPPORTED,"no private key");oa.unwrapKey("jwk",c,this.privateKey,this.wrapTransform,f,!1,h).then(l,function(b){F.error(new d(a.UNWRAP_ERROR))})},this)},sign:function(c,f){b(f,function(){if("nullOp"==this.algo)return new Uint8Array(0);if(!this.privateKey)throw new d(a.SIGN_NOT_SUPPORTED,"no private key");oa.sign(this.algo,this.privateKey,c).then(function(a){Pb(new Uint8Array(a),{result:function(a){f.result(a.bytes)},
error:f.error})},function(b){f.error(new d(a.SIGNATURE_ERROR))})},this)},verify:function(c,f,h){var F=this;b(h,function(){if("nullOp"==this.algo)return!0;if(!this.publicKey)throw new d(a.VERIFY_NOT_SUPPORTED,"no public key");gc(f,hc.V1,{result:function(l){b(h,function(){var b=h.result;oa.verify(this.algo,this.publicKey,l.signature,c).then(b,function(b){h.error(new d(a.SIGNATURE_ERROR))})},F)},error:h.error})},this)}})})();var Tb;(function(){Tb=hb.extend({init:function Ga(a,b,d,c,l){Ga.base.call(this);
d=d&&d.rawKey;c=c&&c.rawKey;l=l&&l.rawKey;Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},id:{value:b,writable:!1,enumerable:!1,configurable:!1},encryptionKey:{value:d,writable:!1,enumerable:!1,configurable:!1},signatureKey:{value:c,writable:!1,enumerable:!1,configurable:!1},wrapKey:{value:l,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(c,f){var h=this;b(f,function(){if(!this.encryptionKey)throw new d(a.ENCRYPT_NOT_SUPPORTED,"no encryption/decryption key");
if(0==c.length)return c;var b=new Uint8Array(16);this.ctx.getRandom().nextBytes(b);oa.encrypt({name:ca.AES_CBC.name,iv:b},h.encryptionKey,c).then(function(c){sc(h.id,b,new Uint8Array(c),{result:function(b){try{var m=JSON.stringify(b);f.result(na(m,Y))}catch(c){f.error(new d(a.ENCRYPT_ERROR,null,c))}},error:function(b){b instanceof v||(b=new d(a.ENCRYPT_ERROR,null,b));f.error(b)}})},function(b){f.error(new d(a.ENCRYPT_ERROR))})},this)},decrypt:function(c,h){var g=this;b(h,function(){if(!this.encryptionKey)throw new d(a.DECRYPT_NOT_SUPPORTED,
"no encryption/decryption key");if(0==c.length)return c;var b;try{var F=pa(c,Y);b=JSON.parse(F)}catch(l){if(l instanceof SyntaxError)throw new d(a.CIPHERTEXT_ENVELOPE_PARSE_ERROR,null,l);throw new d(a.DECRYPT_ERROR,null,l);}tc(b,uc.V1,{result:function(b){try{if(b.keyId!=g.id)throw new d(a.ENVELOPE_KEY_ID_MISMATCH);oa.decrypt({name:ca.AES_CBC.name,iv:b.iv},g.encryptionKey,b.ciphertext).then(function(a){h.result(new Uint8Array(a))},function(){h.error(new d(a.DECRYPT_ERROR))})}catch(m){m instanceof v?
h.error(m):h.error(new d(a.DECRYPT_ERROR,null,m))}},error:function(b){b instanceof f&&(b=new d(a.CIPHERTEXT_ENVELOPE_ENCODE_ERROR,null,b));b instanceof v||(b=new d(a.DECRYPT_ERROR,null,b));h.error(b)}})},this)},wrap:function(c,f){b(f,function(){if(!this.wrapKey)throw new d(a.WRAP_NOT_SUPPORTED,"no wrap/unwrap key");oa.wrapKey("raw",c.rawKey,this.wrapKey,this.wrapKey.algorithm).then(function(a){f.result(new Uint8Array(a))},function(b){f.error(new d(a.WRAP_ERROR))})},this)},unwrap:function(c,f,h,g){function F(c){b(g,
function(){switch(c.type){case "secret":Ha(c,g);break;case "public":qb(c,g);break;case "private":fb(c,g);break;default:throw new d(a.UNSUPPORTED_KEY,"type: "+c.type);}})}b(g,function(){if(!this.wrapKey)throw new d(a.UNWRAP_NOT_SUPPORTED,"no wrap/unwrap key");oa.unwrapKey("raw",c,this.wrapKey,this.wrapKey.algorithm,f,!1,h).then(function(a){F(a)},function(b){g.error(new d(a.UNWRAP_ERROR))})},this)},sign:function(c,f){var h=this;b(f,function(){if(!this.signatureKey)throw new d(a.SIGN_NOT_SUPPORTED,"no signature key.");
oa.sign(this.signatureKey.algorithm,this.signatureKey,c).then(function(a){b(f,function(){Pb(new Uint8Array(a),{result:function(a){f.result(a.bytes)},error:f.error})},h)},function(){f.error(new d(a.HMAC_ERROR))})},this)},verify:function(c,f,h){var g=this;b(h,function(){if(!this.signatureKey)throw new d(a.VERIFY_NOT_SUPPORTED,"no signature key.");gc(f,hc.V1,{result:function(f){b(h,function(){var b=h.result;oa.verify(this.signatureKey.algorithm,this.signatureKey,f.signature,c).then(b,function(b){h.error(new d(a.HMAC_ERROR))})},
g)},error:h.error})},this)}})})();var wa=Tb.extend({init:function Ga(b,d,c,f,l){if(void 0!==c||f||l)Ga.base.call(this,b,c?c+"_"+d.sequenceNumber:""+d.sequenceNumber,f,l,null);else{if(!d.isDecrypted())throw new Ea(a.MASTERTOKEN_UNTRUSTED,d);Ga.base.call(this,b,d.identity+"_"+d.sequenceNumber,d.encryptionKey,d.signatureKey,null)}}}),se=hb.extend({encrypt:function(a,b){b.result(a)},decrypt:function(a,b){b.result(a)},wrap:function(a,b){b.error(new C("Wrap is unsupported by the MSL token crypto context."))},
unwrap:function(a,b,d,c){c.error(new C("Unwrap is unsupported by the MSL token crypto context."))},sign:function(a,b){b.result(new Uint8Array(0))},verify:function(a,b,d){d.result(!1)}}),ib,jb;(function(){var c=jb={RSA_OAEP:ca.RSA_OAEP.name,A128KW:ca.A128KW.name};K="A128GCM";ib=M.Class.create({init:function(a,b,d,f,l){switch(b){case c.RSA_OAEP:b=ca.RSA_OAEP;l=l&&(l.rawKey||l);f=f&&(f.rawKey||f);break;case c.A128KW:b=ca.A128KW;l=f=f&&(f.rawKey||f);break;default:throw new C("Unsupported algorithm: "+
b);}Object.defineProperties(this,{_ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},_transform:{value:b,writable:!1,enumerable:!1,configurable:!1},_enc:{value:d,writable:!1,enumerable:!1,configurable:!1},_wrapKey:{value:l,writable:!1,enumerable:!1,configurable:!1},_unwrapKey:{value:f,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(b,c){c.error(new d(a.ENCRYPT_NOT_SUPPORTED))},decrypt:function(b,c){c.error(new d(a.DECRYPT_NOT_SUPPORTED))},wrap:function(c,f){b(f,function(){oa.wrapKey("jwe+jwk",
c.rawKey,this._wrapKey,this._transform).then(function(a){f.result(new Uint8Array(a))},function(b){f.error(new d(a.WRAP_ERROR))})},this)},unwrap:function(c,f,h,g){function l(c){b(g,function(){switch(c.type){case "secret":Ha(c,g);break;case "public":qb(c,g);break;case "private":fb(c,g);break;default:throw new d(a.UNSUPPORTED_KEY,"type: "+c.type);}})}b(g,function(){oa.unwrapKey("jwe+jwk",c,this._unwrapKey,this._transform,f,!1,h).then(function(a){l(a)},function(){g.error(new d(a.UNWRAP_ERROR))})},this)},
sign:function(b,c){c.error(new d(a.SIGN_NOT_SUPPORTED))},verify:function(b,c,f){f.error(new d(a.VERIFY_NOT_SUPPORTED))}})})();var vc;(function(){vc=hb.extend({init:function xa(a,b,d){xa.base.call(this);b&&(b=b.rawKey);d&&(d=d.rawKey);Object.defineProperties(this,{privateKey:{value:b,writable:!1,enumerable:!1,configurable:!1},publicKey:{value:d,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(a,d){b(d,function(){return a},this)},decrypt:function(a,d){b(d,function(){return a},this)},wrap:function(c,
f){b(f,function(){throw new d(a.WRAP_NOT_SUPPORTED,"ECC does not wrap");},this)},unwrap:function(c,f,h,g){b(g,function(){throw new d(a.UNWRAP_NOT_SUPPORTED,"ECC does not unwrap");},this)},sign:function(c,f){b(f,function(){if(!this.privateKey)throw new d(a.SIGN_NOT_SUPPORTED,"no private key");oa.sign(ca.ECDSA_SHA256,this.privateKey,c).then(function(a){Pb(new Uint8Array(a),{result:function(a){f.result(a.bytes)},error:f.error})},function(b){f.error(new d(a.SIGNATURE_ERROR))})},this)},verify:function(c,
f,h){var g=this;b(h,function(){if(!this.publicKey)throw new d(a.VERIFY_NOT_SUPPORTED,"no public key");gc(f,hc.V1,{result:function(l){b(h,function(){var b=h.result;oa.verify(ca.ECDSA_SHA256,this.publicKey,l.signature,c).then(b,function(b){h.error(new d(a.SIGNATURE_ERROR))})},g)},error:h.error})},this)}})})();var ja,Vc;(function(){var a={};ja=function(b,d,c){Object.defineProperties(this,{name:{value:b,writable:!1,configurable:!1},encrypts:{value:d,writable:!1,configurable:!1},protectsIntegrity:{value:c,
writable:!1,configurable:!1}});a[b]=this};M.Class.mixin(ja,{PSK:new ja("PSK",!0,!0),PSK_PROFILE:new ja("PSK_PROFILE",!0,!0),X509:new ja("X509",!1,!0),RSA:new ja("RSA",!1,!0),ECC:new ja("ECC",!1,!0),NONE:new ja("NONE",!1,!1),NONE_SUFFIXED:new ja("NONE_SUFFIXED",!1,!1),MT_PROTECTED:new ja("MT_PROTECTED",!1,!1),PROVISIONED:new ja("PROVISIONED",!1,!1)});Object.freeze(ja);Vc=function(b){return a[b]?a[b]:null}})();var Ya,Wc;(function(){Ya=M.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,
writable:!1,configurable:!1}})},getIdentity:function(){},getAuthData:function(){},equals:function(a){return this===a?!0:a instanceof Ya?this.scheme==a.scheme:!1},toJSON:function(){var a={};a.scheme=this.scheme.name;a.authdata=this.getAuthData();return a}});Wc=function(d,c,h){b(h,function(){var b=c.scheme,g=c.authdata;if("string"!==typeof b||"object"!==typeof g)throw new f(a.JSON_PARSE_ERROR,"entityauthdata "+JSON.stringify(c));var l=d.getEntityAuthenticationScheme(b);if(!l)throw new u(a.UNIDENTIFIED_ENTITYAUTH_SCHEME,
b);b=d.getEntityAuthenticationFactory(l);if(!b)throw new u(a.ENTITYAUTH_FACTORY_NOT_FOUND,l.name);b.createData(d,g,h)})}})();var Za,Xc;(function(){Za=Ya.extend({init:function xa(a){xa.base.call(this,ja.PSK);Object.defineProperties(this,{identity:{value:a,writable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;return a},equals:function Ra(a){return this===a?!0:a instanceof Za?Ra.base.call(this,a)&&this.identity==a.identity:!1}});Xc=function(b){var d=
b.identity;if("string"!==typeof d)throw new f(a.JSON_PARSE_ERROR,"psk authdata"+JSON.stringify(b));return new Za(d)}})();var Yc,Zc;(function(){Yc=M.Class.create({init:function(a,b,d){Object.defineProperties(this,{encryptionKey:{value:a,writable:!1,configurable:!1},hmacKey:{value:b,writable:!1,configurable:!1},wrappingKey:{value:d,writable:!1,configurable:!1}})}});Zc=M.Class.create({getKeys:function(a){}})})();var ic,$c;(function(){ic=Ya.extend({init:function xa(a,b){xa.base.call(this,ja.RSA);Object.defineProperties(this,
{identity:{value:a,writable:!1,configurable:!1},publicKeyId:{value:b,writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;a.pubkeyid=this.publicKeyId;return a},equals:function Ra(a){return this===a?!0:a instanceof ic?Ra.base.call(this,a)&&this.identity==a.identity&&this.publicKeyId==a.publicKeyId:!1}});$c=function(b){var d=b.identity,c=b.pubkeyid;if("string"!==typeof d||"string"!==typeof c)throw new f(a.JSON_PARSE_ERROR,
"RSA authdata"+JSON.stringify(b));return new ic(d,c)}})();var xb,ad;(function(){xb=Ya.extend({init:function xa(a){xa.base.call(this,ja.NONE);Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;return a},equals:function Ra(a){return this===a?!0:a instanceof xb?Ra.base.call(this,a)&&this.identity==a.identity:!1}});ad=function(b){var d=b.identity;if("string"!==typeof d)throw new f(a.JSON_PARSE_ERROR,
"Unauthenticated authdata"+JSON.stringify(b));return new xb(d)}})();var kb=M.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},createData:function(a,b,d){},getCryptoContext:function(a,b){}}),bd;bd=kb.extend({init:function xa(a,b){xa.base.call(this,ja.PSK);Object.defineProperties(this,{store:{value:a,writable:!1,enumerable:!1,configurable:!1},authutils:{value:b,writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,d,c){b(c,function(){return Xc(d)})},
getCryptoContext:function(b,d){if(!(d instanceof Za))throw new C("Incorrect authentication data type "+JSON.stringify(d)+".");var c=d.getIdentity();if(this.authutils.isEntityRevoked(c))throw(new u(a.ENTITY_REVOKED,"psk "+c)).setEntityAuthenticationData(d);if(!this.authutils.isSchemePermitted(c,this.scheme))throw(new u(a.INCORRECT_ENTITYAUTH_DATA,"Authentication scheme for entity "+c+" not supported:"+this.scheme)).setEntityAuthenticationData(d);var f=this.store.getKeys(c);if(!f)throw(new u(a.ENTITY_NOT_FOUND,
"psk "+c)).setEntityAuthenticationData(d);return new Tb(b,c,f.encryptionKey,f.hmacKey,f.wrappingKey)}});var te=M.Class.create({init:function(){Object.defineProperties(this,{publicKeys:{value:{},writable:!0,enumerable:!1,configurable:!1},privateKeys:{value:{},writable:!0,enumerable:!1,configurable:!1}})},getIdentities:function(){for(var a=Object.keys(this.publicKeys).concat(Object.keys(this.privateKeys)),b=0;b<a.length;++b)for(var d=0;d<a.length;++b)a[b]==a[d]&&a.splice(d--,1);return a},addPublicKey:function(a,
b){if(!(b instanceof Ob))throw new C("Incorrect key data type "+b+".");this.publicKeys[a]=b},removePublicKey:function(a){delete this.publicKeys[a]},getPublicKey:function(a){return this.publicKeys[a]},addPrivateKey:function(a,b){if(!(b instanceof fc))throw new C("Incorrect key data type "+b+".");this.privateKeys[a]=b},removePrivateKey:function(a){delete this.privateKeys[a]},getPrivateKey:function(a){return this.privateKeys[a]},clear:function(){this.publicKeys={};this.privateKeys={}}}),cd=kb.extend({init:function Ra(a,
b){Ra.base.call(this,ja.RSA);Object.defineProperties(this,{keyPairId:{value:a,writable:!1,enumerable:!1,configurable:!1},store:{value:b,writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,d,c){b(c,function(){return $c(d)})},getCryptoContext:function(b,d){if(!(d instanceof ic))throw new C("Incorrect authentication data type "+d+".");var c=d.identity,l=d.publicKeyId,m=this.store.getPublicKey(l),n=this.store.getPrivateKey(l);if(l==this.keyPairId&&!n)throw(new u(a.RSA_PRIVATEKEY_NOT_FOUND,
l)).setEntityAuthenticationData(d);if(l!=this.keyPairId&&!m)throw(new u(a.RSA_PUBLICKEY_NOT_FOUND,l)).setEntityAuthenticationData(d);return new Rb(b,c,n,m,Sb.SIGN_VERIFY)}}),ue=M.Class.create({init:function(){Object.defineProperties(this,{publicKeys:{value:{},writable:!0,enumerable:!1,configurable:!1},privateKeys:{value:{},writable:!0,enumerable:!1,configurable:!1}})},getIdentities:function(){for(var a=Object.keys(this.publicKeys).concat(Object.keys(this.privateKeys)),b=0;b<a.length;++b)for(var d=
0;d<a.length;++b)a[b]==a[d]&&a.splice(d--,1);return a},addPublicKey:function(a,b){if(!(b instanceof Ob))throw new C("Incorrect key data type "+b+".");this.publicKeys[a]=b},removePublicKey:function(a){delete this.publicKeys[a]},getPublicKey:function(a){return this.publicKeys[a]},addPrivateKey:function(a,b){if(!(b instanceof fc))throw new C("Incorrect key data type "+b+".");this.privateKeys[a]=b},removePrivateKey:function(a){delete this.privateKeys[a]},getPrivateKey:function(a){return this.privateKeys[a]},
clear:function(){this.publicKeys={};this.privateKeys={}}}),ve=kb.extend({init:function ma(a,b){ma.base.call(this,ja.ECC);Object.defineProperties(this,{keyPairId:{value:a,writable:!1,enumerable:!1,configurable:!1},store:{value:b,writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,d,c){b(c,function(){return dd(d)})},getCryptoContext:function(b,d){if(!(d instanceof jc))throw new C("Incorrect authentication data type "+d+".");var c=d.publicKeyId,m=this.store.getPublicKey(c),n=this.store.getPrivateKey(c);
if(c==this.keyPairId&&!n)throw(new u(a.ECC_PRIVATEKEY_NOT_FOUND,c)).setEntityAuthenticationData(d);if(c!=this.keyPairId&&!m)throw(new u(a.ECC_PUBLICKEY_NOT_FOUND,c)).setEntityAuthenticationData(d);return new vc(b,n,m)}}),jc,dd;(function(){jc=Ya.extend({init:function F(a,b){F.base.call(this,ja.ECC);Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1},publicKeyId:{value:b,writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a=
{};a.identity=this.identity;a.pubkeyid=this.publicKeyId;return a},equals:function l(a){return this===a?!0:a instanceof jc?l.base.call(this,a)&&this.identity==a.identity&&this.publicKeyId==a.publicKeyId:!1}});dd=function(b){var d=b.identity,c=b.pubkeyid;if("string"!==typeof d||"string"!==typeof c)throw new f(a.JSON_PARSE_ERROR,"ECC authdata"+JSON.stringify(b));return new jc(d,c)}})();var ed=kb.extend({init:function F(){F.base.call(this,ja.NONE)},createData:function(a,d,c){b(c,function(){return ad(d)})},
getCryptoContext:function(a,b){if(!(b instanceof xb))throw new C("Incorrect authentication data type "+JSON.stringify(b)+".");return new Qb}}),Hb;(function(){Hb=Ya.extend({init:function l(a,b,d){l.base.call(this,ja.X509);b&&(a=b.getSubjectString());Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1},x509cert:{value:b,writable:!1,configurable:!1},x509chain:{value:d,writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};
if(this.x509cert){var b=CryptoJS.enc.Hex.parse(this.x509cert.hex),b=CryptoJS.enc.Base64.stringify(b);a.x509certificate=b}else this.x509chain&&(a.x509chain=this.x509chain);a.identity=this.identity;return a},equals:function m(a){return this===a?!0:a instanceof Hb?m.base.call(this,a)&&this.identity===a.identity&&this.x509cert===a.x509cert&&this.x509chain===a.x509chain:!1}})})();var fd=M.Class.create({abort:function(){},close:function(a,b){},mark:function(){},reset:function(){},markSupported:function(){},
read:function(a,b,d){}}),wc=M.Class.create({abort:function(){},close:function(a,b){},write:function(a,b,d,c,f){},flush:function(a,b){}}),we=M.Class.create({init:function(a){Object.defineProperties(this,{_data:{value:a,writable:!1,enumerable:!1,configurable:!1},_closed:{value:!1,writable:!0,enumerable:!1,configurable:!1},_currentPosition:{value:0,writable:!0,enumerable:!1,configurable:!1},_mark:{value:-1,writable:!0,enumerable:!1,configurable:!1}})},abort:function(){},close:function(){this._closed=
!0},mark:function(){this._mark=this._currentPosition},reset:function(){if(-1==this._mark)throw new ua("Stream has not been marked.");this._currentPosition=this._mark},markSupported:function(){return!0},read:function(a,b,d){h(d,function(){if(this._closed)throw new ua("Stream is already closed.");if(this._currentPosition==this._data.length)return null;-1==a&&(a=this._data.length-this._currentPosition);var b=this._data.subarray(this._currentPosition,this._currentPosition+a);this._currentPosition+=b.length;
return b},this)}}),xe=M.Class.create({init:function(){var a={_closed:{value:!1,writable:!0,enumerable:!1,configurable:!1},_result:{value:new Uint8Array(0),writable:!0,enuemrable:!1,configurable:!1},_buffered:{value:[],writable:!1,enumerable:!1,configurable:!1}};Object.defineProperties(this,a)},abort:function(){},close:function(a,b){this._closed=!0;b.result(!0)},write:function(a,b,d,c,f){h(f,function(){if(this._closed)throw new ua("Stream is already closed.");if(0>b)throw new RangeError("Offset cannot be negative.");
if(0>d)throw new RangeError("Length cannot be negative.");if(b+d>a.length)throw new RangeError("Offset plus length cannot be greater than the array length.");var c=a.subarray(b,d);this._buffered.push(c);return c.length},this)},flush:function(a,b){for(;0<this._buffered.length;){var d=this._buffered.shift();if(this._result){var c=new Uint8Array(this._result.length+d.length);c.set(this._result);c.set(d,this._result.length);this._result=c}else this._result=new Uint8Array(d)}b.result(!0)},size:function(){this.flush(1,
{result:function(){}});return this._result.length},toByteArray:function(){this.flush(1,{result:function(){}});return this._result}}),gd=function(a,b,d){(function(a,b,c){a.read(-1,b,{result:function(a){a&&a.length?c(null,a):c(null,null)},timeout:function(){d.timeout()},error:function(a){c(a,null)}})})(a,b,function(b,c){var l;if(b)d.error(b);else if(c){void 0!==a.getJSON&&"function"===typeof a.getJSON&&(l=a.getJSON());if(void 0===l){l=new ClarinetParser(pa(c,"utf-8"));var f=[],h;for(h=l.nextValue();void 0!==
h;)f.push(h),h=l.nextValue();l=f}d.result(l)}else d.result(null)})},hd,ye=M.Class.create({getResponse:function(a,b,d){}});(function(){var a=wc.extend({init:function(a,b){var d={_httpLocation:{value:a,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:b,writable:!0,enumerable:!1,configurable:!1},_buffer:{value:new xe,writable:!1,enumerable:!1,configurable:!1},_response:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_abortToken:{value:void 0,writable:!0,enumerable:!1,configurable:!1},
_responseQueue:{value:new N,writable:!0,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1}};Object.defineProperties(this,d)},setTimeout:function(a){this._timeout=a},getResponse:function(a){var d=this;this._responseQueue.poll(-1,{result:function(c){b(a,function(){c&&this._responseQueue.add(c);return c},d)},timeout:function(){b(a,function(){this._response={isTimeout:!0};this._responseQueue.add(this._response);this.abort();a.timeout()},d)},error:function(c){b(a,
function(){this._response={isError:!0};this._responseQueue.add(this._response);throw c;},d)}})},abort:function(){this._abortToken&&this._abortToken.abort();this._aborted=!0},close:function(a,b){var d=this;h(b,function(){if(this._response||this._abortToken||this._aborted)return!0;var a=this._buffer.toByteArray();0<a.length&&(this._abortToken=this._httpLocation.getResponse({body:a},this._timeout,{result:function(a){d._response={response:a};d._responseQueue.add(d._response)},timeout:function(){d._response=
{isTimeout:!0};d._responseQueue.add(d._response)},error:function(a){d._response={isError:!0,error:a};d._responseQueue.add(d._response)}}));return!0},this)},write:function(a,b,d,c,l){h(l,function(){if(this._response)throw new ua("HttpOutputStream already closed.");this._buffer.write(a,b,d,c,l)},this)},flush:function(a,b){h(b,function(){if(this._response)return!0;this._buffer.flush(a,b)},this)}}),d=fd.extend({init:function(a){Object.defineProperties(this,{_out:{value:a,writable:!1,enumerable:!1,configurable:!1},
_buffer:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_exception:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_timedout:{value:!1,writable:!0,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_json:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},abort:function(){this._out.abort()},close:function(a,b){h(b,function(){this._buffer&&this._buffer.close();return!0},this)},mark:function(){this._buffer||this._buffer.mark()},reset:function(){this._buffer&&
this._buffer.reset()},markSupported:function(){if(this._buffer)return this._buffer.markSupported()},getJSON:function(){return this._json},read:function(a,b,d){function c(f){h(d,function(){if(!f)return new Uint8Array(0);this._out.getResponse({result:function(c){h(d,function(){var l;if(c.isTimeout)this._timedout=!0,d.timeout();else{if(c.isError)throw this._exception=c.error||new ua("Unknown HTTP exception."),this._exception;if(!c.response)throw this._exception=new ua("Missing HTTP response."),this._exception;
void 0!==c.response.json?(this._json=c.response.json,l=new Uint8Array([0])):l=c.response.content||sa(c.response.body);this._buffer=new we(l);this._buffer.read(a,b,d)}},l)},timeout:function(){d.timeout()},error:function(a){d.error(a)}})},l)}var l=this;h(d,function(){if(this._exception)throw this._exception;if(this._timedout)d.timeout();else{if(this._aborted)return new Uint8Array(0);this._buffer?this._buffer.read(a,b,d):this._out.close(b,{result:function(a){c(a)},timeout:function(){d.timeout()},error:function(a){d.error(a)}})}},
l)}});hd=M.Class.create({init:function(a,b){Object.defineProperties(this,{_httpLocation:{value:a,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:b,writable:!0,enumerable:!1,configurable:!1}})},setTimeout:function(a){this._timeout=a},openConnection:function(){var b=new a(this._httpLocation,this._timeout);return{input:new d(b),output:b}}})})();var za,id;(function(){var a={};za=function(b){Object.defineProperties(this,{name:{value:b,writable:!1,configurable:!1}});a[b]=this};M.Class.mixin(za,
{ASYMMETRIC_WRAPPED:new za("ASYMMETRIC_WRAPPED"),DIFFIE_HELLMAN:new za("DIFFIE_HELLMAN"),JWE_LADDER:new za("JWE_LADDER"),JWK_LADDER:new za("JWK_LADDER"),SYMMETRIC_WRAPPED:new za("SYMMETRIC_WRAPPED")});Object.freeze(za);id=function(b){return a[b]?a[b]:null}})();var $a,jd;(function(){$a=M.Class.create({init:function(a){Object.defineProperties(this,{keyExchangeScheme:{value:a,writable:!1,configurable:!1}})},getKeydata:function(){},toJSON:function(){var a={};a.scheme=this.keyExchangeScheme.name;a.keydata=
this.getKeydata();return a},equals:function(a){return this===a?!0:a instanceof $a?this.keyExchangeScheme==a.keyExchangeScheme:!1},uniqueKey:function(){return this.keyExchangeScheme}});jd=function(d,c,m){b(m,function(){var b=c.scheme,h=c.keydata;if("string"!==typeof b||"object"!==typeof h)throw new f(a.JSON_PARSE_ERROR,"keyrequestdata "+JSON.stringify(c));var p=d.getKeyExchangeScheme(b);if(!p)throw new aa(a.UNIDENTIFIED_KEYX_SCHEME,b);b=d.getKeyExchangeFactory(p);if(!b)throw new aa(a.KEYX_FACTORY_NOT_FOUND,
p.name);b.createRequestData(d,h,m)})}})();var ab,kd;(function(){ab=M.Class.create({init:function(a,b){Object.defineProperties(this,{masterToken:{value:a,writable:!1,configurable:!1},keyExchangeScheme:{value:b,wrtiable:!1,configurable:!1}})},getKeydata:function(){},toJSON:function(){var a={};a.mastertoken=this.masterToken;a.scheme=this.keyExchangeScheme.name;a.keydata=this.getKeydata();return a},equals:function(a){return this===a?!0:a instanceof ab?this.masterToken.equals(a.masterToken)&&this.keyExchangeScheme==
a.keyExchangeScheme:!1},uniqueKey:function(){return this.masterToken.uniqueKey()+":"+this.keyExchangeScheme}});kd=function(d,c,m){b(m,function(){var n=c.mastertoken,h=c.scheme,p=c.keydata;if("string"!==typeof h||"object"!==typeof n||"object"!==typeof p)throw new f(a.JSON_PARSE_ERROR,"keyresponsedata "+JSON.stringify(c));var S=d.getKeyExchangeScheme(h);if(!S)throw new aa(a.UNIDENTIFIED_KEYX_SCHEME,h);rb(d,n,{result:function(c){b(m,function(){var b=d.getKeyExchangeFactory(S);if(!b)throw new aa(a.KEYX_FACTORY_NOT_FOUND,
S.name);return b.createResponseData(d,c,p)})},error:function(a){m.error(a)}})})}})();var Ba;(function(){var c=M.Class.create({init:function(a,b){Object.defineProperties(this,{keyResponseData:{value:a,writable:!1,configurable:!1},cryptoContext:{value:b,writable:!1,configurable:!1}})}});Ba=M.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},createRequestData:function(a,b,d){},createResponseData:function(a,b,d){},generateResponse:function(a,
b,d,c){},getCryptoContext:function(a,b,d,c,f){},generateSessionKeys:function(c,m){b(m,function(){var b=new Uint8Array(16),f=new Uint8Array(32);c.getRandom().nextBytes(b);c.getRandom().nextBytes(f);eb(b,ca.AES_CBC,ob,{result:function(b){eb(f,ca.HMAC_SHA256,pb,{result:function(a){m.result({encryptionKey:b,hmacKey:a})},error:function(b){m.error(new d(a.SESSION_KEY_CREATION_FAILURE,null,b))}})},error:function(b){m.error(new d(a.SESSION_KEY_CREATION_FAILURE,null,b))}})})},importSessionKeys:function(a,
b,d){eb(a,ca.AES_CBC,ob,{result:function(a){eb(b,ca.HMAC_SHA256,pb,{result:function(b){d.result({encryptionKey:a,hmacKey:b})},error:function(a){d.error(a)}})},error:function(a){d.error(a)}})}});Ba.KeyExchangeData=c})();var Ib,xc,Ub,yc;(function(){function c(b,m,f,n,h){switch(f){case l.JWE_RSA:case l.JWEJS_RSA:return new ib(b,jb.RSA_OAEP,K,n,h);case l.RSA:case l.JWK_RSA:return new Rb(b,m,n,h,Sb.WRAP_UNWRAP_OAEP);case l.JWK_RSAES:return new Rb(b,m,n,h,Sb.WRAP_UNWRAP_PKCS1);default:throw new d(a.UNSUPPORTED_KEYX_MECHANISM,
f);}}var l=xc={RSA:"RSA",ECC:"ECC",JWE_RSA:"JWE_RSA",JWEJS_RSA:"JWEJS_RSA",JWK_RSA:"JWK_RSA",JWK_RSAES:"JWK_RSAES"},m=Ub=$a.extend({init:function S(a,b,d,c){S.base.call(this,za.ASYMMETRIC_WRAPPED);Object.defineProperties(this,{keyPairId:{value:a,writable:!1,configurable:!1},mechanism:{value:b,writable:!1,configurable:!1},publicKey:{value:d,writable:!1,configurable:!1},privateKey:{value:c,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keypairid=this.keyPairId;a.mechanism=this.mechanism;
a.publickey=D(this.publicKey.getEncoded());return a},equals:function G(a){if(a===this)return!0;if(!(a instanceof Ub))return!1;var b=this.privateKey===a.privateKey||this.privateKey&&a.privateKey&&q(this.privateKey.getEncoded(),a.privateKey.getEncoded());return G.base.call(this,a)&&this.keyPairId==a.keyPairId&&this.mechanism==a.mechanism&&q(this.publicKey.getEncoded(),a.publicKey.getEncoded())&&b},uniqueKey:function w(){var a=this.publicKey.getEncoded(),b=this.privateKey&&this.privateKey.getEncoded(),
a=w.base.call(this)+":"+this.keyPairId+":"+this.mechanism+":"+y(a);b&&(a+=":"+y(b));return a}}),n=function(c,n){b(n,function(){var b=c.keypairid,h=c.mechanism,t=c.publickey;if("string"!==typeof b||!h||"string"!==typeof t)throw new f(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(c));if(!l[h])throw new aa(a.UNIDENTIFIED_KEYX_MECHANISM,h);try{var g=P(t);switch(h){case l.RSA:case l.JWE_RSA:case l.JWEJS_RSA:case l.JWK_RSA:qc(g,ca.RSA_OAEP,Tc,Fa.SPKI,{result:function(a){n.result(new m(b,h,a,null))},error:function(a){n.error(a)}});
break;case l.JWK_RSAES:qc(g,ca.RSAES,Tc,Fa.SPKI,{result:function(a){n.result(new m(b,h,a,null))},error:function(a){n.error(a)}});break;default:throw new d(a.UNSUPPORTED_KEYX_MECHANISM,h);}}catch(O){if(!(O instanceof v))throw new d(a.INVALID_PUBLIC_KEY,"keydata "+JSON.stringify(c),O);throw O;}})},h=yc=ab.extend({init:function z(a,b,d,c){z.base.call(this,a,za.ASYMMETRIC_WRAPPED);Object.defineProperties(this,{keyPairId:{value:b,writable:!1,configurable:!1},encryptionKey:{value:d,writable:!1,configurable:!1},
hmacKey:{value:c,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keypairid=this.keyPairId;a.encryptionkey=D(this.encryptionKey);a.hmackey=D(this.hmacKey);return a},equals:function r(a){return this===a?!0:a instanceof yc?r.base.call(this,a)&&this.keyPairId==a.keyPairId&&q(this.encryptionKey,a.encryptionKey)&&q(this.hmacKey,a.hmacKey):!1},uniqueKey:function W(){return W.base.call(this)+":"+this.keyPairId+":"+y(this.encryptionKey)+":"+y(this.hmacKey)}});Ib=Ba.extend({init:function ta(a){ta.base.call(this,
za.ASYMMETRIC_WRAPPED);Object.defineProperties(this,{authutils:{value:a,writable:!1,enumerable:!1,configurable:!1}})},createRequestData:function(a,b,d){n(b,d)},createResponseData:function(b,c,m){b=m.keypairid;var l=m.encryptionkey,n=m.hmackey;if(!b||"string"!==typeof b||!l||"string"!==typeof l||!n||"string"!==typeof n)throw new f(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(m));var g;try{g=P(l)}catch(ia){throw new d(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(m),ia);}var B;try{B=P(n)}catch(ia){throw new d(a.INVALID_HMAC_KEY,
"keydata "+JSON.stringify(m),ia);}return new h(c,b,g,B)},generateResponse:function(d,l,f,n){function H(a,m,f,h){b(n,function(){var t=c(d,l.keyPairId,l.mechanism,null,l.publicKey);t.wrap(f,{result:function(d){b(n,function(){t.wrap(h,{result:function(b){g(a,m,f,d,h,b)},error:function(d){b(n,function(){d instanceof v&&(d.setMasterToken(a),d.setEntityAuthenticationData(m));throw d;},B)}})},B)},error:function(d){b(n,function(){d instanceof v&&d instanceof v&&(d.setMasterToken(a),d.setEntityAuthenticationData(m));
throw d;},B)}})},B)}function g(a,c,m,H,V,R){b(n,function(){var g=d.getTokenFactory();f instanceof La?g.renewMasterToken(d,f,m,V,null,{result:function(a){b(n,function(){var b=new wa(d,a),c=new h(a,l.keyPairId,H,R);return new Ba.KeyExchangeData(c,b,n)},B)},error:function(d){b(n,function(){d instanceof v&&(d.setMasterToken(a),d.setEntityAuthenticationData(c));throw d;},B)}}):g.createMasterToken(d,f,m,V,null,{result:function(a){b(n,function(){var b=new wa(d,a),c=new h(a,l.keyPairId,H,R);return new Ba.KeyExchangeData(c,
b,n)},B)},error:function(d){b(n,function(){d instanceof v&&(d.setMasterToken(a),d.setEntityAuthenticationData(c));throw d;},B)}})},B)}var B=this;b(n,function(){if(!(l instanceof m))throw new C("Key request data "+JSON.stringify(l)+" was not created by this factory.");var c,h,t;if(f instanceof La){c=f;if(!c.isVerified())throw new Ea(a.MASTERTOKEN_UNTRUSTED,f);t=c.identity;if(!this.authutils.isSchemePermitted(t,this.scheme))throw(new aa(a.KEYX_INCORRECT_DATA,"Authentication scheme for entity not permitted "+
t+": "+this.scheme.name)).setMasterToken(f);}else if(h=f,t=h.getIdentity(),!this.authutils.isSchemePermitted(t,this.scheme))throw(new aa(a.KEYX_INCORRECT_DATA,"Authentication scheme for entity not permitted "+t+": "+this.scheme.name)).setEntityAuthenticationData(f);this.generateSessionKeys(d,{result:function(a){H(c,h,a.encryptionKey,a.hmacKey)},error:function(a){b(n,function(){a instanceof v&&(a.setMasterToken(c),a.setEntityAuthenticationData(h));throw a;},B)}})},B)},getCryptoContext:function(d,l,
f,n,H){var g=this;b(H,function(){if(!(l instanceof m))throw new C("Key request data "+JSON.stringify(l)+" was not created by this factory.");if(!(f instanceof h))throw new C("Key response data "+JSON.stringify(f)+" was not created by this factory.");var B=l.keyPairId,ia=f.keyPairId;if(B!=ia)throw(new aa(a.KEYX_RESPONSE_REQUEST_MISMATCH,"request "+B+"; response "+ia)).setMasterToken(n);ia=l.privateKey;if(!ia)throw(new aa(a.KEYX_PRIVATE_KEY_MISSING,"request Asymmetric private key")).setMasterToken(n);
var ba=c(d,B,l.mechanism,ia,null);ba.unwrap(f.encryptionKey,ca.AES_CBC,ob,{result:function(a){ba.unwrap(f.hmacKey,ca.HMAC_SHA256,pb,{result:function(c){d.getEntityAuthenticationData(null,{result:function(m){b(H,function(){var b=m.getIdentity();return new wa(d,f.masterToken,b,a,c)},g)},error:function(a){b(H,function(){a instanceof v&&a.setMasterToken(n);throw a;},g)}})},error:function(a){b(H,function(){a instanceof v&&a.setMasterToken(n);throw a;},g)}})},error:function(a){b(H,function(){a instanceof
v&&a.setMasterToken(n);throw a;},g)}})},g)}})})();var ze=M.Class.create({addCryptoContext:function(a,b){},getCryptoContext:function(a){},removeCryptoContext:function(a){}}),ld;(function(){ld=function(c,l,m,n){function h(p,t,g){b(n,function(){var h=l.headerdata;if(void 0!=h&&null!=h){if("string"!==typeof h)throw new f(a.JSON_PARSE_ERROR,"header/errormsg "+JSON.stringify(l));p?rb(c,p,{result:function(f){zc(c,h,g,f,t,m,{result:function(c){b(n,function(){if(!c.isDecrypted())throw(new d(a.MESSAGE_MASTERTOKENBASED_VERIFICATION_FAILED)).setMasterToken(f);
return c})},error:n.error})},error:n.error}):zc(c,h,g,null,t,m,{result:function(c){b(n,function(){if(!c.isDecrypted())throw(new d(a.MESSAGE_ENTITYDATABASED_VERIFICATION_FAILED)).setEntityAuthenticationData(g);return c})},error:n.error})}else{var z=l.errordata;if(void 0!=z&&null!=z){if("string"!==typeof z)throw new f(a.JSON_PARSE_ERROR,"header/errormsg "+JSON.stringify(l));md(c,z,g,t,n)}else throw new f(a.JSON_PARSE_ERROR,JSON.stringify(l));}})}b(n,function(){var b=l.entityauthdata,d=l.mastertoken,
m=l.signature;if(b&&"object"!==typeof b||d&&"object"!==typeof d||"string"!==typeof m)throw new f(a.JSON_PARSE_ERROR,"header/errormsg "+JSON.stringify(l));var g;try{g=P(m)}catch(z){throw new fa(a.HEADER_SIGNATURE_INVALID,"header/errormsg "+JSON.stringify(l),z);}b?Wc(c,b,{result:function(a){h(d,g,a)},error:n.error}):h(d,g,null)})}})();var yb,nd,md;(function(){function h(a,b,d){this.errordata=a;this.signature=b;this.timestampSeconds=d}yb=M.Class.create({init:function(d,c,f,h,p,g,G,w,z,r){var W=this;
b(r,function(){0>g&&(g=-1);if(0>h||h>L)throw new C("Message ID "+h+" is out of range.");if(!c)throw new fa(a.MESSAGE_ENTITY_NOT_FOUND);c.scheme.encrypts||(f=null);if(z)return ta=z.timestampSeconds,Object.defineProperties(this,{entityAuthenticationData:{value:c,writable:!1,configurable:!1},recipient:{value:f,writable:!1,configurable:!1},timestampSeconds:{value:ta,writable:!1,enumerable:!1,configurable:!1},messageId:{value:h,writable:!1,configurable:!1},errorCode:{value:p,writable:!1,configurable:!1},
internalCode:{value:g,writable:!1,configurable:!1},errorMessage:{value:G,writable:!1,configurable:!1},userMessage:{value:w,writable:!1,configurable:!1},errordata:{value:z.errordata,writable:!1,enumerable:!1,configurable:!1},signature:{value:z.signature,writable:!1,enumerable:!1,configurable:!1}}),this;var ta=d.getTime()/1E3,T={};f&&(T.recipient=f);T.timestamp=ta;T.messageid=h;T.errorcode=p;0<g&&(T.internalcode=g);G&&(T.errormsg=G);w&&(T.usermsg=w);var O;try{O=d.getEntityAuthenticationFactory(c.scheme).getCryptoContext(d,
c)}catch(I){throw I instanceof v&&(I.setEntityAuthenticationData(c),I.setMessageId(h)),I;}T=na(JSON.stringify(T),Y);O.encrypt(T,{result:function(a){b(r,function(){O.sign(a,{result:function(d){b(r,function(){Object.defineProperties(this,{entityAuthenticationData:{value:c,writable:!1,configurable:!1},recipient:{value:f,writable:!1,configurable:!1},timestampSeconds:{value:ta,writable:!1,enumerable:!1,configurable:!1},messageId:{value:h,writable:!1,configurable:!1},errorCode:{value:p,writable:!1,configurable:!1},
internalCode:{value:g,writable:!1,configurable:!1},errorMessage:{value:G,writable:!1,configurable:!1},userMessage:{value:w,writable:!1,configurable:!1},errordata:{value:a,writable:!1,enumerable:!1,configurable:!1},signature:{value:d,writable:!1,enumerable:!1,configurable:!1}});return this},W)},error:function(a){b(r,function(){a instanceof v&&(a.setEntityAuthenticationData(c),a.setMessageId(h));throw a;},W)}})},W)},error:function(a){b(r,function(){a instanceof v&&(a.setEntityAuthenticationData(c),
a.setMessageId(h));throw a;},W)}})},W)},get timestamp(){return new Date(1E3*this.timestampSeconds)},toJSON:function(){var a={};a.entityauthdata=this.entityAuthenticationData;a.errordata=D(this.errordata);a.signature=D(this.signature);return a}});nd=function(a,b,d,c,f,h,g,w,z){new yb(a,b,d,c,f,h,g,w,null,z)};md=function(l,m,n,t,p){b(p,function(){if(!n)throw new fa(a.MESSAGE_ENTITY_NOT_FOUND);var g;try{var G=n.scheme,w=l.getEntityAuthenticationFactory(G);if(!w)throw new u(a.ENTITYAUTH_FACTORY_NOT_FOUND,
G);g=w.getCryptoContext(l,n)}catch(z){throw z instanceof v&&z.setEntityAuthenticationData(n),z;}try{m=P(m)}catch(z){throw(new fa(a.HEADER_DATA_INVALID,m,z)).setEntityAuthenticationData(n);}if(!m||0==m.length)throw(new fa(a.HEADER_DATA_MISSING,m)).setEntityAuthenticationData(n);g.verify(m,t,{result:function(z){b(p,function(){if(!z)throw(new d(a.MESSAGE_VERIFICATION_FAILED)).setEntityAuthenticationData(n);g.decrypt(m,{result:function(d){b(p,function(){var b=pa(d,Y),g;try{g=JSON.parse(b)}catch(z){if(z instanceof
SyntaxError)throw(new f(a.JSON_PARSE_ERROR,"errordata "+b,z)).setEntityAuthenticationData(n);throw z;}var w=void 0!==g.recipient?g.recipient:null,S=void 0!==g.timestamp?g.timestamp:null,I=parseInt(g.messageid),H=parseInt(g.errorcode),V=parseInt(g.internalcode),B=g.errormsg,G=g.usermsg;if(w&&"string"!==typeof w||S&&"number"!==typeof S||!I||I!=I||!H||H!=H||g.internalcode&&V!=V||B&&"string"!==typeof B||G&&"string"!==typeof G)throw(new f(a.JSON_PARSE_ERROR,"errordata "+b)).setEntityAuthenticationData(n);
if(0>I||I>L)throw(new fa(a.MESSAGE_ID_OUT_OF_RANGE,"errordata "+b)).setEntityAuthenticationData(n);g=!1;for(var ba in c)if(c[ba]==H){g=!0;break}g||(H=c.FAIL);if(V){if(0>V)throw(new fa(a.INTERNAL_CODE_NEGATIVE,"errordata "+b)).setEntityAuthenticationData(n).setMessageId(I);}else V=-1;b=new h(m,t,S);new yb(l,n,w,I,H,V,B,G,b,p)})},error:function(a){b(p,function(){a instanceof v&&a.setEntityAuthenticationData(n);throw a;})}})})},error:function(a){b(p,function(){a instanceof v&&a.setEntityAuthenticationData(n);
throw a;})}})})}})();var Ae=M.Class.create({getUserMessage:function(a,b){}}),Vb,od,Ac;(function(){function b(a,d){var c={},f=[],p;for(p=0;p<a.length;++p)c[a[p]]=!0;for(p=0;p<d.length;++p)c[d[p]]&&f.push(d[p]);return f}Ac=function(a,d){if(!a||!d)return null;var c=b(a.compressionAlgorithms,d.compressionAlgorithms),f=b(a.languages,d.languages);return new Vb(c,f)};Vb=M.Class.create({init:function(a,b){a||(a=[]);b||(b=[]);a.sort();Object.defineProperties(this,{compressionAlgorithms:{value:a,writable:!1,
enumerable:!0,configurable:!1},languages:{value:b,writable:!1,enumerable:!0,configurable:!1}})},toJSON:function(){var a={};a.compressionalgos=this.compressionAlgorithms;a.languages=this.languages;return a},equals:function(a){return this===a?!0:a instanceof Vb?g(this.compressionAlgorithms,a.compressionAlgorithms)&&g(this.languages,a.languages):!1},uniqueKey:function(){return this.compressionAlgorithms.join(":")+"|"+this.languages.join(":")}});od=function(b){var d=b.compressionalgos,c=b.languages;if(d&&
!(d instanceof Array)||c&&!(c instanceof Array))throw new f(a.JSON_PARSE_ERROR,"capabilities "+JSON.stringify(b));b=[];for(var h=0;d&&h<d.length;++h){var p=d[h];Qa[p]&&b.push(p)}return new Vb(b,c)}})();var zb,pd,zc,qd,rd;(function(){function d(a,b,c,f,m,l,n,p){this.user=a;this.sender=b;this.timestampSeconds=c;this.messageCryptoContext=f;this.headerdata=m;this.plaintext=l;this.signature=n;this.verified=p}function c(a,b,d,f,m,l,n,p,h,g,r,t,z,R,w,S,G,Xa,x,X,k,F,Z,Ka,v){return{cryptoContext:{value:b,
writable:!1,configurable:!1},user:{value:d,writable:!1,configurable:!1},entityAuthenticationData:{value:f,writable:!1,configurable:!1},masterToken:{value:m,writable:!1,configurable:!1},sender:{value:l,writable:!1,configurable:!1},recipient:{value:n,writable:!1,configurable:!1},timestampSeconds:{value:p,writable:!1,enumerable:!1,configurable:!1},messageId:{value:h,writable:!1,configurable:!1},nonReplayableId:{value:Xa,writable:!1,configurable:!1},keyRequestData:{value:g,writable:!1,configurable:!1},
keyResponseData:{value:r,writable:!1,configurable:!1},userAuthenticationData:{value:t,writable:!1,configurable:!1},userIdToken:{value:z,writable:!1,configurable:!1},serviceTokens:{value:R,writable:!1,configurable:!1},peerMasterToken:{value:w,writable:!1,configurable:!1},peerUserIdToken:{value:S,writable:!1,configurable:!1},peerServiceTokens:{value:G,writable:!1,configurable:!1},messageCapabilities:{value:k,writable:!1,configurable:!1},renewable:{value:x,writable:!1,enumerable:!1,configurable:!1},
handshake:{value:X,writable:!1,enumerable:!1,configurable:!1},headerdata:{value:F,writable:!1,enumerable:!1,configurable:!1},plaintext:{value:Z,writable:!1,enumerable:!1,configurable:!1},signature:{value:Ka,writable:!1,enumerable:!1,configurable:!1},verified:{value:v,writable:!1,enumerable:!1,configurable:!1}}}function m(b,d,c){if(c){if(d=b.getMslStore().getCryptoContext(c))return d;if(!c.isVerified()||!c.isDecrypted())throw new Ea(a.MASTERTOKEN_UNTRUSTED,c);return new wa(b,c)}c=d.scheme;var f=b.getEntityAuthenticationFactory(c);
if(!f)throw new u(a.ENTITYAUTH_FACTORY_NOT_FOUND,c.name);return f.getCryptoContext(b,d)}function n(a,d,c){b(c,function(){if(d)kd(a,d,c);else return null})}function h(a,d,c,f){b(f,function(){if(d)sb(a,d,c,f);else return null})}function p(a,d,c,f){b(f,function(){if(c)sd(a,d,c,f);else return null})}function g(d,c,m,l,n,p,h){function r(c,h,g){if(h>=c.length){var z=[],R;for(R in t)z.push(t[R]);g.result(z)}else{z=c[h];if("object"!==typeof z)throw new f(a.JSON_PARSE_ERROR,"headerdata "+p);kc(d,z,m,l,n,{result:function(a){b(g,
function(){t[a.uniqueKey()]=a;r(c,h+1,g)})},error:function(a){g.error(a)}})}}var t={};b(h,function(){if(c){if(!(c instanceof Array))throw new f(a.JSON_PARSE_ERROR,"headerdata "+p);r(c,0,h)}else return[]})}function G(d,c,m,l,n,p){function h(d,c,m){b(m,function(){var b=c.peermastertoken;if(b&&"object"!==typeof b)throw new f(a.JSON_PARSE_ERROR,"headerdata "+n);if(!b)return null;rb(d,b,m)})}function r(d,c,m,l){b(l,function(){var b=c.peeruseridtoken;if(b&&"object"!==typeof b)throw new f(a.JSON_PARSE_ERROR,
"headerdata "+n);if(!b)return null;sb(d,b,m,l)})}b(p,function(){if(!d.isPeerToPeer())return{peerMasterToken:null,peerUserIdToken:null,peerServiceTokens:[]};h(d,c,{result:function(a){b(p,function(){var f=m?m.masterToken:a;r(d,c,f,{result:function(m){b(p,function(){g(d,c.peerservicetokens,f,m,l,n,{result:function(d){b(p,function(){return{peerMasterToken:a,peerUserIdToken:m,peerServiceTokens:d}})},error:function(a){b(p,function(){a instanceof v&&(a.setMasterToken(f),a.setUserIdToken(m));throw a;})}})})},
error:function(a){b(p,function(){a instanceof v&&a.setMasterToken(f);throw a;})}})})},error:p.error})})}function w(d,c,m,l){function n(a,c){b(l,function(){if(c>=a.length)return p;jd(d,a[c],{result:function(d){b(l,function(){p.push(d);n(a,c+1)})},error:function(a){l.error(a)}})})}var p=[];b(l,function(){var b=c.keyrequestdata;if(!b)return p;if(!(b instanceof Array))throw new f(a.JSON_PARSE_ERROR,"headerdata "+m);n(b,0)})}var z=qd=M.Class.create({init:function(a,b,d,c,f,m,l,n,p,h,g){Object.defineProperties(this,
{recipient:{value:a,writable:!1,configurable:!1},messageId:{value:b,writable:!1,configurable:!1},nonReplayableId:{value:d,writable:!1,configurable:!1},renewable:{value:c,writable:!1,configurable:!1},handshake:{value:f,writable:!1,configurable:!1},capabilities:{value:m,writable:!1,configurable:!1},keyRequestData:{value:l,writable:!1,configurable:!1},keyResponseData:{value:n,writable:!1,configurable:!1},userAuthData:{value:p,writable:!1,configurable:!1},userIdToken:{value:h,writable:!1,configurable:!1},
serviceTokens:{value:g,writable:!1,configurable:!1}})}}),r=rd=M.Class.create({init:function(a,b,d){Object.defineProperties(this,{peerMasterToken:{value:a,writable:!1,configurable:!1},peerUserIdToken:{value:b,writable:!1,configurable:!1},peerServiceTokens:{value:d,writable:!1,configurable:!1}})}});zb=M.Class.create({init:function(a,d,f,n,p,h,g){function r(z){b(g,function(){if(0>n.messageId||n.messageId>L)throw new C("Message ID "+n.messageId+" is out of range.");if(!d&&!f)throw new C("Message entity authentication data or master token must be provided.");
var r;r=f?!0:d.scheme.encrypts;d=f?null:d;var w=n.nonReplayableId,S=n.renewable,R=n.handshake,B=n.capabilities,Ja=r?n.recipient:null,G=n.messageId,Xa=n.keyRequestData?n.keyRequestData:[],x=n.keyResponseData,X=n.userAuthData,k=n.userIdToken,F=n.serviceTokens?n.serviceTokens:[],Z,Ka,u;a.isPeerToPeer()?(Z=p.peerMasterToken,Ka=p.peerUserIdToken,u=p.peerServiceTokens?p.peerServiceTokens:[]):(Ka=Z=null,u=[]);var A,Ab;x?a.isPeerToPeer()?(A=f,Ab=x.masterToken):(A=x.masterToken,Ab=Z):(A=f,Ab=Z);if(k&&(!A||
!k.isBoundTo(A)))throw new C("User ID token must be bound to a master token.");if(Ka&&(!Ab||!Ka.isBoundTo(Ab)))throw new C("Peer user ID token must be bound to a peer master token.");F.forEach(function(a){if(a.isMasterTokenBound()&&(!A||!a.isBoundTo(A)))throw new C("Master token bound service tokens must be bound to the provided master token.");if(a.isUserIdTokenBound()&&(!k||!a.isBoundTo(k)))throw new C("User ID token bound service tokens must be bound to the provided user ID token.");},this);u.forEach(function(a){if(a.isMasterTokenBound()&&
(!Ab||!a.isBoundTo(Ab)))throw new C("Master token bound peer service tokens must be bound to the provided peer master token.");if(a.isUserIdTokenBound()&&(!Ka||!a.isBoundTo(Ka)))throw new C("User ID token bound peer service tokens must be bound to the provided peer user ID token.");},this);if(h)return lb=h.user,lc=h.timestampSeconds,q=h.messageCryptoContext,r=h.headerdata,D=h.plaintext,r=c(a,q,lb,d,f,z,Ja,lc,G,Xa,x,X,k,F,Z,Ka,u,w,S,R,B,r,D,h.signature,h.verified),Object.defineProperties(this,r),this;
var lb=k?k.user:null,lc=a.getTime()/1E3;r={};z&&(r.sender=z);Ja&&(r.recipient=Ja);r.timestamp=lc;r.messageid=G;r.nonreplayable="number"===typeof w;"number"===typeof w&&(r.nonreplayableid=w);r.renewable=S;r.handshake=R;B&&(r.capabilities=B);0<Xa.length&&(r.keyrequestdata=Xa);x&&(r.keyresponsedata=x);X&&(r.userauthdata=X);k&&(r.useridtoken=k);0<F.length&&(r.servicetokens=F);Z&&(r.peermastertoken=Z);Ka&&(r.peeruseridtoken=Ka);0<u.length&&(r.peerservicetokens=u);var q;try{q=m(a,d,f)}catch(E){throw E instanceof
v&&(E.setMasterToken(f),E.setEntityAuthenticationData(d),E.setUserIdToken(k),E.setUserAuthenticationData(X),E.setMessageId(G)),E;}var D=na(JSON.stringify(r),Y);q.encrypt(D,{result:function(m){b(g,function(){q.sign(m,{result:function(n){b(g,function(){var b=c(a,q,lb,d,f,z,Ja,lc,G,Xa,x,X,k,F,Z,Ka,u,w,S,R,B,m,D,n,!0);Object.defineProperties(this,b);return this},t)},error:function(a){b(g,function(){a instanceof v&&(a.setMasterToken(f),a.setEntityAuthenticationData(d),a.setUserIdToken(k),a.setUserAuthenticationData(X),
a.setMessageId(G));throw a;},t)}})},t)},error:function(a){b(g,function(){a instanceof v&&(a.setMasterToken(f),a.setEntityAuthenticationData(d),a.setUserIdToken(k),a.setUserAuthenticationData(X),a.setMessageId(G));throw a;},t)}})},t)}var t=this;b(g,function(){h?r(h.sender):f?a.getEntityAuthenticationData(null,{result:function(a){a=a.getIdentity();r(a)},error:g.error}):r(null)},t)},get timestamp(){return new Date(1E3*this.timestampSeconds)},isDecrypted:function(){return this.plaintext?!0:!1},isVerified:function(){return this.verified},
isEncrypting:function(){return this.masterToken||this.entityAuthenticationData.scheme.encrypts},isRenewable:function(){return this.renewable},isHandshake:function(){return this.handshake},toJSON:function(){var a={};this.masterToken?a.mastertoken=this.masterToken:a.entityauthdata=this.entityAuthenticationData;a.headerdata=D(this.headerdata);a.signature=D(this.signature);return a}});pd=function(a,b,d,c,f,m){new zb(a,b,d,c,f,null,m)};zc=function(c,l,T,k,I,H,V){function B(m,l,B,I,ta,R){b(V,function(){if(B){var Ca;
try{Ca=JSON.parse(R)}catch(Ka){if(Ka instanceof SyntaxError)throw(new f(a.JSON_PARSE_ERROR,"headerdata "+R,Ka)).setMasterToken(k).setEntityAuthenticationData(T);throw Ka;}var Ja=parseInt(Ca.messageid);if(!Ja||Ja!=Ja)throw(new f(a.JSON_PARSE_ERROR,"headerdata "+R)).setMasterToken(k).setEntityAuthenticationData(T);if(0>Ja||Ja>L)throw(new fa(a.MESSAGE_ID_OUT_OF_RANGE,"headerdata "+R)).setMasterToken(k).setEntityAuthenticationData(T);var Uc=k?Ca.sender:null;if(k&&"string"!==typeof Uc)throw(new f(a.JSON_PARSE_ERROR,
"headerdata "+R)).setMasterToken(k).setEntityAuthenticationData(T).setMessageId(Ja);var Xa="undefined"!==Ca.recipient?Ca.recipient:null;if(Xa&&"string"!==typeof Xa)throw(new f(a.JSON_PARSE_ERROR,"headerdata "+R)).setMasterToken(k).setEntityAuthenticationData(T).setMessageId(Ja);var x="undefined"!==Ca.timestamp?Ca.timestamp:null;if(x&&"number"!==typeof x)throw(new f(a.JSON_PARSE_ERROR,"headerdata "+R)).setMasterToken(k).setEntityAuthenticationData(T).setMessageId(Ja);var X=Ca.keyresponsedata;if(X&&
"object"!==typeof X)throw(new f(a.JSON_PARSE_ERROR,"headerdata "+R)).setMasterToken(k).setEntityAuthenticationData(T).setMessageId(Ja);var Jb=V;V={result:function(a){Jb.result(a)},error:function(a){a instanceof v&&(a.setMasterToken(k),a.setEntityAuthenticationData(T),a.setMessageId(Ja));Jb.error(a)}};n(c,X,{result:function(n){b(V,function(){var X=!c.isPeerToPeer()&&n?n.masterToken:k,Z=Ca.useridtoken;if(Z&&"object"!==typeof Z)throw new f(a.JSON_PARSE_ERROR,"headerdata "+R);h(c,Z,X,{result:function(h){b(V,
function(){var t=Ca.userauthdata;if(t&&"object"!==typeof t)throw new f(a.JSON_PARSE_ERROR,"headerdata "+R);p(c,X,t,{result:function(p){b(V,function(){var t;if(p){var Z=p.scheme,lb=c.getUserAuthenticationFactory(Z);if(!lb)throw(new da(a.USERAUTH_FACTORY_NOT_FOUND,Z)).setUserIdToken(h).setUserAuthenticationData(p);Z=k?k.identity:T.getIdentity();t=lb.authenticate(c,Z,p,h)}else t=h?h.user:null;g(c,Ca.servicetokens,X,h,H,R,{result:function(g){b(V,function(){var S=void 0!==Ca.nonreplayableid?parseInt(Ca.nonreplayableid):
null,X=Ca.renewable,Z=void 0!==Ca.handshake?Ca.handshake:!1;if(S!=S||"boolean"!==typeof X||"boolean"!==typeof Z)throw new f(a.JSON_PARSE_ERROR,"headerdata "+R);if(0>S||S>L)throw new fa(a.NONREPLAYABLE_ID_OUT_OF_RANGE,"headerdata "+R);var lb=null,Jb=Ca.capabilities;if(Jb){if("object"!==typeof Jb)throw new f(a.JSON_PARSE_ERROR,"headerdata "+R);lb=od(Jb)}w(c,Ca,R,{result:function(a){G(c,Ca,n,H,R,{result:function(f){b(V,function(){var b=f.peerMasterToken,R=f.peerUserIdToken,w=f.peerServiceTokens,H=new z(Xa,
Ja,S,X,Z,lb,a,n,p,h,g),b=new r(b,R,w),R=new d(t,Uc,x,m,l,B,I,ta);new zb(c,T,k,H,b,R,V)})},error:V.error})},error:function(a){b(V,function(){a instanceof v&&(a.setUserIdToken(h),a.setUserAuthenticationData(p));throw a;})}})})},error:function(a){b(V,function(){a instanceof v&&(a.setMasterToken(X),a.setUserIdToken(h),a.setUserAuthenticationData(p));throw a;})}})})},error:V.error})})},error:V.error})})},error:V.error})}else{var X=new z(null,1,null,!1,!1,null,[],null,null,null,[]),C=new r(null,null,[]),
Z=new d(null,null,null,m,l,B,I,ta,!1);new zb(c,T,k,X,C,Z,V)}})}b(V,function(){T=k?null:T;if(!T&&!k)throw new fa(a.MESSAGE_ENTITY_NOT_FOUND);var d=l;try{l=P(d)}catch(f){throw new fa(a.HEADER_DATA_INVALID,d,f);}if(!l||0==l.length)throw new fa(a.HEADER_DATA_MISSING,d);var n;try{n=m(c,T,k)}catch(f){throw f instanceof v&&(f.setMasterToken(k),f.setEntityAuthenticationData(T)),f;}n.verify(l,I,{result:function(a){b(V,function(){a?n.decrypt(l,{result:function(d){b(V,function(){var b=pa(d,Y);B(n,l,d,I,a,b)})},
error:V.error}):B(n,null,null,I,a,null)})},error:V.error})})}})();var Cc,td,ud;(function(){function c(a,b){this.payload=a;this.signature=b}Cc=M.Class.create({init:function(a,d,c,f,p,h,g,w){var z=this;b(w,function(){if(0>a||a>L)throw new C("Sequence number "+a+" is outside the valid range.");if(0>d||d>L)throw new C("Message ID "+d+" is outside the valid range.");if(g)return Object.defineProperties(this,{sequenceNumber:{value:a,writable:!1,configurable:!1},messageId:{value:d,writable:!1,configurable:!1},
compressionAlgo:{value:f,writable:!1,configurable:!1},data:{value:p,writable:!1,configurable:!1},endofmsg:{value:c,writable:!1,enumerable:!1,configurable:!1},payload:{value:g.payload,writable:!1,enumerable:!1,configurable:!1},signature:{value:g.signature,writable:!1,enumerable:!1,configurable:!1}}),this;var r;f?(r=Dc(f,p),r||(f=null,r=p)):(f=null,r=p);var W={};W.sequencenumber=a;W.messageid=d;c&&(W.endofmsg=c);f&&(W.compressionalgo=f);W.data=D(r);r=na(JSON.stringify(W),Y);h.encrypt(r,{result:function(g){b(w,
function(){h.sign(g,{result:function(h){b(w,function(){Object.defineProperties(this,{sequenceNumber:{value:a,writable:!1,configurable:!1},messageId:{value:d,writable:!1,configurable:!1},compressionAlgo:{value:f,writable:!1,configurable:!1},data:{value:p,writable:!1,configurable:!1},endofmsg:{value:c,writable:!1,enumerable:!1,configurable:!1},payload:{value:g,writable:!1,enumerable:!1,configurable:!1},signature:{value:h,writable:!1,enumerable:!1,configurable:!1}});return this},z)},error:function(a){w.error(a)}})},
z)},error:function(a){w.error(a)}})},z)},isEndOfMessage:function(){return this.endofmsg},toJSON:function(){var a={};a.payload=D(this.payload);a.signature=D(this.signature);return a}});td=function(a,b,d,c,f,h,g){new Cc(a,b,d,c,f,h,null,g)};ud=function(l,m,n){b(n,function(){var h=l.payload,p=l.signature;if("string"!==typeof h||"string"!==typeof p)throw new f(a.JSON_PARSE_ERROR,"payload chunk "+JSON.stringify(l));var g,G;try{g=P(h)}catch(w){throw new fa(a.PAYLOAD_INVALID,"payload chunk "+JSON.stringify(l),
w);}try{G=P(p)}catch(w){throw new fa(a.PAYLOAD_SIGNATURE_INVALID,"payload chunk "+JSON.stringify(l),w);}m.verify(g,G,{result:function(l){b(n,function(){if(!l)throw new d(a.PAYLOAD_VERIFICATION_FAILED);m.decrypt(g,{result:function(d){b(n,function(){var b=pa(d,Y),l;try{l=JSON.parse(b)}catch(p){if(p instanceof SyntaxError)throw new f(a.JSON_PARSE_ERROR,"payload chunk payload "+b,p);throw p;}var h=parseInt(l.sequencenumber),t=parseInt(l.messageid),w=l.endofmsg,I=l.compressionalgo;l=l.data;if(!h||h!=h||
!t||t!=t||w&&"boolean"!==typeof w||I&&"string"!==typeof I||"string"!==typeof l)throw new f(a.JSON_PARSE_ERROR,"payload chunk payload "+b);if(0>h||h>L)throw new v(a.PAYLOAD_SEQUENCE_NUMBER_OUT_OF_RANGE,"payload chunk payload "+b);if(0>t||t>L)throw new v(a.PAYLOAD_MESSAGE_ID_OUT_OF_RANGE,"payload chunk payload "+b);w||(w=!1);if(I&&!Qa[I])throw new fa(a.UNIDENTIFIED_COMPRESSION,I);var H;try{H=P(l)}catch(p){throw new fa(a.PAYLOAD_DATA_CORRUPT,l,p);}if(H&&0!=H.length)b=I?mc(I,H):H;else{if(0<l.length)throw new fa(a.PAYLOAD_DATA_CORRUPT,
l);if(w)b=new Uint8Array(0);else throw new fa(a.PAYLOAD_DATA_MISSING,l);}H=new c(g,G);new Cc(h,t,w,I,b,m,H,n)})},error:function(a){n.error(a)}})})},error:function(a){n.error(a)}})})}})();var nc,Bb,Kb,Cb,vd,wd;(function(){function d(c,f,m,l,n){function h(){b(n,function(){t>=f.length&&(t=0,++g);if(g>=k.length){if(O)throw O;throw new aa(a.KEYX_FACTORY_NOT_FOUND,JSON.stringify(f));}var d=k[g],m=f[t];d.scheme!=m.keyExchangeScheme?(++t,h()):d.generateResponse(c,m,I,{result:function(a){n.result(a)},error:function(a){b(n,
function(){if(!(a instanceof v))throw a;O=a;++t;h()})}})})}var g=0,t=0,k=c.getKeyExchangeFactories(),O,I=m?m:l;h()}function c(a,f,m,l,n){b(n,function(){var b=f.keyRequestData;if(f.isRenewable()&&0<b.length)if(l)if(l.isRenewable(null)||l.isExpired(null))d(a,b,l,null,n);else return null;else d(a,b,null,m,n);else return null})}function f(d,c,m,l){b(l,function(){var b=c.userIdToken,f=c.userAuthenticationData,n=c.messageId;if(b&&b.isVerified()){if(b.isRenewable(null)&&c.isRenewable()||b.isExpired(null)||
!b.isBoundTo(m)){f=d.getTokenFactory();f.renewUserIdToken(d,b,m,l);return}}else if(c.isRenewable()&&m&&f){b=c.user;if(!b){var b=f.scheme,h=d.getUserAuthenticationFactory(b);if(!h)throw(new da(a.USERAUTH_FACTORY_NOT_FOUND,b)).setMasterToken(m).setUserAuthenticationData(f).setMessageId(n);b=h.authenticate(d,m.identity,f,null)}f=d.getTokenFactory();f.createUserIdToken(d,b,m,l);return}return b})}var n=new Uint8Array(0),h=Bb=function(a){if(0>a||a>L)throw new C("Message ID "+a+" is outside the valid range.");
return a==L?0:a+1};Kb=function(a){if(0>a||a>L)throw new C("Message ID "+a+" is outside the valid range.");return 0==a?L:a-1};Cb=function(a,d,c,f,m,l){b(l,function(){if(void 0==m||null==m){var n=a.getRandom();do m=n.nextLong();while(0>m||m>L)}else if(0>m||m>L)throw new C("Message ID "+m+" is outside the valid range.");a.getEntityAuthenticationData(null,{result:function(n){b(l,function(){var b=a.getMessageCapabilities();return new nc(a,f,m,b,n,d,c,null,null,null,null,null)})},error:function(a){l.error(a)}})})};
vd=function(a,d,n){b(n,function(){function g(a){b(n,function(){a instanceof v&&(a.setMasterToken(z),a.setEntityAuthenticationData(r),a.setUserIdToken(k),a.setUserAuthenticationData(ta),a.setMessageId(O));throw a;})}var z=d.masterToken,r=d.entityAuthenticationData,k=d.userIdToken,ta=d.userAuthenticationData,T=z?z.identity:r.getIdentity(),O=d.messageId,I=h(O);c(a,d,r,z,{result:function(c){b(n,function(){var l=c?c.keyResponseData.masterToken:l=z;a.getEntityAuthenticationData(null,{result:function(h){b(n,
function(){f(a,d,l,{result:function(f){b(n,function(){k=f;var b=Ac(d.messageCapabilities,a.getMessageCapabilities()),m=d.keyResponseData,l=d.serviceTokens;return a.isPeerToPeer()?new nc(a,T,I,b,h,m?m.masterToken:d.peerMasterToken,d.peerUserIdToken,d.peerServiceTokens,z,k,l,c):new nc(a,T,I,b,h,m?m.masterToken:z,k,l,null,null,null,c)})},error:g})})},error:g})})},error:g})})};wd=function(a,d,c,f,m,l){b(l,function(){a.getEntityAuthenticationData(null,{result:function(n){b(l,function(){var b;if(void 0!=
c&&null!=c)b=h(c);else{var g=a.getRandom();do b=g.nextLong();while(0>b||b>L)}nd(a,n,d,b,f.responseCode,f.internalCode,f.message,m,l)})},error:function(a){l.error(a)}})})};nc=M.Class.create({init:function(a,b,d,c,f,m,l,n,h,g,t,H){if(!a.isPeerToPeer()&&(h||g))throw new C("Cannot set peer master token or peer user ID token when not in peer-to-peer mode.");var V;V=H&&!a.isPeerToPeer()?H.keyResponseData.masterToken:m;var B={};a.getMslStore().getServiceTokens(V,l).forEach(function(a){B[a.name]=a},this);
n&&n.forEach(function(a){B[a.name]=a},this);var k,ba,F={};a.isPeerToPeer()&&(k=h,ba=g,n=H?H.keyResponseData.masterToken:h,a.getMslStore().getServiceTokens(n,g).forEach(function(a){F[a.name]=a},this),t&&t.forEach(function(a){F[a.name]=a},this));Object.defineProperties(this,{_ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},_entityAuthData:{value:f,writable:!1,enumerable:!1,configurable:!1},_masterToken:{value:m,writable:!0,enumerable:!1,configurable:!1},_recipient:{value:b,writable:!1,enumerable:!1,
configurable:!1},_messageId:{value:d,writable:!1,enumerable:!1,configurable:!1},_capabilities:{value:c,writable:!1,enumerable:!1,configurable:!1},_keyExchangeData:{value:H,writable:!1,enumerable:!1,configurable:!1},_nonReplayable:{value:!1,writable:!0,enumerable:!1,configurable:!1},_handshake:{value:!1,writable:!0,enumerable:!1,configurable:!1},_renewable:{value:!1,writable:!0,enumerable:!1,configurable:!1},_keyRequestData:{value:{},writable:!1,enumerable:!1,configurable:!1},_userAuthData:{value:null,
writable:!0,enumerable:!1,configurable:!1},_userIdToken:{value:l,writable:!0,enumerable:!1,configurable:!1},_serviceTokens:{value:B,writable:!1,enumerable:!1,configurable:!1},_peerMasterToken:{value:k,writable:!0,enumerable:!1,configurable:!1},_peerUserIdToken:{value:ba,writable:!0,enumerable:!1,configurable:!1},_peerServiceTokens:{value:F,writable:!1,enumerable:!1,configurable:!1}})},getMessageId:function(){return this._messageId},getMasterToken:function(){return this._masterToken},getUserIdToken:function(){return this._userIdToken},
getKeyExchangeData:function(){return this._keyExchangeData},willEncryptHeader:function(){return this._masterToken||this._entityAuthData.scheme.encrypts},willEncryptPayloads:function(){return this._masterToken||!this._ctx.isPeerToPeer()&&this._keyExchangeData||this._entityAuthData.scheme.encrypts},willIntegrityProtectHeader:function(){return this._masterToken||this._entityAuthData.scheme.protectsIntegrity},willIntegrityProtectPayloads:function(){return this._masterToken||!this._ctx.isPeerToPeer()&&
this._keyExchangeData||this._entityAuthData.scheme.protectsIntegrity},getHeader:function(d){b(d,function(){var b=this._keyExchangeData?this._keyExchangeData.keyResponseData:null,c=[],f;for(f in this._serviceTokens)c.push(this._serviceTokens[f]);var m=[],l;for(l in this._keyRequestData)m.push(this._keyRequestData[l]);if(this._nonReplayable){if(!this._masterToken)throw new fa(a.NONREPLAYABLE_MESSAGE_REQUIRES_MASTERTOKEN);l=this._ctx.getMslStore().getNonReplayableId(this._masterToken)}else l=null;b=
new qd(this._recipient,this._messageId,l,this._renewable,this._handshake,this._capabilities,m,b,this._userAuthData,this._userIdToken,c);c=[];for(f in this._peerServiceTokens)c.push(this._peerServiceTokens[f]);f=new rd(this._peerMasterToken,this._peerUserIdToken,c);pd(this._ctx,this._entityAuthData,this._masterToken,b,f,d)},this)},isNonReplayable:function(){return this._nonReplayable},setNonReplayable:function(a){if(this._nonReplayable=a)this._handshake=!1;return this},isRenewable:function(){return this._renewable},
setRenewable:function(a){this._renewable=a;this._renewable||(this._handshake=!1);return this},isHandshake:function(){return this._handshake},setHandshake:function(a){if(this._handshake=a)this._nonReplayable=!1,this._renewable=!0;return this},setAuthTokens:function(a,b){if(b&&!b.isBoundTo(a))throw new C("User ID token must be bound to master token.");if(this._keyExchangeData&&!this._ctx.isPeerToPeer())throw new C("Attempt to set message builder master token when key exchange data exists as a trusted network server.");
var d;try{d=this._ctx.getMslStore().getServiceTokens(a,b)}catch(c){if(c instanceof v)throw new C("Invalid master token and user ID token combination despite checking above.",c);throw c;}var f=[],m;for(m in this._serviceTokens)f.push(this._serviceTokens[m]);f.forEach(function(d){(d.isUserIdTokenBound()&&!d.isBoundTo(b)||d.isMasterTokenBound()&&!d.isBoundTo(a))&&delete this._serviceTokens[d.name]},this);d.forEach(function(a){this._serviceTokens[a.name]=a},this);this._masterToken=a;this._userIdToken=
b},setUserAuthenticationData:function(a){this._userAuthData=a;return this},setUser:function(a,d){var c=this;b(d,function(){if(!this._ctx.isPeerToPeer()&&null!=this._userIdToken||this._ctx.isPeerToPeer()&&null!=this._peerUserIdToken)throw new C("User ID token or peer user ID token already exists for the remote user.");var f;f=this._keyExchangeData?this._keyExchangeData.keyResponseData.masterToken:this._ctx.isPeerToPeer()?this._peerMasterToken:this._masterToken;if(!f)throw new C("User ID token or peer user ID token cannot be created because no corresponding master token exists.");
this._ctx.getTokenFactory().createUserIdToken(this._ctx,a,f,{result:function(a){b(d,function(){this._ctx.isPeerToPeer()?this._peerUserIdToken=a:(this._userIdToken=a,this._userAuthData=null);return!0},c)},error:function(a){d.error(a)}})},c)},addKeyRequestData:function(a){this._keyRequestData[a.uniqueKey()]=a;return this},removeKeyRequestData:function(a){delete this._keyRequestData[a.uniqueKey()];return this},addServiceToken:function(b){var d;d=this._keyExchangeData&&!this._ctx.isPeerToPeer()?this._keyExchangeData.keyResponseData.masterToken:
this._masterToken;if(b.isMasterTokenBound()&&!b.isBoundTo(d))throw(new fa(a.SERVICETOKEN_MASTERTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; mt "+JSON.stringify(d))).setMasterToken(d);if(b.isUserIdTokenBound()&&!b.isBoundTo(this._userIdToken))throw(new fa(a.SERVICETOKEN_USERIDTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; uit "+JSON.stringify(this._userIdToken))).setMasterToken(d).setUserIdToken(this._userIdToken);this._serviceTokens[b.name]=b;return this},addServiceTokenIfAbsent:function(a){this._serviceTokens[a.name]||
this.addServiceToken(a);return this},excludeServiceToken:function(a){delete this._serviceTokens[a];return this},deleteServiceToken:function(a,d){var c=this;b(d,function(){var f=this._serviceTokens[a];if(!f)return this;var m=f.isMasterTokenBound()?this._masterToken:null,f=f.isUserIdTokenBound()?this._userIdToken:null;mb(this._ctx,a,n,m,f,!1,null,new Qb,{result:function(a){b(d,function(){return this.addServiceToken(a)},c)},error:function(a){a instanceof v&&(a=new C("Failed to create and add empty service token to message.",
a));d.error(a)}})},c)},getServiceTokens:function(){var a=[],b;for(b in this._serviceTokens)a.push(this._serviceTokens[b]);return a},getPeerMasterToken:function(){return this._peerMasterToken},getPeerUserIdToken:function(){return this._peerUserIdToken},setPeerAuthTokens:function(b,d){if(!this._ctx.isPeerToPeer())throw new C("Cannot set peer master token or peer user ID token when not in peer-to-peer mode.");if(d&&!b)throw new C("Peer master token cannot be null when setting peer user ID token.");if(d&&
!d.isBoundTo(b))throw(new fa(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit "+d+"; mt "+b)).setMasterToken(b).setUserIdToken(d);var c;try{c=this._ctx.getMslStore().getServiceTokens(b,d)}catch(f){if(f instanceof v)throw new C("Invalid peer master token and user ID token combination despite proper check.",f);throw f;}Object.keys(this._peerServiceTokens).forEach(function(a){var c=this._peerServiceTokens[a];c.isUserIdTokenBound()&&!c.isBoundTo(d)?delete this._peerServiceTokens[a]:c.isMasterTokenBound()&&!c.isBoundTo(b)&&
delete this._peerServiceTokens[a]},this);c.forEach(function(a){var b=a.name;this._peerServiceTokens[b]||(this._peerServiceTokens[b]=a)},this);this._peerUserIdToken=d;this._peerMasterToken=b;return this},addPeerServiceToken:function(b){if(!this._ctx.isPeerToPeer())throw new C("Cannot set peer service tokens when not in peer-to-peer mode.");if(b.isMasterTokenBound()&&!b.isBoundTo(this._peerMasterToken))throw(new fa(a.SERVICETOKEN_MASTERTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; mt "+JSON.stringify(this._peerMasterToken))).setMasterToken(this._peerMasterToken);
if(b.isUserIdTokenBound()&&!b.isBoundTo(this._peerUserIdToken))throw(new fa(a.SERVICETOKEN_USERIDTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; uit "+JSON.stringify(this._peerUserIdToken))).setMasterToken(this._peerMasterToken).setUserIdToken(this._peerUserIdToken);this._peerServiceTokens[b.name]=b;return this},addPeerServiceTokenIfAbsent:function(a){this._peerServiceTokens[a.name]||this.addPeerServiceToken(a);return this},excludePeerServiceToken:function(a){delete this._peerServiceTokens[a];return this},
deletePeerServiceToken:function(a,d){var c=this;b(d,function(){var f=this._peerServiceTokens[a];if(!f)return this;var m=f.isMasterTokenBound()?this._peerMasterToken:null,f=f.isUserIdTokenBound()?this._peerUserIdToken:null;mb(this._ctx,a,n,m,f,!1,null,new Qb,{result:function(a){b(d,function(){return this.addPeerServiceToken(a)},c)},error:function(a){a instanceof v&&(a=new C("Failed to create and add empty peer service token to message.",a));d.error(a)}})},c)},getPeerServiceTokens:function(){var a=
[],b;for(b in this._peerServiceTokens)a.push(this._peerServiceTokens[b]);return a}})})();var xd;(function(){function a(b,d){return d[b]?d[b]:d[""]}function d(a){var b=a.builder.getKeyExchangeData();return b&&!a.ctx.isPeerToPeer()?b.keyResponseData.masterToken:a.builder.getMasterToken()}xd=M.Class.create({init:function(a,b,d){a={ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},cryptoContexts:{value:b.getCryptoContexts(),writable:!1,enumerable:!1,configurable:!1},builder:{value:d,writable:!1,
enumerable:!1,configurable:!1}};Object.defineProperties(this,a)},isPrimaryMasterTokenAvailable:function(){return d(this)?!0:!1},isPrimaryUserIdTokenAvailable:function(){return this.builder.getUserIdToken()?!0:!1},isPeerMasterTokenAvailable:function(){return this.builder.getPeerMasterToken()?!0:!1},isPeerUserIdTokenAvailable:function(){return this.builder.getPeerUserIdToken()?!0:!1},getPrimaryServiceTokens:function(){return this.builder.getServiceTokens()},getPeerServiceTokens:function(){return this.builder.getPeerServiceTokens()},
addPrimaryServiceToken:function(a){try{return this.builder.addServiceToken(a),!0}catch(b){if(b instanceof fa)return!1;throw b;}},addPeerServiceToken:function(a){try{return this.builder.addPeerServiceToken(a),!0}catch(b){if(b instanceof fa)return!1;throw b;}},addUnboundPrimaryServiceToken:function(d,c,f,l,h){var g=this;b(h,function(){var w=a(d,this.cryptoContexts);if(!w)return!1;mb(this.ctx,d,c,null,null,f,l,w,{result:function(a){b(h,function(){try{this.builder.addServiceToken(a)}catch(b){if(b instanceof
fa)throw new C("Service token bound to incorrect authentication tokens despite being unbound.",b);throw b;}return!0},g)},error:function(a){h.error(a)}})},g)},addUnboundPeerServiceToken:function(d,c,f,l,h){var g=this;b(h,function(){var w=a(d,this.cryptoContexts);if(!w)return!1;mb(this.ctx,d,c,null,null,f,l,w,{result:function(a){b(h,function(){try{this.builder.addPeerServiceToken(a)}catch(b){if(b instanceof fa)throw new C("Service token bound to incorrect authentication tokens despite being unbound.",
b);throw b;}return!0},g)},error:function(a){h.error(a)}})},g)},addMasterBoundPrimaryServiceToken:function(c,f,h,g,S){var k=this;b(S,function(){var w=d(this);if(!w)return!1;var z=a(c,this.cryptoContexts);if(!z)return!1;mb(this.ctx,c,f,w,null,h,g,z,{result:function(a){b(S,function(){try{this.builder.addServiceToken(a)}catch(b){if(b instanceof fa)throw new C("Service token bound to incorrect authentication tokens despite setting correct master token.",b);throw b;}return!0},k)},error:function(a){S.error(a)}})},
k)},addMasterBoundPeerServiceToken:function(d,c,f,l,h){var g=this;b(h,function(){var w=this.builder.getPeerMasterToken();if(!w)return!1;var z=a(d,this.cryptoContexts);if(!z)return!1;mb(this.ctx,d,c,w,null,f,l,z,{result:function(a){b(h,function(){try{this.builder.addPeerServiceToken(a)}catch(b){if(b instanceof fa)throw new C("Service token bound to incorrect authentication tokens despite setting correct master token.",b);throw b;}return!0},g)},error:function(a){h.error(a)}})},g)},addUserBoundPrimaryServiceToken:function(c,
f,h,g,S){var k=this;b(S,function(){var w=d(this);if(!w)return!1;var z=this.builder.getUserIdToken();if(!z)return!1;var r=a(c,this.cryptoContexts);if(!r)return!1;mb(this.ctx,c,f,w,z,h,g,r,{result:function(a){b(S,function(){try{this.builder.addServiceToken(a)}catch(b){if(b instanceof fa)throw new C("Service token bound to incorrect authentication tokens despite setting correct master token and user ID token.",b);throw b;}return!0},k)},error:function(a){S.error(a)}})},k)},addUserBoundPeerServiceToken:function(d,
c,f,l,h){var g=this;b(h,function(){var w=this.builder.getPeerMasterToken();if(!w)return!1;var z=this.builder.getPeerUserIdToken();if(!z)return!1;var r=a(d,this.cryptoContexts);if(!r)return!1;mb(this.ctx,d,c,w,z,f,l,r,{result:function(a){b(h,function(){try{this.builder.addPeerServiceToken(a)}catch(b){if(b instanceof fa)throw new C("Service token bound to incorrect authentication tokens despite setting correct master token and user ID token.",b);throw b;}return!0},g)},error:function(a){h.error(a)}})},
g)},excludePrimaryServiceToken:function(a){for(var b=this.builder.getServiceTokens(),d=0;d<b.length;++d)if(b[d].name==a)return this.builder.excludeServiceToken(a),!0;return!1},excludePeerServiceToken:function(a){for(var b=this.builder.getPeerServiceTokens(),d=0;d<b.length;++d)if(b[d].name==a)return this.builder.excludePeerServiceToken(a),!0;return!1},deletePrimaryServiceToken:function(a,d){b(d,function(){for(var b=this.builder.getServiceTokens(),c=0;c<b.length;++c)if(b[c].name==a){this.builder.deleteServiceToken(a,
{result:function(){d.result(!0)},error:function(a){d.error(a)}});return}return!1},this)},deletePeerServiceToken:function(a,d){b(d,function(){for(var b=this.builder.getPeerServiceTokens(),c=0;c<b.length;++c)if(b[c].name==a){this.builder.deletePeerServiceToken(a,{result:function(){d.result(!0)},error:function(a){d.error(a)}});return}return!1},this)}})})();var Ec,yd;(function(){function d(c,f,h,g){b(g,function(){function d(){b(g,function(){if(F>=h.length){if(W)throw W;throw new aa(a.KEYX_RESPONSE_REQUEST_MISMATCH,
JSON.stringify(h));}var f=h[F];z!=f.keyExchangeScheme?(++F,d()):r.getCryptoContext(c,f,G,k,{result:g.result,error:function(a){b(g,function(){if(!(a instanceof v))throw a;W=a;++F;d()})}})})}var k=f.masterToken,G=f.keyResponseData;if(!G)return null;var w=G.masterToken;if(w.isDecrypted())return new wa(c,w);var z=G.keyExchangeScheme,r=c.getKeyExchangeFactory(z);if(!r)throw new aa(a.KEYX_FACTORY_NOT_FOUND,z);var W,F=0;d()})}Ec=fd.extend({init:function(b,c,n,g,p,k,G){var w=this;h(G,function(){function h(){w._ready=
!0;w._readyQueue.add(!0)}function r(a,b){try{var d=b.masterToken;a.getTokenFactory().isMasterTokenRevoked(a,d,{result:function(c){c?(w._errored=(new Ea(c,d)).setUserIdToken(b.userIdToken).setUserAuthenticationData(b.userAuthenticationData).setMessageId(b.messageId),h()):G(a,b)},error:function(a){a instanceof v&&(a.setMasterToken(b.masterToken),a.setUserIdToken(b.userIdToken),a.setUserAuthenticationData(b.userAuthenticationData),a.setMessageId(b.messageId));w._errored=a;h()}})}catch(c){c instanceof
v&&(c.setMasterToken(b.masterToken),c.setUserIdToken(b.userIdToken),c.setUserAuthenticationData(b.userAuthenticationData),c.setMessageId(b.messageId)),w._errored=c,h()}}function G(a,b){try{var d=b.masterToken,c=b.userIdToken;c?a.getTokenFactory().isUserIdTokenRevoked(a,d,c,{result:function(f){f?(w._errored=(new MslUserIdTokenException(f,c)).setMasterToken(d).setUserIdToken(c).setMessageId(b.messageId),h()):ta(a,b)},error:function(a){a instanceof v&&(a.setMasterToken(b.masterToken),a.setUserIdToken(b.userIdToken),
a.setUserAuthenticationData(b.userAuthenticationData),a.setMessageId(b.messageId));w._errored=a;h()}}):ta(a,b)}catch(f){f instanceof v&&(f.setMasterToken(b.masterToken),f.setUserIdToken(b.userIdToken),f.setUserAuthenticationData(b.userAuthenticationData),f.setMessageId(b.messageId)),w._errored=f,h()}}function ta(b,d){try{var c=d.masterToken;c.isExpired(null)?d.isRenewable()&&0!=d.keyRequestData.length?b.getTokenFactory().isMasterTokenRenewable(b,c,{result:function(a){a?(w._errored=(new fa(a,"Master token is expired and not renewable.")).setMasterToken(c).setUserIdToken(d.userIdToken).setUserAuthenticationData(d.userAuthenticationData).setMessageId(d.messageId),
h()):T(b,d)},error:function(a){a instanceof v&&(a.setMasterToken(d.masterToken),a.setUserIdToken(d.userIdToken),a.setUserAuthenticationData(d.userAuthenticationData),a.setMessageId(d.messageId));w._errored=a;h()}}):(w._errored=(new fa(a.MESSAGE_EXPIRED,JSON.stringify(d))).setMasterToken(c).setUserIdToken(d.userIdToken).setUserAuthenticationData(d.userAuthenticationData).setMessageId(d.messageId),h()):T(b,d)}catch(f){f instanceof v&&(f.setMasterToken(d.masterToken),f.setUserIdToken(d.userIdToken),
f.setUserAuthenticationData(d.userAuthenticationData),f.setMessageId(d.messageId)),w._errored=f,h()}}function T(b,d){try{var c=d.masterToken,f=d.nonReplayableId;"number"===typeof f?c?b.getTokenFactory().acceptNonReplayableId(b,c,f,{result:function(a){a&&(w._errored=(new fa(a,JSON.stringify(d))).setMasterToken(c).setUserIdToken(d.userIdToken).setUserAuthenticationData(d.userAuthenticationData).setMessageId(d.messageId));h()},error:function(a){a instanceof v&&(a.setMasterToken(c),a.setUserIdToken(d.userIdToken),
a.setUserAuthenticationData(d.userAuthenticationData),a.setMessageId(d.messageId));w._errored=a;h()}}):(w._errored=(new fa(a.INCOMPLETE_NONREPLAYABLE_MESSAGE,JSON.stringify(d))).setEntityAuthenticationData(d.entityAuthenticationData).setUserIdToken(d.userIdToken).setUserAuthenticationData(d.userAuthenticationData).setMessageId(d.messageId),h()):h()}catch(l){l instanceof v&&(l.setMasterToken(d.masterToken),l.setEntityAuthenticationData(d.entityAuthenticationData),l.setUserIdToken(d.userIdToken),l.setUserAuthenticationData(d.userAuthenticationData),
l.setMessageId(d.messageId)),w._errored=l,h()}}var O={_source:{value:c,writable:!1,enumerable:!1,configurable:!1},_parser:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_charset:{value:n,writable:!1,enumerable:!1,configurable:!1},_remainingData:{value:"",writable:!0,enumerable:!1,configurable:!1},_header:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_cryptoContext:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_keyxCryptoContext:{value:void 0,writable:!0,enumerable:!1,
configurable:!1},_payloadSequenceNumber:{value:1,writable:!0,enuemrable:!1,configurable:!1},_eom:{value:!1,writable:!0,enumerable:!1,configurable:!1},_handshake:{value:null,writable:!0,enumerable:!1,configurable:!1},_closeSource:{value:!1,writable:!0,enumerable:!1,configurable:!1},_payloads:{value:[],writable:!0,enumerable:!1,configurable:!1},_payloadIndex:{value:-1,writable:!0,enumerable:!1,configurable:!1},_payloadOffset:{value:0,writable:!0,enuemrable:!1,configurable:!1},_markOffset:{value:0,writable:!0,
enumerable:!1,configurable:!1},_currentPayload:{value:null,writable:!0,enumerable:!1,configurable:!1},_readException:{value:null,writable:!0,enumerable:!1,configurable:!1},_ready:{value:!1,writable:!0,enumerable:!1,configurable:!1},_readyQueue:{value:new N,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_timedout:{value:!1,writable:!0,enumerable:!1,configurable:!1},_errored:{value:null,writable:!0,enumerable:!1,configurable:!1}};Object.defineProperties(this,
O);gd(w._source,k,{result:function(c){w._json=c;w._jsonIndex=0;null===w._json?(w._errored=new f(a.MESSAGE_DATA_MISSING),h()):ld(b,w._json[w._jsonIndex++],p,{result:function(c){w._header=c;if(w._header instanceof yb)w._keyxCryptoContext=null,w._cryptoContext=null,h();else{var f=w._header;d(b,f,g,{result:function(d){try{w._keyxCryptoContext=d;b.isPeerToPeer()||!w._keyxCryptoContext?w._cryptoContext=f.cryptoContext:w._cryptoContext=w._keyxCryptoContext;try{if(f.isHandshake()&&(!f.isRenewable()||0==f.keyRequestData.length))throw new fa(a.HANDSHAKE_DATA_MISSING,
JSON.stringify(f));try{var c=f.masterToken;c&&(b.isPeerToPeer()||c.isVerified())?r(b,f):T(b,f)}catch(m){m instanceof v&&(m.setMasterToken(f.masterToken),m.setUserIdToken(f.userIdToken),m.setUserAuthenticationData(f.userAuthenticationData),m.setMessageId(f.messageId)),w._errored=m,h()}}catch(m){m instanceof v&&(m.setMasterToken(f.masterToken),m.setEntityAuthenticationData(f.entityAuthenticationData),m.setUserIdToken(f.userIdToken),m.setUserAuthenticationData(f.userAuthenticationData),m.setMessageId(f.messageId)),
w._errored=m,h()}}catch(m){m instanceof v&&(m.setMasterToken(f.masterToken),m.setEntityAuthenticationData(f.entityAuthenticationData),m.setUserIdToken(f.userIdToken),m.setUserAuthenticationData(f.userAuthenticationData),m.setMessageId(f.messageId)),w._errored=m,h()}},error:function(a){a instanceof v&&(a.setMasterToken(f.masterToken),a.setEntityAuthenticationData(f.entityAuthenticationData),a.setUserIdToken(f.userIdToken),a.setUserAuthenticationData(f.userAuthenticationData),a.setMessageId(f.messageId));
w._errored=a;h()}})}},error:function(a){w._errored=a;h()}})},timeout:function(){w._timedout=!0;h()},error:function(a){w._errored=a;h()}});return this},w)},nextJsonObject:function(b,d){var c=this;h(d,function(){function g(a){h(a,function(){var d;if(this._jsonIndex<this._json.length)return d=this._json[this._jsonIndex++];gd(this._source,b,{result:function(b){b&&b.length&&0<b.length?(b.forEach(function(a){this._json.push(a)}),g(a)):(this._eom=!0,a.result(null))},timeout:a.timeout,error:a.error})},c)}
if(!this.getMessageHeader())throw new C("Read attempted with error message.");if(this._eom)return null;g({result:function(b){h(d,function(){if(!b)return null;if("object"!==typeof b)throw new f(a.MESSAGE_FORMAT_ERROR);return b},c)},timeout:d.timeout,error:d.error})},c)},nextData:function(b,d){var c=this;h(d,function(){var g=this.getMessageHeader();if(!g)throw new C("Read attempted with error message.");if(-1!=this._payloadIndex&&this._payloadIndex<this._payloads.length)return this._payloads[this._payloadIndex++];
if(this._eom)return null;this.nextJsonObject(b,{result:function(b){h(d,function(){if(!b)return null;ud(b,this._cryptoContext,{result:function(b){h(d,function(){var d=g.masterToken,c=g.entityAuthenticationData,f=g.userIdToken,m=g.getUserAuthenticationData;if(b.messageId!=g.messageId)throw(new fa(a.PAYLOAD_MESSAGE_ID_MISMATCH,"payload mid "+b.messageId+" header mid "+g.messageId)).setMasterToken(d).setEntityAuthenticationData(c).setUserIdToken(f).setUserAuthenticationData(m);if(b.sequenceNumber!=this._payloadSequenceNumber)throw(new fa(a.PAYLOAD_SEQUENCE_NUMBER_MISMATCH,
"payload seqno "+b.sequenceNumber+" expected seqno "+this._payloadSequenceNumber)).setMasterToken(d).setEntityAuthenticationData(c).setUserIdToken(f).setUserAuthenticationData(m);++this._payloadSequenceNumber;null==this._handshake&&(this._handshake=g.isRenewable()&&0<g.keyRequestData.length&&b.isEndOfMessage()&&0==b.data.length);b.isEndOfMessage()&&(this._eom=!0);d=b.data;this._payloads.push(d);this._payloadIndex=-1;return d},c)},error:function(b){b instanceof SyntaxError&&(b=new f(a.JSON_PARSE_ERROR,
"payloadchunk",b));d.error(b)}})},c)},timeout:d.timeout,error:d.error})},c)},isReady:function(a){function d(){h(a,function(){if(this._aborted)return!1;if(this._timedout)a.timeout();else{if(this._errored)throw this._errored;return!0}},c)}var c=this;h(a,function(){this._ready?d():this._readyQueue.poll(-1,{result:function(b){h(a,function(){if(void 0===b)return!1;d()},c)},timeout:function(){b(a,function(){throw new C("Timeout while waiting for MessageInputStream.isReady() despite no timeout being specified.");
})},error:function(b){a.error(b)}})},c)},isHandshake:function(a,b){var d=this;h(b,function(){var c=this.getMessageHeader();if(!c)return!1;if(c.isHandshake())return!0;if(null==this._handshake)this.nextData(a,{result:function(a){h(b,function(){if(!this._aborted)return this._currentPayload=a,this._payloadOffset=0,this._currentPayload||(this._handshake=!1),this._handshake},d)},timeout:b.timeout,error:function(a){h(b,function(){a instanceof v&&(this._readException=new ua("Error reading the payload chunk.",
a));throw a;},d)}});else return this._handshake},d)},getMessageHeader:function(){return this._header instanceof zb?this._header:null},getErrorHeader:function(){return this._header instanceof yb?this._header:null},getIdentity:function(){var a=this.getMessageHeader();if(a){var b=a.masterToken;return b?b.identity:a.entityAuthenticationData.getIdentity()}return this.getErrorHeader().entityAuthenticationData.getIdentity()},getUser:function(){var a=this.getMessageHeader();return a?a.user:null},getPayloadCryptoContext:function(){return this._cryptoContext},
getKeyExchangeCryptoContext:function(){return this._keyxCryptoContext},closeSource:function(a){this._closeSource=a},abort:function(){this._aborted=!0;this._source.abort();this._readyQueue.cancelAll()},close:function(a,b){var d=this;h(b,function(){function c(){d.nextData(a,{result:function(a){a?c():b.result(!0)},timeout:b.timeout,error:function(){b.result(!0)}})}if(this._closeSource)this._source.close(a,b);else{if(!this.getMessageHeader())return!0;this.isHandshake(a,{result:function(a){a?b.result(!0):
c()},timeout:b.timeout,error:function(){b.result(!0)}})}},d)},mark:function(){if(this._currentPayload){for(;0<this._payloads.length&&this._payloads[0]!==this._currentPayload;)this._payloads.shift();this._payloadIndex=0;this._currentPayload=this._payloads[this._payloadIndex++];this._markOffset=this._payloadOffset}else this._payloadIndex=-1,this._payloads=[]},markSupported:function(){return!0},read:function(a,b,d){function c(){h(d,function(){if(this._aborted)return new Uint8Array(0);if(this._timedout)d.timeout(new Uint8Array(0));
else{if(this._errored)throw this._errored;if(null!=this._readException){var a=this._readException;this._readException=null;throw a;}this.isHandshake(b,{result:function(a){h(d,function(){if(void 0===a)return new Uint8Array(0);if(a)return null;f()},g)},timeout:d.timeout,error:function(a){h(d,function(){this._readException=null;throw new ua("Error reading the payload chunk.",a);},g)}})}},g)}function f(){h(d,function(){function c(d){h(d,function(){if(f&&t>=f.length)return f.subarray(0,t);var n=-1;if(this._currentPayload){var k=
this._currentPayload.length-this._payloadOffset;if(!f){var F=k;if(-1!=this._payloadIndex)for(var I=this._payloadIndex;I<this._payloads.length;++I)F+=this._payloads[I].length;0<F&&(f=new Uint8Array(F))}k=Math.min(k,f?f.length-t:0);0<k&&(n=this._currentPayload.subarray(this._payloadOffset,this._payloadOffset+k),f.set(n,p),n=k,p+=k,this._payloadOffset+=k)}-1!=n?(t+=n,c(d)):this.nextData(b,{result:function(b){h(d,function(){if(this._aborted)return f?f.subarray(0,t):new Uint8Array(0);this._currentPayload=
b;this._payloadOffset=0;if(this._currentPayload)c(d);else return 0==t&&0!=a?null:f?f.subarray(0,t):new Uint8Array(0)},g)},timeout:function(){d.timeout(f?f.subarray(0,t):new Uint8Array(0))},error:function(a){h(d,function(){a instanceof v&&(a=new ua("Error reading the payload chunk.",a));if(0<t)return g._readException=a,f.subarray(0,t);throw a;},g)}})},g)}var f=-1!=a?new Uint8Array(a):void 0,p=0,t=0;c(d)},g)}var g=this;h(d,function(){if(-1>a)throw new RangeError("read requested with illegal length "+
a);this._ready?c():this._readyQueue.poll(b,{result:function(a){void 0===a?d.result(!1):c()},timeout:function(){d.timeout(new Uint8Array(0))},error:function(a){d.error(a)}})},g)},reset:function(){this._payloadIndex=0;0<this._payloads.length?(this._currentPayload=this._payloads[this._payloadIndex++],this._payloadOffset=this._markOffset):this._currentPayload=null}});yd=function(a,b,d,c,f,h,g){new Ec(a,b,d,c,f,h,g)}})();var zd,Ad;(function(){zd=wc.extend({init:function(a,b,d,c,f,g,k){var G=this;h(k,function(){function h(){G._ready=
!0;G._readyQueue.add(!0)}var z=Ac(a.getMessageCapabilities(),c.messageCapabilities),r=null;z&&(r=vb(z.compressionAlgorithms));z={_destination:{value:b,writable:!1,enumerable:!1,configurable:!1},_charset:{value:d,writable:!1,enumerable:!1,configurable:!1},_capabilities:{value:z,writable:!1,enumerable:!1,configurable:!1},_header:{value:c,writable:!1,enumerable:!1,configurable:!1},_compressionAlgo:{value:r,writable:!0,enumerable:!1,configurable:!1},_cryptoContext:{value:f,writable:!1,enumerable:!1,configurable:!1},
_payloadSequenceNumber:{value:1,writable:!0,enumerable:!1,configurable:!1},_currentPayload:{value:[],writable:!0,enumerable:!1,configurable:!1},_closed:{value:!1,writable:!0,enumerable:!1,configurable:!1},_closeDestination:{value:!1,writable:!0,enuemrable:!1,configurable:!1},_caching:{value:!0,writable:!0,enumerable:!1,configurable:!1},_payloads:{value:[],writable:!1,enumerable:!1,configurable:!1},_ready:{value:!1,writable:!0,enumerable:!1,configurable:!1},_readyQueue:{value:new N,writable:!1,enumerable:!1,
configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_timedout:{value:!1,writable:!0,enumerable:!1,configurable:!1},_errored:{value:null,writable:!0,enumerable:!1,configurable:!1}};Object.defineProperties(this,z);var k=na(JSON.stringify(c),d);b.write(k,0,k.length,g,{result:function(a){try{G._aborted?h():a<k.length?(G._timedout=!0,h()):b.flush(g,{result:function(a){G._aborted||(G._timedout=!a);h()},timeout:function(){G._timedout=!0;h()},error:function(a){G._errored=a;h()}})}catch(d){G._errored=
d,h()}},timeout:function(){G._timedout=!0;h()},error:function(a){G._errored=a;h()}});return this},G)},setCompressionAlgorithm:function(a,b,d){function c(){f.flush(b,{result:function(b){h(d,function(){if(!b)throw new ua("flush() aborted");this._compressionAlgo=a;return!0},f)},timeout:function(){d.timeout()},error:function(a){d.error(a)}})}var f=this;h(d,function(){if(!this.getMessageHeader())throw new C("Cannot write payload data for an error message.");if(this._compressionAlgo==a)return!0;if(a){if(!this._capabilities)return!1;
for(var b=this._capabilities.compressionAlgorithms,d=0;d<b.length;++d)if(b[d]==a){c();return}return!1}c()},f)},getMessageHeader:function(){return this._header instanceof zb?this._header:null},getErrorMessage:function(){return this._header instanceof yb?this._header:null},getPayloads:function(){return this._payloads},stopCaching:function(){this._caching=!1;this._payloads.length=0},abort:function(){this._aborted=!0;this._destination.abort();this._readyQueue.cancelAll()},closeDestination:function(a){this._closeDestination=
a},close:function(a,b){var d=this;h(b,function(){if(this._aborted)return!1;if(this._timedout)b.timeout();else{if(this._errored)throw this._errored;if(this._closed)return!0;this._closed=!0;this.flush(a,{result:function(c){h(b,function(){c&&(this._currentPayload=null);if(this._closeDestination)this._destination.close(a,b);else return c},d)},timeout:b.timeout,error:b.error})}},d)},flush:function(a,b){function d(){h(b,function(){if(this._aborted)return!1;if(this._timedout)b.timeout();else{if(this._errored)throw this._errored;
if(!this._currentPayload||!this._closed&&0==this._currentPayload.length)return!0;var d=this.getMessageHeader();if(!d||d.isHandshake())return!0;var f=0;this._currentPayload&&this._currentPayload.forEach(function(a){f+=a.length});for(var m=new Uint8Array(f),g=0,k=0;this._currentPayload&&k<this._currentPayload.length;++k){var z=this._currentPayload[k];m.set(z,g);g+=z.length}td(this._payloadSequenceNumber,d.messageId,this._closed,this._compressionAlgo,m,this._cryptoContext,{result:function(d){h(b,function(){this._caching&&
this._payloads.push(d);var f=na(JSON.stringify(d),this._charset);this._destination.write(f,0,f.length,a,{result:function(f){h(b,function(){if(this._aborted)return!1;f<d.length?b.timeout():this._destination.flush(a,{result:function(a){h(b,function(){if(this._aborted)return!1;if(a)return++this._payloadSequenceNumber,this._currentPayload=this._closed?null:[],!0;b.timeout()},c)},timeout:function(){b.timeout()},error:function(a){a instanceof v&&(a=new ua("Error encoding payload chunk [sequence number "+
c._payloadSequenceNumber+"].",a));b.error(a)}})},c)},timeout:function(a){b.timeout()},error:function(a){a instanceof v&&(a=new ua("Error encoding payload chunk [sequence number "+c._payloadSequenceNumber+"].",a));b.error(a)}})},c)},error:function(a){a instanceof v&&(a=new ua("Error encoding payload chunk [sequence number "+c._payloadSequenceNumber+"].",a));b.error(a)}})}},c)}var c=this;h(b,function(){this._ready?d():this._readyQueue.poll(a,{result:function(a){void 0===a?b.result(!1):d()},timeout:function(){b.timeout()},
error:function(a){b.error(a)}})},c)},write:function(a,b,d,c,f){h(f,function(){if(this._aborted)return!1;if(this._timedout)f.timeout();else{if(this._errored)throw this._errored;if(this._closed)throw new ua("Message output stream already closed.");if(0>b)throw new RangeError("Offset cannot be negative.");if(0>d)throw new RangeError("Length cannot be negative.");if(b+d>a.length)throw new RangeError("Offset plus length cannot be greater than the array length.");var c=this.getMessageHeader();if(!c)throw new C("Cannot write payload data for an error message.");
if(c.isHandshake())throw new C("Cannot write payload data for a handshake message.");c=a.subarray(b,b+d);this._currentPayload.push(c);return c.length}},this)}});Ad=function(a,b,d,c,f,h,g){new zd(a,b,d,c,f,h,g)}})();var Bd=M.Class.create({createInputStream:function(a,b,d,c,f,h,g){yd(a,b,d,c,f,h,g)},createOutputStream:function(a,b,d,c,f,h,g){Ad(a,b,d,c,f,h,g)}});Object.freeze({USERDATA_REAUTH:c.USERDATA_REAUTH,SSOTOKEN_REJECTED:c.SSOTOKEN_REJECTED});var Xb=M.Class.create({getCryptoContexts:function(){},
getRecipient:function(){},isEncrypted:function(){},isIntegrityProtected:function(){},isNonReplayable:function(){},isRequestingTokens:function(){},getUserId:function(){},getUserAuthData:function(a,b,d,c){},getUser:function(){},getKeyRequestData:function(a){},updateServiceTokens:function(a,b,d){},write:function(a,b,d){},getDebugContext:function(){}}),Ie=M.Class.create({sentHeader:function(a){},receivedHeader:function(a){}});M.Class.create({getInputStream:function(a){},getOutputStream:function(a){}});
var Cd;(function(){function d(a){return function(){a.abort()}}function f(a,b){Object.defineProperties(this,{masterToken:{value:a,writable:!1,configurable:!1},ticket:{value:b,writable:!1,configurable:!1}})}function m(a,b){Object.defineProperties(this,{builder:{value:a,writable:!1,configurable:!1},msgCtx:{value:b,writable:!1,configurable:!1}})}function g(a,b){Object.defineProperties(this,{request:{value:a,writable:!1,configurable:!1},handshake:{value:b,writable:!1,configurable:!1}})}function t(a,b){Object.defineProperties(this,
{request:{value:b.request,writable:!1,configurable:!1},handshake:{value:b.handshake,writable:!1,configurable:!1},response:{value:a,writable:!1,configurable:!1}})}function p(a){for(;a;){if(a instanceof Na)return!0;a=a instanceof v?a.cause:void 0}return!1}function k(a){var b=a.masterToken;return b?b.identity:a.entityAuthenticationData.getIdentity()}function G(a,b,d,c,f,m,l,g,n,p,t){wd(d,f,m,l,g,{result:function(f){c&&c.sentHeader(f);b._streamFactory.createOutputStream(d,n,Y,f,null,null,p,{result:function(b){a.setAbort(function(){b.abort()});
b.close(p,{result:function(a){h(t,function(){if(!a)throw new Na("sendError aborted.");return a})},timeout:function(){t.timeout()},error:function(a){t.error(a)}})},timeout:function(){},error:function(a){t.error(a)}})},error:function(a){t.error(a)}})}var w=function(a,b){Object.defineProperties(this,{input:{value:a,writable:!1,configurable:!1},output:{value:b,writable:!1,configurable:!1}});return this},z=M.Class.create({init:function(a,b){Object.defineProperties(this,{_ctx:{value:a,writable:!1,enumerable:!1,
configurable:!1},_masterToken:{value:b,writable:!1,enumerable:!1,configurable:!1}})},equals:function(a){return this===a?!0:a instanceof z?this._ctx===a._ctx&&this._masterToken.equals(a._masterToken):!1},uniqueKey:function(){return this._ctx.uniqueKey()+":"+this._masterToken.uniqueKey()}});wc.extend({close:function(a,b){b.result(!0)},write:function(a,d,c,f,h){b(h,function(){return Math.min(a.length-d,c)})},flush:function(a,b){b.result(!0)}});var r=Ae.extend({getUserMessage:function(a,b){return null}}),
W=Xb.extend({init:function(a){Object.defineProperties(this,{_appCtx:{value:a,writable:!1,enumerable:!1,configurable:!1}})},getCryptoContexts:function(){return this._appCtx.getCryptoContexts()},getRecipient:function(){return this._appCtx.getRecipient()},isEncrypted:function(){return this._appCtx.isEncrypted()},isIntegrityProtected:function(){return this._appCtx.isIntegrityProtected()},isNonReplayable:function(){return this._appCtx.isNonReplayable()},isRequestingTokens:function(){return this._appCtx.isRequestingTokens()},
getUserId:function(){return this._appCtx.getUserId()},getUserAuthData:function(a,b,d,c){this._appCtx.getUserAuthData(a,b,d,c)},getUser:function(){return this._appCtx.getUser()},getKeyRequestData:function(a){this._appCtx.getKeyRequestData(a)},updateServiceTokens:function(a,b,d){this._appCtx.updateServiceTokens(a,b,d)},write:function(a,b,d){this._appCtx.write(a,b,d)},getDebugContext:function(){return this._appCtx.getDebugContext()}}),u=W.extend({init:function pe(a,b){pe.base.call(this,b);Object.defineProperties(this,
{_payloads:{value:a,writable:!1,enumerable:!1,configurable:!1}})},write:function qe(a,b,d){function c(m){if(m==f._payloads.length)d.result(!0);else{var l=f._payloads[m];a.setCompressionAlgorithm(l.compressionAlgo,b,{result:function(g){a.write(l.data,0,l.data.length,b,{result:function(g){h(d,function(){l.isEndOfMessage()?a.close(b,{result:function(a){a?c(m+1):d.result(a)},timeout:d.timeout,error:d.error}):a.flush(b,{result:function(a){a?c(m+1):d.result(a)},timeout:d.timeout,error:d.error})},f)},timeout:d.timeout,
error:d.error})},timeout:d.timeout,error:d.error})}}var f=this;this._payloads&&0!=this._payloads.length?c(0):qe.base.call(this,a,b,d)}}),T=W.extend({init:function R(a){R.base.call(this,a)},isEncrypted:function(){return!1},isIntegrityProtected:function(){return!1},isNonReplayable:function(){return!1},write:function(a,b,d){d.result(!0)}}),O={},I,H,V,B,ia=M.Class.create({init:function(a,b){a||(a=new Bd);b||(b=new r);Object.defineProperties(this,{_streamFactory:{value:a,writable:!1,enumerable:!1,configurable:!1},
_messageRegistry:{value:b,writable:!1,enumerable:!1,configurable:!1},_filterFactory:{value:null,writable:!0,enumerable:!1,configurable:!1},_renewingContexts:{value:[],writable:!1,enumerable:!1,configurable:!1},_masterTokenLocks:{value:{},writable:!1,enumerable:!1,configurable:!1},_remoteClocks:{value:[],writable:!1,enumerable:!1,configurable:!1}})},setFilterFactory:function(a){this._filterFactory=a},getNewestMasterToken:function(a,b,d,c){var m=this;h(c,function(){var g=b.getMslStore(),n=g.getMasterToken();
if(!n)return null;var p=(new z(b,n)).uniqueKey(),t=this._masterTokenLocks[p];t||(t=new Ta,this._masterTokenLocks[p]=t);var r=t.readLock(d,{result:function(r){h(c,function(){if(void 0===r)throw new Na("getNewestMasterToken aborted.");var k=g.getMasterToken();if(n.equals(k))return new f(n,r);t.unlock(r);t.writeLock(d,{result:function(f){h(c,function(){if(void 0===f)throw new Na("getNewestMasterToken aborted.");delete this._masterTokenLocks[p];t.unlock(f);return this.getNewestMasterToken(a,b,d,c)},m)},
timeout:function(){c.timeout()},error:function(a){c.error(a)}})},m)},timeout:function(){c.timeout()},error:function(a){c.error(a)}});a.setAbort(function(){r&&(t.cancel(r),r=void 0)})},m)},deleteMasterToken:function(a,b){if(b){var d=this;setTimeout(function(){var c=(new z(a,b)).uniqueKey(),f=d._masterTokenLocks[c];f||(f=new Ta,d._masterTokenLocks[c]=f);f.writeLock(-1,{result:function(h){a.getMslStore().removeCryptoContext(b);delete d._masterTokenLocks[c];f.unlock(h)},timeout:function(){throw new C("Unexpected timeout received.");
},error:function(a){throw a;}})},0)}},releaseMasterToken:function(a,b){if(b&&b.masterToken){var d=(new z(a,b.masterToken)).uniqueKey();(d=this._masterTokenLocks[d])&&d.unlock(b.ticket)}},updateOutgoingCryptoContexts:function(a,b,d){var c=a.getMslStore();!a.isPeerToPeer()&&d&&(c.setCryptoContext(d.keyResponseData.masterToken,d.cryptoContext),this.deleteMasterToken(a,b.masterToken))},updateIncomingCryptoContexts:function(a,b,d){var c=d.getMessageHeader();if(c){var f=a.getMslStore();if(c=c.keyResponseData)f.setCryptoContext(c.masterToken,
d.getKeyExchangeCryptoContext()),this.deleteMasterToken(a,b.masterToken)}},storeServiceTokens:function(a,b,d,c){a=a.getMslStore();for(var f=[],h=0;h<c.length;++h){var m=c[h];if(!m.isBoundTo(b)||!b.isVerified()){var l=m.data;l&&0==l.length?a.removeServiceTokens(m.name,m.isMasterTokenBound()?b:null,m.isUserIdTokenBound()?d:null):f.push(m)}}0<f.length&&a.addServiceTokens(f)},buildRequest:function(a,d,c,f,h){var m=this;this.getNewestMasterToken(a,d,f,{result:function(a){b(h,function(){var f=a&&a.masterToken,
l;if(f){l=c.getUserId();var g=d.getMslStore();l=(l=l?g.getUserIdToken(l):null)&&l.isBoundTo(f)?l:null}else l=null;g=c.getRecipient();Cb(d,f,l,g,null,{result:function(d){b(h,function(){d.setNonReplayable(c.isNonReplayable());return{builder:d,tokenTicket:a}})},error:function(c){b(h,function(){this.releaseMasterToken(d,a);c instanceof v&&(c=new C("User ID token not bound to master token despite internal check.",c));throw c;},m)}})},m)},timeout:function(){h.timeout()},error:function(a){h.error(a)}})},
buildResponse:function(a,b,d,c,f,m){var l=this;vd(b,c,{result:function(g){h(m,function(){g.setNonReplayable(d.isNonReplayable());if(!b.isPeerToPeer()&&!c.keyResponseData)return{builder:g,tokenTicket:null};this.getNewestMasterToken(a,b,f,{result:function(a){h(m,function(){var c=a&&a.masterToken,f;if(c){f=d.getUserId();var h=b.getMslStore();f=(f=f?h.getUserIdToken(f):null)&&f.isBoundTo(c)?f:null}else f=null;g.setAuthTokens(c,f);return{builder:g,tokenTicket:a}},l)},timeout:function(){m.timeout()},error:function(a){m.error(a)}})},
l)},error:function(a){m.error(a)}})},buildErrorResponse:function(a,b,d,f,l,g,n){function p(a,c){h(n,function(){var f=Bb(l.messageId),g=new u(c,d),x=g.getRecipient();Cb(b,null,null,x,f,{result:function(d){h(n,function(){b.isPeerToPeer()&&d.setPeerAuthTokens(a.peerMasterToken,a.peerUserIdToken);d.setNonReplayable(g.isNonReplayable());return{errorResult:new m(d,g),tokenTicket:null}},r)},error:function(a){n.error(a)}})},r)}function t(c,f){r.getNewestMasterToken(a,b,g,{result:function(a){h(n,function(){var g=
a&&a.masterToken,x=Bb(l.messageId),R=new u(f,d),p=R.getRecipient();Cb(b,g,null,p,x,{result:function(d){h(n,function(){b.isPeerToPeer()&&d.setPeerAuthTokens(c.peerMasterToken,c.peerUserIdToken);d.setNonReplayable(R.isNonReplayable());return{errorResult:new m(d,R),tokenTicket:a}},r)},error:function(a){n.error(a)}})},r)},timeout:function(){n.timeout()},error:function(a){n.error(a)}})}var r=this;h(n,function(){var k=f.request.getMessageHeader(),B=f.request.getPayloads(),z=l.errorCode;switch(z){case c.ENTITYDATA_REAUTH:case c.ENTITY_REAUTH:b.getEntityAuthenticationData(z,
{result:function(a){h(n,function(){if(!a)return null;p(k,B)},r)},error:function(a){n.error(a)}});break;case c.USERDATA_REAUTH:case c.SSOTOKEN_REJECTED:d.getUserAuthData(z,!1,!0,{result:function(a){h(n,function(){if(!a)return null;t(k,B)},r)},error:function(a){n.error(a)}});break;case c.USER_REAUTH:t(k,B);break;case c.KEYX_REQUIRED:var z=Bb(l.messageId),w=new u(B,d),I=w.getRecipient();Cb(b,null,null,I,z,{result:function(a){h(n,function(){b.isPeerToPeer()&&a.setPeerAuthTokens(k.peerMasterToken,k.peerUserIdToken);
a.setRenewable(!0);a.setNonReplayable(w.isNonReplayable());return{errorResult:new m(a,w),tokenTicket:null}},r)},error:function(a){n.error(a)}});break;case c.EXPIRED:this.getNewestMasterToken(a,b,g,{result:function(a){h(n,function(){var c=a&&a.masterToken,f;if(c){f=d.getUserId();var g=b.getMslStore();f=(f=f?g.getUserIdToken(f):null)&&f.isBoundTo(c)?f:null}else f=null;var g=Bb(l.messageId),x=new u(B,d),R=x.getRecipient();Cb(b,c,f,R,g,{result:function(d){h(n,function(){b.isPeerToPeer()&&d.setPeerAuthTokens(k.peerMasterToken,
k.peerUserIdToken);var f=k.masterToken;f&&!f.equals(c)||d.setRenewable(!0);d.setNonReplayable(x.isNonReplayable());return{errorResult:new m(d,x),tokenTicket:a}},r)},error:function(a){n.error(a)}},r)},r)},timeout:function(){n.timeout()},error:function(a){n.error(a)}});break;case c.REPLAYED:this.getNewestMasterToken(a,b,g,{result:function(a){h(n,function(){var c=a&&a.masterToken,f;if(c){f=d.getUserId();var g=b.getMslStore();f=(f=f?g.getUserIdToken(f):null)&&f.isBoundTo(c)?f:null}else f=null;var g=Bb(l.messageId),
x=new u(B,d),R=x.getRecipient();Cb(b,c,f,R,g,{result:function(d){h(n,function(){b.isPeerToPeer()&&d.setPeerAuthTokens(k.peerMasterToken,k.peerUserIdToken);d.setNonReplayable(x.isNonReplayable());return{errorResult:new m(d,x),tokenTicket:a}},r)},error:function(a){n.error(a)}})},r)},timeout:function(){n.timeout()},error:function(a){n.error(a)}});break;default:return null}},r)},cleanupContext:function(a,b,d){switch(d.errorCode){case c.ENTITY_REAUTH:case c.ENTITYDATA_REAUTH:this.deleteMasterToken(a,b.masterToken);
break;case c.USER_REAUTH:case c.USERDATA_REAUTH:d=b.userIdToken,b.masterToken&&d&&a.getMslStore().removeUserIdToken(d)}},send:function(a,b,d,c,f,m,l,p){function t(a,c,m){h(p,function(){var l=f.getPeerUserIdToken();!b.isPeerToPeer()&&!c||b.isPeerToPeer()&&!l?(l=d.getUser())?f.setUser(l,{result:function(b){h(p,function(){c=f.getUserIdToken();r(a,c,m)},z)},error:function(a){p.error(a)}}):r(a,c,m):r(a,c,m)},z)}function r(a,c,m){h(p,function(){var l=!(!(m||d.isEncrypted()&&!f.willEncryptPayloads()||d.isIntegrityProtected()&&
!f.willIntegrityProtectPayloads())&&(!d.isNonReplayable()||f.isNonReplayable()&&a));f.setHandshake(l);var g=[];if(f.isRenewable()){var n=b.getRemoteTime();if(!a||a.isRenewable(n)||d.isNonReplayable()){d.getKeyRequestData({result:function(b){h(p,function(){for(var d=0;d<b.length;++d){var h=b[d];g.push(h);f.addKeyRequestData(h)}k(a,c,l,g)},z)},error:function(a){p.error(a)}});return}}k(a,c,l,g)},z)}function k(g,n,t,r){h(p,function(){var r=new xd(b,d,f);d.updateServiceTokens(r,t,{result:function(r){f.getHeader({result:function(r){h(p,
function(){var k=d.getDebugContext();k&&k.sentHeader(r);k=f.getKeyExchangeData();this.updateOutgoingCryptoContexts(b,r,k);this.storeServiceTokens(b,k?k.keyResponseData.masterToken:g,n,r.serviceTokens);k=!b.isPeerToPeer()&&k?k.cryptoContext:r.cryptoContext;if(a.isAborted())throw new Na("send aborted.");var w=null!=this._filterFactory?this._filterFactory.getOutputStream(c):c;this._streamFactory.createOutputStream(b,w,Y,r,k,l,{result:function(b){h(p,function(){a.setAbort(function(){b.abort()});b.closeDestination(m);
B(b,t)},z)},timeout:function(){p.timeout()},error:function(a){p.error(a)}})},z)},timeout:function(){p.timeout()},error:function(a){p.error(a)}})},error:function(a){p.error(a)}})},z)}function B(b,c){c?h(p,function(){return new g(b,c)},z):d.write(b,l,{result:function(d){h(p,function(){if(a.isAborted())throw new Na("MessageOutputStream write aborted.");return new g(b,c)},z)},timeout:function(){p.timeout()},error:function(a){p.error(a)}})}var z=this;h(p,function(){var a=f.getMasterToken(),b=f.getUserIdToken(),
c=!1;if(d.getUserId()){var m=!b;d.getUserAuthData(null,f.isRenewable(),m,{result:function(d){h(p,function(){d&&(f.willEncryptHeader()&&f.willIntegrityProtectHeader()?f.setUserAuthenticationData(d):c=!0);t(a,b,c)},z)},error:function(a){p.error(a)}})}else t(a,b,c)},z)},receive:function(b,d,f,m,l,g,n){var p=this;h(n,function(){if(b.isAborted())throw new Na("receive aborted.");var t=[];l&&(t=l.keyRequestData.filter(function(){return!0}));var r=f.getCryptoContexts(),k=this._filterFactory?this._filterFactory.getInputStream(m):
m;this._streamFactory.createInputStream(d,k,Y,t,r,g,{result:function(m){b.setAbort(function(){m.abort()});m.isReady({result:function(b){h(n,function(){if(!b)throw new Na("MessageInputStream aborted.");var g=m.getMessageHeader(),x=m.getErrorHeader(),t=f.getDebugContext();t&&t.receivedHeader(g?g:x);var r,R,k;g?(t=g.masterToken,r=g.entityAuthenticationData,R=g.userIdToken,k=g.userAuthenticationData):(t=null,r=x.entityAuthenticationData,k=R=null);if(l){var z=x?x.errorCode:null;if(g||z!=c.FAIL&&z!=c.TRANSIENT_FAILURE&&
z!=c.ENTITY_REAUTH&&z!=c.ENTITYDATA_REAUTH){var z=g?g.messageId:x.messageId,B=Bb(l.messageId);if(z!=B)throw(new fa(a.UNEXPECTED_RESPONSE_MESSAGE_ID,"expected "+B+"; received "+z)).setMasterToken(t).setEntityAuthenticationData(r).setUserIdToken(R).setUserAuthenticationData(k);}}d.getEntityAuthenticationData(null,{result:function(b){h(n,function(){var c=b.getIdentity(),h;try{if(g){var n=g.entityAuthenticationData,p=g.masterToken;h=p?g.sender:n.getIdentity();if(p&&p.isDecrypted()&&p.identity!=h||c==
h)throw new fa(a.UNEXPECTED_MESSAGE_SENDER,h);var t=g.recipient;if(t&&t!=c)throw new fa(a.MESSAGE_RECIPIENT_MISMATCH,t);l&&this.updateIncomingCryptoContexts(d,l,m);var r=g.keyResponseData,z,B,w;d.isPeerToPeer()?(z=r?r.masterToken:g.peerMasterToken,B=g.peerUserIdToken,w=g.peerServiceTokens):(z=r?r.masterToken:g.masterToken,B=g.userIdToken,w=g.serviceTokens);var I=f.getUserId();I&&B&&!B.isVerified()&&d.getMslStore().addUserIdToken(I,B);this.storeServiceTokens(d,z,B,w)}else if(h=x.entityAuthenticationData.getIdentity(),
c==h)throw new fa(a.UNEXPECTED_MESSAGE_SENDER,h);var X=g?g.timestamp:x.timestamp;X&&(l||d.isPeerToPeer())&&d.updateRemoteTime(X)}catch(H){throw H instanceof v&&(H.setMasterToken(p),H.setEntityAuthenticationData(n),H.setUserIdToken(R),H.setUserAuthenticationData(k)),H;}return m},p)},error:n.error})},p)},timeout:function(){n.timeout()},error:function(a){n.error(a)}})},timeout:function(){n.timeout()},error:function(a){n.error(a)}})},p)},sendReceive:function(a,b,d,c,f,m,l,g,n,p){function r(m,x,z){h(p,
function(){var r=m.builder,B=m.tokenTicket;r.setRenewable(z);this.send(a,b,d,f,r,g,n,{result:function(f){h(p,function(){var m=f.request.getMessageHeader(),r=m.keyRequestData;l||f.handshake||!r.isEmpty()||m.isRenewable()&&m.masterToken&&m.userAuthenticationData?this.receive(a,b,d,c,m,n,{result:function(a){h(p,function(){var d=a.getErrorHeader();d&&this.cleanupContext(b,m,d);z&&this.releaseRenewalLock(b,x,a);this.releaseMasterToken(b,B);a.closeSource(g);return new t(a,f)},k)},timeout:function(){h(p,
function(){z&&this.releaseRenewalLock(b,x,null);this.releaseMasterToken(b,B);p.timeout()},k)},error:function(a){h(p,function(){z&&this.releaseRenewalLock(b,x,null);this.releaseMasterToken(b,B);p.error(a)},k)}}):h(p,function(){z&&this.releaseRenewalLock(b,x,null);this.releaseMasterToken(b,B);return new t(null,f)},k)},k)},timeout:function(){h(p,function(){z&&this.releaseRenewalLock(b,x,null);this.releaseMasterToken(b,B);p.timeout()},k)},error:function(a){h(p,function(){z&&this.releaseRenewalLock(b,
x,null);this.releaseMasterToken(b,B);p.error(a)},k)}})},k)}var k=this;h(p,function(){var c=new N;this.acquireRenewalLock(a,b,d,c,m,n,{result:function(a){r(m,c,a)},timeout:function(){h(p,function(){this.releaseMasterToken(b,m.ticket);p.timeout()},k)},error:function(a){h(p,function(){this.releaseMasterToken(b,m.ticket);if(a instanceof Na)return null;p.error(a)},k)}})},k)},acquireRenewalLock:function(a,b,d,c,f,m,l){function g(d,p,t,k,z){h(l,function(){if(a.isAborted())throw new Na("acquireRenewalLock aborted.");
for(var B=null,w=0;w<this._renewingContexts.length;++w){var I=this._renewingContexts[w];if(I.ctx===b){B=I.queue;break}}if(!B)return this._renewingContexts.push({ctx:b,queue:c}),!0;var H=B.poll(m,{result:function(c){h(l,function(){if(void 0===c)throw new Na("acquireRenewalLock aborted.");B.add(c);if(c===O)g(d,p,t,k,z);else{var w=d;d&&d.equals(c)?n(w,d,p,t,k,z):(this.releaseMasterToken(b,z),this.getNewestMasterToken(a,b,m,{result:function(a){h(l,function(){(d=(f.tokenTicket=a)&&a.masterToken)?n(w,d,
p,t,k,a):g(d,p,t,k,a)},r)},timeout:l.timeout,error:l.error}))}},r)},timeout:l.timeout,error:l.error});a.setAbort(function(){H&&(B.cancel(H),H=void 0)})},r)}function n(a,c,f,m,x,t){h(l,function(){if(m&&!f||f&&!f.isBoundTo(c)){var h=b.getMslStore().getUserIdToken(m);f=h&&h.isBoundTo(c)?h:null}x.setAuthTokens(c,f);h=b.getRemoteTime();c.isExpired(h)?g(c,f,m,x,t):x.isRenewable()&&c.equals(a)?g(c,f,m,x,t):d.isRequestingTokens()&&!f?g(c,f,m,x,t):p(c,f)},r)}function p(f,m){h(l,function(){if(a.isAborted())throw new Na("acquireRenewalLock aborted.");
var h=b.getRemoteTime();if(!f||f.isRenewable(h)||!m&&d.getUserId()||m&&m.isRenewable(h)){for(var h=null,l=0;l<this._renewingContexts.length;++l){var g=this._renewingContexts[l];if(g.ctx===b){h=g.queue;break}}if(!h)return this._renewingContexts.push({ctx:b,queue:c}),!0}return!1},r)}var r=this;h(l,function(){var a=f.builder,c=f.tokenTicket,m=a.getMasterToken(),h=a.getUserIdToken(),l=d.getUserId(),n=b.getRemoteTime();d.isEncrypted()&&!a.willEncryptPayloads()||d.isIntegrityProtected()&&!a.willIntegrityProtectPayloads()||
a.isRenewable()||!m&&d.isNonReplayable()||m&&m.isExpired(n)||!(h||!l||a.willEncryptHeader()&&a.willIntegrityProtectHeader())||d.isRequestingTokens()&&(!m||l&&!h)?g(m,h,l,a,c):p(m,h)},r)},releaseRenewalLock:function(a,b,d){for(var c,f,m=0;m<this._renewingContexts.length;++m){var h=this._renewingContexts[m];if(h.ctx===a){c=m;f=h.queue;break}}if(f!==b)throw new C("Attempt to release renewal lock that is not owned by this queue.");d?(d=d.getMessageHeader())?(f=d.keyResponseData)?b.add(f.masterToken):
(a=a.isPeerToPeer()?d.peerMasterToken:d.masterToken)?b.add(a):b.add(O):b.add(O):b.add(O);this._renewingContexts.splice(c,1)}});Cd=M.Class.create({init:function(a,b){var d={_impl:{value:new ia(a,b),writable:!1,enumerable:!1,configurable:!1},_shutdown:{value:!1,writable:!1,enumerable:!1,configurable:!1}};Object.defineProperties(this,d)},setFilterFactory:function(a){this._impl.setFilterFactory(a)},shutdown:function(){this._shutdown=!0},receive:function(a,b,c,f,m,h){if(this._shutdown)throw new v("MslControl is shutdown.");
var l=new I(this._impl,a,b,c,f,m);setTimeout(function(){l.call(h)},0);return d(l)},respond:function(a,b,c,f,m,h,l){if(this._shutdown)throw new v("MslControl is shutdown.");var g=new H(this._impl,a,b,c,f,m,h);setTimeout(function(){g.call(l)},0);return d(g)},error:function(a,b,c,f,m,h,l){if(this._shutdown)throw new v("MslControl is shutdown.");var g=new V(this._impl,a,b,c,f,m,h);setTimeout(function(){g.call(l)},0);return d(g)},request:function(a,b){if(this._shutdown)throw new v("MslControl is shutdown.");
var c,f,m,h,l;if(5==arguments.length){if(c=arguments[2],m=f=null,h=arguments[3],l=arguments[4],a.isPeerToPeer()){l.error(new C("This method cannot be used in peer-to-peer mode."));return}}else if(6==arguments.length&&(c=null,f=arguments[2],m=arguments[3],h=arguments[4],l=arguments[5],!a.isPeerToPeer())){l.error(new C("This method cannot be used in trusted network mode."));return}var g=new B(this._impl,a,b,c,f,m,null,0,h);setTimeout(function(){g.call(l)},0);return d(g)}});I=M.Class.create({init:function(a,
b,d,c,f,m){Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:d,writable:!1,enumerable:!1,configurable:!1},_input:{value:c,writable:!1,enumerable:!1,configurable:!1},_output:{value:f,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:m,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_abortFunc:{value:void 0,writable:!0,enumerable:!1,
configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},call:function(b){function d(f){h(b,function(){var d=f.getMessageHeader();if(!d)return f;this.setAbort(function(){f.abort()});f.isHandshake(this._timeout,{result:function(a){h(b,function(){if(void 0===a)return null;if(!a)return f;c(f)},m)},timeout:b.timeout,error:function(c){h(b,function(){if(p(c))return null;var l=f.getIdentity(),
g=d.messageId,n=a.INTERNAL_EXCEPTION,r=new C("Error peeking into the message payloads.");G(this,this._ctrl,this._ctx,this._msgCtx.getDebugContext(),l,g,n,null,this._output,this._timeout,{result:function(a){b.error(r)},timeout:function(){b.timeout()},error:function(a){h(b,function(){if(p(a))return null;throw new Aa("Error peeking into the message payloads.",a,c);},m)}})},m)}})},m)}function c(d){h(b,function(){d.close();this._ctrl.buildResponse(this,this._ctx,this._msgCtx,d.getMessageHeader(),this._timeout,
{result:function(a){h(b,function(){var c=a.builder,m=a.tokenTicket,l=new T(this._msgCtx);if(this._ctx.isPeerToPeer()){var g=new B(this._ctrl,this._ctx,l,null,this._input,this._output,a,1,this._timeout);this.setAbort(function(){g.abort()});g.call({result:function(a){h(b,function(){return a?a.input:null})},timeout:b.timeout,error:b.error})}else f(d,c,l,m)},m)},timeout:b.timeout,error:function(c){h(b,function(){if(p(c))return null;var f=d.getIdentity(),l,g,n,r;c instanceof v?(l=c.messageId,g=c.error,
n=d.getMessageHeader().messageCapabilities,n=this._ctrl.messageRegistry.getUserMessage(g,n?n.languages:null),r=c):(l=d.messageHeader.messageId,g=a.INTERNAL_EXCEPTION,n=null,r=new C("Error creating an automatic handshake response.",c));G(this,this._ctrl,this._ctx,this._msgCtx.getDebugContext(),f,l,g,n,this._output,this._timeout,{result:function(a){b.error(r)},timeout:function(){b.timeout()},error:function(a){h(b,function(){if(p(a))return null;throw new Aa("Error creating an automatic handshake response.",
a,c);},m)}})},m)}})},m)}function f(d,c,l,g){h(b,function(){c.setRenewable(!1);this._ctrl.send(this._ctx,l,this._output,c,!1,this._timeout,{result:function(a){h(b,function(){this._ctx.isPeerToPeer()&&this._ctrl.releaseMasterToken(this._ctx,g);return null},m)},timeout:function(){h(b,function(){this._ctx.isPeerToPeer()&&this._ctrl.releaseMasterToken(this._ctx,g);b.timeout()},m)},error:function(c){h(b,function(){this._ctx.isPeerToPeer()&&this._ctrl.releaseMasterToken(this._ctx,g);if(p(c))return null;
var f=d.getIdentity(),l,n,r,t;c instanceof v?(l=c.messageId,n=c.error,r=d.getMessageHeader().messageCapabilities,r=this._ctrl.messageRegistry.getUserMessage(n,r?r.languages:null),t=c):c instanceof ua?(l=d.getMessageHeader().messageId,n=a.MSL_COMMS_FAILURE,r=null,t=c):(l=d.getMessageHeader().messageId,n=a.INTERNAL_EXCEPTION,r=null,t=new C("Error sending an automatic handshake response.",c));G(this,this._ctrl,this._ctx,this._msgCtx.getDebugContext(),f,l,n,r,this._output,this._timeout,{result:function(a){b.error(t)},
timeout:function(){b.timeout()},error:function(a){h(b,function(){if(p(a))return null;throw new Aa("Error sending an automatic handshake response.",a,c);},m)}})},m)}})},m)}var m=this;h(b,function(){this._ctrl.receive(this,this._ctx,this._msgCtx,this._input,null,this._timeout,{result:function(a){d(a)},timeout:function(){b.timeout()},error:function(d){h(b,function(){if(p(d))return null;var c,f,l,g,n;d instanceof v?(c=d.masterToken,f=d.entityAuthenticationData,c=c?c.identity:f?f.getIdentity():null,f=
d.messageId,l=d.error,g=this._ctrl.messageRegistry.getUserMessage(l,null),n=d):(f=c=null,l=a.INTERNAL_EXCEPTION,g=null,n=new C("Error receiving the message header.",d));G(this,this._ctrl,this._ctx,this._msgCtx.getDebugContext(),c,f,l,g,this._output,this._timeout,{result:function(a){b.error(n)},timeout:function(){b.timeout()},error:function(a){h(b,function(){if(p(a))return null;throw new Aa("Error receiving the message header.",a,d);},m)}})},m)}})},m)}});H=M.Class.create({init:function(a,b,d,c,f,m,
h){Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:d,writable:!1,enumerable:!1,configurable:!1},_input:{value:c,writable:!1,enumerable:!1,configurable:!1},_output:{value:f,writable:!1,enumerable:!1,configurable:!1},_request:{value:m,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:h,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},
_abortFunc:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},trustedNetworkExecute:function(b,d,c){var f=this;h(c,function(){try{var m=b.builder,l=b.tokenTicket;if(d+1>Oa)return this._ctrl.releaseMasterToken(this._ctx,l),null;var g;if(g=this._msgCtx.isIntegrityProtected()&&!m.willIntegrityProtectHeader()?a.RESPONSE_REQUIRES_INTEGRITY_PROTECTION:
this._msgCtx.isEncrypted()&&!m.willEncryptPayloads()?a.RESPONSE_REQUIRES_ENCRYPTION:null){var n=k(this._request),r=Kb(m.getMessageId());G(this,this._ctrl,this._ctx,this._msgCtx.getDebugContext(),n,r,g,null,this._output,this._timeout,{result:function(a){c.result(null)},timeout:c.timeout,error:function(a){h(c,function(){if(p(a))return null;throw new Aa("Response requires encryption or integrity protection but cannot be protected: "+g,a,null);},f)}});this._ctrl.releaseMasterToken(this._ctx,l)}else!this._msgCtx.getUser()||
m.getMasterToken()||m.getKeyExchangeData()?(m.setRenewable(!1),this._ctrl.send(this._ctx,this._msgCtx,this._output,m,!1,this._timeout,{result:function(a){h(c,function(){this._ctrl.releaseMasterToken(this._ctx,l);return new w(this._request,a.request)},f)},timeout:function(){h(c,function(){this._ctrl.releaseMasterToken(this._ctx,l);c.timeout()},f)},error:function(a){h(c,function(){this._ctrl.releaseMasterToken(this._ctx,l);c.error(a)},f)}})):(n=k(this._request),r=Kb(m.getMessageId()),G(this,this._ctrl,
this._ctx,this._msgCtx.getDebugContext(),n,r,a.RESPONSE_REQUIRES_MASTERTOKEN,null,this._output,this._timeout,{result:function(a){c.result(null)},timeout:c.timeout,error:function(a){h(c,function(){if(p(a))return null;throw new Aa("Response wishes to attach a user ID token but there is no master token.",a,null);},f)}}),this._ctrl.releaseMasterToken(this._ctx,l))}catch(t){throw this._ctrl.releaseMasterToken(this._ctx,l),t;}},f)},peerToPeerExecute:function(b,d,c,f){function m(a){h(f,function(){a.response.close(this._timeout,
{result:function(b){h(f,function(){if(!b)return null;l(a)},g)},timeout:function(){l(a)},error:function(b){h(f,function(){if(p(b))return null;l(a)},g)}})},g)}function l(a){h(f,function(){var d=a.response.getErrorHeader();this._ctrl.buildErrorResponse(this,this._ctx,b,a,d,{result:function(a){h(f,function(){if(!a)return null;var b=a.errorResult;this.peerToPeerExecute(b.msgCtx,{builder:b.builder,tokenTicket:a.tokenTicket},c,f)},g)}})},g)}var g=this;h(f,function(){var l=d.builder,n=d.tokenTicket;if(c+
2>Oa)return this._ctrl.releaseMasterToken(this._ctx,n),null;null!=b.getUser()&&null==l.getPeerMasterToken()&&null==l.getKeyExchangeData()?(this._ctrl.releaseMasterToken(this._ctx,n),n=k(this._request),l=Kb(l.getMessageId()),G(this,this._ctrl,this._ctx,b.getDebugContext(),n,l,a.RESPONSE_REQUIRES_MASTERTOKEN,null,this._output,this._timeout,{result:function(a){f.result(null)},timeout:f.timeout,error:function(a){h(f,function(){if(p(a))return null;throw new Aa("Response wishes to attach a user ID token but there is no master token.",
a,null);},g)}})):this._ctrl.sendReceive(this._ctx,b,this._input,this._output,d,!1,!1,this._timeout,{result:function(a){h(f,function(){function d(){n.close(g._timeout,{result:function(a){h(f,function(){if(!a)return null;l()},g)},timeout:function(){l()},error:function(a){h(f,function(){if(p(a))return null;l()},g)}})}function l(){h(f,function(){var a=new u(null,b);this._ctrl.buildResponse(this,this._ctx,a,r,this._timeout,{result:function(b){h(f,function(){this.peerToPeerExecute(a,b,c,f)},g)},timeout:f.timeout,
error:f.error})},g)}var n=a.response;c+=2;if(!n)return new w(this._request,a.request);var r=n.getMessageHeader();if(r)if(a.handshake)d();else return new w(a.response,a.request);else m(a)},g)},timeout:f.timeout,error:f.error})},g)},call:function(b){var d=this;h(b,function(){var c=this._request.getMessageHeader();this._ctrl.buildResponse(this,this._ctx,this._msgCtx,c,this._timeout,{result:function(f){h(b,function(){var m=f.builder;this._ctx.isPeerToPeer()?this.peerToPeerExecute(this._msgCtx,f,3,{result:function(a){h(b,
function(){a&&a.output.stopCaching();return a},d)},timeout:b.timeout,error:function(c){h(b,function(){if(p(c))return null;var f=k(this._request),l=Kb(m.getMessageId()),g,n,r;c instanceof v?(g=c.error,n=this._request.messageCapabilities,n=this._ctrl.messageRegistry.getUserMessage(g,n?n.languages:null),r=c):c instanceof ua?(g=a.MSL_COMMS_FAILURE,n=null,r=c):(g=a.INTERNAL_EXCEPTION,n=null,r=new C("Error sending the response.",c));G(this,this._ctrl,this._ctx,this._msgCtx.getDebugContext(),f,l,g,n,this._output,
this._timeout,{result:function(a){b.error(r)},timeout:function(){b.timeout()},error:function(a){h(b,function(){if(p(a))return!1;throw new Aa("Error sending the response.",a,null);},d)}})},d)}}):this.trustedNetworkExecute(f,3,{result:function(a){h(b,function(){a&&a.output.stopCaching();return a},d)},timeout:b.timeout,error:function(f){h(b,function(){if(p(f))return null;var l=k(this._request),g=Kb(m.getMessageId()),n,r,t;f instanceof v?(n=f.error,r=c.messageCapabilities,r=this._ctrl.messageRegistry.getUserMessage(n,
r?r.languages:null),t=f):f instanceof ua?(n=a.MSL_COMMS_FAILURE,r=null,t=f):(n=a.INTERNAL_EXCEPTION,r=null,t=new C("Error sending the response.",f));G(this,this._ctrl,this._ctx,this._msgCtx.getDebugContext(),l,g,n,r,this._output,this._timeout,{result:function(a){b.error(t)},timeout:function(){b.timeout()},error:function(a){h(b,function(){if(p(a))return null;throw new Aa("Error sending the response.",a,null);},d)}})},d)}})},d)},timeout:b.timeout,error:function(f){h(b,function(){if(p(f))return null;
var m=k(this._request),l,g,n,r;f instanceof v?(l=f.messageId,g=f.error,n=c.messageCapabilities,n=this._ctrl.messageRegistry.getUserMessage(g,n?n.languages:null),r=f):(l=null,g=a.INTERNAL_EXCEPTION,n=null,r=new C("Error building the response.",f));G(this,this._ctrl,this._ctx,this._msgCtx.getDebugContext(),m,l,g,n,this._output,this._timeout,{result:function(a){b.error(r)},timeout:b.timeout,error:function(a){h(b,function(){if(p(a))return null;throw new Aa("Error building the response.",a,f);},d)}})},
d)}})},d)}});V=M.Class.create({init:function(a,b,d,c,f,m,l){Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:d,writable:!1,enumerable:!1,configurable:!1},_appError:{value:c,writable:!1,enumerable:!1,configurable:!1},_output:{value:f,writable:!1,enumerable:!1,configurable:!1},_request:{value:m,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:l,writable:!1,enumerable:!1,configurable:!1},
_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_abortFunc:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},call:function(b){var d=this;h(b,function(){var c;if("ENTITY_REJECTED"==this._appError)c=this._request.masterToken?a.MASTERTOKEN_REJECTED_BY_APP:a.ENTITY_REJECTED_BY_APP;else if("USER_REJECTED"==this._appError)c=
this._request.userIdToken?a.USERIDTOKEN_REJECTED_BY_APP:a.USER_REJECTED_BY_APP;else throw new C("Unhandled application error "+this._appError+".");var f=this._request.messageCapabilities,f=this._ctrl.messageRegistry.getUserMessage(c,f?f.languages:null);G(this,this._ctrl,this._ctx,this._msgCtx.getDebugContext(),this._request.messageId,c,f,this._output,this._timeout,{result:function(a){b.result(a)},timeout:b.timeout,error:function(a){h(b,function(){if(p(a))return!1;a instanceof v&&b.error(a);throw new C("Error building the error response.",
a);},d)}})},d)}});var ba={result:function(){},timeout:function(){},error:function(){}};B=M.Class.create({init:function(a,b,d,c,f,m,l,h,g){var n;l?(n=l.builder,l=l.tokenTicket):l=n=null;Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:d,writable:!1,enumerable:!1,configurable:!1},_remoteEntity:{value:c,writable:!1,enumerable:!1,configurable:!1},_input:{value:f,writable:!0,enumerable:!1,configurable:!1},
_output:{value:m,writable:!0,enumerable:!1,configurable:!1},_openedStreams:{value:!1,writable:!0,enumerable:!1,configurable:!1},_builder:{value:n,writable:!0,enumerable:!1,configurable:!1},_tokenTicket:{value:l,writable:!0,enumerable:!1,configurable:!1},_timeout:{value:g,writable:!1,enumerable:!1,configurable:!1},_msgCount:{value:h,writable:!1,enumerable:!1,configurable:!1},_maxMessagesHit:{value:!1,writable:!0,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},
_abortFunc:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},execute:function(a,b,d,c,f){function m(a,b){a.request.close(t._timeout,{result:function(a){b.call(t,a)},timeout:function(){b.call(t,!0)},error:function(a){p(a)&&b.call(t,!1);b.call(t,!0)}})}function l(a,b){m(a,function(d){d?a.response.close(t._timeout,{result:function(a){b.call(t,
a)},timeout:function(){b.call(t,!0)},error:function(a){p(a)&&b.call(t,!1);b.call(t,!0)}}):b.call(t,!1)})}function g(a){h(f,function(){l(a,function(b){b?n(a):f.result(null)})},t)}function n(b){function m(a,b){h(f,function(){return this._maxMessagesHit||b&&!b.input?new w(a.response,null):b},t)}h(f,function(){var l=b.response,g=l.getErrorHeader();this._ctrl.buildErrorResponse(this,this._ctx,a,b,g,d,{result:function(a){h(f,function(){if(!a)return new w(l,null);var d=a.errorResult,g=a.tokenTicket,n={builder:d.builder,
tokenTicket:g},d=d.msgCtx;if(this._ctx.isPeerToPeer())this.execute(d,n,this._timeout,c,{result:function(a){h(f,function(){this._ctrl.releaseMasterToken(this._ctx,g);m(b,a)},t)},timeout:function(){h(f,function(){this._ctrl.releaseMasterToken(this._ctx,g);f.timeout()},t)},error:function(a){h(f,function(){this._ctrl.releaseMasterToken(this._ctx,g);f.error(a)},t)}});else{var r=new B(this._ctrl,this._ctx,d,this._remoteEntity,null,null,n,c,this._timeout);this.setAbort(function(){r.abort()});r.call({result:function(a){h(f,
function(){this._maxMessagesHit=r._maxMessagesHit;m(b,a)},t)},timeout:f.timeout,error:f.error})}},t)},timeout:function(){f.timeout()},error:function(a){f.error(a)}})},t)}function r(b){h(f,function(){var g=b.request,n=b.response,r=n.getMessageHeader();if(this._ctx.isPeerToPeer())if(b.handshake)l(b,function(b){h(f,function(){if(!b)return null;var m=new u(null,a);this._ctrl.buildResponse(this,this._ctx,a,r,d,{result:function(a){this.execute(m,a,this._timeout,c,f)},timeout:f.timeout,error:f.error})},
t)});else if(0<r.keyRequestData.length||r.isRenewable()&&r.masterToken&&r.userAuthenticationData){var p=new T(a);this._ctrl.buildResponse(this,this._ctx,p,r,d,{result:function(a){h(f,function(){var d=a.builder,g=a.tokenTicket;n.isHandshake(this._timeout,{result:function(a){h(f,function(){a?l(b,function(a){h(f,function(){if(!a)return this._ctrl.releaseMasterToken(this._ctx,g),null;t.execute(p,d,this._timeout,c,{result:function(a){h(f,function(){this._ctrl.releaseMasterToken(this._ctx,g);return a},
t)},timeout:function(){h(f,function(){this._ctrl.releaseMasterToken(this._ctx,g);f.timeout()},t)},error:function(a){h(f,function(){this._ctrl.releaseMasterToken(this._ctx,g);f.error(a)},t)}})},t)}):m(b,function(a){h(f,function(){if(!a)return this._ctrl.releaseMasterToken(this._ctx,g),null;d.setRenewable(!1);this._ctrl.send(this,this._ctx,p,this._output,d,this._timeout,{result:function(a){h(f,function(){this._ctrl.releaseMasterToken(this._ctx,g);return new w(n,a.request)},t)},timeout:f.timeout,error:f.error})},
t)})},t)},timeout:function(){h(f,function(){this._ctrl.releaseMasterToken(this._ctx,g);f.timeout()},t)},error:function(a){h(f,function(){this._ctrl.releaseMasterToken(this._ctx,g);f.error(a)},t)}})},t)},timeout:f.timeout,error:f.error})}else return new w(n,g);else{if(!b.handshake)return new w(n,g);l(b,function(b){h(f,function(){if(!b)return null;var m=new u(null,a);this._ctrl.buildResponse(this,this._ctx,a,r,d,{result:function(a){h(f,function(){var b=new B(this._ctrl,this._ctx,m,this._remoteEntity,
null,null,a,c,this._timeout);this.setAbort(function(){b.abort()});b.call(f)},t)},timeout:f.timeout,error:f.error})},t)})}},t)}var t=this;h(f,function(){if(c+2>Oa)return this._ctrl.releaseMasterToken(this._ctx,b.tokenTicket),this._maxMessagesHit=!0,null;this._ctrl.sendReceive(this,this._ctx,a,this._input,this._output,b,!0,this._openedStreams,d,{result:function(a){h(f,function(){if(!a)return null;var b=a.response;c+=2;b.getMessageHeader()?r(a):g(a)},t)},timeout:function(){f.timeout()},error:function(a){f.error(a)}})},
t)},call:function(a){function b(c,f,m){h(a,function(){this.execute(this._msgCtx,{builder:c,tokenTicket:f},m,this._msgCount,{result:function(b){h(a,function(){b&&b.output&&b.output.stopCaching();return b},d)},timeout:function(){h(a,function(){this._openedStreams&&(this._output.close(m,ba),this._input.close(m,ba));a.timeout()},d)},error:function(b){h(a,function(){this._openedStreams&&(this._output.close(m,ba),this._input.close(m,ba));if(p(b))return null;a.error(b)},d)}})},d)}var d=this;h(a,function(){var c=
this._timeout;if(!this._input||!this._output)try{this._remoteEntity.setTimeout(this._timeout);var f=Date.now(),m=this._remoteEntity.openConnection();this._output=m.output;this._input=m.input;-1!=c&&(c=this._timeout-(Date.now()-f));this._openedStreams=!0}catch(l){this._builder&&this._ctrl.releaseMasterToken(this._ctx,this._tokenTicket);this._output&&this._output.close(this._timeout,ba);this._input&&this._input.close(this._timeout,ba);if(p(l))return null;throw l;}this._builder?b(this._builder,this._tokenTicket,
c):this._ctrl.buildRequest(this,this._ctx,this._msgCtx,this._timeout,{result:function(f){h(a,function(){b(f.builder,f.tokenTicket,c)},d)},timeout:function(){h(a,function(){this._openedStreams&&(this._output.close(this._timeout,ba),this._input.close(this._timeout,ba));a.timeout()},d)},error:function(b){h(a,function(){this._openedStreams&&(this._output.close(this._timeout,ba),this._input.close(this._timeout,ba));if(p(b))return null;a.error(b)},d)}})},d)}})})();Xb.extend({isEncrypted:function(){return!0},
isIntegrityProtected:function(){return!0},isNonReplayable:function(){return!0}});Xb.extend({isEncrypted:function(){return!1},isIntegrityProtected:function(){return!0},isNonReplayable:function(){return!1}});Xb.extend({isEncrypted:function(){return!0},isIntegrityProtected:function(){return!0},isNonReplayable:function(){return!1}});M.Class.create({isMasterTokenRevoked:function(a,b,d){},acceptNonReplayableId:function(a,b,d,c){},createMasterToken:function(a,b,d,c,f,g){},isMasterTokenRenewable:function(a,
b,d){},renewMasterToken:function(a,b,d,c,f,g){},isUserIdTokenRevoked:function(a,b,d,c){},createUserIdToken:function(a,b,d,c){},renewUserIdToken:function(a,b,d,c){},createUser:function(a,b,d){}});var La,rb;(function(){function c(a,b,d,f){this.sessiondata=a;this.tokendata=b;this.signature=d;this.verified=f}La=M.Class.create({init:function(c,f,g,h,p,k,G,w,z,r,W){var v=this;b(W,function(){if(g.getTime()<f.getTime())throw new C("Cannot construct a master token that expires before its renewal window opens.");
if(0>h||h>L)throw new C("Sequence number "+h+" is outside the valid range.");if(0>p||p>L)throw new C("Serial number "+p+" is outside the valid range.");var T=Math.floor(f.getTime()/1E3),O=Math.floor(g.getTime()/1E3),I;if(r)I=r.sessiondata;else{var H=D(w.toByteArray()),V=cb(w.algorithm),B=D(z.toByteArray()),ia=Ua(z.algorithm);if(!V||!ia)throw new d(a.UNIDENTIFIED_ALGORITHM,"encryption algorithm: "+w.algorithm+"; signature algorithm: "+z.algorithm);var ba={};k&&(ba.issuerdata=k);ba.identity=G;ba.encryptionkey=
H;ba.encryptionalgorithm=V;ba.hmackey=B;ba.signaturekey=B;ba.signaturealgorithm=ia;I=na(JSON.stringify(ba),Y)}if(r)return Object.defineProperties(this,{ctx:{value:c,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:T,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:O,writable:!1,enumerable:!1,configurable:!1},sequenceNumber:{value:h,writable:!1,configurable:!1},serialNumber:{value:p,writable:!1,configurable:!1},issuerData:{value:k,writable:!1,configurable:!1},
identity:{value:G,writable:!1,configurable:!1},encryptionKey:{value:w,writable:!1,configurable:!1},signatureKey:{value:z,writable:!1,configurable:!1},sessiondata:{value:I,writable:!1,enumerable:!1,configurable:!1},verified:{value:r.verified,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:r.tokendata,writable:!1,enumerable:!1,configurable:!1},signature:{value:r.signature,writable:!1,enumerable:!1,configurable:!1}}),this;var u=c.getMslCryptoContext();u.encrypt(I,{result:function(a){b(W,
function(){var d={};d.renewalwindow=T;d.expiration=O;d.sequencenumber=h;d.serialnumber=p;d.sessiondata=D(a);var f=na(JSON.stringify(d),Y);u.sign(f,{result:function(a){b(W,function(){Object.defineProperties(this,{ctx:{value:c,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:T,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:O,writable:!1,enumerable:!1,configurable:!1},sequenceNumber:{value:h,writable:!1,enumerable:!1,configurable:!1},serialNumber:{value:p,writable:!1,
enumerable:!1,configurable:!1},issuerData:{value:k,writable:!1,configurable:!1},identity:{value:G,writable:!1,configurable:!1},encryptionKey:{value:w,writable:!1,configurable:!1},signatureKey:{value:z,writable:!1,configurable:!1},sessiondata:{value:I,writable:!1,enumerable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:f,writable:!1,enumerable:!1,configurable:!1},signature:{value:a,writable:!1,enumerable:!1,configurable:!1}});return this},v)},error:function(a){W.error(a)}})},
v)},error:function(a){W.error(a)}})},this)},get renewalWindow(){return new Date(1E3*this.renewalWindowSeconds)},get expiration(){return new Date(1E3*this.expirationSeconds)},isDecrypted:function(){return this.sessiondata?!0:!1},isVerified:function(){return this.verified},isRenewable:function(a){return a?this.renewalWindow.getTime()<=a.getTime():this.isVerified()?this.renewalWindow.getTime()<=this.ctx.getTime():!0},isExpired:function(a){return a?this.expiration.getTime()<=a.getTime():this.isVerified()?
this.expiration.getTime()<=this.ctx.getTime():!1},isNewerThan:function(a){if(this.sequenceNumber==a.sequenceNumber)return this.expiration>a.expiration;if(this.sequenceNumber>a.sequenceNumber){var b=this.sequenceNumber-L+127;return a.sequenceNumber>=b}b=a.sequenceNumber-L+127;return this.sequenceNumber<b},toJSON:function(){var a={};a.tokendata=D(this.tokendata);a.signature=D(this.signature);return a},equals:function(a){return this===a?!0:a instanceof La?this.serialNumber==a.serialNumber&&this.sequenceNumber==
a.sequenceNumber&&this.expiration.getTime()==a.expiration.getTime():!1},uniqueKey:function(){return this.serialNumber+":"+this.sequenceNumber+":"+this.expiration.getTime()}});rb=function(g,m,h){b(h,function(){var t=g.getMslCryptoContext(),p=m.tokendata,k=m.signature;if("string"!==typeof p||"string"!==typeof k)throw new f(a.JSON_PARSE_ERROR,"mastertoken "+JSON.stringify(m));var G,w;try{G=P(p)}catch(z){throw new v(a.MASTERTOKEN_TOKENDATA_INVALID,"mastertoken "+JSON.stringify(m),z);}if(!G||0==G.length)throw new f(a.MASTERTOKEN_TOKENDATA_MISSING,
"mastertoken "+JSON.stringify(m));try{w=P(k)}catch(z){throw new v(a.MASTERTOKEN_SIGNATURE_INVALID,"mastertoken "+JSON.stringify(m),z);}t.verify(G,w,{result:function(m){b(h,function(){var r,p,k,S,O,I=pa(G,Y);try{var H=JSON.parse(I);r=parseInt(H.renewalwindow);p=parseInt(H.expiration);k=parseInt(H.sequencenumber);S=parseInt(H.serialnumber);O=H.sessiondata}catch(ba){if(ba instanceof SyntaxError)throw new f(a.MASTERTOKEN_TOKENDATA_PARSE_ERROR,"mastertokendata "+I,ba);throw ba;}if(!r||r!=r||!p||p!=p||
"number"!==typeof k||k!=k||"number"!==typeof S||S!=S||"string"!==typeof O)throw new f(a.MASTERTOKEN_TOKENDATA_PARSE_ERROR,"mastertokendata "+I);if(p<r)throw new v(a.MASTERTOKEN_EXPIRES_BEFORE_RENEWAL,"mastertokendata "+I);if(0>k||k>L)throw new v(a.MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_RANGE,"mastertokendata "+I);if(0>S||S>L)throw new v(a.MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"mastertokendata "+I);var V=new Date(1E3*r),B=new Date(1E3*p),ia;try{ia=P(O)}catch(ba){throw new v(a.MASTERTOKEN_SESSIONDATA_INVALID,
O,ba);}if(!ia||0==ia.length)throw new v(a.MASTERTOKEN_SESSIONDATA_MISSING,O);m?t.decrypt(ia,{result:function(r){b(h,function(){var p,t,I,H,W,ia,v=pa(r,Y);try{var O=JSON.parse(v);p=O.issuerdata;t=O.identity;I=O.encryptionkey;W=O.encryptionalgorithm;H=O.signaturekey;"string"!==typeof H&&(H=O.hmackey);ia=O.signaturealgorithm}catch(u){if(u instanceof SyntaxError)throw new f(a.MASTERTOKEN_SESSIONDATA_PARSE_ERROR,"sessiondata "+v,u);throw u;}if(p&&"object"!==typeof p||!t||"string"!==typeof I||W&&"string"!==
typeof W||"string"!==typeof H||ia&&"string"!==typeof ia)throw new f(a.MASTERTOKEN_SESSIONDATA_PARSE_ERROR,"sessiondata "+v);W||(W=ka.AES);ia||(ia=db.HmacSHA256);var v=va(W),x=wb(ia);if(!v||!x)throw new d(a.UNIDENTIFIED_ALGORITHM,"encryption algorithm: "+W+"; signature algorithm: "+ia);eb(I,v,ob,{result:function(f){eb(H,x,pb,{result:function(a){b(h,function(){var b=new c(r,G,w,m);new La(g,V,B,k,S,p,t,f,a,b,h)})},error:function(b){h.error(new d(a.MASTERTOKEN_KEY_CREATION_ERROR,b))}})},error:function(b){h.error(new d(a.MASTERTOKEN_KEY_CREATION_ERROR,
b))}})})},error:function(a){h.error(a)}}):(r=new c(null,G,w,m),new La(g,V,B,k,S,null,null,null,null,r,h))})},error:function(a){h.error(a)}})})}})();var Yb,sb;(function(){function d(a,b,c){this.tokendata=a;this.signature=b;this.verified=c}Yb=M.Class.create({init:function(a,d,c,f,g,h,k,w,z){var r=this;b(z,function(){if(c.getTime()<d.getTime())throw new C("Cannot construct a user ID token that expires before its renewal window opens.");if(!f)throw new C("Cannot construct a user ID token without a master token.");
if(0>g||g>L)throw new C("Serial number "+g+" is outside the valid range.");var W=Math.floor(d.getTime()/1E3),u=Math.floor(c.getTime()/1E3),T=f.serialNumber;if(w){var O=w.tokendata,I=w.signature,H=w.verified,T=f.serialNumber;Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:W,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:u,writable:!1,enumerable:!1,configurable:!1},mtSerialNumber:{value:T,writable:!1,configurable:!1},
serialNumber:{value:g,writable:!1,configurable:!1},issuerData:{value:h,writable:!1,configurable:!1},user:{value:k,writable:!1,configurable:!1},verified:{value:H,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:O,writable:!1,enumerable:!1,configurable:!1},signature:{value:I,writable:!1,enumerable:!1,configurable:!1}});return this}O={};h&&(O.issuerdata=h);O.identity=k.getEncoded();var O=na(JSON.stringify(O),Y),V=a.getMslCryptoContext();V.encrypt(O,{result:function(d){b(z,function(){var c=
{};c.renewalwindow=W;c.expiration=u;c.mtserialnumber=T;c.serialnumber=g;c.userdata=D(d);var m=na(JSON.stringify(c),Y);V.sign(m,{result:function(d){b(z,function(){Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:W,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:u,writable:!1,enumerable:!1,configurable:!1},mtSerialNumber:{value:f.serialNumber,writable:!1,configurable:!1},serialNumber:{value:g,writable:!1,configurable:!1},
issuerData:{value:h,writable:!1,configurable:!1},user:{value:k,writable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:m,writable:!1,enumerable:!1,configurable:!1},signature:{value:d,writable:!1,enumerable:!1,configurable:!1}});return this},r)},error:function(a){b(z,function(){a instanceof v&&a.setMasterToken(f);throw a;},r)}})},r)},error:function(a){b(z,function(){a instanceof v&&a.setMasterToken(f);throw a;},r)}})},this)},get renewalWindow(){return new Date(1E3*
this.renewalWindowSeconds)},get expiration(){return new Date(1E3*this.expirationSeconds)},isVerified:function(){return this.verified},isDecrypted:function(){return this.user?!0:!1},isRenewable:function(a){return a?this.renewalWindow.getTime()<=a.getTime():this.isVerified()?this.renewalWindow.getTime()<=this.ctx.getTime():!0},isExpired:function(a){return a?this.expiration.getTime()<=a.getTime():this.isVerified()?this.expiration.getTime()<=this.ctx.getTime():!1},isBoundTo:function(a){return a&&a.serialNumber==
this.mtSerialNumber},toJSON:function(){var a={};a.tokendata=D(this.tokendata);a.signature=D(this.signature);return a},equals:function(a){return this===a?!0:a instanceof Yb?this.serialNumber==a.serialNumber&&this.mtSerialNumber==a.mtSerialNumber:!1},uniqueKey:function(){return this.serialNumber+":"+this.mtSerialNumber}});sb=function(c,m,g,h){b(h,function(){var p=c.getMslCryptoContext(),k=m.tokendata,G=m.signature;if("string"!==typeof k||"string"!==typeof G)throw(new f(a.JSON_PARSE_ERROR,"useridtoken "+
JSON.stringify(m))).setMasterToken(g);var w,z;try{w=P(k)}catch(r){throw(new v(a.USERIDTOKEN_TOKENDATA_INVALID,"useridtoken "+JSON.stringify(m),r)).setMasterToken(g);}if(!w||0==w.length)throw(new f(a.USERIDTOKEN_TOKENDATA_MISSING,"useridtoken "+JSON.stringify(m))).setMasterToken(g);try{z=P(G)}catch(r){throw(new v(a.USERIDTOKEN_TOKENDATA_INVALID,"useridtoken "+JSON.stringify(m),r)).setMasterToken(g);}p.verify(w,z,{result:function(m){b(h,function(){var k,G,S,O,I,H=pa(w,Y);try{var V=JSON.parse(H);k=parseInt(V.renewalwindow);
G=parseInt(V.expiration);S=parseInt(V.mtserialnumber);O=parseInt(V.serialnumber);I=V.userdata}catch(u){if(u instanceof SyntaxError)throw(new f(a.USERIDTOKEN_TOKENDATA_PARSE_ERROR,"usertokendata "+H,u)).setMasterToken(g);throw u;}if(!k||k!=k||!G||G!=G||"number"!==typeof S||S!=S||"number"!==typeof O||O!=O||"string"!==typeof I)throw(new f(a.USERIDTOKEN_TOKENDATA_PARSE_ERROR,"usertokendata "+H)).setMasterToken(g);if(G<k)throw(new v(a.USERIDTOKEN_EXPIRES_BEFORE_RENEWAL,"mastertokendata "+H)).setMasterToken(g);
if(0>S||S>L)throw(new v(a.USERIDTOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"usertokendata "+H)).setMasterToken(g);if(0>O||O>L)throw(new v(a.USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"usertokendata "+H)).setMasterToken(g);var B=new Date(1E3*k),ia=new Date(1E3*G);if(!g||S!=g.serialNumber)throw(new v(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit mtserialnumber "+S+"; mt "+JSON.stringify(g))).setMasterToken(g);var ba;try{ba=P(I)}catch(u){throw(new v(a.USERIDTOKEN_USERDATA_INVALID,I,u)).setMasterToken(g);}if(!ba||
0==ba.length)throw(new v(a.USERIDTOKEN_USERDATA_MISSING,I)).setMasterToken(g);m?p.decrypt(ba,{result:function(p){b(h,function(){var k,I,H=pa(p,Y);try{var V=JSON.parse(H);k=V.issuerdata;I=V.identity}catch(G){if(G instanceof SyntaxError)throw(new f(a.USERIDTOKEN_USERDATA_PARSE_ERROR,"userdata "+H)).setMasterToken(g);throw G;}if(k&&"object"!==typeof k||"string"!==typeof I)throw(new f(a.USERIDTOKEN_USERDATA_PARSE_ERROR,"userdata "+H)).setMasterToken(g);if(!I||0==I.length)throw(new v(a.USERIDTOKEN_IDENTITY_INVALID,
"userdata "+H)).setMasterToken(g);c.getTokenFactory().createUser(c,I,{result:function(a){b(h,function(){if(!a)throw new C("TokenFactory.createUser() returned null in violation of the interface contract.");var b=new d(w,z,m);new Yb(c,B,ia,g,O,k,a,b,h)})},error:function(a){b(h,function(){a instanceof v&&a.setMasterToken(g);throw a;})}})})},error:function(a){b(h,function(){a instanceof v&&a.setMasterToken(g);throw a;})}}):(k=new d(w,z,m),new Yb(c,B,ia,g,O,null,null,k,h))})},error:function(a){b(h,function(){a instanceof
v&&a.setMasterToken(g);throw a;})}})})}})();var Db,mb,kc;(function(){function d(b,c){var g=b.tokendata;if("string"!==typeof g)throw new f(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(b));var h;try{h=P(g)}catch(l){throw new v(a.SERVICETOKEN_TOKENDATA_INVALID,"servicetoken "+JSON.stringify(b),l);}if(!h||0==h.length)throw new f(a.SERVICETOKEN_TOKENDATA_MISSING,"servicetoken "+JSON.stringify(b));var k;try{k=JSON.parse(pa(h,Y)).name}catch(l){if(l instanceof SyntaxError)throw new f(a.JSON_PARSE_ERROR,
"servicetoken "+JSON.stringify(b),l);throw l;}if(!k)throw new f(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(b));return c[k]?c[k]:c[""]}function c(a,b,d){this.tokendata=a;this.signature=b;this.verified=d}Db=M.Class.create({init:function(a,d,c,f,g,h,l,k,r,W){var u=this;b(W,function(){if(f&&g&&!g.isBoundTo(f))throw new C("Cannot construct a service token bound to a master token and user ID token where the user ID token is not bound to the same master token.");var T=f?f.serialNumber:-1,O=g?g.serialNumber:
-1;if(r)return V=r.tokendata,Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},name:{value:d,writable:!1,configurable:!1},mtSerialNumber:{value:T,writable:!1,configurable:!1},uitSerialNumber:{value:O,writable:!1,configurable:!1},data:{value:c,writable:!1,configurable:!1},encrypted:{value:h,writable:!1,enumerable:!1,configurable:!1},compressionAlgo:{value:l,writable:!1,configurable:!1},verified:{value:r.verified,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:V,
writable:!1,enumerable:!1,configurable:!1},signature:{value:r.signature,writable:!1,enumerable:!1,configurable:!1}}),this;var I;l?(I=Dc(l,c),I.length<c.length||(l=null,I=c)):(l=null,I=c);var H={};H.name=d;-1!=T&&(H.mtserialnumber=T);-1!=O&&(H.uitserialnumber=O);H.encrypted=h;l&&(H.compressionalgo=l);if(h&&0<I.length)k.encrypt(I,{result:function(r){b(W,function(){H.servicedata=D(r);var I=na(JSON.stringify(H),Y);k.sign(I,{result:function(f){b(W,function(){Object.defineProperties(this,{ctx:{value:a,
writable:!1,enumerable:!1,configurable:!1},name:{value:d,writable:!1,configurable:!1},mtSerialNumber:{value:T,writable:!1,configurable:!1},uitSerialNumber:{value:O,writable:!1,configurable:!1},data:{value:c,writable:!1,configurable:!1},encrypted:{value:h,writable:!1,enumerable:!1,configurable:!1},compressionAlgo:{value:l,writable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:I,writable:!1,enumerable:!1,configurable:!1},signature:{value:f,writable:!1,
enumerable:!1,configurable:!1}});return this},u)},error:function(a){b(W,function(){a instanceof v&&(a.setMasterToken(f),a.setUserIdTokenIdToken(g));throw a;})}})},u)},error:function(a){b(W,function(){a instanceof v&&(a.setMasterToken(f),a.setUserIdToken(g));throw a;})}});else{H.servicedata=D(I);var V=na(JSON.stringify(H),Y);k.sign(V,{result:function(f){b(W,function(){Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},name:{value:d,writable:!1,configurable:!1},mtSerialNumber:{value:T,
writable:!1,configurable:!1},uitSerialNumber:{value:O,writable:!1,configurable:!1},data:{value:c,writable:!1,configurable:!1},encrypted:{value:h,writable:!1,enumerable:!1,configurable:!1},compressionAlgo:{value:l,writable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:V,writable:!1,enumerable:!1,configurable:!1},signature:{value:f,writable:!1,enumerable:!1,configurable:!1}});return this},u)},error:function(a){b(W,function(){a instanceof v&&(a.setMasterToken(f),
a.setUserIdToken(g));throw a;})}})}},this)},isEncrypted:function(){return this.encrypted},isVerified:function(){return this.verified},isDecrypted:function(){return this.data?!0:!1},isDeleted:function(){return this.data&&0==this.data.length},isMasterTokenBound:function(){return-1!=this.mtSerialNumber},isBoundTo:function(a){return a?a instanceof La?a.serialNumber==this.mtSerialNumber:a instanceof Yb?a.serialNumber==this.uitSerialNumber:!1:!1},isUserIdTokenBound:function(){return-1!=this.uitSerialNumber},
isUnbound:function(){return-1==this.mtSerialNumber&&-1==this.uitSerialNumber},toJSON:function(){var a={};a.tokendata=D(this.tokendata);a.signature=D(this.signature);return a},equals:function(a){return this===a?!0:a instanceof Db?this.name==a.name&&this.mtSerialNumber==a.mtSerialNumber&&this.uitSerialNumber==a.uitSerialNumber:!1},uniqueKey:function(){return this.name+":"+this.mtSerialNumber+":"+this.uitSerialNumber}});mb=function(a,b,d,c,f,g,h,l,r){new Db(a,b,d,c,f,g,h,l,null,r)};kc=function(g,h,k,
p,S,G){b(G,function(){!S||S instanceof hb||(S=d(h,S));var w=h.tokendata,z=h.signature;if("string"!==typeof w||"string"!==typeof z)throw(new f(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(h))).setMasterToken(k).setUserIdToken(p);var r,W;try{r=P(w)}catch(u){throw(new v(a.SERVICETOKEN_TOKENDATA_INVALID,"servicetoken "+JSON.stringify(h),u)).setMasterToken(k).setUserIdToken(p);}if(!r||0==r.length)throw(new f(a.SERVICETOKEN_TOKENDATA_MISSING,"servicetoken "+JSON.stringify(h))).setMasterToken(k).setUserIdToken(p);
try{W=P(z)}catch(u){throw(new v(a.SERVICETOKEN_SIGNATURE_INVALID,"servicetoken "+JSON.stringify(h),u)).setMasterToken(k).setUserIdToken(p);}var C,T,O,I,H,V,B=pa(r,Y);try{var ia=JSON.parse(B);C=ia.name;T=ia.mtserialnumber?parseInt(ia.mtserialnumber):-1;O=ia.uitserialnumber?parseInt(ia.uitserialnumber):-1;I=ia.encrypted;H=ia.compressionalgo;V=ia.servicedata}catch(u){if(u instanceof SyntaxError)throw(new f(a.JSON_PARSE_ERROR,"servicetokendata "+B,u)).setMasterToken(k).setUserIdToken(p);throw u;}if(!C||
"number"!==typeof T||T!=T||"number"!==typeof O||O!=O||"boolean"!==typeof I||H&&"string"!==typeof H||"string"!==typeof V)throw(new f(a.JSON_PARSE_ERROR,"servicetokendata "+B)).setMasterToken(k).setUserIdToken(p);if(ia.mtserialnumber&&0>T||T>L)throw(new v(a.SERVICETOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"servicetokendata "+B)).setMasterToken(k).setUserIdToken(p);if(ia.uitserialnumber&&0>O||O>L)throw(new v(a.SERVICETOKEN_USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"servicetokendata "+B)).setMasterToken(k).setUserIdToken(p);
if(-1!=T&&(!k||T!=k.serialNumber))throw(new v(a.SERVICETOKEN_MASTERTOKEN_MISMATCH,"st mtserialnumber "+T+"; mt "+k)).setMasterToken(k).setUserIdToken(p);if(-1!=O&&(!p||O!=p.serialNumber))throw(new v(a.SERVICETOKEN_USERIDTOKEN_MISMATCH,"st uitserialnumber "+O+"; uit "+p)).setMasterToken(k).setUserIdToken(p);I=!0===I;var ba;if(H){if(!Qa[H])throw new v(a.UNIDENTIFIED_COMPRESSION,H);ba=H}else ba=null;S?S.verify(r,W,{result:function(d){b(G,function(){if(d){var f;try{f=P(V)}catch(h){throw(new v(a.SERVICETOKEN_SERVICEDATA_INVALID,
"servicetokendata "+B,h)).setMasterToken(k).setUserIdToken(p);}if(!f||0!=V.length&&0==f.length)throw(new v(a.SERVICETOKEN_SERVICEDATA_INVALID,"servicetokendata "+B)).setMasterToken(k).setUserIdToken(p);if(I&&0<f.length)S.decrypt(f,{result:function(a){b(G,function(){var b=ba?mc(ba,a):a,f=new c(r,W,d);new Db(g,C,b,-1!=T?k:null,-1!=O?p:null,I,ba,S,f,G)})},error:function(a){b(G,function(){a instanceof v&&(a.setMasterToken(k),a.setUserIdToken(p));throw a;})}});else{f=ba?mc(ba,f):f;var n=new c(r,W,d);new Db(g,
C,f,-1!=T?k:null,-1!=O?p:null,I,ba,S,n,G)}}else f=""==V?new Uint8Array(0):null,n=new c(r,W,d),new Db(g,C,f,-1!=T?k:null,-1!=O?p:null,I,ba,S,n,G)})},error:function(a){b(G,function(){a instanceof v&&(a.setMasterToken(k),a.setUserIdToken(p));throw a;})}}):(w=""==V?new Uint8Array(0):null,z=new c(r,W,!1),new Db(g,C,w,-1!=T?k:null,-1!=O?p:null,I,ba,S,z,G))})}})();var nb,Dd;(function(){var a={};nb=function(b){Object.defineProperties(this,{name:{value:b,writable:!1,configurable:!1}});a[b]=this};M.Class.mixin(nb,
{EMAIL_PASSWORD:new nb("EMAIL_PASSWORD"),USER_ID_TOKEN:new nb("USER_ID_TOKEN")});Object.freeze(nb);Dd=function(b){return a[b]?a[b]:null}})();var tb,sd;(function(){tb=M.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},getAuthData:function(){},equals:function(a){return this===a?!0:a instanceof tb?this.scheme==a.scheme:!1},toJSON:function(){var a={};a.scheme=this.scheme.name;a.authdata=this.getAuthData();return a}});sd=function(d,c,g,h){b(h,
function(){var b=g.scheme,k=g.authdata;if("string"!==typeof b||"object"!==typeof k)throw new f(a.JSON_PARSE_ERROR,"userauthdata "+JSON.stringify(g));var u=d.getUserAuthenticationScheme(b);if(!u)throw new da(a.UNIDENTIFIED_USERAUTH_SCHEME,b);b=d.getUserAuthenticationFactory(u);if(!b)throw new da(a.USERAUTH_FACTORY_NOT_FOUND,u.name);b.createData(d,c,k,h)})}})();var Zb=M.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},createData:function(a,
b,d,c){},authenticate:function(a,b,d,c){}}),$b,Ed;(function(){$b=tb.extend({init:function l(a,b){l.base.call(this,nb.EMAIL_PASSWORD);Object.defineProperties(this,{email:{value:a,writable:!1,configurable:!1},password:{value:b,writable:!1,configurable:!1}})},getAuthData:function(){var a={};a.email=this.email;a.password=this.password;return a},equals:function m(a){return this===a?!0:a instanceof $b?m.base.call(this,this,a)&&this.email==a.email&&this.password==a.password:!1}});Ed=function(b){var d=b.email,
c=b.password;if("string"!==typeof d||"string"!==typeof c)throw new f(a.JSON_PARSE_ERROR,"email/password authdata "+JSON.stringify(b));return new $b(d,c)}})();Zb.extend({init:function l(a,b){l.base.call(this,nb.EMAIL_PASSWORD);Object.defineProperties(this,{_store:{value:a,writable:!1,enumerable:!1,configurable:!1},_authutils:{value:b,writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,d,c,f){b(f,function(){return Ed(c)})},authenticate:function(b,d,c,f){if(!(c instanceof $b))throw new C("Incorrect authentication data type "+
c+".");if(!this._authutils.isSchemePermitted(d,this.scheme))throw(new da(a.USERAUTH_ENTITY_INCORRECT_DATA,"Authentication scheme "+this.scheme+" not permitted for entity "+d+".")).setUserAuthenticationData(c);b=c.email;var g=c.password;if(!b||0==b.trim().length||!g||0==g.trim().length)throw(new da(a.EMAILPASSWORD_BLANK)).setUserAuthenticationData(c);b=this._store.isUser(b,g);if(null==b)throw(new da(a.EMAILPASSWORD_INCORRECT)).setUserAuthenticationData(c);if(!this._authutils.isSchemePermitted(d,b,
this.scheme))throw(new da(a.USERAUTH_ENTITYUSER_INCORRECT_DATA,"Authentication scheme "+this.scheme+" not permitted for entity "+d+".")).setUserAuthenticationData(c);if(f&&(d=f.user,!b.equals(d)))throw(new da(a.USERIDTOKEN_USERAUTH_DATA_MISMATCH,"uad user "+b+"; uit user "+d)).setUserAuthenticationData(c);return b}});var Fc;(function(){Fc=tb.extend({init:function m(a,b){m.base.call(this,nb.USER_ID_TOKEN);if(!b.isBoundTo(a))throw new C("User ID token must be bound to master token.");Object.defineProperties(this,
{masterToken:{value:a,writable:!1,configurable:!1},userIdToken:{value:b,writable:!1,configurable:!1}})},getAuthData:function(){var a={};a.mastertoken=JSON.parse(JSON.stringify(this.masterToken));a.useridtoken=JSON.parse(JSON.stringify(this.userIdToken));return a},equals:function n(a){return this===a?!0:a instanceof Fc?n.base.call(this,this,a)&&this.masterToken.equals(a.masterToken)&&this.userIdToken.equals(a.userIdToken):!1}})})();var Me=M.Class.create({isEntityRevoked:function(a){},isSchemePermitted:function(a){}});
Object.freeze({ENTITY_REAUTH:c.ENTITY_REAUTH,ENTITYDATA_REAUTH:c.ENTITYDATA_REAUTH});var Fd;(function(){var a=0;Fd=M.Class.create({init:function(){var b=++a;if(0>=b||!isFinite(b))throw new C("MSL context unique ID has overflowed. Are you sure you are using MSL context's correctly?");Object.defineProperties(this,{_uniqueId:{value:b,writable:!1,enumerable:!1,configurable:!1},_synced:{value:!1,writable:!0,enumerable:!1,configurable:!1},_offset:{value:0,writable:!0,enumerable:!1,configurable:!1}})},getTime:function(){},
getRandom:function(){},isPeerToPeer:function(){},getMessageCapabilities:function(){},getEntityAuthenticationData:function(a,b){},getMslCryptoContext:function(){},getEntityAuthenticationScheme:function(a){},getEntityAuthenticationFactory:function(a){},getUserAuthenticationScheme:function(a){},getUserAuthenticationFactory:function(a){},getTokenFactory:function(){},getKeyExchangeScheme:function(a){},getKeyExchangeFactory:function(a){},getKeyExchangeFactories:function(){},getMslStore:function(){},updateRemoteTime:function(a){var b=
this.getTime()/1E3;this._offset=a.getTime()/1E3-b;this._synced=!0},getRemoteTime:function(){if(!this._synced)return null;var a=this.getTime()/1E3+this._offset;return new Date(1E3*a)},equals:function(a){return this===a?!0:!1},uniqueKey:function(){return this._uniqueId}})})();var Ne=M.Class.create({setCryptoContext:function(a,b){},getMasterToken:function(){},getNonReplayableId:function(a){},getCryptoContext:function(a){},removeCryptoContext:function(a){},clearCryptoContexts:function(){},addUserIdToken:function(a,
b){},getUserIdToken:function(a){},removeUserIdToken:function(a){},clearUserIdTokens:function(){},addServiceTokens:function(a){},getServiceTokens:function(a,b){},removeServiceTokens:function(a,b,d){},clearServiceTokens:function(){}}),Gd;(function(){Gd=Ne.extend({init:function m(){m.base.call(this);Object.defineProperties(this,{masterTokens:{value:{},writable:!1,enumerable:!1,configurable:!1},cryptoContexts:{value:{},writable:!1,enumerable:!1,configurable:!1},userIdTokens:{value:{},writable:!1,enumerable:!1,
configurable:!1},nonReplayableIds:{value:{},writable:!1,enumerable:!1,configurable:!1},unboundServiceTokens:{value:{},writable:!1,enumerable:!1,configurable:!1},mtServiceTokens:{value:{},writable:!1,enumerable:!1,configurable:!1},uitServiceTokens:{value:{},writable:!1,enumerable:!1,configurable:!1}})},setCryptoContext:function(a,b){if(b){var d=a.uniqueKey();this.masterTokens[d]=a;this.cryptoContexts[d]=b}else this.removeCryptoContext(a)},getMasterToken:function(){var a=null,b;for(b in this.masterTokens){var d=
this.masterTokens[b];if(!a||d.isNewerThan(a))a=d}return a},getNonReplayableId:function(a){a=a.serialNumber;var b;b=void 0!==this.nonReplayableIds[a]?this.nonReplayableIds[a]:0;if(0>b||b>L)throw new C("Non-replayable ID "+b+" is outside the valid range.");b=b==L?0:b+1;return this.nonReplayableIds[a]=b},getCryptoContext:function(a){return this.cryptoContexts[a.uniqueKey()]},removeCryptoContext:function(a){var b=a.uniqueKey();if(this.masterTokens[b]){delete this.masterTokens[b];delete this.cryptoContexts[b];
var b=a.serialNumber,d;for(d in this.masterTokens)if(this.masterTokens[d].serialNumber==b)return;delete this.nonReplayableIds[b];Object.keys(this.userIdTokens).forEach(function(b){b=this.userIdTokens[b];b.isBoundTo(a)&&this.removeUserIdToken(b)},this);try{this.removeServiceTokens(null,a,null)}catch(c){if(c instanceof v)throw new C("Unexpected exception while removing master token bound service tokens.",c);throw c;}}},clearCryptoContexts:function(){[this.masterTokens,this.cryptoContexts,this.nonReplayableIds,
this.userIdTokens,this.uitServiceTokens,this.mtServiceTokens].forEach(function(a){for(var b in a)delete a[b]},this)},addUserIdToken:function(b,d){var c=!1,f;for(f in this.masterTokens)if(d.isBoundTo(this.masterTokens[f])){c=!0;break}if(!c)throw new v(a.USERIDTOKEN_MASTERTOKEN_NOT_FOUND,"uit mtserialnumber "+d.mtSerialNumber);this.userIdTokens[b]=d},getUserIdToken:function(a){return this.userIdTokens[a]},removeUserIdToken:function(a){var b=null,d;for(d in this.masterTokens){var c=this.masterTokens[d];
if(a.isBoundTo(c)){b=c;break}}Object.keys(this.userIdTokens).forEach(function(d){if(this.userIdTokens[d].equals(a)){delete this.userIdTokens[d];try{this.removeServiceTokens(null,b,a)}catch(c){if(c instanceof v)throw new C("Unexpected exception while removing user ID token bound service tokens.",c);throw c;}}},this)},clearUserIdTokens:function(){for(var a in this.userIdTokens){var b=this.userIdTokens[a];try{this.removeServiceTokens(null,null,b)}catch(d){if(d instanceof v)throw new C("Unexpected exception while removing user ID token bound service tokens.",
d);throw d;}delete this.userIdTokens[a]}},addServiceTokens:function(b){b.forEach(function(b){if(b.isMasterTokenBound()){var d=!1,c;for(c in this.masterTokens)if(b.isBoundTo(this.masterTokens[c])){d=!0;break}if(!d)throw new v(a.SERVICETOKEN_MASTERTOKEN_NOT_FOUND,"st mtserialnumber "+b.mtSerialNumber);}if(b.isUserIdTokenBound()){var d=!1,f;for(f in this.userIdTokens)if(b.isBoundTo(this.userIdTokens[f])){d=!0;break}if(!d)throw new v(a.SERVICETOKEN_USERIDTOKEN_NOT_FOUND,"st uitserialnumber "+b.uitSerialNumber);
}},this);b.forEach(function(a){if(a.isUnbound())this.unboundServiceTokens[a.uniqueKey()]=a;else{if(a.isMasterTokenBound()){var b=this.mtServiceTokens[a.mtSerialNumber];b||(b={});b[a.uniqueKey()]=a;this.mtServiceTokens[a.mtSerialNumber]=b}a.isUserIdTokenBound()&&((b=this.uitServiceTokens[a.uitSerialNumber])||(b={}),b[a.uniqueKey()]=a,this.uitServiceTokens[a.uitSerialNumber]=b)}},this)},getServiceTokens:function(b,d){if(d){if(!b)throw new v(a.USERIDTOKEN_MASTERTOKEN_NULL);if(!d.isBoundTo(b))throw new v(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,
"uit mtserialnumber "+d.mtSerialNumber+"; mt "+b.serialNumber);}var c={},f;for(f in this.unboundServiceTokens){var g=this.unboundServiceTokens[f];c[g.uniqueKey()]=g}if(b&&(g=this.mtServiceTokens[b.serialNumber]))for(f in g){var h=g[f];h.isUserIdTokenBound()||(c[f]=h)}if(d&&(g=this.uitServiceTokens[d.serialNumber]))for(f in g)h=g[f],h.isBoundTo(b)&&(c[f]=h);g=[];for(f in c)g.push(c[f]);return g},removeServiceTokens:function(b,d,c){if(c&&d&&!c.isBoundTo(d))throw new v(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,
"uit mtserialnumber "+c.mtSerialNumber+"; mt "+d.serialNumber);if(b&&!d&&!c){Object.keys(this.unboundServiceTokens).forEach(function(a){this.unboundServiceTokens[a].name==b&&delete this.unboundServiceTokens[a]},this);for(var f in this.mtServiceTokens){var g=this.mtServiceTokens[f],h=Object.keys(g);h.forEach(function(a){g[a].name==b&&delete g[a]},this);this.mtServiceTokens[f]=g}for(var k in this.uitServiceTokens)g=this.uitServiceTokens[k],f=Object.keys(g),f.forEach(function(a){g[a].name==b&&delete g[a]},
this),this.uitServiceTokens[k]=g}if(d&&!c){if(g=this.mtServiceTokens[d.serialNumber])h=Object.keys(g),h.forEach(function(a){var d=g[a];b&&d.name!=b||delete g[a]},this),this.mtServiceTokens[d.serialNumber]=g;for(k in this.uitServiceTokens){var z=this.uitServiceTokens[k];f=Object.keys(z);f.forEach(function(a){var c=z[a];b&&c.name!=b||c.isBoundTo(d)&&delete z[a]},this);this.uitServiceTokens[k]=z}}c&&(g=this.uitServiceTokens[c.serialNumber])&&(f=Object.keys(g),f.forEach(function(a){var c=g[a];b&&c.name!=
b||d&&!c.isBoundTo(d)||delete g[a]},this),this.uitServiceTokens[c.serialNumber]=g)},clearServiceTokens:function(){[this.unboundServiceTokens,this.mtServiceTokens,this.uitServiceTokens].forEach(function(a){for(var b in a)delete a[b]},this)}})})();var Dc,mc;(function(){var b=Qa;Dc=function(d,c){switch(d){case b.LZW:return nrdp.compress(c,"lzw",!0);case b.GZIP:if("function"===typeof Sa)return Sa(c);default:throw new v(a.UNSUPPORTED_COMPRESSION,d);}};mc=function(d,c,f){switch(d){case b.LZW:return nrdp.uncompress(c,
"lzw",!0);case b.GZIP:if("function"===typeof ga)return ga(c);default:throw new v(a.UNSUPPORTED_COMPRESSION,d.name());}}})();var J;(function(){J=function(b,d,c){a.call(this,2E5+b,d,c)}})();M.Class.mixin(J,{ASN1_PARSE_ERROR:new J(22,c.FAIL,"Error parsing ASN.1."),ASN1_ENCODE_ERROR:new J(23,c.FAIL,"Error encoding ASN.1."),XML_PARSE_ERROR:new J(49,c.FAIL,"Error parsing XML."),XML_ENCODE_ERROR:new J(50,c.FAIL,"Error encoding XML."),MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_SYNC:new J(1009,c.ENTITY_REAUTH,"Master token sequence number does not have the expected value."),
MASTERTOKEN_IDENTITY_REVOKED:new J(1013,c.ENTITY_REAUTH,"Master token entity identity is revoked."),USERIDTOKEN_IDENTITY_NOT_FOUND:new J(2013,c.USER_REAUTH,"The user identity was not found."),USERIDTOKEN_PASSWORD_VERSION_CHANGED:new J(2014,c.USER_REAUTH,"The user identity must be reauthenticated because the password version changed."),USERIDTOKEN_INCORRECT_MSLUSER:new J(2015,c.FAIL,"The user ID token MSL user type is incorrect."),USERIDTOKEN_INVALID_MSLUSER:new J(2016,c.USER_REAUTH,"The user ID token MSL user is invalid."),
ENTITY_NOT_FOUND:new J(4005,c.FAIL,"Entity not recognized."),INCORRECT_ENTITYAUTH_DATA:new J(4006,c.FAIL,"Entity used incorrect entity authentication data type."),NPTICKET_GRACE_PERIOD_EXCEEDED:new J(4008,c.ENTITYDATA_REAUTH,"Fake NP-Tickets cannot be used after the grace period when the Playstation Network is up."),NPTICKET_SERVICE_ID_MISSING:new J(4009,c.ENTITYDATA_REAUTH,"NP-Ticket service ID is missing."),NPTICKET_SERVICE_ID_DISALLOWED:new J(4010,c.ENTITYDATA_REAUTH,"NP-Ticket service ID is not allowed."),
NPTICKET_NOT_YET_VALID:new J(4011,c.ENTITYDATA_REAUTH,"NP-Ticket issuance date is in the future."),NPTICKET_EXPIRED:new J(4012,c.ENTITYDATA_REAUTH,"NP-Ticket has expired."),NPTICKET_PRIVATE_KEY_NOT_FOUND:new J(4013,c.ENTITYDATA_REAUTH,"No private key found for NP-Ticket GUID."),NPTICKET_COOKIE_VERIFICATION_FAILED:new J(4014,c.ENTITYDATA_REAUTH,"NP-Ticket cookie signature verification failed."),NPTICKET_INCORRECT_COOKIE_VERSION:new J(4015,c.ENTITYDATA_REAUTH,"Incorrect NP-Ticket cookie version."),
NPTICKET_BROKEN:new J(4016,c.ENTITYDATA_REAUTH,"NP-Ticket broken."),NPTICKET_VERIFICATION_FAILED:new J(4017,c.ENTITYDATA_REAUTH,"NP-Ticket signature verification failed."),NPTICKET_ERROR:new J(4018,c.ENTITYDATA_REAUTH,"Unknown NP-Ticket TCM error."),NPTICKET_CIPHER_INFO_NOT_FOUND:new J(4019,c.ENTITYDATA_REAUTH,"No cipher information found for NP-Ticket."),NPTICKET_INVALID_CIPHER_INFO:new J(4020,c.ENTITYDATA_REAUTH,"Cipher information for NP-Ticket is invalid."),NPTICKET_UNSUPPORTED_VERSION:new J(4021,
c.ENTITYDATA_REAUTH,"Unsupported NP-Ticket version."),NPTICKET_INCORRECT_KEY_LENGTH:new J(4022,c.ENTITYDATA_REAUTH,"Incorrect NP-Ticket public key length."),CRYPTEX_RSA_KEY_SET_NOT_FOUND:new J(4024,c.FAIL,"Cryptex RSA key set not found."),ENTITY_REVOKED:new J(4025,c.FAIL,"Entity is revoked."),NPTICKET_COOKIE_PARSE_ERROR:new J(4027,c.ENTITYDATA_REAUTH,"Error parsing NP-Ticket cookie."),ANYCAST_CHALLENGE_PARSE_ERROR:new J(4028,c.ENTITYDATA_REAUTH,"Error parsing Anycast challenge."),ANYCAST_CHALLENGE_REJECTED:new J(4029,
c.ENTITYDATA_REAUTH,"Anycast challenge is not acceptable."),FORCE_LOGIN:new J(5E3,c.USERDATA_REAUTH,"User must login again."),NETFLIXID_COOKIES_EXPIRED:new J(5001,c.USERDATA_REAUTH,"Netflix ID cookie identity has expired."),NETFLIXID_COOKIES_BLANK:new J(5002,c.USERDATA_REAUTH,"Netflix ID or Secure Netflix ID cookie is blank."),AUTHMGR_COMMS_FAILURE:new J(5006,c.TRANSIENT_FAILURE,"Error communicating with authentication manager."),EMAILPASSWORD_INCORRECT:new J(5007,c.USERDATA_REAUTH,"Email or password is incorrect."),
SSOTOKEN_BLANK:new J(5009,c.SSOTOKEN_REJECTED,"SSO token is blank."),SSOTOKEN_NOT_ASSOCIATED:new J(5010,c.USERDATA_REAUTH,"SSO token is not associated with a Netflix user."),PROFILEGUID_BLANK:new J(5012,c.USERDATA_REAUTH,"Profile GUID is blank."),SSOTOKEN_INVALID:new J(5015,c.SSOTOKEN_REJECTED,"SSO token invalid."),ACCTMGR_COMMS_FAILURE:new J(5017,c.TRANSIENT_FAILURE,"Error communicating with the account manager."),SSO_ASSOCIATION_FAILURE:new J(5018,c.TRANSIENT_FAILURE,"SSO user association failed."),
SSO_DISASSOCIATION_FAILURE:new J(5019,c.TRANSIENT_FAILURE,"SSO user disassociation failed."),MDX_USERAUTH_VERIFICATION_FAILED:new J(5020,c.USERDATA_REAUTH,"MDX user authentication data verification failed."),MDX_USERAUTH_ACTION_INVALID:new J(5022,c.USERDATA_REAUTH,"MDX user authentication data action is invalid."),CTICKET_DECRYPT_ERROR:new J(5023,c.USERDATA_REAUTH,"CTicket decryption failed."),CTICKET_CRYPTOCONTEXT_ERROR:new J(5026,c.USERDATA_REAUTH,"Error creating CTicket crypto context."),MDX_PIN_BLANK:new J(5027,
c.USERDATA_REAUTH,"MDX controller or target PIN is blank."),MDX_PIN_MISMATCH:new J(5028,c.USERDATA_REAUTH,"MDX controller and target PIN mismatch."),MDX_USER_UNKNOWN:new J(5029,c.USERDATA_REAUTH,"MDX controller user ID token or CTicket is not decrypted or verified."),MDX_CONTROLLERDATA_INVALID:new J(5031,c.USERDATA_REAUTH,"MDX controller authentication data is invalid."),USERAUTH_ENTITY_MISMATCH:new J(5032,c.USERDATA_REAUTH,"User authentication data does not match entity identity."),USERAUTH_INCORRECT_DATA:new J(5033,
c.FAIL,"Entity used incorrect user authentication data type."),SSO_ASSOCIATION_WITH_NONMEMBER:new J(5034,c.USERDATA_REAUTH,"SSO user association failed because the customer is not a member."),SSO_ASSOCIATION_WITH_FORMERMEMBER:new J(5035,c.USERDATA_REAUTH,"SSO user association failed because the customer is a former member."),SSO_ASSOCIATION_CONFLICT:new J(5036,c.USERDATA_REAUTH,"SSO user association failed because the token identifies a different member."),PROFILE_SWITCH_DISALLOWED:new J(5038,c.TRANSIENT_FAILURE,
"Unable to switch user profile."),MEMBERSHIPCLIENT_COMMS_FAILURE:new J(5039,c.TRANSIENT_FAILURE,"Error communicating with the membership manager."),USERIDTOKEN_IDENTITY_ENTITY_ASSOCIATION_NOT_FOUND:new J(5040,c.USERDATA_REAUTH,"No entity association record found for the user."),INCORRECT_MSLUSER:new J(5041,c.FAIL,"The MSL user type is incorrect."),USERIDTOKEN_IDENTITY_ENTITY_ASSOCIATION_ERROR:new J(5042,c.USERDATA_REAUTH,"User entity association record query returned an error."),USERIDTOKEN_IDENTITY_ENTITY_ASSOCIATION_ENTITY_MISMATCH:new J(5043,
c.USERDATA_REAUTH,"User entity association record query returned different entity identities."),USERIDTOKEN_IDENTITY_ENTITY_ASSOCIATION_DEACTIVATED:new J(5044,c.USERDATA_REAUTH,"User entity association record is deactivated."),USERIDTOKEN_IDENTITY_ENTITY_ASSOCIATION_USER_MISMATCH:new J(5045,c.USERDATA_REAUTH,"User entity association record query returned different user identities."),USERIDTOKEN_IDENTITY_ENTITY_ASSOCIATION_NOT_FOUND_USERREAUTH:new J(5046,c.USER_REAUTH,"No entity association record found for the user."),
USERIDTOKEN_IDENTITY_ENTITY_ASSOCIATION_ERROR_USERREAUTH:new J(5047,c.USER_REAUTH,"User entity association record query returned an error."),USERIDTOKEN_IDENTITY_ENTITY_ASSOCIATION_ENTITY_MISMATCH_USERREAUTH:new J(5048,c.USER_REAUTH,"User entity association record query returned different entity identities."),USERIDTOKEN_IDENTITY_ENTITY_ASSOCIATION_DEACTIVATED_USERREAUTH:new J(5049,c.USER_REAUTH,"User entity association record is deactivated."),USERIDTOKEN_IDENTITY_ENTITY_ASSOCIATION_USER_MISMATCH_USERREAUTH:new J(5050,
c.USER_REAUTH,"User entity association record query returned different user identities."),NONREPLAYABLE_ID_OUT_OF_RANGE:new J(6032,c.FAIL,"Non-replayable message non-replayable ID is out of range."),KEYX_INVALID_GUID:new J(7E3,c.FAIL,"Invalid key exchange GUID."),KEYX_COMMS_FAILURE:new J(7001,c.TRANSIENT_FAILURE,"Error communicating with key exchange service"),KEYX_IDENTITY_FAILURE:new J(7002,c.FAIL,"Identity in challenge doesn't match device identity"),CRYPTEX_ENCRYPTION_ERROR:new J(8E3,c.FAIL,"Error encrypting data with cryptex."),
CRYPTEX_DECRYPTION_ERROR:new J(8001,c.FAIL,"Error decrypting data with cryptex."),CRYPTEX_MAC_ERROR:new J(8002,c.FAIL,"Error computing MAC with cryptex."),CRYPTEX_VERIFY_ERROR:new J(8003,c.FAIL,"Error verifying MAC or signature with cryptex."),CRYPTEX_CONTEXT_CREATION_FAILURE:new J(8004,c.FAIL,"Error creating cryptex cipher or MAC context."),DATAMODEL_DEVICE_ACCESS_ERROR:new J(8005,c.TRANSIENT_FAILURE,"Error accessing data model device."),DATAMODEL_DEVICETYPE_NOT_FOUND:new J(8006,c.FAIL,"Data model device type not found."),
CRYPTEX_KEYSET_UNSUPPORTED:new J(8007,c.FAIL,"Cryptex key set not supported."),CRYPTEX_PRIVILEGE_EXCEPTION:new J(8008,c.FAIL,"Insufficient privileges for cryptex operation."),CRYPTEX_WRAP_ERROR:new J(8009,c.FAIL,"Error wrapping data with cryptex."),CRYPTEX_UNWRAP_ERROR:new J(8010,c.FAIL,"Error unwrapping data with cryptex."),CRYPTEX_COMMS_FAILURE:new J(8011,c.TRANSIENT_FAILURE,"Error comunicating with cryptex."),CRYPTEX_SIGN_ERROR:new J(8012,c.FAIL,"Error computing signature with cryptex."),CRYPTEX_FINGERPRINT_ERROR:new J(8013,
c.FAIL,"Error computing key fingerprint with cryptex.")});Object.freeze(J);var Hd;(function(){Hd=hb.extend({init:function m(a,b,d){m.base.call(this);Object.defineProperties(this,{id:{value:b,writable:!1,enumerable:!1,configurable:!1},privateKey:{value:d,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(a,b){b.result(a)},decrypt:function(a,b){b.result(a)},wrap:function(b,c){c.error(new d(a.WRAP_NOT_SUPPORTED))},unwrap:function(b,c,f){f.error(new d(a.UNWRAP_NOT_SUPPORTED))},sign:function(c,
f){b(f,function(){if(!this.privateKey)throw new d(a.SIGN_NOT_SUPPORTED,"no private key");var b=Pa.sign(ca.RSASSA_SHA1,this.privateKey,c);b.oncomplete=function(){f.result(b.result)};b.onerror=function(){f.error(new d(a.SIGNATURE_ERROR))}},this)},verify:function(a,b,d){d.result(a)}})})();var Id;(function(){Id=hb.extend({init:function m(a){m.base.call(this);Object.defineProperties(this,{signatureKey:{value:a,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(a,b){b.result(a)},decrypt:function(b,
c){c.result(new d(a.DECRYPT_NOT_SUPPORTED))},wrap:function(b,c){c.error(new d(a.WRAP_NOT_SUPPORTED))},unwrap:function(b,c){c.error(new d(a.UNWRAP_NOT_SUPPORTED))},sign:function(c,f){b(f,function(){oa.sign(this.signatureKey.algorithm,this.signatureKey,c).then(function(a){Pb(new Uint8Array(a),{result:function(a){f.result(a.bytes)},error:f.error})},function(b){f.error(new d(a.SIGNATURE_ERROR))})},this)},verify:function(b,c){callback.error(new d(a.VERIFY_NOT_SUPPORTED))}})})();var ac;(function(){ac=Ya.extend({init:function m(a){m.base.call(this,
qa.ANYCAST);Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;return a},equals:function n(a){return this===a?!0:a instanceof ac?n.base.call(this,a)&&this.identity===a.identity:!1}})})();var Oe=kb.extend({init:function m(a,b){m.base.call(this,qa.ANYCAST);Object.defineProperties(this,{_identity:{value:a,writable:!1,enumerable:!1,configurable:!1},_cdmKey:{value:b,writable:!1,
enumerable:!1,configurable:!1}})},createData:function(a,d,c){b(c,function(){return new ac(d)})},getCryptoContext:function(b,d){if(!(d instanceof ac))throw new C("Incorrect authentication data type "+JSON.stringify(d)+".");if(d.getIdentity()!=this._identity)throw(new u(a.ENTITY_NOT_FOUND,"anycast "+d.getIdentity())).setEntityAuthenticationData(d);return new Id(this._cdmKey)}}),bb,Jd;(function(){bb=Ya.extend({init:function n(a){n.base.call(this,qa.MGK);Object.defineProperties(this,{identity:{value:a,
writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;return a},equals:function t(a){return this===a?!0:a instanceof bb?t.base.call(this,a)&&this.identity==a.identity:!1}});Jd=function(b){var d=b.identity;if(!d)throw new f(a.JSON_PARSE_ERROR,"mgk authdata"+JSON.stringify(b));return new bb(d)}})();var Pe=kb.extend({init:function n(a){n.base.call(this,qa.MGK);Object.defineProperties(this,{localIdentity:{value:a,writable:!1,
enumerable:!1,configurable:!1}})},createData:function(a,d,c){b(c,function(){return Jd(d)})},getCryptoContext:function(b,d){if(!(d instanceof bb))throw new C("Incorrect authentication data type "+JSON.stringify(d)+".");if(d.getIdentity()!=this.localIdentity)throw(new u(a.ENTITY_NOT_FOUND,"mgk "+d.identity)).setEntityAuthenticationData(d);return new Qb}}),Lb,Kd;(function(){Lb=Ya.extend({init:function t(a,b){t.base.call(this,qa.NPTICKET);var d=b.algorithm.npTicketExpiration,c=b.algorithm.npTicket,f=
b.algorithm.npTicketIssue,g=b.algorithm.npTicketFake;if(d<f)throw new C("Cannot construct an NP-Ticket that expires before it was issued.");Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1},privateKey:{value:b,writable:!1,configurable:!1},npticket:{value:c,writable:!1,enumerable:!0,configuration:!1},issuance:{value:f,writable:!1,configurable:!1},expiration:{value:d,writable:!1,configurable:!1},fake:{value:g,writable:!1,configurable:!1}})},isNetflixGenerated:function(){return this.fake},
isValid:function(a){return Date.now()+a>=1E3*this.issuance},isExpired:function(a){return Date.now()-a>1E3*this.expiration},getIssuance:function(){return new Date(1E3*this.issuance)},getExpiration:function(){return new Date(1E3*this.expiration)},getAuthData:function(){var a={};a.npticket=this.npticket;return a},equals:function p(a){return this===a?!0:a instanceof Lb?p.base.call(this,a)&&q(this.npticket,a.npticket):!1},getIdentity:function(){return this.identity},getPrivateKey:function(){return this.privateKey}});
Kd=function(){throw new u(a.UNSUPPORTED_ENTITY_AUTH,"npticket");}})();var Qe=kb.extend({init:function t(a){t.base.call(this,qa.NPTICKET)},createData:function(a,d,c){b(c,function(){return Kd(d)})},getCryptoContext:function(b,d){if(!(d instanceof Lb))throw new C("Incorrect authentication data type "+JSON.stringify(d)+".");var c=d.getIdentity(),f=d.getPrivateKey();if(!c)throw(new u(a.ENTITY_NOT_FOUND,"npticket "+c)).setEntityAuthenticationData(d);if(!f)throw(new u(a.NPTICKET_PRIVATE_KEY_NOT_FOUND,"npticket "+
c)).setEntityAuthenticationData(d);return new Hd(b,c,f)}}),qa;(function(){qa=function(a,b,d){ja.call(this,a,b,d)};M.Class.mixin(qa,{MGK:new qa("MGK",!0,!0),MGK_PROFILE:new qa("MGK_PROFILE",!0,!0),NPTICKET:new qa("NPTICKET",!1,!0),ECC:new qa("ECC",!1,!0),ANYCAST:new qa("ANYCAST",!1,!0)});Object.freeze(qa)})();var Ld,Gc,Md,Nd,Od;(function(){function c(a,d,f){b(f,function(){Ha(a,{result:function(a){Ha(d,{result:function(b){f.result({encryptionKey:a,cmacKey:b})},error:f.error})},error:f.error})})}var g=
Gc=$a.extend({init:function w(a,b,d){w.base.call(this,Da.ANYCAST);a={baseKey:{value:a,writable:!1,configurable:!1},slotId:{value:b,writable:!1,configurable:!1},keyRequest:{value:D(d),writable:!1,configurable:!1}};Object.defineProperties(this,a)},getKeydata:function(){var a={};a.slotid=this.slotId;a.keyrequest=this.keyRequest;return a},equals:function z(a){return a===this?!0:a instanceof Gc?z.base.call(this,a)&&this.slotId==a.slotId&&this.keyRequest==a.keyRequest:!1},uniqueKey:function r(){return r.base.call(this)+
":"+this.slotId+":"+this.keyRequest}});Md=function(b){var d=b.slotid,c=b.keyrequest;if("string"!==typeof d||"string"!==typeof c)throw new f(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(b));if(!isUuid)throw new aa(J.KEYX_INVALID_GUID,"keydata "+JSON.stringify(b));return new g(d,c)};var h=Nd=ab.extend({init:function W(a,b,d,c){W.base.call(this,a,Da.ANYCAST);Object.defineProperties(this,{keyResponse:{value:b,writable:!1,configurable:!1},encryptionKeyId:{value:d,writable:!1,configurable:!1},cmacKeyId:{value:c,
writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.encryptionkeyid=this.encryptionKeyId;a.cmackeyid=this.cmacKeyId;a.keyresponse=this.keyResponse;return a},equals:function ta(a){return this===a?!0:a instanceof Nd?ta.base.call(this,a)&&this.keyResponse==a.keyResponse&&this.encryptionKeyId==a.encryptionKeyId&&this.cmacKeyId==a.cmacKeyId:!1},uniqueKey:function T(){return T.base.call(this)+":"+keyResponse+":"+encryptionKeyId+":"+cmacKeyId}});Od=function(b,d){var c=d.keyresponse,g=d.encryptionkeyid,
k=d.cmackeyid;if("string"!==typeof c||"string"!==typeof g||"string"!==typeof k)throw new f(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(d));return new h(b,c,g,k)};Ld=Ba.extend({init:function O(){O.base.call(this,Da.ANYCAST)},createRequestData:function(a,d,c){b(c,function(){return Md(d)})},createResponseData:function(a,b,d){return Od(b,d)},generateResponse:function(d,c,f,g){b(g,function(){var b,d;f instanceof La?b=f:d=f;throw(new aa(a.UNSUPPORTED_KEYX_SCHEME)).setMasterToken(b).setEntityAuthenticationData(d);
})},getCryptoContext:function(f,k,H,V,B){function u(g,h,k){b(B,function(){var p=h.baseKey;oa.deriveKey({name:p.algorithm.name,params:{cdmResponseData:k.keyResponse,keKeyId:""+h.slotId+";"+k.encryptionKeyId,khKeyId:""+h.slotId+";"+k.cmacKeyId}},p).then(function(a){c(a.encryptionKey,a.hmacKey,{result:function(a){b(B,function(){var b=k.masterToken,d=g.getIdentity();return new wa(f,b,d,a.encryptionKey,a.cmacKey)},ba)},error:function(a){b(B,function(){a instanceof v&&a.setEntityAuthenticationData(g);throw a;
})}})},function(b){B.error((new d(a.DERIVEKEY_ERROR,"",b)).setEntityAuthenticationData(g))})},ba)}var ba=this;b(B,function(){if(!(k instanceof g))throw new C("Key request data "+JSON.stringify(k)+" was not created by this factory.");if(!(H instanceof h))throw new C("Key response data "+JSON.stringify(H)+" was not created by this factory.");f.getEntityAuthenticationData(null,{result:function(a){b(B,function(){u(a,k,H)},ba)},error:B.error})},ba)}})})();var Pd,Hc,Ic,Qd,Rd;(function(){function c(a){for(var b=
0,d=0;d<a.length&&0==a[d];++d)++b;if(1==b)return a;d=new Uint8Array(a.length-b+1);d[0]=0;d.set(a.subarray(b),1);return d}function g(a,d,c,f){b(f,function(){Ha(a,{result:function(a){Ha(d,{result:function(b){Ha(c,{result:function(d){f.result({encryptionKey:a,hmacKey:b,wrappingKey:d})},error:f.error})},error:f.error})},error:f.error})})}var h=Hc={PSK:"PSK",MGK:"MGK",WRAP:"WRAP"};Rd=M.Class.create({addDerivationKey:function(a,b){},getDerivationKey:function(a){},removeDerivationKey:function(a){}});var k=
Ic=$a.extend({init:function r(a,b,d,c,f){r.base.call(this,Da.AUTHENTICATED_DH);switch(a){case h.WRAP:if(!f)throw new C("Previous wrapping key based key exchange requires the previous wrapping key data and ID.");break;default:f=null}Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},wrapdata:{value:f,writable:!1,configurable:!1},parametersId:{value:b,writable:!1,configurable:!1},publicKey:{value:d,writable:!1,configurable:!1},privateKey:{value:c,writable:!1,configurable:!1}})},
getKeydata:function(){var a={};a.mechanism=this.mechanism;a.publickey=D(c(this.publicKey));a.parametersid=this.parametersId;this.wrapdata&&(a.wrapdata=D(this.wrapdata));return a},equals:function W(a){if(a===this)return!0;if(!(a instanceof Ic))return!1;var b=this.privateKey===a.privateKey||this.privateKey&&a.privateKey&&q(this.privateKey.getEncoded(),a.privateKey.getEncoded());return W.base.call(this,a)&&this.mechanism==a.mechanism&&this.parametersId==a.parametersId&&q(this.publicKey,a.publicKey)&&
q(this.wrapdata,a.wrapdata)&&b},uniqueKey:function ta(){var a=ta.base.call(this)+":"+this.mechanism+":"+this.parametersId+":"+y(this.publicKey);this.wrapdata&&(a+=":"+y(this.wrapdata));return a}}),w=Qd=ab.extend({init:function T(a,b,d,c){T.base.call(this,a,Da.AUTHENTICATED_DH);Object.defineProperties(this,{parametersId:{value:b,writable:!1,configurable:!1},publicKey:{value:d,writable:!1,configurable:!1},wrapdata:{value:c,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.parametersid=
this.parametersId;a.wrapdata=D(this.wrapdata);var b=c(this.publicKey);a.publickey=D(b);return a},equals:function O(a){return this===a?!0:a instanceof Qd?O.base.call(this,a)&&this.parametersId==a.parametersId&&q(this.publicKey,a.publicKey)&&q(this.wrapdata,a.wrapdata):!1},uniqueKey:function I(){return I.base.call(this)+":"+this.parametersId+":"+y(this.publicKey)+":"+y(this.wrapdata)}});Pd=Ba.extend({init:function H(a,b){H.base.call(this,Da.AUTHENTICATED_DH);Object.defineProperties(this,{repository:{value:a,
writable:!1,enumerable:!1,configurable:!1},params:{value:b,writable:!1,enumerable:!1,configurable:!1}})},createRequestData:function(a,d,c){b(c,function(){return RequestData$parse(d)})},createResponseData:function(b,d,g){b=g.wrapdata;var h=g.parametersid,k=g.publickey;if("string"!==typeof b||"string"!==typeof h||"string"!==typeof k)throw new f(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(g));var p;try{p=P(b)}catch(u){throw new aa(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+g.toString(),u);}if(!p||0==p.length)throw new aa(a.KEYX_WRAPPING_KEY_MISSING,
"keydata "+g.toString());var v;try{var G=P(k);v=c(G)}catch(u){throw new aa(a.KEYX_INVALID_PUBLIC_KEY,"keydata "+JSON.stringify(g),u);}if(!v||0==v.length)throw new aa(a.KEYX_INVALID_PUBLIC_KEY,"keydata "+JSON.stringify(g));return new w(d,h,v,p)},generateResponse:function(c,f,B,t){function u(c,f,k,B,w){b(t,function(){var k=request.mechanism,x=request.wrapdata,H=request.publicKey;switch(k){case h.PSK:case h.MGK:x=this.repository.getDerivationKey();if(!x)throw(new aa(a.UNSUPPORTED_KEYX_MECHANISM,k)).setMasterToken(c).setEntityAuthenticationData(f);
break;case h.WRAP:x=this.repository.getDerivationKey(x);if(!x)throw(new aa(a.KEYX_DERIVATION_KEY_MISSING,D(requestWrapdata))).setMasterToken(c).setEntityAuthenticationData(f);break;default:throw(new aa(a.UNSUPPORTED_KEYX_MECHANISM,k)).setMasterToken(c).setEntityAuthenticationData(f);}oa.deriveKey({name:ca.AUTHENTICATED_DH.name,params:{"public":H,kd:x}},w).then(function(a){g(a.encryptionKey,a.hmacKey,a.wrappingKey,{result:function(a){A(c,f,B,a)},error:function(a){b(t,function(){a instanceof v&&(a.setMasterToken(c),
a.setEntityAuthenticationData(f));throw a;})}})},function(g){b(t,function(){throw(new d(a.DERIVEKEY_ERROR,"",g)).setMasterToken(c).setEntityAuthenticationData(f);})})},q)}function A(a,d,f,g){b(t,function(){var h=request.parametersId;c.getMslCryptoContext().wrap(g.derivationKey,{result:function(a){a=c.getTokenFactory();B instanceof La?a.renewMasterToken(c,B,g.encryptionKey,g.hmacKey,{result:function(a){b(t,function(){var b=new wa(c,a),d=new w(a,h,f);return new Ba.KeyExchangeData(d,b)},q)},error:function(a){b(t,
function(){a instanceof v&&a.setMasterToken(B);throw a;},q)}}):a.createMasterToken(c,B,g.encryptionKey,g.hmacKey,{result:function(a){b(t,function(){var b=new wa(c,a),d=new w(a,h,f);return new Ba.KeyExchangeData(d,b)},q)},error:function(a){b(t,function(){a instanceof v&&a.setEntityAuthenticationData(B);throw a;})}})},error:function(c){b(t,function(){c instanceof v&&(c.setMasterToken(a),c.setEntityAuthenticationData(d));throw c;})}})},q)}var q=this;b(t,function(){if(!(f instanceof k))throw new C("Key request data "+
JSON.stringify(f)+" was not created by this factory.");var c,g,h;if(B instanceof La){c=g;if(!c.isVerified())throw new Ea(a.MASTERTOKEN_UNTRUSTED,c);h=c.identity}else g=B,h=g.getIdentity();var p=this.params.getParameterSpec(f.parametersId);oa.generateKey({name:ca.AUTHENTICATED_DH,prime:p.p,generator:p.g},!1,re).then(function(a){u(c,g,h,a.publicKey,a.privateKey)},function(f){b(t,function(){throw(new d(a.GENERATEKEY_ERROR,"Error generating Diffie-Hellman key pair.",f)).setMasterToken(c).setEntityAuthenticationData(g);
})})},q)},getCryptoContext:function(c,f,B,t,u){function A(f,h,k,B){b(u,function(){oa.deriveKey({name:ca.AUTHENTICATED_DH.name,params:{"public":k.publicKey,kd:B.rawKey}},h.privateKey).then(function(a){g(a.encryptionKey,a.hmacKey,a.wrappingKey,{result:function(a){b(u,function(){this.repository.addDerivationKey(k.wrapdata,a.derivationKey);h.wrapdata&&this.repository.removeDerivationKey(h.wrapdata);var b=k.masterToken,d=f.getIdentity();return new wa(c,b,d,a.encryptionKey,a.hmacKey)},q)},error:function(a){b(u,
function(){a instanceof v&&a.setEntityAuthenticationData(f);throw a;})}})},function(b){u.error((new d(a.DERIVEKEY_ERROR,"",b)).setEntityAuthenticationData(f))})},q)}var q=this;b(u,function(){if(!(f instanceof k))throw new C("Key request data "+JSON.stringify(f)+" was not created by this factory.");if(!(B instanceof w))throw new C("Key response data "+JSON.stringify(B)+" was not created by this factory.");var d=f.parametersId,g=B.parametersId;if(d!=g)throw(new aa(a.KEYX_RESPONSE_REQUEST_MISMATCH,"request "+
d+"; response "+g)).setMasterToken(t);var p=f.mechanism,v=f.wrapdata;c.getEntityAuthenticationData(null,{result:function(d){b(u,function(){var b;switch(p){case h.WRAP:b=this.repository.getDerivationKey(v);if(!b)throw new aa(a.KEYX_DERIVATION_KEY_MISSING,D(v));break;case h.PSK:case h.MGK:b=this.repository.getDerivationKey();if(!b)throw new aa(a.UNSUPPORTED_KEYX_MECHANISM,p);break;default:throw new C("Key request data mechanism "+p+" is not supported but it should be.");}A(d,f,B,b)},q)},error:u.error})},
q)}})})();var Sd,Jc,Kc,Td;(function(){function c(d,f,h,k,t){b(t,function(){switch(f){case g.PSK:var c=new Za(k),u=d.getEntityAuthenticationFactory(ja.PSK);if(!u)throw new aa(a.UNSUPPORTED_KEYX_MECHANISM,f);c=u.getCryptoContext(d,c);return new ib(d,jb.A128KW,K,void 0);case g.MGK:c=new bb(k);u=d.getEntityAuthenticationFactory(qa.MGK);if(!u)throw new aa(a.UNSUPPORTED_KEYX_MECHANISM,f);c=u.getCryptoContext(d,c);return new ib(d,jb.A128KW,K,void 0);case g.WRAP:c=d.getMslCryptoContext();c.unwrap(h,ca.A128KW,
Gb,{result:function(a){b(t,function(){return new ib(d,jb.A128KW,K,a)})},error:t.error});break;default:throw new aa(a.UNSUPPORTED_KEYX_MECHANISM,f);}})}var g=Jc={PSK:"PSK",MGK:"MGK",WRAP:"WRAP"},h=Kc=$a.extend({init:function z(a,b){z.base.call(this,za.JWE_LADDER);switch(a){case g.WRAP:if(!b)throw new C("Previous wrapping key based key exchange requires the previous wrapping key data and ID.");break;default:b=null}Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},wrapdata:{value:b,
writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.mechanism=this.mechanism;this.wrapdata&&(a.wrapdata=D(this.wrapdata));return a},equals:function r(a){return a===this?!0:a instanceof Kc?r.base.call(this,a)&&this.mechanism==a.mechanism&&q(this.wrapdata,a.wrapdata):!1},uniqueKey:function W(){var a=W.base.call(this)+":"+this.mechanism;this.wrapdata&&(a+=":"+y(this.wrapdata));return a}}),k=Td=ab.extend({init:function ta(a,b,d,c,f){ta.base.call(this,a,za.JWE_LADDER);Object.defineProperties(this,
{wrapKey:{value:b,writable:!1,configurable:!1},wrapdata:{value:d,writable:!1,configurable:!1},encryptionKey:{value:c,writable:!1,configurable:!1},hmacKey:{value:f,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.wrapkey=D(this.wrapKey);a.wrapdata=D(this.wrapdata);a.encryptionkey=D(this.encryptionKey);a.hmackey=D(this.hmacKey);return a},equals:function T(a){return this===a?!0:a instanceof Td?T.base.call(this,a)&&q(this.wrapKey,a.wrapKey)&&q(this.wrapdata,a.wrapdata)&&q(this.encryptionKey,
a.encryptionKey)&&q(this.hmacKey,a.hmacKey):!1},uniqueKey:function O(){return O.base.call(this)+":"+y(this.wrapKey)+":"+y(this.wrapdata)+":"+y(this.encryptionKey)+":"+y(this.hmacKey)}});Sd=Ba.extend({init:function I(a){I.base.call(this,za.JWE_LADDER);Object.defineProperties(this,{repository:{value:a,writable:!1,enumerable:!1,configurable:!1}})},createRequestData:function(d,c,k){b(k,function(){var b=c.mechanism,d=c.wrapdata;if(!b||b==g.WRAP&&(!d||"string"!==typeof d))throw new f(a.JSON_PARSE_ERROR,
"keydata "+JSON.stringify(c));if(!g[b])throw new aa(a.UNIDENTIFIED_KEYX_MECHANISM,b);var k;switch(b){case g.WRAP:try{k=P(d)}catch(I){throw new aa(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+c.toString());}if(null==k||0==k.length)throw new aa(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+c.toString());break;default:k=null}return new h(b,k)})},createResponseData:function(b,c,g){b=g.wrapkey;var h=g.wrapdata,p=g.encryptionkey,t=g.hmackey;if(!(b&&"string"===typeof b&&h&&"string"===typeof h&&p&&"string"===typeof p&&
t)||"string"!==typeof t)throw new f(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(g));var u,v,C,R;try{u=P(b),v=P(h)}catch(A){throw new d(a.INVALID_SYMMETRIC_KEY,"keydata "+JSON.stringify(g),A);}try{C=P(p)}catch(A){throw new d(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(g),A);}try{R=P(t)}catch(A){throw new d(a.INVALID_HMAC_KEY,"keydata "+JSON.stringify(g),A);}return new k(c,u,v,C,R)},generateResponse:function(f,g,p,B){function u(a,d,c){D.generateSessionKeys(f,{result:function(f){b(B,function(){A(a,
d,c,f.encryptionKey,f.hmacKey)},D)},error:function(a){b(B,function(){a instanceof v&&(a.setMasterToken(R),a.setEntityAuthenticationData(y));throw a;})}})}function A(a,d,h,k,p){b(B,function(){c(f,g.mechanism,g.wrapdata,a,{result:function(a){a.wrap(d,{result:function(a){q(d,h,k,p,a)},error:function(a){b(B,function(){a instanceof v&&(a.setMasterToken(R),a.setEntityAuthenticationData(y));throw a;})}})},error:function(a){b(B,function(){a instanceof v&&(a.setMasterToken(R),a.setEntityAuthenticationData(y));
throw a;})}})},D)}function q(a,d,c,g,h){b(B,function(){var k=new ib(f,jb.A128KW,K,a);k.wrap(c,{result:function(a){k.wrap(g,{result:function(b){E(d,h,c,a,g,b)},error:function(a){b(B,function(){a instanceof v&&(a.setMasterToken(R),a.setEntityAuthenticationData(y));throw a;})}})},error:function(a){b(B,function(){a instanceof v&&(a.setMasterToken(R),a.setEntityAuthenticationData(y));throw a;})}})},D)}function E(a,d,c,g,h,t){b(B,function(){var u=f.getTokenFactory();R?u.renewMasterToken(f,R,c,h,{result:function(c){b(B,
function(){var b=new wa(f,c),h=new k(c,d,a,g,t);return new Ba.KeyExchangeData(h,b,B)},D)},error:function(a){b(B,function(){a instanceof v&&a.setMasterToken(R);throw a;})}}):u.createMasterToken(f,p,c,h,{result:function(c){b(B,function(){var b=new wa(f,c),h=new k(c,d,a,g,t);return new Ba.KeyExchangeData(h,b,B)},D)},error:function(a){b(B,function(){a instanceof v&&a.setEntityAuthenticationData(p);throw a;})}})},D)}var D=this,R,y;b(B,function(){if(!(g instanceof h))throw new C("Key request data "+JSON.stringify(g)+
" was not created by this factory.");var c;if(p instanceof La){if(!p.isVerified())throw new Ea(a.MASTERTOKEN_UNTRUSTED,p);R=p;c=R.identity}else y=p,c=y.getIdentity();var k=new Uint8Array(16);f.getRandom().nextBytes(k);eb(k,ca.A128KW,Gb,{result:function(a){b(B,function(){f.getMslCryptoContext().wrap(a,{result:function(b){u(c,a,b)},error:function(a){b(B,function(){a instanceof v&&(a.setMasterToken(R),a.setEntityAuthenticationData(y));throw a;},D)}})},D)},error:function(c){b(B,function(){throw(new d(a.WRAP_KEY_CREATION_FAILURE,
null,c)).setMasterToken(R).setEntityAuthenticationData(y);},D)}})},D)},getCryptoContext:function(d,c,f,B,t){function u(a,c,f,g,h){b(t,function(){var k=new ib(d,jb.A128KW,K,h);k.unwrap(c.encryptionKey,ca.AES_CBC,ob,{result:function(h){k.unwrap(c.hmacKey,ca.HMAC_SHA256,pb,{result:function(a){b(t,function(){this.repository.addCryptoContext(c.wrapdata,k);this.repository.removeCryptoContext(f);return new wa(d,c.masterToken,g,h,a)},A)},error:function(d){b(t,function(){d instanceof v&&d.setEntityAuthenticationData(a);
throw d;})}})},error:function(d){b(t,function(){d instanceof v&&d.setEntityAuthenticationData(a);throw d;})}})},A)}var A=this;b(t,function(){if(!(c instanceof h))throw new C("Key request data "+JSON.stringify(c)+" was not created by this factory.");if(!(f instanceof k))throw new C("Key response data "+JSON.stringify(f)+" was not created by this factory.");var B=c.mechanism,q=c.wrapdata;d.getEntityAuthenticationData(null,{result:function(c){b(t,function(){var h=c.getIdentity(),k;switch(B){case g.PSK:k=
new Za(h);var H=d.getEntityAuthenticationFactory(ja.PSK);if(!H)throw(new aa(a.UNSUPPORTED_KEYX_MECHANISM,B)).setEntityAuthenticationData(c);H.getCryptoContext(d,k);k=new ib(d,jb.A128KW,K,H._kw);break;case g.MGK:k=new bb(h);H=d.getEntityAuthenticationFactory(qa.MGK);if(!H)throw(new aa(a.UNSUPPORTED_KEYX_MECHANISM,B)).setEntityAuthenticationData(c);H.getCryptoContext(d,k);k=new ib(d,jb.A128KW,K,H._kw);break;case g.WRAP:k=this.repository.getCryptoContext(q);if(!k)throw(new aa(a.KEYX_WRAPPING_KEY_MISSING,
D(q))).setEntityAuthenticationData(c);break;default:throw(new aa(a.UNSUPPORTED_KEYX_MECHANISM,B)).setEntityAuthenticationData(c);}k.unwrap(f.wrapKey,ca.A128KW,Gb,{result:function(a){u(c,f,q,h,a)},error:function(a){b(t,function(){a instanceof v&&a.setEntityAuthenticationData(c);throw a;})}})},A)},error:t.error})},A)}})})();var Ud,Vd;(function(){function c(d,f,h,k,t){b(t,function(){switch(f){case g.PSK:var c=new Za(k),I=d.getEntityAuthenticationFactory(ja.PSK);if(!I)throw new aa(a.UNSUPPORTED_KEYX_MECHANISM,
f);c=I.getCryptoContext(d,c);return new w(void 0);case g.MGK:c=new bb(k);I=d.getEntityAuthenticationFactory(qa.MGK);if(!I)throw new aa(a.UNSUPPORTED_KEYX_MECHANISM,f);c=I.getCryptoContext(d,c);return new w(void 0);case g.WRAP:c=d.getMslCryptoContext();c.unwrap(h,ca.A128KW,Gb,{result:function(a){b(t,function(){return new w(a)})},error:t.error});break;default:throw new aa(a.UNSUPPORTED_KEYX_MECHANISM,f);}})}var g={PSK:"PSK",MGK:"MGK",WRAP:"WRAP"},h=Ud=$a.extend({init:function r(a,b){r.base.call(this,
za.JWK_LADDER);switch(a){case g.WRAP:if(!b)throw new C("Previous wrapping key based key exchange requires the previous wrapping key data and ID.");break;default:b=null}Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},wrapdata:{value:b,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.mechanism=this.mechanism;this.wrapdata&&(a.wrapdata=D(this.wrapdata));return a},equals:function W(a){return a===this?!0:a instanceof Ud?W.base.call(this,a)&&this.mechanism==
a.mechanism&&q(this.wrapdata,a.wrapdata):!1},uniqueKey:function ta(){var a=ta.base.call(this)+":"+this.mechanism;this.wrapdata&&(a+=":"+y(this.wrapdata));return a}}),k=Vd=ab.extend({init:function T(a,b,d,c,f){T.base.call(this,a,za.JWK_LADDER);Object.defineProperties(this,{wrapKey:{value:b,writable:!1,configurable:!1},wrapdata:{value:d,writable:!1,configurable:!1},encryptionKey:{value:c,writable:!1,configurable:!1},hmacKey:{value:f,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.wrapkey=
D(this.wrapKey);a.wrapdata=D(this.wrapdata);a.encryptionkey=D(this.encryptionKey);a.hmackey=D(this.hmacKey);return a},equals:function O(a){return this===a?!0:a instanceof Vd?O.base.call(this,a)&&q(this.wrapKey,a.wrapKey)&&q(this.wrapdata,a.wrapdata)&&q(this.encryptionKey,a.encryptionKey)&&q(this.hmacKey,a.hmacKey):!1},uniqueKey:function I(){return I.base.call(this)+":"+y(this.wrapKey)+":"+y(this.wrapdata)+":"+y(this.encryptionKey)+":"+y(this.hmacKey)}}),w=hb.extend({init:function(a){a&&(a=a.rawKey);
Object.defineProperties(this,{_wrapKey:{value:a,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(b,c){c.error(new d(a.ENCRYPT_NOT_SUPPORTED))},decrypt:function(b,c){c.error(new d(a.DECRYPT_NOT_SUPPORTED))},wrap:function(c,f){b(f,function(){oa.wrapKey("jwk",c.rawKey,this._wrapKey,ca.A128KW).then(function(a){f.result(a)},function(b){f.error(new d(a.WRAP_ERROR))})},this)},unwrap:function(c,f,g,h){function k(c){b(h,function(){switch(c.type){case "secret":Ha(c,h);break;case "public":qb(c,
h);break;case "private":fb(c,h);break;default:throw new d(a.UNSUPPORTED_KEY,"type: "+c.type);}})}b(h,function(){oa.unwrapKey("jwk",c,this._wrapKey,ca.A128KW,f,!1,g).then(function(a){k(a)},function(b){h.error(new d(a.UNWRAP_ERROR))})},this)},sign:function(b,c){c.error(new d(a.SIGN_NOT_SUPPORTED))},verify:function(b,c,f){f.error(new d(a.VERIFY_NOT_SUPPORTED))}});Ba.extend({init:function H(a){H.base.call(this,za.JWK_LADDER);Object.defineProperties(this,{repository:{value:a,writable:!1,enumerable:!1,
configurable:!1}})},createRequestData:function(d,c,k){b(k,function(){var b=c.mechanism,d=c.wrapdata;if(!b||b==g.WRAP&&(!d||"string"!==typeof d))throw new f(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(c));if(!g[b])throw new aa(a.UNIDENTIFIED_KEYX_MECHANISM,b);var k;switch(b){case g.WRAP:try{k=P(d)}catch(B){throw new aa(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+c.toString());}if(null==k||0==k.length)throw new aa(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+c.toString());break;default:k=null}return new h(b,
k)})},createResponseData:function(b,c,g){b=g.wrapkey;var h=g.wrapdata,p=g.encryptionkey,t=g.hmackey;if(!(b&&"string"===typeof b&&h&&"string"===typeof h&&p&&"string"===typeof p&&t)||"string"!==typeof t)throw new f(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(g));var w,u,v,C;try{w=P(b),u=P(h)}catch(A){throw new d(a.INVALID_SYMMETRIC_KEY,"keydata "+JSON.stringify(g),A);}try{v=P(p)}catch(A){throw new d(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(g),A);}try{C=P(t)}catch(A){throw new d(a.INVALID_HMAC_KEY,
"keydata "+JSON.stringify(g),A);}return new k(c,w,u,v,C)},generateResponse:function(f,g,p,u){function A(a,d,c){R.generateSessionKeys(f,{result:function(f){b(u,function(){q(a,d,c,f.encryptionKey,f.hmacKey)},R)},error:function(a){b(u,function(){a instanceof v&&(a.setMasterToken(y),a.setEntityAuthenticationData(P));throw a;})}})}function q(a,d,h,k,p){b(u,function(){c(f,g.mechanism,g.wrapdata,a,{result:function(a){a.wrap(d,{result:function(a){D(d,h,k,p,a)},error:function(a){b(u,function(){a instanceof
v&&(a.setMasterToken(y),a.setEntityAuthenticationData(P));throw a;})}})},error:function(a){b(u,function(){a instanceof v&&(a.setMasterToken(y),a.setEntityAuthenticationData(P));throw a;})}})},R)}function D(a,d,c,f,g){b(u,function(){var h=new w(a);h.wrap(c,{result:function(a){h.wrap(f,{result:function(b){E(d,g,c,a,f,b)},error:function(a){b(u,function(){a instanceof v&&(a.setMasterToken(y),a.setEntityAuthenticationData(P));throw a;})}})},error:function(a){b(u,function(){a instanceof v&&(a.setMasterToken(y),
a.setEntityAuthenticationData(P));throw a;})}})},R)}function E(a,d,c,g,h,t){b(u,function(){var w=f.getTokenFactory();y?w.renewMasterToken(f,y,c,h,{result:function(c){b(u,function(){var b=new wa(f,c),h=new k(c,d,a,g,t);return new Ba.KeyExchangeData(h,b,u)},R)},error:function(a){b(u,function(){a instanceof v&&a.setMasterToken(y);throw a;})}}):w.createMasterToken(f,p,c,h,{result:function(c){b(u,function(){var b=new wa(f,c),h=new k(c,d,a,g,t);return new Ba.KeyExchangeData(h,b,u)},R)},error:function(a){b(u,
function(){a instanceof v&&a.setEntityAuthenticationData(p);throw a;})}})},R)}var R=this,y,P;b(u,function(){if(!(g instanceof h))throw new C("Key request data "+JSON.stringify(g)+" was not created by this factory.");var c;if(p instanceof La){if(!p.isVerified())throw new Ea(a.MASTERTOKEN_UNTRUSTED,p);y=p;c=y.identity}else P=p,c=P.getIdentity();var k=new Uint8Array(16);f.getRandom().nextBytes(k);eb(k,ca.A128KW,Gb,{result:function(a){b(u,function(){f.getMslCryptoContext().wrap(a,{result:function(b){A(c,
a,b)},error:function(a){b(u,function(){a instanceof v&&(a.setMasterToken(y),a.setEntityAuthenticationData(P));throw a;},R)}})},R)},error:function(c){b(u,function(){throw(new d(a.WRAP_KEY_CREATION_FAILURE,null,c)).setMasterToken(y).setEntityAuthenticationData(P);},R)}})},R)},getCryptoContext:function(d,c,f,t,u){function A(a,c,f,g,h){b(u,function(){var k=new w(h);k.unwrap(c.encryptionKey,ca.AES_CBC,ob,{result:function(h){k.unwrap(c.hmacKey,ca.HMAC_SHA256,pb,{result:function(a){b(u,function(){this.repository.addCryptoContext(c.wrapdata,
k);this.repository.removeCryptoContext(f);return new wa(d,c.masterToken,g,h,a)},q)},error:function(d){b(u,function(){d instanceof v&&d.setEntityAuthenticationData(a);throw d;})}})},error:function(d){b(u,function(){d instanceof v&&d.setEntityAuthenticationData(a);throw d;})}})},q)}var q=this;b(u,function(){if(!(c instanceof h))throw new C("Key request data "+JSON.stringify(c)+" was not created by this factory.");if(!(f instanceof k))throw new C("Key response data "+JSON.stringify(f)+" was not created by this factory.");
var t=c.mechanism,R=c.wrapdata;d.getEntityAuthenticationData(null,{result:function(c){b(u,function(){var h=c.getIdentity(),k;switch(t){case g.PSK:k=new Za(h);var C=d.getEntityAuthenticationFactory(ja.PSK);if(!C)throw(new aa(a.UNSUPPORTED_KEYX_MECHANISM,t)).setEntityAuthenticationData(c);C.getCryptoContext(d,k);k=new w(void 0);break;case g.MGK:k=new bb(h);C=d.getEntityAuthenticationFactory(qa.MGK);if(!C)throw(new aa(a.UNSUPPORTED_KEYX_MECHANISM,t)).setEntityAuthenticationData(c);C.getCryptoContext(d,
k);k=new w(void 0);break;case g.WRAP:k=this.repository.getCryptoContext(R);if(!k)throw(new aa(a.KEYX_WRAPPING_KEY_MISSING,D(R))).setEntityAuthenticationData(c);break;default:throw(new aa(a.UNSUPPORTED_KEYX_MECHANISM,t)).setEntityAuthenticationData(c);}k.unwrap(f.wrapKey,ca.A128KW,Gb,{result:function(a){A(c,f,R,h,a)},error:function(a){b(u,function(){a instanceof v&&a.setEntityAuthenticationData(c);throw a;})}})},q)},error:u.error})},q)}})})();var Wd,Lc,Xd;(function(){function c(d,f,h,k,t){b(t,function(){switch(f){case g.SESSION:if(!h)throw new aa(a.KEYX_MASTER_TOKEN_MISSING,
f);var b=d.getMslStore().getCryptoContext(h);if(b)return b;if(!h.isDecrypted())throw new Ea(a.MASTERTOKEN_UNTRUSTED,h);return new wa(d,h);case g.PSK:var b=new Za(k),c=d.getEntityAuthenticationFactory(ja.PSK);if(!c)throw new aa(a.UNSUPPORTED_KEYX_KEY_ID,f);return c.getCryptoContext(d,b);case g.MGK:b=new bb(k);c=d.getEntityAuthenticationFactory(qa.MGK);if(!c)throw new aa(a.UNSUPPORTED_KEYX_KEY_ID,f);return c.getCryptoContext(d,b);default:throw new aa(a.UNSUPPORTED_KEYX_KEY_ID,f);}})}var g={PSK:"PSK",
MGK:"MGK",SESSION:"SESSION"},h=Lc=$a.extend({init:function z(a){z.base.call(this,za.SYMMETRIC_WRAPPED);Object.defineProperties(this,{keyId:{value:a,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keyid=this.keyId;return a},equals:function r(a){return this===a?!0:a instanceof Lc?r.base.call(this,a)&&this.keyId==a.keyId:!1},uniqueKey:function W(){return W.base.call(this)+":"+this.keyId}}),k=Xd=ab.extend({init:function ta(a,b,d,c){ta.base.call(this,a,za.SYMMETRIC_WRAPPED);Object.defineProperties(this,
{keyId:{value:b,writable:!1,configurable:!1},encryptionKey:{value:d,writable:!1,configurable:!1},hmacKey:{value:c,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keyid=this.keyId;a.encryptionkey=D(this.encryptionKey);a.hmackey=D(this.hmacKey);return a},equals:function T(a){return this===a?!0:a instanceof Xd?T.base.call(this,a)&&this.keyId==a.keyId&&q(this.encryptionKey,a.encryptionKey)&&q(this.hmacKey,a.hmacKey):!1},uniqueKey:function O(){return O.base.call(this)+":"+this.keyId+":"+
y(this.encryptionKey)+":"+y(this.hmacKey)}});Wd=Ba.extend({init:function I(){I.base.call(this,za.SYMMETRIC_WRAPPED)},createRequestData:function(d,c,k){b(k,function(){var b=c.keyid;if(!b||"string"!==typeof b)throw new f(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(c));if(!g[b])throw new aa(a.UNIDENTIFIED_KEYX_KEY_ID,b);return new h(b)},this)},createResponseData:function(b,c,h){b=h.keyid;var t=h.encryptionkey,u=h.hmackey;if(!b||"string"!==typeof b||!t||"string"!==typeof t||!u||"string"!==typeof u)throw new f(a.JSON_PARSE_ERROR,
"keydata "+JSON.stringify(h));if(!g[b])throw new aa(a.UNIDENTIFIED_KEYX_KEY_ID,b);var v;try{v=P(t)}catch(C){throw new d(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(h),C);}var A;try{A=P(u)}catch(C){throw new d(a.INVALID_HMAC_KEY,"keydata "+JSON.stringify(h),C);}return new k(c,b,v,A)},generateResponse:function(d,f,g,p){function u(h,k){b(p,function(){var u,C,G;if(g instanceof La){if(!g.isVerified())throw new Ea(a.MASTERTOKEN_UNTRUSTED,g);u=g;C=null;G=u.identity}else u=null,C=g,G=g.getIdentity();
c(d,f.keyId,u,G,{result:function(a){a.wrap(h,{result:function(d){a.wrap(k,{result:function(a){A(h,d,k,a)},error:function(a){b(p,function(){a instanceof v&&(a.setMasterToken(u),a.setEntityAuthenticationData(C));throw a;},q)}})},error:function(a){b(p,function(){a instanceof v&&(a.setMasterToken(u),a.setEntityAuthenticationData(C));throw a;},q)}})},error:function(a){b(p,function(){a instanceof v&&(a.setMasterToken(u),a.setEntityAuthenticationData(C));throw a;},q)}})},q)}function A(a,c,h,t){b(p,function(){var u=
d.getTokenFactory();g instanceof La?u.renewMasterToken(d,g,a,h,null,{result:function(a){b(p,function(){var b;try{b=new wa(d,a)}catch(h){if(h instanceof Ea)throw new C("Master token constructed by token factory is not trusted.",h);h instanceof v&&h.setMasterToken(g);throw h;}var p=new k(a,f.keyId,c,t);return new Ba.KeyExchangeData(p,b)},q)},error:function(a){b(p,function(){a instanceof v&&a.setMasterToken(g);throw a;},q)}}):u.createMasterToken(d,g,a,h,null,{result:function(a){b(p,function(){var b;
try{b=new wa(d,a)}catch(g){if(g instanceof Ea)throw new C("Master token constructed by token factory is not trusted.",g);throw g;}var h=new k(a,f.keyId,c,t);return new Ba.KeyExchangeData(h,b)},q)},error:function(a){b(p,function(){a instanceof v&&a.setEntityAuthenticationData(g);throw a;},q)}})},q)}var q=this;b(p,function(){if(!(f instanceof h))throw new C("Key request data "+JSON.stringify(f)+" was not created by this factory.");this.generateSessionKeys(d,{result:function(a){u(a.encryptionKey,a.hmacKey)},
error:function(a){b(p,function(){a instanceof v&&a.setMasterToken(g);throw a;},q)}})},q)},getCryptoContext:function(d,f,g,p,u){function A(a){b(u,function(){a instanceof v&&(a.setMasterToken(p),a.setEntityAuthenticationData(y));throw a;},q)}var q=this,y;b(u,function(){if(!(f instanceof h))throw new C("Key request data "+JSON.stringify(f)+" was not created by this factory.");if(!(g instanceof k))throw new C("Key response data "+JSON.stringify(g)+" was not created by this factory.");var v=f.keyId,D=
g.keyId;if(v!=D)throw(new aa(a.KEYX_RESPONSE_REQUEST_MISMATCH,"request "+v+"; response "+D)).setMasterToken(p);d.getEntityAuthenticationData(null,{result:function(a){b(u,function(){y=a;var f=y.getIdentity();c(d,D,p,f,{result:function(a){a.unwrap(g.encryptionKey,ca.AES_CBC,ob,{result:function(c){a.unwrap(g.hmacKey,ca.HMAC_SHA256,pb,{result:function(a){d.getEntityAuthenticationData(null,{result:function(f){b(u,function(){var b=f.getIdentity();return new wa(d,g.masterToken,b,c,a)},q)},error:A})},error:A})},
error:A})},error:A})},q)},error:A})},q)}})})();var Da;(function(){Da=function(a){za.call(this,a)};M.Class.mixin(Da,{AUTHENTICATED_DH:new Da("AUTHENTICATED_DH"),WIDEVINE:new Da("WIDEVINE"),ANYCAST:new Da("ANYCAST"),CDM:new Da("CDM")});Object.freeze(Da)})();var Mc,Nc,Yd;(function(){function c(a,d,f){b(f,function(){Ha(a,{result:function(a){Ha(d,{result:function(b){f.result({encryptionKey:a,hmacKey:b})},error:f.error})},error:f.error})})}var g=Nc=$a.extend({init:function w(a,b){w.base.call(this,Da.WIDEVINE);
if(!b)throw new C("Key request missing key request data.");Object.defineProperties(this,{baseKey:{value:a,writable:!1,configurable:!1},keyRequest:{value:D(b),writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keyrequest=this.keyRequest;return a},equals:function z(a){return a===this?!0:a instanceof Nc?z.base.call(this,a)&&this.baseKey===a.baseKey&&this.keyRequest===a.keyRequest:!1},uniqueKey:function r(){return r.base.call(this)+":"+this.baseKey+":"+this.keyRequest}}),h=Yd=ab.extend({init:function W(a,
b,d,c){W.base.call(this,a,Da.WIDEVINE);Object.defineProperties(this,{keyResponse:{value:b,writable:!1,configurable:!1},encryptionKeyId:{value:d,writable:!1,configurable:!1},hmacKeyId:{value:c,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.cdmkeyresponse=this.keyResponse;a.encryptionkeyid=this.encryptionKeyId;a.hmackeyid=this.hmacKeyId;return a},equals:function ta(a){return this===a?!0:a instanceof Yd?ta.base.call(this,a)&&this.keyResponse===a.keyResponse&&this.encryptionKeyId==a.encryptionKeyId&&
this.hmacKeyId==a.hmacKeyId:!1},uniqueKey:function T(){return T.base.call(this)+":"+this.keyResponse+":"+this.encryptionKeyId+":"+this.hmacKeyId}});Mc=Ba.extend({init:function O(){O.base.call(this,Da.WIDEVINE)},createRequestData:function(a,b,d){throw new C("WidevineExchange::createRequestData not implemented.");},createResponseData:function(b,d,c){b=c.cdmkeyresponse;var g=c.encryptionkeyid,k=c.hmackeyid;if("string"!==typeof b||"string"!==typeof g||"string"!==typeof k)throw new f(a.JSON_PARSE_ERROR,
"keydata "+JSON.stringify(c));return new h(d,b,g,k)},generateResponse:function(a,b,d,c){throw new C("WidevineExchange::generateResponse not implemented.");},getCryptoContext:function(f,k,u,A,B){function q(g,h,k){b(B,function(){oa.deriveKey({name:"NFLX-CDM-WIDEVINE",params:{cdmProvisionResponseData:k.keyResponse,keKeyId:k.encryptionKeyId,khKeyId:k.hmacKeyId}},h.baseKey).then(function(a){c(a.encryptionKey,a.hmacKey,{result:function(a){b(B,function(){var b=k.masterToken,d=g.getIdentity();return new wa(f,
b,d,a.encryptionKey,a.hmacKey)},y)},error:function(a){b(B,function(){a instanceof v&&a.setEntityAuthenticationData(g);throw a;})}})},function(b){B.error((new d(a.DERIVEKEY_ERROR,"",b)).setEntityAuthenticationData(g))})},y)}var y=this;b(B,function(){if(!(k instanceof g))throw new C("Key request data "+JSON.stringify(k)+" was not created by this factory.");if(!(u instanceof h))throw new C("Key response data "+JSON.stringify(u)+" was not created by this factory.");f.getEntityAuthenticationData(null,
{result:function(a){b(B,function(){q(a,k,u)},y)},error:B.error})},y)}})})();var Zd,Oc,$d;(function(){function c(a,d,f){b(f,function(){Ha(a,{result:function(a){Ha(d,{result:function(b){f.result({encryptionKey:a,hmacKey:b})},error:f.error})},error:f.error})})}var g=Oc=$a.extend({init:function w(a,b,d){w.base.call(this,Da.CDM);if(!d)throw new C("Key request missing key request data.");Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},baseKey:{value:b,writable:!1,configurable:!1},
keyRequest:{value:D(d),writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.mechanism=this.mechanism;a.keyrequest=this.keyRequest;return a},equals:function z(a){return a===this?!0:a instanceof Oc?z.base.call(this,a)&&this.baseKey===a.baseKey&&this.mechanism===a.mechanism&&this.keyRequest===a.keyRequest:!1},uniqueKey:function r(){return r.base.call(this)+":"+this.baseKey+":"+this.mechanism+":"+this.keyRequest}}),h=$d=ab.extend({init:function W(a,b,d,c){W.base.call(this,a,Da.CDM);Object.defineProperties(this,
{keyResponse:{value:b,writable:!1,configurable:!1},encryptionKeyId:{value:d,writable:!1,configurable:!1},hmacKeyId:{value:c,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.cdmkeyresponse=this.keyResponse;a.encryptionkeyid=this.encryptionKeyId;a.hmackeyid=this.hmacKeyId;return a},equals:function ta(a){return this===a?!0:a instanceof $d?ta.base.call(this,a)&&this.keyResponse===a.keyResponse&&this.encryptionKeyId==a.encryptionKeyId&&this.hmacKeyId==a.hmacKeyId:!1},uniqueKey:function T(){return T.base.call(this)+
":"+this.keyResponse+":"+this.encryptionKeyId+":"+this.hmacKeyId}});Zd=Ba.extend({init:function O(){O.base.call(this,Da.CDM)},createRequestData:function(a,b,d){throw new C("CdmExchange::createRequestData not implemented.");},createResponseData:function(b,d,c){b=c.cdmkeyresponse;var g=c.encryptionkeyid,k=c.hmackeyid;if("string"!==typeof b||"string"!==typeof g||"string"!==typeof k)throw new f(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(c));return new h(d,b,g,k)},generateResponse:function(a,b,d,c){throw new C("CdmExchange::generateResponse not implemented.");
},getCryptoContext:function(f,k,u,A,B){function q(g,h,k){b(B,function(){oa.deriveKey({name:"NFLX-CDM-JWELE",params:{cdmProvisionResponseData:k.keyResponse,keKeyId:k.encryptionKeyId,khKeyId:k.hmacKeyId}},h.baseKey).then(function(a){c(a.encryptionKey,a.hmacKey,{result:function(a){b(B,function(){var b=k.masterToken,d=g.getIdentity();return new wa(f,b,d,a.encryptionKey,a.hmacKey)},y)},error:function(a){b(B,function(){a instanceof v&&a.setEntityAuthenticationData(g);throw a;})}})},function(b){B.error((new d(a.DERIVEKEY_ERROR,
"",b)).setEntityAuthenticationData(g))})},y)}var y=this;b(B,function(){if(!(k instanceof g))throw new C("Key request data "+JSON.stringify(k)+" was not created by this factory.");if(!(u instanceof h))throw new C("Key response data "+JSON.stringify(u)+" was not created by this factory.");f.getEntityAuthenticationData(null,{result:function(a){b(B,function(){q(a,k,u)},y)},error:B.error})},y)}})})();var Mb,ae,oc,Pc,bc,Qc;(function(){function c(a,b){return"<"+a+">"+b+"</"+a+">"}function g(a){return a.replace(/[<>&"']/g,
function(a){return A[a]})}function h(a){return encodeURIComponent(a).replace("%20","+").replace(/[!'()]/g,escape).replace(/\*/g,"%2A")}var k=oc={MSL:"MSL",NTBA:"NTBA",MSL_LEGACY:"MSL_LEGACY"},u=M.Class.create({getAction:function(){},getNonce:function(){},getPin:function(){},getSignature:function(){},getEncoding:function(){},equals:function(){}}),z=Pc=u.extend({init:function(d,c,g,h,k,p,r){function u(h){b(r,function(){var b;try{var p={};p.useridtoken=d;p.action=c;p.nonce=g;p.pin=D(h);b=na(JSON.stringify(p),
Y)}catch(u){throw new f(a.JSON_ENCODE_ERROR,"MSL-based MDX authdata",u);}k.sign(b,{result:function(a){t(b,a)},error:r.error})},z)}function t(a,f){b(r,function(){Object.defineProperties(this,{_userIdToken:{value:d,writable:!1,enumerable:!1,configurable:!1},_action:{value:c,writable:!1,enumerable:!1,configurable:!1},_nonce:{value:g,writable:!1,enumerable:!1,configurable:!1},_pin:{value:h,writable:!1,enumerable:!1,configurable:!1},_encoding:{value:a,writable:!1,enumerable:!1,configurable:!1},_signature:{value:f,
writable:!1,enumerable:!1,configurable:!1}});return this},z)}var z=this;b(r,function(){p?t(p.encoding,p.signature):k.encrypt(na(h,Y),{result:function(a){u(a)},error:r.error})},z)},getUserIdToken:function(){return this._userIdToken},getAction:function(){return this._action},getNonce:function(){return this._nonce},getPin:function(){return this._pin},getSignature:function(){return this._signature},getEncoding:function(){return this._encoding},equals:function(a){return this===a?!0:a instanceof z?this._action==
a._action&&this._nonce==a._nonce&&this._pin==a._pin&&this._userIdToken.equals(a._userIdToken):!1}});Pc.ACTION="userauth";var r=function(c,g,h,k,p){function r(d){b(p,function(){var k=pa(h,Y),r,t,z,w;try{var B=JSON.parse(k);r=B.useridtoken;t=B.action;z=B.nonce;w=B.pin}catch(x){if(x instanceof SyntaxError)throw new f(a.JSON_PARSE_ERROR,"MDX authdata "+k,x);throw x;}if(!(r&&"object"===typeof r&&t&&"string"===typeof t&&z&&"number"===typeof z&&w)||"string"!==typeof w)throw new f(a.JSON_PARSE_ERROR,"MDX authdata "+
k);sb(c,r,g,{result:function(c){b(p,function(){if(!c.isDecrypted())throw new da(a.USERAUTH_USERIDTOKEN_NOT_DECRYPTED,"MDX authdata "+k);u(d,c,t,z,w)})},error:function(d){b(p,function(){if(d instanceof v)throw new da(a.USERAUTH_USERIDTOKEN_INVALID,"MDX authdata "+k,d);throw d;})}})})}function u(a,d,c,f,g){b(p,function(){var r=P(g);a.decrypt(r,{result:function(a){b(p,function(){var b=pa(a,Y);new z(d,c,f,b,null,{encoding:h,signature:k},p)})},error:p.error})})}b(p,function(){var f;try{var u=c.getMslStore().getCryptoContext(g);
f=u?u:new wa(c,g)}catch(t){if(t instanceof Ea)throw new da(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,"MDX authdata "+D(h));throw t;}f.verify(h,k,{result:function(a){b(p,function(){if(!a)throw new d(J.MDX_USERAUTH_VERIFICATION_FAILED,"MDX authdata "+D(h));r(f)})},error:p.error})})},A={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"},y=bc=u.extend({init:function(a,b,d,f){var h=c("action",g(a)),k=c("nonce",b.toString());d=c("pin",d);h=c("registerdata",h+k+d);h=na(h,"utf-8");Object.defineProperties(this,
{_action:{value:a,writable:!1,enumerable:!1,configurable:!1},_nonce:{value:b,writable:!1,enumerable:!1,configurable:!1},_pin:{value:null,writable:!1,enumerable:!1,configurable:!1},_encoding:{value:h,writable:!1,enumerable:!1,configurable:!1},_signature:{value:f,writable:!1,enumerable:!1,configurable:!1}})},getAction:function(){return this._action},getNonce:function(){return this._nonce},getPin:function(){return this._pin},getSignature:function(){return this._signature},getEncoding:function(){return this._encoding},
equals:function(a){return this===a?!0:a instanceof y?this._action==a._action&&this._nonce==a._nonce&&this._pin==a._pin:!1}});bc.ACTION="regpairrequest";var E=Qc=u.extend({init:function(a,d,f,k,r,u){function z(f){b(u,function(){var b=D(f),r=c("action",g(a)),z=c("nonce",d.toString()),v=c("pin",b),r=c("registerdata",r+z+v),x=na(r,"utf-8"),b="action="+h(a)+"&nonce="+h(d.toString())+"&pin="+h(b);k.sign(na(b,"utf-8"),{result:function(a){w(x,a)},error:u.error})},v)}function w(c,g){b(u,function(){Object.defineProperties(this,
{_action:{value:a,writable:!1,enumerable:!1,configurable:!1},_nonce:{value:d,writable:!1,enumerable:!1,configurable:!1},_pin:{value:f,writable:!1,enumerable:!1,configurable:!1},_encoding:{value:c,writable:!1,enumerable:!1,configurable:!1},_signature:{value:g,writable:!1,enumerable:!1,configurable:!1}});return this},v)}var v=this;b(u,function(){r?w(r.encoding,r.signature):k.encrypt(na(f,"utf-8"),{result:function(a){z(a)},error:u.error})},v)},getAction:function(){return this._action},getNonce:function(){return this._nonce},
getPin:function(){return this._pin},getSignature:function(){return this._signature},getEncoding:function(){return this._encoding},equals:function(a){return this===a?!0:a instanceof E?this._action==a._action&&this._nonce==a._nonce&&this._pin==a._pin:!1}});Qc.ACTION=bc.ACTION;var L=function(a,c,g,k,p){b(p,function(){var r=a.getMslStore().getCryptoContext(c),u=r?r:new wa(a,c),r=pa(g,"utf-8"),t=(new DOMParser).parseFromString(r,"application/xml"),r=t.getElementsByTagName("action"),z=t.getElementsByTagName("nonce"),
t=t.getElementsByTagName("pin"),w=r&&1==r.length&&r[0].firstChild?r[0].firstChild.nodeValue:null,v=z&&1==z.length&&z[0].firstChild?parseInt(z[0].firstChild.nodeValue):null,C=t&&1==t.length&&t[0].firstChild?t[0].firstChild.nodeValue:null;if(!w||!v||!C)throw new f(J.XML_PARSE_ERROR,"MDX authdata "+D(g));r="action="+h(w)+"&nonce="+h(v.toString())+"&pin="+h(C);u.verify(na(r,"utf-8"),k,{result:function(a){b(p,function(){if(!a)throw new d(J.MDX_USERAUTH_VERIFICATION_FAILED,"MDX authdata "+D(g));var c=P(C);
u.decrypt(c,{result:function(a){b(p,function(){var b=pa(a,"utf-8");new E(w,v,b,null,{encoding:g,signature:k},p)})},error:p.error})})},error:p.error})})};Mb=tb.extend({init:function H(a,b,d,c,f,g){H.base.call(this,Ma.MDX);var h=null,p=null,r=null;if("string"===typeof d)a=k.MSL_LEGACY,r=d;else if(d instanceof Uint8Array)a=k.NTBA,p=d;else if(d instanceof La)a=k.MSL,h=d;else throw new TypeError("Controller token "+d+" is not a master token, encrypted CTicket, or MSL token construct.");var u=d=null,t=
null;if(g){var w=g.controllerAuthData;d=w.getAction();u=w.getPin();g=g.userIdToken;w instanceof z?t=w.getUserIdToken().user:g&&(t=g.user)}Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},action:{value:d,writable:!1,configurable:!1},targetPin:{value:b,writable:!1,configurable:!1},controllerPin:{value:u,writable:!1,configurable:!1},user:{value:t,writable:!1,configurable:!1},_masterToken:{value:h,writable:!1,enumerable:!1,configurable:!1},_encryptedCTicket:{value:p,writable:!1,
enumerable:!1,configurable:!1},_mslTokens:{value:r,writable:!1,enumerable:!1,configurable:!1},_controllerEncoding:{value:c,writable:!1,enumerable:!1,configurable:!1},_signature:{value:f,writable:!1,enumerable:!1,configurable:!1}})},getAuthData:function(){var a={};switch(this.mechanism){case k.MSL:var b=JSON.parse(JSON.stringify(this._masterToken));a.mastertoken=b;break;case k.NTBA:b=pa(this._encryptedCTicket,"utf-8");a.cticket=b;break;case k.MSL_LEGACY:a.cticket=this._mslTokens;break;default:throw new C("Unsupported MDX mechanism.");
}a.pin=this.targetPin;a.mdxauthdata=D(this._controllerEncoding);a.signature=D(this._signature);return a},equals:function V(a){return this===a?!0:a instanceof Mb?V.base.call(this,a)&&(this._masterToken==a._masterToken||this._masterToken&&this._masterToken.equals(a._masterToken))&&(this._encryptedCTicket==a._encryptedCTicket||this._encryptedCTicket&&q(this._encryptedCTicket,a._encryptedCTicket))&&this._mslTokens==a._mslTokens&&q(this._controllerEncoding,a._controllerEncoding)&&q(this._signature,a._signature):
!1}});ae=function(d,c,g){function h(f,k,p,u){rb(d,k,{result:function(h){b(g,function(){if(!h.isDecrypted())throw new da(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,"MDX authdata "+c.toString());r(d,h,p,u,{result:function(a){b(g,function(){var b=a.getEncoding(),c=a.getSignature();return new Mb(d,f,h,b,c,{controllerAuthData:a,userIdToken:null})})},error:g.error})})},error:function(d){b(g,function(){if(d instanceof v)throw new da(a.USERAUTH_MASTERTOKEN_INVALID,"MDX authdata "+JSON.stringify(c),d);throw d;})}})}
function k(d,c,f,h){b(g,function(){throw new da(a.UNSUPPORTED_USERAUTH_MECHANISM,"NtbaControllerData$parse");})}function p(h,k,r,u){function t(g,h){b(h,function(){var k;try{k=P(g)}catch(p){throw new da(a.USERAUTH_MASTERTOKEN_INVALID,"MDX authdata "+JSON.stringify(c),p);}if(!k||0==k.length)throw new da(a.USERAUTH_MASTERTOKEN_MISSING,"MDX authdata "+JSON.stringify(c));try{var r=JSON.parse(pa(k,"utf-8"));rb(d,r,{result:function(d){b(h,function(){if(!d.isDecrypted())throw new da(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,
"MDX authdata "+c.toString());return d})},error:function(d){b(h,function(){if(d instanceof v)throw new da(a.USERAUTH_MASTERTOKEN_INVALID,"MDX authdata "+JSON.stringify(c),d);throw d;})}})}catch(p){if(p instanceof SyntaxError)throw new f(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(c),p);throw p;}})}function z(g,h,k){b(k,function(){var p;try{p=P(g)}catch(r){throw new da(a.USERAUTH_USERIDTOKEN_INVALID,"MDX authdata "+JSON.stringify(c),r);}if(!p||0==p.length)throw new da(a.USERAUTH_USERIDTOKEN_MISSING,
"MDX authdata "+JSON.stringify(c));try{var u=JSON.parse(pa(p,"utf-8"));sb(d,u,h,{result:function(d){b(k,function(){if(!d.isDecrypted())throw new da(a.USERAUTH_USERIDTOKEN_NOT_DECRYPTED,"MDX authdata "+JSON.stringify(c));return d})},error:function(d){b(k,function(){if(d instanceof v)throw new da(a.USERAUTH_USERIDTOKEN_INVALID,"MDX authdata "+JSON.stringify(c),d);throw d;})}})}catch(r){if(r instanceof SyntaxError)throw new f(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(c),r);throw r;}})}b(g,function(){var f=
k.split(",");if(3!=f.length||"1"!=f[0])throw new da(a.UNIDENTIFIED_USERAUTH_MECHANISM,"MDX authdata "+JSON.stringify(c));t(f[1],{result:function(p){z(f[2],p,{result:function(f){L(d,p,r,u,{result:function(a){b(g,function(){return new Mb(d,h,k,r,u,{controllerAuthData:a,userIdToken:f})})},error:function(d){b(g,function(){if(d instanceof Ea)throw new da(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,"MDX authdata "+JSON.stringify(c),d);throw d;})}})},error:g.error})},error:g.error})})}b(g,function(){var b=c.pin,
d=c.mdxauthdata,g=c.signature;if(!b||"string"!==typeof b||!d||"string"!==typeof d||!g||"string"!==typeof g)throw new f(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(c));var r,u;try{r=P(d),u=P(g)}catch(t){throw new da(J.MDX_CONTROLLERDATA_INVALID,"MDX authdata "+JSON.stringify(c),t);}if(c.mastertoken){d=c.mastertoken;if(!d||"object"!==typeof d)throw new f(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(c));h(b,d,r,u)}else if(c.cticket){d=c.cticket;if(!d||"string"!==typeof d)throw new f(a.JSON_PARSE_ERROR,
"MDX authdata "+JSON.stringify(c));-1==d.indexOf(",")?k(b,d,r,u):p(b,d,r,u)}else throw new da(a.UNIDENTIFIED_USERAUTH_MECHANISM,"MDX authdata "+JSON.stringify(c));})}})();(function(){var b=Pc.ACTION,d=bc.ACTION,c=Qc.ACTION;Zb.extend({init:function w(){w.base.call(this,Ma.MDX)},createData:function(a,b,d,c){ae(a,d,c)},authenticate:function(f,g,h,k){if(!(h instanceof Mb))throw new C("Incorrect authentication data type "+h.getClass().getName()+".");f=h.action;switch(h.mechanism){case oc.MSL:if(b!=f)throw(new da(J.MDX_USERAUTH_ACTION_INVALID)).setUserAuthenticationData(h);
break;case oc.NTBA:if(d!=f)throw(new da(J.MDX_USERAUTH_ACTION_INVALID)).setUserAuthenticationData(h);break;case oc.MSL_LEGACY:if(c!=f)throw(new da(J.MDX_USERAUTH_ACTION_INVALID)).setUserAuthenticationData(h);}f=h.controllerPin;g=h.targetPin;if(!f||!g)throw(new da(J.MDX_PIN_BLANK)).setUserAuthenticationData(h);if(f!=g)throw(new da(J.MDX_PIN_MISMATCH)).setUserAuthenticationData(h);f=h.user;if(!f)throw(new da(J.MDX_USER_UNKNOWN)).setUserAuthenticationData(h);if(k&&(k=k.user,!f.equals(k)))throw(new da(a.USERIDTOKEN_USERAUTH_DATA_MISMATCH,
"uad user "+f+"; uit user "+k)).setUserAuthenticationData(h);return f}})})();var cc,be;(function(){cc=tb.extend({init:function p(a,b){p.base.call(this,Ma.NETFLIXID);Object.defineProperties(this,{netflixId:{value:a,writable:!1,configurable:!1},secureNetflixId:{value:b,writable:!1,configurable:!1}})},getAuthData:function(){var a={};this.netflixId&&(a.netflixid=this.netflixId);this.secureNetflixId&&(a.securenetflixid=this.secureNetflixId);return a},equals:function S(a){return this===a?!0:a instanceof
cc?S.base.call(this,a)&&this.netflixId==a.netflixId&&this.secureNetflixId==a.secureNetflixId:!1}});be=function(a){var b=a.netflixid,d=a.securenetflixid;if(!b)throw new f(J.NETFLIXID_COOKIES_BLANK,"NetflixId authdata "+JSON.stringify(a));return new cc(b,d)}})();Zb.extend({init:function p(){p.base.call(this,Ma.NETFLIXID)},createData:function(a,d,c,f){b(f,function(){return be(c)})},authenticate:function(b,d,c,f){if(!(c instanceof cc))throw new C("Incorrect authentication data type "+c+".");b=c.secureNetflixId;
if(!c.netflixId||!b)throw(new da(J.NETFLIXID_COOKIES_BLANK)).setUserAuthenticationData(c);throw(new da(a.UNSUPPORTED_USERAUTH_DATA,this.scheme)).setUserAuthenticationData(c);}});var Ma;(function(){Ma=function(a){nb.call(this,a)};M.Class.mixin(Ma,{NETFLIXID:new Ma("NETFLIXID"),SSO:new Ma("SSO"),SWITCH_PROFILE:new Ma("SWITCH_PROFILE"),MDX:new Ma("MDX")});Object.freeze(Ma)})();var dc,ce,Rc,de,ee;(function(){var b=Rc={MICROSOFT_SAML:"MICROSOFT_SAML",MICROSOFT_JWT:"MICROSOFT_JWT"},d=de=M.Class.create({init:function(a,
b){Object.defineProperties(this,{email:{value:a,writable:!1,enumerable:!0,configurable:!1},password:{value:b,writable:!1,enumerable:!0,configurable:!1}})}}),c=ee=M.Class.create({init:function(a,b){Object.defineProperties(this,{netflixId:{value:a,writable:!1,enumerable:!0,configurable:!1},secureNetflixId:{value:b,writable:!1,enumerable:!0,configurable:!1}})}});dc=tb.extend({init:function z(a,b,f){z.base.call(this,Ma.SSO);var g=null,h=null,k=null,p=null;f instanceof d?(g=f.email,h=f.password):f instanceof
c&&(k=f.netflixId,p=f.secureNetflixId);Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},token:{value:b,writable:!1,configurable:!1},email:{value:g,writable:!1,configurable:!1},password:{value:h,writable:!1,configurable:!1},netflixId:{value:k,writable:!1,configurable:!1},secureNetflixId:{value:p,writable:!1,configurable:!1}})},getAuthData:function(){var a={};a.mechanism=this.mechanism;a.token=D(this.token);this.email&&this.password?(a.email=this.email,a.password=this.password):
this.netflixId&&this.secureNetflixId&&(a.netflixid=this.netflixId,a.securenetflixid=this.secureNetflixId);return a},equals:function r(a){return this===a?!0:a instanceof dc?r.base.call(this,a)&&this.mechanism==a.mechanism&&q(this.token,a.token)&&this.email==a.email&&this.password==a.password&&this.netflixId==a.netflixId&&this.secureNetflixId==a.secureNetflixId:!1}});ce=function(g){var h=g.mechanism,k=g.token;if(!h||!k||"string"!==typeof k)throw new f(a.JSON_PARSE_ERROR,"SSO authdata "+JSON.stringify(g));
if(!b[h])throw new da(a.UNIDENTIFIED_USERAUTH_MECHANISM,"SSO authdata "+JSON.stringify(g));var u=g.email,v=g.password,C=g.netflixid,A=g.securenetflixid;if(u&&!v||!u&&v||C&&!A||!C&&A||u&&C)throw new f(a.JSON_PARSE_ERROR,"SSO authdata "+JSON.stringify(g));var q;try{q=P(k)}catch(y){throw new da(J.SSOTOKEN_INVALID,"SSO authdata "+JSON.stringify(g),y);}var B;u&&v?B=new d(u,v):C&&A&&(B=new c(C,A));return new dc(h,q,B)}})();Zb.extend({init:function S(){S.base.call(this,Ma.SSO)},createData:function(a,d,c,
f){b(f,function(){return ce(c)})},authenticate:function(b,d,c,f){if(!(c instanceof dc))throw new C("Incorrect authentication data type "+c+".");b=c.token;d=c.email;f=c.password;var g=c.netflixId,h=c.secureNetflixId;if(!b||0==b.length)throw new da(J.SSOTOKEN_BLANK);if(!(null===d&&null===f||d&&f))throw new da(a.EMAILPASSWORD_BLANK);if(!(null===g&&null===h||g&&h))throw(new da(J.NETFLIXID_COOKIES_BLANK)).setUserAuthenticationData(c);throw(new da(a.UNSUPPORTED_USERAUTH_DATA,this.scheme)).setUserAuthenticationData(c);
}});var ec,fe;(function(){ec=tb.extend({init:function G(a,b){G.base.call(this,Ma.SWITCH_PROFILE);Object.defineProperties(this,{userIdToken:{value:a,writable:!1,configurable:!1},profileGuid:{value:b,writable:!1,configurable:!1}})},getAuthData:function(){var a={};a.useridtoken=JSON.parse(JSON.stringify(this.userIdToken));a.profileguid=this.profileGuid;return a},equals:function w(a){return this==a?!0:a instanceof ec?w.base.call(this,a)&&this.userIdToken.equals(a.userIdToken)&&this.profileGuid==a.profileGuid:
!1}});fe=function(d,c,g,h){b(h,function(){if(!c)throw new da(a.USERAUTH_MASTERTOKEN_MISSING);var k=g.useridtoken,u=g.profileguid;if("object"!==typeof k||"string"!==typeof u)throw new f(a.JSON_PARSE_ERROR,"switch profile authdata "+JSON.stringify(g));sb(d,k,c,{result:function(d){b(h,function(){if(!d.isDecrypted())throw new da(a.USERAUTH_USERIDTOKEN_NOT_DECRYPTED,"switch profile authdata "+JSON.stringify(g));return new ec(d,u)})},error:function(b){h.error(new da(a.USERAUTH_USERIDTOKEN_INVALID,"switch profile authdata "+
JSON.stringify(g),b))}})})}})();Zb.extend({init:function G(a){G.base.call(this,Ma.SWITCH_PROFILE);Object.defineProperties(this,{_store:{value:a,writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,b,d,c){fe(a,b,d,c)},authenticate:function(b,d,c,f){if(!(c instanceof ec))throw new C("Incorrect authentication data type "+c+".");d=c.userIdToken;b=c.profileGuid;if(!b)throw(new da(J.PROFILEGUID_BLANK)).setUserAuthenticationData(c);d=d.user;if(!d)throw(new da(a.USERAUTH_USERIDTOKEN_NOT_DECRYPTED)).setUserAuthenticationData(c);
b=this._store.switchUsers(d,b);if(!b)throw(new da(J.PROFILE_SWITCH_DISALLOWED)).setUserAuthenticationData(c);if(f&&(f=f.user,!b.equals(f)))throw(new da(a.USERIDTOKEN_USERAUTH_DATA_MISMATCH,"uad user "+b+"; uit user "+f)).setUserAuthenticationData(c);return b}});var ge,he;(function(){ge=Ec.extend({init:function w(a,b,d,c,f,g,h){w.base.call(this,a,b,d,c,f,g,h)},getNetflixIdentity:function z(){var a=this.getMessageHeader();if(a){var b=a.masterToken;if(b){if(a=b.issuerData)if(a=a[NetflixMslConstants$MASTER_TOKEN_NETFLIX_IDENTITY],
"string"===typeof a)return a;return b.identity}return z(a.entityAuthenticationData)}b=this.getErrorHeader();return z(b.entityAuthenticationData)}});he=function(a,b,d,c,f,g,h){new ge(a,b,d,c,f,g,h)}})();Bd.extend({createInputStream:function(a,b,d,c,f,g,h){he(a,b,d,c,f,g,h)}});A.prototype=Error();A.prototype.constructor=A;var ub;(function(){function b(a,d,c){for(var f=0,g=d?d.length:0;void 0!==a&&f<g;)a=a[d[f++]];return void 0===a?c:a}function f(a,b){var d,c,g;if(a&&b)try{d="",c=nrdp.network.ERRORGROUP,
Object.keys(c).some(function(b){if(a===c[b])return d=b,!0}),g=nrdp.network.ERRORCODE,Object.keys(g).some(function(a){if(b===g[a])return d+=(d?"/":"")+a,!0})}catch(h){}return d}function g(a){return new X(function(b,d){a.oncomplete=b;a.onerror=function(a){d(a.error)}})}function h(a){var b=this;this.promise=new X(function(d,c){b.result=Z.isUndefined(a)?d:function(b){d([b,a])};b.error=c;b.timeout=function(){c(new A)}})}function u(){this.name="no-user"}function q(a,b){var d;a&&Z.isObject(a)&&(d=a.algorithm,
!d||Z.isObject(d)&&!d.name)&&(x.warn("Patching algorithm for",a),a.algorithm=b,x.warn("  Key is now          ",a));return a}function y(){return new X(function(a){var b;b=nrdp.storage.diskStoreContexts;if(!b||!Z.isObject(b))throw"Platform does not support disk store";b=b["msl-backup-tokens"];a(b)})}function E(){return y().then(function(a){if(a)return a;if(!Z.isFunction(nrdp.storage.createDiskStoreContext))throw"Platform doesn't support creating disk store contexts";x.log("Disk store context doesn't exist, creating");
a=nrdp.storage.createDiskStoreContext({context:"msl-backup-tokens",size:5120,encrypted:!1,signed:!1,doubleBuffer:!0,syncWrites:!0});if(!a)throw"Failed to create disk store context";return a})}function P(a){this.config=a;this.name="backup storage"}function L(a){if(a instanceof A)return 1;if(a instanceof ua)return 2;if(a instanceof v&&a.error)switch(a.error.responseCode){case c.TRANSIENT_FAILURE:return 2;case c.USERDATA_REAUTH:return a.error.internalCode==J.NETFLIXID_COOKIES_EXPIRED.internalCode?12:
8;case c.SSOTOKEN_REJECTED:return 10}return 1}function Y(a){return a?""+a.sequenceNumber+":"+a.serialNumber+":"+a.expiration.toISOString()+":"+a.renewalWindow.toISOString():"null"}function B(a){return a?""+a.serialNumber+":"+a.mtSerialNumber+":"+a.expiration.toISOString()+":"+a.renewalWindow.toISOString():"null"}function Aa(){return X.attempt(function(){x.info("Generating AsymmetricWrappedExchange RSA keys");var a={name:"RSA-OAEP",params:{modulusLength:1024,publicExponent:new Uint8Array([1,0,1])}};
return g(k.generateKey(a,!0))}).then(function(a){var b=new h,d=new h;fb(a.target.result.privateKey,b);qb(a.target.result.publicKey,d);return[b.promise,d.promise]}).spread(function(a,b){var d="RKPI"+Math.floor(nrdp.now()/1E3)+Math.floor(1E8*Math.random());return new Ub(d,xc.JWE_RSA,b,a)})}function M(){return X.attempt(function(){x.info("Generating Widevine CDM key");return g(k.generateKey({name:"NFLX-CDM-WIDEVINE"},!0))}).then(function(a){var b=a.target.result;x.log("Exporting CDM key request data");
return g(k.exportKey("raw",b)).then(function(a){a=a.target.result;if(Z.isNumber(a.byteLength)&&!a.byteLength)throw Error("Key request data for Widevine key exchange has zero length");return new Nc(b,a)})})}function K(){return X.attempt(function(){x.info("Generating Widevine CDM JWE key");return g(k.generateKey({name:"NFLX-CDM-JWELE"},!0))}).then(function(a){var b=a.target.result;x.log("Exporting CDM JWE key request data");return g(k.exportKey("raw",b)).then(function(a){return new Oc("JWELE",b,a.target.result)})})}
function N(a,b){var d,c;switch(b){case qa.MGK:d=bb;break;case ja.PSK:d=Za;break;default:x.error("Invalid entity authentication scheme :",b);return}c="MGK"===nrdp.webcrypto.entityAuthenticationType&&"WIDEVINE"===nrdp.webcrypto.keyExchangeType;return X.attempt(function(){return[g(k.getKeyByName("DKE")),g(k.getKeyByName("DKH")),c?null:g(k.getKeyByName("DKW"))]}).all().spread(function(a,b,d){return[q(a.target.result,Oa),q(b.target.result,Ea),c?null:q(d.target.result,ga)].map(function(a,b){var d;if(Z.isNull(a)){if(2===
b&&c)return x.info("Ignoring DKW, not needed"),X.resolve(null);throw Error("Failed to get device key by name");}d=new h;Ha(a,d);return d.promise})}).spread(function(c,f,g){var h,k,u;switch(b){case qa.MGK:h=Pe.extend({init:function Ce(a,b,d,c){Ce.base.call(this,a);Object.defineProperties(this,{_ke:{value:b,writable:!1,enumerable:!1,configurable:!1},_kh:{value:d,writable:!1,enumerable:!1,configurable:!1},_kw:{value:c,writable:!1,enumerable:!1,configurable:!1},_esn:{value:a,writable:!1,enumerable:!1,
configurable:!1}})},getCryptoContext:function De(a,b){return b instanceof d&&this._esn==b.identity?new Tb(a,this._esn,this._ke,this._kh,this._kw):De.base.call(this,a,b)}});break;case ja.PSK:k=Zc.extend({init:function(a,b,d,c){Object.defineProperties(this,{keys:{value:new Yc(b,d,c),writable:!1,enumerable:!1,configurable:!1},identity:{value:a,writable:!1,enumerable:!1,configurable:!1}})},getKeys:function(a){x.warn("identity is",a,this.identity,this.keys);return a===this.identity?this.keys:null}});u=
Me.extend({isEntityRevoked:function(a){return!1},isSchemePermitted:function(a){return!0}});h=bd.extend({init:function Bc(a,b,d,c){Bc.base.call(this,new k(a,b,d,c),new u)}});break;default:x.error("Invalid entity authentication scheme :",b);return}x.info("Created",b.name,"entity auth factory");a._entityAuthFactories[b.name]=new h(a._deviceIdentity,c,f,g);a._entityAuthData=new d(a._deviceIdentity);return[c,f,g]})}function fa(a,b,d,c){var f;switch(d){case qa.MGK:case ja.PSK:break;default:x.error("Invalid entity authentication scheme :",
d);return}if(a.swex)x.info("Using symmetric wrapped exchange"),b._keyRequestDataFactory=function(){return X.attempt(function(){return new Lc(d.name)})},b._keyExchangeFactories.push(new Wd);else if(a.awex)x.info("Using asymmetric wrapped exchange (JWE_RSA)"),b._keyExchangeFactories.push(new Ib),b._keyRequestDataFactory=Aa;else if(nrdp.webcrypto.nflxDhDerive){x.info("Using ADH exchange");switch(d){case qa.MGK:f=Hc.MGK;break;case ja.PSK:f=Hc.PSK}b._keyExchangeFactories.push(b._makeADHExchange(c));b._keyRequestDataFactory=
function(){return b._generateADHExchangeRequestData(f,c.rawKey)}}else{x.info("Using JWE ladder exchange");a=ze.extend({init:function Be(){Be.base.call(this);Object.defineProperties(this,{_contextMap:{value:{},writable:!1,enumerable:!1,configurable:!1}})},addCryptoContext:function(a,b){b&&a&&a.length&&(this._contextMap[D(a)]=b)},getCryptoContext:function(a){return a&&a.length?this._contextMap[D(a)]||null:null},removeCryptoContext:function(a){a&&a.length&&delete this._contextMap[D(a)]}});switch(d){case qa.MGK:f=
Jc.MGK;break;case ja.PSK:f=Jc.PSK}b._keyExchangeFactories.push(new Sd(new a));b._keyRequestDataFactory=function(){return X.attempt(function(){return new Kc(f)})}}}function R(a){return g(k.getKeyByName("WIIU-ECC")).then(function(b){var d;b=b.target.result;if(Z.isNull(b))throw Error("Failed to find named key WIIU-ECC");x.log("Got","WIIU-ECC","key");d=b.algorithm.certificate;if(!Z.isString(d))throw Error("WIIU-ECC key missing 'certificate'");if(!d.length)throw Error("WIIU-ECC key has empty 'certificate'");
a._entityAuthData=new Hb(a._deviceIdentity,null,d);return b}).then(function(a){var b=new h;a.type="private";fb(a,b);return b.promise}).then(function(b){var d=ja.X509,c=kb.extend({init:function Wb(a){Wb.base.call(this,d);Object.defineProperties(this,{_eccKey:{value:a,writable:!1,enumerable:!1,configurable:!1}})},getCryptoContext:function(a,b){if(!(b instanceof Hb))throw new C("Incorrect authentication data type "+JSON.stringify(b)+".");return new vc(a,this._eccKey)}});a._entityAuthFactories[d.name]=
new c(b)}).then(function(){x.info("Using asymmetric wrapped exchange (JWE_RSA)");a._keyExchangeFactories.push(new Ib);a._keyRequestDataFactory=Aa})}function ka(b){return g(k.getKeyByName("XSIGN")).then(function(a){var d;a=a.target.result;if(Z.isNull(a))throw Error("Failed to find named key XSIGN");x.log("Got","XSIGN","key");d=a.algorithm.certificate;if(!Z.isString(d))throw Error("XSIGN key missing 'certificate'");if(!d.length)throw Error("XSIGN key has empty 'certificate'");b._entityAuthData=new Hb(b._deviceIdentity,
null,d);return a}).then(function(a){var b=new h;fb(a,b);return b.promise}).then(function(a){var d=ja.X509,c=kb.extend({init:function Wb(a){Wb.base.call(this,d);Object.defineProperties(this,{_privateKey:{value:a,writable:!1,enumerable:!1,configurable:!1}})},getCryptoContext:function(a,b){if(!(b instanceof Hb))throw new C("Incorrect authentication data type "+JSON.stringify(b)+".");return new Rb(a,"XSIGN",this._privateKey,null,Sb.SIGN_VERIFY)}});b._entityAuthFactories[d.name]=new c(a)}).then(function(){return X.all([g(k.getKeyByName("XWRAP_PUB")),
g(k.getKeyByName("XWRAP_PRIV"))]).spread(function(a,b){var d=new h,c=new h;qb(a.target.result,c);fb(b.target.result,d);return[c.promise,d.promise]})}).spread(function(c,f){x.info("Using asymmetric wrapped exchange (RSA)");var u=Ib.extend({init:function Wb(){Wb.base.call(this)},getCryptoContext:function(b,c,f,u,x){if(!(c instanceof Ub))throw new C("Key request data "+JSON.stringify(c)+" was not created by this factory.");if(!(f instanceof yc))throw new C("Key response data "+JSON.stringify(f)+" was not created by this factory.");
var w=c.keyPairId,A=f.keyPairId;if(w!=A)throw(new aa(a.KEYX_RESPONSE_REQUEST_MISMATCH,"request "+w+"; response "+A)).setMasterToken(u);c=c.privateKey;if(!c)throw(new aa(a.KEYX_PRIVATE_KEY_MISSING,"request Asymmetric private key")).setMasterToken(u);X.all([g(k.unwrapKey(f.encryptionKey,ca.AES_CBC,c.rawKey,!1,ob,"rsa")),g(k.unwrapKey(f.hmacKey,ca.HMAC_SHA256,c.rawKey,!1,pb,"rsa"))]).fail(function(){throw new d(a.UNWRAP_ERROR);}).spread(function(a,b){var d=new h,c=new h;Ha(a.target.result,d);Ha(b.target.result,
c);return[d.promise,c.promise]}).spread(function(a,d){var c=new h;b.getEntityAuthenticationData(null,c);return c.promise.then(function(c){return new wa(b,f.masterToken,c.getIdentity(),a,d)})}).then(x.result.bind(null),function(a){a instanceof v&&a.setMasterToken(u);x.error(a)}).done()}});b._keyExchangeFactories.push(new u);b._keyRequestDataFactory=function(){return X.resolve().then(function(){var a="RKPI"+Math.floor(nrdp.now()/1E3)+Math.floor(1E8*Math.random());return new Ub(a,xc.RSA,c,f)})}})}function pa(a){return g(k.getKeyByName("NAGRA-CDM")).then(function(b){b=
b.target.result;if(Z.isNull(b))throw Error("Failed to find named key NAGRA-CDM");x.log("Got","NAGRA-CDM","key");a._entityAuthData=new ac(a._deviceIdentity);return b}).then(function(b){a._entityAuthFactories[qa.ANYCAST.name]=new Oe(a._deviceIdentity,b)}).then(function(){x.info("Using Nagra/Anycast key exchange");var b=["70af7b2b-6c34-431d-b10a-50bad4f683a4","57f13e19-ecc3-4cb4-87df-5a8760bc4e5f"];a._keyExchangeFactories.push(new Ld);a._keyRequestDataFactory=function(){return X.attempt(function(){x.info("Generating Nagra/Anycast CDM key");
return g(k.generateKey({name:"NAGRA"},!0,["derive"]))}).then(function(a){var d=a.target.result.publicKey,c=a.target.result.privateKey;x.log("Exporting Nagra/Anycast key request data");return g(k.exportKey("raw",d)).then(function(a){a=a.target.result;var d=b.shift();b.push(d);return new Gc(c,d,a)})})}})}function da(d){function C(a,b,d,c,f){var g=[];d&&(g=d.slice(0));c&&(d=c.getMslStore(),c=d.getMasterToken())&&(g=g.concat(d.getServiceTokens(c,null)),f&&(f=f.getUserId())&&(f=d.getUserIdToken(f))&&(g=
g.concat(d.getServiceTokens(c,f))));0===g.length?x.trace("No "+a+" service tokens for request ("+b.n+")"):g.forEach(function(d,c){d?(x.trace(a+" service token "+c+" for request ("+b.n+") : "+d.name),x.dump(d.toJSON())):x.error("st is undefined, wtf.")})}var y=!1,D=!1,E=!1,J=1,aa=Gd.extend({init:function Bc(a,b){Bc.base.call(this);this._deviceIdentity=a;this._eventEmitter=b},_hasUserIdTokens:function(){return!!Object.keys(this.userIdTokens).length},_emit:function(a,b){this._eventEmitter&&this._eventEmitter.emit(a,
b)},setCryptoContext:function Ee(a,b){function d(a){return a?a.sequenceNumber+":"+a.serialNumber+":"+a.expiration.getTime():"<null>"}var c=this.getMasterToken();Ee.base.call(this,a,b);this.markDirty("setCryptoContext ["+d(c)+" TO "+d(a)+"]");this._emit("setCryptoContext",{masterToken:a,cryptoContext:b})},removeCryptoContext:function Fe(a){Fe.base.call(this,a);this.markDirty("removeCryptoContext");this._emit("removeCryptoContext",{masterToken:a})},clearCryptoContexts:function Ge(){Ge.base.call(this);
this.markDirty("clearCryptoContexts");this._emit("clearCryptoContexts")},addUserIdToken:function He(a,b){He.base.call(this,a,b);this.markDirty("addUserIdToken");this._emit("addUserIdToken",{userId:a,userIdToken:b})},removeUserIdToken:function Je(a){Je.base.call(this,a);this.markDirty("removeUserIdToken");this._emit("removeUserIdToken",{userIdToken:a})},clearUserIdTokens:function Ke(){Ke.base.call(this);this.markDirty("clearUserIdTokens");this._emit("clearUserIdTokens")},addServiceTokens:function Le(a){var b=
{"streaming.servicetokens.movie":!0,"streaming.servicetokens.license":!0};a=a.filter(function(a){return a&&!b[a.name]});0<a.length&&(Le.base.call(this,a),this.markDirty("addServiceTokens"),this._emit("addServiceTokens",{tokens:a}))},removeServiceTokens:function Re(a,b,d){Re.base.call(this,a,b,d);this.markDirty("removeServiceTokens");this._emit("removeServiceTokens",{name:a,masterToken:b,userIdToken:d})},clearServiceTokens:function Se(){Se.base.call(this);this.markDirty("clearServiceTokens");this._emit("clearServiceTokens")},
setNpTicket:function(a){if(a)this._npTicketWCKey=a;else{if(!this._npTicketWCKey)return;delete this._npTicketWCKey}this.markDirty("setNpTicket")},getNpTicket:function(){return this._npTicketWCKey},markDirty:function(a){this._loading||(x.log("MslStore dirty ("+a+")"),this._dirty=!0)},eraseUserIdToken:function(a){if(this.userIdTokens[a])return delete this.userIdTokens[a],this.markDirty("eraseUserIdToken"),!0},getBackupTokens:function(a,b){if(!d.mslBackupTokens)return x.log("Backup tokens are disabled"),
X.resolve().then(b).done();(new P(d)).load().spread(function(a,b){x.log("Loaded backup tokens",b);if(!(b&&Z.isObject(b)&&b.mt&&b.uit))throw"Loaded backup tokens don't look good";return b}).fail(function(a){x.warn("Failed to get backup tokens",a)}).then(b).done()},dropBackupTokens:function(){return(new P(d))["delete"]()},load:function(a){var b=this,d,c;return X.attempt(function(){d=nrdp.storage.getItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore");x.log("Attempting to load MslStore");if(d)if(c=JSON.parse(d),
x.log("Loaded MslStore"),E&&x.dump(c),c.di!==b._deviceIdentity)x.warn("MslStore is for a different device: "+c.di),nrdp.storage.removeItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore");else return X.attempt(function(){var d=c.mt,f;b._loading=!0;if(!d)throw Error("No master token found");f=new h;rb(a,d,f);return f.promise}).then(function(d){switch(c.cc){case "symmetric":return X.resolve([c.ek,c.hk].map(function(a){return g(k.getKeyInfo(a)).then(function(a){return a.target.result})})).all().spread(function(a,
b){return[q(a,Oa),q(b,Ea)].map(function(a){var b=new h;Ha(a,b);return b.promise})}).all().spread(function(c,f){var g=new wa(a,d,b._deviceIdentity,c,f);b.setCryptoContext(d,g)}).thenResolve(d);default:throw Error("Unable to load crypto context");}}).then(function(d){var f=c.uit;if(f)return x.log("Parsing user id tokens"),X.attempt(function(){return f.map(function(b){var c=new h({id:b.id,st:b.st});sb(a,b.t,d,c);return c.promise})}).all().then(function(c){var f=[];c.forEach(function(c){var g=c[0],k=
c[1].st;b.addUserIdToken(c[1].id,g);Z.isArray(k)&&k.forEach(function(b){var c=new h;kc(a,b,d,g,null,c);f.push(c.promise.fail(function(a){x.warn("Failed to parse service token from store");return null}))})});return f}).all().then(function(a){a.forEach(function(a){if(a)try{b.addServiceTokens([a]),x.log("Added service token "+a.name)}catch(d){x.warn("Failed to add service token "+a.name)}})})}).then(function(){var a=c.npk;if(a)if("npticket"!=nrdp.webcrypto.authenticationType)x.log("Ignoring saved NP Ticket");
else return x.log("Loading NP Ticket..."),g(k.getKeyInfo(a)).then(function(a){(a=a.target.result)&&b.setNpTicket(a)})}).then(function(){x.log("Finished loading MslStore");b._lastSaved||(b._lastSaved=d)}).fin(function(){delete b._dirty;delete b._loading});else x.warn("No MslStore to load")}).fail(function(a){x.warn("Failed to load MslStore : "+a);nrdp.storage.removeItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore")}).thenResolve()},save:function(a){var b=this,c=b.getMasterToken(),f,g,h=[],k,u=b._lastSaved;
if(this._dirty){delete this._dirty;x.log("Saving MslStore..."+(a?"("+a+")":""));if(c){k={};k.di=b._deviceIdentity;k.mt=c.toJSON();f=[];Object.keys(b.userIdTokens).forEach(function(a){var d=b.getUserIdToken(a),h;d.isBoundTo(c)&&(h=b.getServiceTokens(c,d).map(function(a){return a.toJSON()}),f.push({id:a,t:d.toJSON(),st:h}),!g||d.expiration>g.expiration)&&(g=d)});k.uit=f;if(a=b.getCryptoContext(c))a instanceof Tb?([a.encryptionKey,a.signatureKey].forEach(function(a){a&&h.push(a)}),k.cc="symmetric",k.ek=
a.encryptionKey.handle,k.hk=a.signatureKey.handle):x.error("NrdpMslStore does not know how to persist this kind of CryptoContext");this._npTicketWCKey&&(h.push(this._npTicketWCKey),k.npk=this._npTicketWCKey.handle)}if(k){a=JSON.stringify(k);if(u&&u===a){x.log("Already saved this, skipping it");return}E&&(x.trace("This is what I will save:"),x.dump(k));nrdp.storage.setItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore",a);b._lastSaved=a;x.log("Finished saving MslStore");c&&g&&(d.mslBackupTokens?(x.log("Saving backup tokens",
Y(c),"/",B(g)),(new P(d)).save(JSON.stringify({mt:c.toJSON(),uit:g.toJSON()}))):x.log("Not saving backup tokens"))}else nrdp.storage.removeItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore"),delete b._lastSaved;nrdp.webcrypto.persistKeys(h,function(a){a.success?x.log("Finished persisting MslStore keys"):x.warn("Failed to persist MslStore keys")});nrdp.device.setRegistered&&nrdp.device.setRegistered(b._hasUserIdTokens())}}}),O=Fd.extend({init:function(a){this._client=a;this._entityAuthFactories={};this._keyRequestDataFactory=
this._keyRequestData=null;this._keyExchangeFactories=[];this._mslCryptoContext=new se;this._deviceIdentity=nrdp.device.ESN;x.warn("ESN: "+this._deviceIdentity);this._store=new aa(this._deviceIdentity,a);this._random=new Wa;this._entityAuthData=new xb(this._deviceIdentity)},_generateNPTicket:function(){var a=this,b={name:"RSASSA-PKCS1-v1_5",params:{npticket:!0}};return X.attempt(function(){if(a._generatingNPTicket)throw Error("Already waiting for NP ticket generation, cannot make a new one now");x.log("Creating NP-Ticket");
a._generatingNPTicket=!0;return g(k.generateKey(b,!0)).fin(function(){delete a._generatingNPTicket}).then(function(b){var d=b.target.result.privateKey;x.log("Created NP-Ticket: "+JSON.stringify(b));if(d.algorithm.npTicketFake&&(b=a.getMslStore().getNpTicket())&&!b.algorithm.npTicketFake){var c=1E3*b.algorithm.npTicketExpiration,f=nrdp.now();if(c>f){x.log("Tried to get a new NP-Ticket, but got a fake one, and the old one was real and isn't expired yet, so I'm keeping it");a._entityAuthData||(a._entityAuthData=
new Lb(a._deviceIdentity,b));return}}a.getMslStore().setNpTicket(d);a._entityAuthData=new Lb(a._deviceIdentity,d)})})},_generateADHExchangeRequestData:function(a,b){var d=new Uint8Array([150,148,233,216,217,58,90,199,76,80,155,75,188,232,94,146,19,44,209,156,206,71,125,26,126,71,213,39,217,236,41,21,21,240,184,179,225,234,237,80,6,225,177,185,30,162,91,145,160,27,16,226,232,52,184,214,96,178,227,33,173,100,76,225,168,59,50,141,144,20,238,126,22,241,228,79,254,137,87,154,195,238,71,214,104,182,183,
102,135,194,254,144,163,91,94,96,40,253,4,239,234,136,35,115,236,246,11,162,246,55,228,205,170,27,96,137,214,192,181,97,168,229,32,231,150,222,39,223]),c=new Uint8Array([5]);x.log("Generating DH key");return g(k.generateKey({name:"NFLX-DH",params:{prime:d,generator:c}},!1,["derive"])).then(function(b){var d=b.target.result.publicKey,c=b.target.result.privateKey;x.log("Exporting DH public key");return g(k.exportKey("raw",d)).then(function(b){return new Ic(a,"1",b.target.result,c,null)})})},_makeADHExchange:function(a){var b=
Rd.extend({getDerivationKey:function(b){if(!b)return a}});return new Pd(new b)},prepare:function(){var a=this;x.info("Preparing MslContext...");return X.resolve(a._store.load(a)).then(function(){var b=function(){x.log("Crypto context removed, dropping key request data");this._keyRequestData=null}.bind(a);a._client.addEventListener("removeCryptoContext",b);a._client.addEventListener("clearCryptoContexts",b);a._client.addEventListener("setCryptoContext",b)}).then(function(){var b,c;x.info("Server entity auth keys...");
if(d.noverify)c=cd.extend({getCryptoContext:function(a,b){this._cryptoContext||(this._cryptoContext=new Qb);return this._cryptoContext}}),x.warn("Added NULL RSA auth factory because we are not verifying the server"),a._entityAuthFactories[ja.RSA.name]=new c;else{try{b=nrdp.storage.transientData.appboot.msltruststore.keys,c=Object.getOwnPropertyNames(b).map(function(a){return{identity:a,type:"downloaded",op:k.importKey("spki",b[a],ca.RSASSA_SHA256,!1,["verify"])}})}catch(f){c=d.appboot_key?[{identity:"APPBOOT",
type:"overridden",op:k.importKey("spki",d.appboot_key,ca.RSASSA_SHA256,!1,["verify"])}]:[{identity:"APPBOOT",type:"baked in",op:k.getKeyByName("ABKP")}]}return X.all(c.map(function(a){return new X(function(b,d){var c=a.op;x.info("Importing",a.type,"key for",a.identity);c.onerror=function(a){d(a.error)};c.oncomplete=function(d){b({identity:a.identity,key:d.target.result})}})})).then(function(a){return X.all(a.map(function(a){var b=new h,d;x.info("Creating MSL PublicKey for",a.identity);d=b.result;
b.result=function(b){d({identity:a.identity,key:b})};qb(a.key,b);return b.promise}))}).then(function(b){var d=new te,c=0,f=new ue,g=0;b.forEach(function(a){"ECDSA"===(a.key.rawKey&&a.key.rawKey.algorithm.name)?(x.info("Adding key to ECC store",a.identity),f.addPublicKey(a.identity,a.key),++g):(x.info("Adding key to RSA store",a.identity),d.addPublicKey(a.identity,a.key),++c)});c&&(a._entityAuthFactories[ja.RSA.name]=new cd(void 0,d));g&&(a._entityAuthFactories[ja.ECC.name]=new ve(void 0,f))}).fail(function(a){x.error("Failed to set-up server entity auth keys : "+
a.toString())})}}).then(function(){var b=nrdp.webcrypto.entityAuthenticationType,c=nrdp.webcrypto.keyExchangeType;if("MGK"===b&&"WIDEVINE"===c)return x.info("Entity authentication",b,": key exchange",c),N(a,qa.MGK).then(function(){a._keyExchangeFactories.push(new Mc);a._keyRequestDataFactory=M});Z.isUndefined(c)||x.info("Ignoring key exchange type",c,"provided by the platform");b=d.unauth?"UNAUTHENTICATED":nrdp.webcrypto.authenticationType;x.info("Device authentication type is",b);switch(b){case "PSK":return x.info("Device authentication using PSK"),
N(a,ja.PSK).spread(function(b,c,f){fa(d,a,ja.PSK,f)});case "MGK":return x.info("Device authentication using MGK"),N(a,qa.MGK).spread(function(b,c,f){fa(d,a,qa.MGK,f)});case "npticket":return x.info("Device authentication using NP-Ticket"),X.attempt(function(){var b=a.getMslStore().getNpTicket(),c,f,g;if(b)if(x.info("Checking saved NP-Ticket"),g=nrdp.now(),c=1E3*b.algorithm.npTicketIssue,f=1E3*b.algorithm.npTicketExpiration,c+d.npticket_interval<g)x.warn("NP-Ticket was issued more than 4 hours ago : issued="+
c+"ms, now="+g+"ms, expiration="+f+"ms");else if(f<=g)x.warn("NP-Ticket is expired : issued="+c+"ms, now="+g+"ms, expiration="+f+"ms");else{x.info("Saved NP-Ticket seems good");a._entityAuthData=new Lb(a._deviceIdentity,b);return}else x.info("No saved NP-Ticket, making a new one");return a._generateNPTicket()}).then(function(){a._entityAuthFactories[qa.NPTICKET.name]=new Qe;a._keyExchangeFactories.push(new Ib);a._keyRequestDataFactory=Aa});case "UNKNOWN":case "UNAUTHENTICATED":x.warn("Using unauthenticated auth factory - NOT using device keys");
a._entityAuthFactories[ja.NONE.name]=new ed;a._entityAuthData=new xb(a._deviceIdentity);d.mslClear?x.warn("Configured for clear messages - NO key exchange"):(a._keyExchangeFactories.push(new Ib),a._keyRequestDataFactory=Aa);break;case "CDM":x.warn("Using unauthenticated auth factory - NOT using device keys");a._entityAuthFactories[ja.NONE.name]=new ed;a._entityAuthData=new xb(a._deviceIdentity);if(!nrdp.webcrypto.cdmDerive)throw Error("Platform does not support CDM key exchange");a._keyExchangeFactories.push(new Mc);
a._keyRequestDataFactory=M;break;case "CDM_JWE":x.info("Device authentication using MGK");if(!nrdp.webcrypto.cdmDerive)throw Error("Platform does not have cdmDerive");return N(a,qa.MGK).then(function(){a._keyExchangeFactories.push(new Zd);a._keyRequestDataFactory=K});case "ecclink":x.info("Device authentication using ECC Ninentdo");if(!nrdp.webcrypto.eccSign)throw Error("Platform does not have eccSign");return R(a);case "NAGRA":case "ANYCAST":x.info("Device authentication using Nagra/Anycast");if(!nrdp.webcrypto.cdmSign)throw Error("Platform does not have cdmSign");
return pa(a);case "x509_COMCAST":return x.info("Device authentication using x509 Comcast"),ka(a);default:throw Error('Unrecognized authentication type "'+nrdp.webcrypto.authenticationType+'" from nrdp.webcrypto.authenticationType');}})},getTime:function(){return nrdp.now()},getRandom:function(){return this._random},isPeerToPeer:function(){return!1},getMessageCapabilities:function(){var a=[],b=this._client.getUserProvider().getCurrentUserLanguages()||[],b=b.concat(nrdp.device.language);"lzw"===d.compress&&
a.push(Qa.LZW);"none"!==d.compress&&a.push(Qa.GZIP);return new Vb(a,b)},getEntityAuthenticationData:function(a,b){var d=this;X.attempt(function(){if(a&&(x.log("Entity re-auth"),"npticket"==nrdp.webcrypto.authenticationType))return d._generateNPTicket()}).then(function(){b.result(d._entityAuthData)},function(a){b.error(a)}).done()},getMslCryptoContext:function(){return this._mslCryptoContext},getEntityAuthenticationFactory:function(a){return this._entityAuthFactories[a.name]},getUserAuthenticationFactory:function(a){return null},
getTokenFactory:function(){return null},getKeyExchangeFactory:function(a){return this.getKeyExchangeFactories().filter(function(b){return b.scheme.name==a.name})[0]},getKeyExchangeFactories:function(){return this._keyExchangeFactories},getMslStore:function(){return this._store},getEntityAuthenticationScheme:function(a){return Vc(a)},getUserAuthenticationScheme:function(a){return Dd(a)},getKeyExchangeScheme:function(a){return id(a)},getKeyRequestData:function(a){var b=this,c=b._keyRequestData;d.nokeyx?
(x.warn("No key exchange - as requested"),a.result([])):X.attempt(function(){if(c)return c;x.info("Don't have key request data, creating one...");if(!b._keyRequestDataFactory)throw Error("Missing a key request data factory");return b._keyRequestDataFactory()}).then(function(d){if(!d)throw Error("Request data factory returned null");b._keyRequestData=d;a.result([d])}).fail(function(b){d.mslClear?(x.warn("No key exchange - configured for clear messages, not including key request data"),a.result([])):
(x.error("Failed to create key request data.","This usually means that the MSL client has been reset.",b.toString()),a.error(b))})}}),T=Ie.extend({init:function(a){this._requestInfo=a},sentHeader:function(a){try{var b=a.masterToken,d=a.userIdToken,c,f,g,h,k="-> ["+this._requestInfo.n+"."+ ++this._requestInfo.r+"] "+this._requestInfo.url,k=k+(" mid="+a.messageId+" mt="+Y(b)),k=k+(" nrp="+!!a.nonReplayable+" ren="+!!a.renewable),k=k+(" nrpid="+a.nonReplayableId),k=k+(" hshk="+!!a.handshake),k=k+(" uit="+
B(d));if(c=a.userAuthenticationData)k+=" uad="+JSON.stringify(c.toJSON());if(h=a.entityAuthenticationData)k+=" ead="+JSON.stringify(h.toJSON());(f=a.serviceTokens)&&f.length&&(k+=" st=[",f.forEach(function(a,b){b&&(k+=",");k+=a.uniqueKey()}),k+="]");(g=a.keyRequestData)&&g.length&&(k+=" krd=[",g.forEach(function(a,b){b&&(k+=",");k+=JSON.stringify(a.toJSON())}),k+="]");x.log(k)}catch(u){}},receivedHeader:function(a){try{var b,d,c,f,g="<- ["+this._requestInfo.n+"."+this._requestInfo.r+"] "+this._requestInfo.url;
a instanceof yb?g+=" mid="+a.messageId+" error="+a.internalCode+" ["+a.errorCode+"] "+a.errorMessage:a instanceof zb&&(b=a.masterToken,d=a.userIdToken,g+=" mid="+a.messageId+" mt="+Y(b),g+=" nrp="+!!a.nonReplayable+" ren="+!!a.renewable,g+=" uit="+B(d),(c=a.serviceTokens)&&c.length&&(g+=" st=[",c.forEach(function(a,b){b&&(g+=",");g+=a.uniqueKey()}),g+="]"),f=a.keyResponseData)&&(b=f.masterToken,g+=" krd-mt="+Y(b));x.log(g)}catch(h){}}}),U=Xb.extend({init:function(a,b,d,c,f,g,h,k,u,r){var v=null,w=
a.getUserProvider();f=Z.isUndefined(f)||Z.isNull(f)?!0:!!f;g=Z.isUndefined(g)||Z.isNull(g)?!0:!!g;h=!!h||u;r&&(x.log("Using custom tokens that were passed in to the message context"),this.tokens=r);d&&Z.isObject(d)?(v=d,x.warn("Using message-specific account",v)):(Z.isUndefined(d)&&(d=w.getCurrentUserId(),x.log("User provider",w.name,"says the current user is",d)),d&&(r=w.getUserAuthToken(d),x.log("User provider",w.name,"tokens for",d,"are",r),r?v={id:d,tokens:r}:x.warn("No tokens for user id",d)));
d&&!v&&(v={id:d});Object.defineProperties(this,{_client:{value:a,writable:!1},_account:{value:v,writable:!1},_payload:{value:c,writable:!1},_encrypted:{value:f,writable:!1},_replayable:{value:g,writable:!1},_requestingTokens:{value:h,writable:!1},_serviceTokens:{value:k,writable:!1},_requestInfo:{value:b,writable:!1},_forceUserAuthData:{value:!!u,writable:!1}})},getCryptoContexts:function(){this._cryptoContexts||(this._cryptoContexts={});return this._cryptoContexts},getRecipient:function(){},isEncrypted:function(){return d.mslClear?
(x.warn("Message will NOT be encrypted"),!1):this._encrypted},isIntegrityProtected:function(){return d.mslClear?(x.warn("Message will NOT be integrity protected"),!1):!0},isNonReplayable:function(){return!this._replayable},isRequestingTokens:function(){return!!this._requestingTokens},getUserId:function(){if(this._account)return this._account.id;x.log("No account associated with this request");return null},getUserAuthData:function(a,b,d,c){var f=null,g=this._account,k,u,v;x.log("reauthCode",a,": renewable",
b,": required",d);if(g)if(a)x.error("Asked to reauth user auth data, need to log in again");else if(this._forceUserAuthData||d||!this._client.getUserIdToken(g.id,!0))if(this._forceUserAuthData&&x.log("User auth data is being forced for this message"),d&&x.log("User auth data is required for this message"),k=this.tokens||g.tokens,!k)x.log("User id "+g.id+" does not have email/password or netflix");else if(k.ssoService&&k.ssoToken)"xboxsaml"==k.ssoService.toLowerCase()?(v=Rc.MICROSOFT_SAML,x.log("Will use XBox SAML SSO user auth data")):
"xboxjwt"==k.ssoService.toLowerCase()&&(v=Rc.MICROSOFT_JWT,x.log("Will use XBox JWT SSO user auth data")),v&&(k.email&&k.password?(x.log("Including SSO email/password user auth data for "+g.id),u=new de(k.email,k.password)):k.NetflixId&&k.SecureNetflixId&&(x.log("Including SSO netflix id user auth data for "+g.id),u=new ee(k.NetflixId,k.SecureNetflixId)),f=new dc(v,k.ssoToken,u));else if(k.email&&k.password)x.log("Including email/password user auth data for "+g.id),f=new $b(k.email,k.password);else if(k.uit&&
k.customerGuid)x.log("Including switch profile user auth data for",g.id),f=new ec(k.uit,k.customerGuid);else if(k.NetflixId&&k.SecureNetflixId)x.log("Including netflix id user auth data for "+g.id),f=new cc(k.NetflixId,k.SecureNetflixId);else if(k.mdxControllerToken)x.log("Including mdx controller auth data"),a=(new bc("regpairrequest",k.mdxNonce,k.mdxEncryptedPinB64,k.mdxSignature)).getEncoding(),f=new Mb(void 0,k.mdxPin,k.mdxControllerToken,a,k.mdxSignature);else{if(k.mt&&k.uit){x.log("Including user id token auth data for",
g.id);x.log("Parsing UIT auth data tokens");var w=this._client.getMslContext();a=new h;rb(w,k.mt,a);return a.promise.then(function(a){var b=new h;sb(w,k.uit,a,b);return b.promise.then(function(b){if(!a||!b)throw"Ended up with falsy tokens";x.log("UIT auth data tokens parsed");return new Fc(a,b)})}).then(c.result,c.error).done()}}else x.log("Already have a user id token for "+g.id+" and this is not a reauth - will not send auth data");else x.log("No account associated with this request");c.result(f)},
getUser:function(){return null},getKeyRequestData:function(a){this._client.getKeyRequestData(a)},updateServiceTokens:function(a,b,d){var c=!0;b||this._serviceTokens&&this._serviceTokens.forEach(function(b){b?(x.log("Adding service token to outbound message : "+b.name),c=c&&a.addPrimaryServiceToken(b)):x.error(">>> MSL message has NULL service token <<<")});c?d.result(!0):d.error(Error("Failed to update all service tokens"))},write:function(a,b,c){var f=this._payload;X.attempt(function(){var c;switch(d.compress){case "none":break;
default:return}c=new h;x.trace("Configuring output stream without compression");a.setCompressionAlgorithm(null,b,c);return c.promise}).then(function(){var d,c=new h;Z.isObject(f)&&f.constructor==Uint8Array||(f=sa(f));d=f.length;a.write(f,0,d,b,c);return c.promise.then(function(c){var f=new h;if(c!==d)throw new ua("Message context did not write all bytes");a.close(b,f);return f.promise})}).then(function(){c.result(!0)}).fail(function(a){x.error("Exception writing : "+a);a instanceof A?c.timeout():
c.error(a)}).done()},getDebugContext:function(){return na.isDebug()?new T(this._requestInfo):null}}),ga=ua.extend({init:function Te(a,b){var d;this.mesg=a;this.url=b.url;this.errorCode=b.errorcode;this.errorGroup=b.errorgroup;this.nativeerrorCode=b.nativeerrorCode;this.finalUrl=b.finalURL;this.serverIp=b.serverIp;this.httpCode=b.statusCode;if(d=f(this.errorGroup,this.errorCode))this.mesg+=" ["+d+"]";Te.base.call(this,a)}}),ya=ye.extend({init:function(a,b,d){this._client=a;this._url=b;this._info=d},
getResponse:function(a,b,c){function f(a){q&&h.clearTimeout(q);if(z)x.warn("load callback was called again");else{z=!0;var b={dt:a.dnsTime||0,ct:a.connectTime||0,tt:a.transactionTime||0,du:a.duration||0,serverIp:a.serverIp};nrdp.instrumentation.startInterval(nrdp.instrumentation.SWITCHED,"nrdjs.handle-msl-response/"+u.n);u.networkTime=nrdp.mono()-C;u.netStats=b;y&&x.dump(a);x.log("  HTTP took "+u.networkTime+" ms ("+A+","+a.size+" bytes) ["+b.dt+","+b.ct+","+b.tt+"="+b.du+" ("+(u.networkTime-b.du)+
")] for request ("+u.n+") "+k);x.log(a.headers);try{switch(a.reason){case h.SUCCESS:b={};if(200===a.statusCode){b.json=a.json||null;u.simnetOverride=a.simnetOverride;c.result(b);break}throw new ga("HTTP status code "+a.statusCode,a);case h.TIMEOUTERROR:throw new ga("TIMED_OUT_ERROR",a);case h.NOTSECUREERROR:throw new ga("NOT_SECURE_ERROR",a);case h.FILEACCESSERROR:throw new ga("FILE_ACCESS_ERROR",a);case h.DATAURIERROR:throw new ga("DATA_URI_ERROR",a);case h.DNS_ERROR:throw new ga("DNS_ERROR",a);
case h.CONNECT_ERROR:throw new ga("CONNECT_ERROR",a);case h.SSLHANDSHAKEERROR:throw new ga("SSL_HANDSHAKE_ERROR",a);case h.SSLCACERTERROR:throw new ga("SSL_CA_CERT_ERROR",a);case h.SSLCACERTFILEERROR:throw new ga("SSL_CA_CERT_FILE_ERROR",a);case h.CERTSTATUSSSLERROR:throw new ga("CERT_STATUS_ERROR",a);case h.CERTSTATUSREVOKED:throw new ga("CERT_REVOKED_ERROR",a);case h.CERTSTATUSPEWREVOKED:throw new ga("CERT_PEW_REVOKED_ERROR",a);case h.SENDERROR:throw new ga("SEND_ERROR",a);case h.RECVERROR:throw new ga("RECV_ERROR",
a);case h.COMPRESSIONERROR:throw new ga("COMPRESSION_ERROR",a);case h.SECURITYERROR:throw new ga("SECURITY_ERROR",a);case h.NETWORKERROR:throw new ga("NETWORK_ERROR",a);default:throw new ga(200<a.statusCode?"HTTP_ERROR":"UNKNOWN ["+a.reason+"]",a);}}catch(d){x.error("Request ("+u.n+") to "+k+" failed : "+d.mesg+" : "+JSON.stringify(d)),g._client.emit("requestError",{exception:d,response:a}),c.error(d)}}}var g=this,h=nrdp.gibbon,k=this._url,u=this._info,r=""+Math.floor(nrdp.now()/1E3)+Math.floor(1E8*
Math.random()),v={url:k,headers:{"X-Gibbon-Cache-Control":"no-cache","X-AllowCompression":"true","X-Client-Request-Id":r},body:a.body,async:!0,secure:!0,timeout:b||void 0,connectTimeout:b/2||void 0,stallTimeout:b||void 0,format:"jsonstream"},w,C=nrdp.mono(),A=a.body.length,z,q,B;Z.isNumber(b)&&(v.headers["X-Netflix.request.expiry.timeout"]=""+b);nrdp.device.deviceModel&&(v.headers["X-DeviceModel"]=nrdp.device.deviceModel);d.noss&&(v.headers["X-Netflix.esn"]=nrdp.device.ESN);if(u.headers&&Z.isObject(u.headers))for(B in u.headers)v.headers[B]=
u.headers[B];u.mslPayload&&(v.mslPayload=u.mslPayload);u.clientRequestId=r;x.log("  Making HTTP request ("+u.n+") ["+r+"] request body is "+a.body.length+" bytes "+k);y&&x.dump(v);nrdp.instrumentation.endInterval(nrdp.instrumentation.SWITCHED,"nrdjs.prepare-msl-request/"+u.n);w=h.load(v,f);d.mslFallbackTimer&&(q=setTimeout(function(){x.error("Failing request on artifical timeout of "+(b+1E3)+" ms");h.stopLoad(w);q=null;f({reason:h.TIMEOUTERROR,size:0,url:k,finalURL:k,errorcode:nrdp.network.ERRORCODE.TIMEOUTERROR,
errorgroup:nrdp.network.ERRORGROUP.CONNECTIVITY_ERROR,nativeerrorCode:0,serverIp:"",statusCode:0})},b+1E3));return{abort:function(){x.warn("Aborting request ("+u.n+") : ID "+w);h.stopLoad(w)}}}});this._prepare=function(){y=d.trace_msl_requests;D=d.trace_msl_service_tokens;E=d.trace_msl_store;x.info("Creating MslControl...");this._mslControl=new Cd;x.info("Creating MslContext...");this._mslContext=new O(this);return this._mslContext.prepare().thenResolve(this)};this.request=function(b,d,c,f,g,k,u,
w,A,z,q,y,B){var E=this,P=nrdp.mono(),L={url:b,n:J++,r:0,headers:B};nrdp.instrumentation.startInterval(nrdp.instrumentation.SWITCHED,"nrdjs.prepare-msl-request/"+L.n,{url:b,n:L.n});x.log("Making MSL request ("+L.n+") payload is "+(c.byteLength||c.length)+" bytes "+b);"undefined"!==typeof simnet&&(L.mslPayload=c);return X.attempt(function(){var a=new U(E,L,d,c,g,k,u,w,A,y),v=new h,B=new hd(new ya(E,b,L));z&&(x.info("Getting new message context from message context factory"),a=z(E._mslContext,a)||a,
nrdp.assert(Z.isObject(a)));D&&C("outbound",L,w,E._mslContext,a);q&&(x.info("Getting URL from URL factory"),B=q(E._mslContext,a,b,L,B)||B,nrdp.assert(Z.isObject(B)));E._mslControl.request(E._mslContext,a,B,f||-1,v);return v.promise}).then(function(a){if(!a)throw Error("No MSL channel returned");return a}).fail(function(a){x.log("<- ["+L.n+"."+L.r+"] "+L.url+" e="+a.toString());throw a;}).then(function(b){b=b.input;var d=b.getErrorHeader(),c=b.getMessageHeader();if(d)throw x.error("MSL response has error header : "+
d.internalCode+" ["+d.errorCode+"] "+d.errorMessage),new v(new a(d.internalCode,d.errorCode,d.errorMessage));d=c.serviceTokens;D&&C("inbound",L,d);c=new h;b.read(-1,f,c);return[c.promise,X.resolve(d)]}).spread(function(a,b){Z.isFunction(L.simnetOverride)&&(a=L.simnetOverride(a),delete L.simnetOverride);return{body:a||new Uint8Array,serviceTokens:b,requestInfo:L}}).fin(function(){E._mslContext.getMslStore().save("After a request");x.log("  MSL took "+(nrdp.mono()-P-(L.networkTime||0))+" ms for request ("+
L.n+") "+b);nrdp.instrumentation.endInterval(nrdp.instrumentation.SWITCHED,"nrdjs.handle-msl-response/"+L.n,{url:b,n:L.n})})};this.send=function(a,b){var d=this;X.attempt(function(){return d.request(a.url,a.userId,a.body,a.timeout,a.encrypted,a.replayable,a.requestingTokens,a.serviceTokens,a.forceUserAuthData,void 0,void 0,a.customTokens,a.headers)}).then(function(a){try{x.trace("MSL networkstats:"+JSON.stringify(a.requestInfo.netStats)),b({success:!0,body:la(a.body),serviceTokens:a.serviceTokens,
requestInfo:a.requestInfo})}catch(d){x.error("Exception in MSL callback : "+d.toString()+"\n"+d.stack)}}).fail(function(f){var g,h,k={mslError:f,errorActionId:L(f),errorIsTimeout:!!(Z.isString(f.mesg)&&-1<f.mesg.indexOf("TIMED_OUT_ERROR")),errorSubCode:1300};f instanceof v&&f.error&&(k.mslErrorInternalCode=f.error.internalCode,k.mslErrorResponseCode=f.error.responseCode,k.mslErrorMessage=f.error.message);x.error("MSL request failed : "+f.toString()+(f.cause&&f.cause.toString?" (caused by "+f.cause.toString()+
")":"")+" : ACTION ID "+k.errorActionId+" : "+a.url);try{f instanceof v&&f.error&&f.error.responseCode===c.USERDATA_REAUTH&&(h=d.getUserProvider(),(g=a.userId||h.getCurrentUserId())&&Z.isObject(g)&&(g=g.id),g&&(x.warn("User data reauth for provider",h.name,"user",g),h.userDataReauth(g),x.warn("Dropping user id token for user",g),d.removeUserIdToken(g))),b(k)}catch(u){x.error("Exception in MSL error callback : "+u.toString()+"\n"+u.stack)}}).done()};this.sendWithRetries=function(a,b,d,c){var f=this;
c="number"===typeof c?c:0;Z.isObject(a.headers)||(a.headers={});a.headers["X-Netflix.request.attempt"]=""+(c+1);f.send(a,function(g){"undefined"!==typeof g.mslError&&2==g.errorActionId&&c<b?(x.info("MSL request failed with retryable condition, will retry "+(b-c)+" more times : "+JSON.stringify(g)+" : "+a.url),g=1E3*Math.pow(2,c),x.info("will retry MSL request in "+g+"ms"),setTimeout(function(){f.sendWithRetries(a,b,d,c+1)},g)):(c===b&&(x.warn("MSL request failed with retryable condition, but we've already retried "+
b+" times, so we'll report it as non-retryable"),g.errorActionId=1,x.warn("responding with "+JSON.stringify(g))),d(g))})};this.getRandom=function(){return this._mslContext.getRandom()};this.getKeyRequestData=function(a){return this._mslContext.getKeyRequestData(a)};this.getMslStore=function(){return this._mslContext.getMslStore()};this.getUserIdToken=function(a,b){var d=this.getMslStore(),c=d.getUserIdToken(a);c&&b&&((d=d.getMasterToken())&&c.isBoundTo(d)||(c=null));return c};this.removeUserIdToken=
function(a){var b=this.getMslStore();if(a=b.getUserIdToken(a))b.removeUserIdToken(a),b.save()};this.eraseUserIdToken=function(a){return this.getMslStore().eraseUserIdToken(a)};this.clearUserIdTokens=function(){var a=this.getMslStore();a.clearUserIdTokens();a.save()};this.parseServiceToken=function(a,b,d){var c=this;X.attempt(function(){var d=c.getMslStore(),f=d.getMasterToken(),d=d.getUserIdToken(a),g;if(b&&f&&d)return g=new h,kc(this._mslContext,b,f,d,null,g),g.promise}).fail(function(a){x.warn("Failed to parse service token",
a)}).then(function(b){b?x.trace("Parsed service token "+b.name+" for account "+a):x.trace("Did not parse the service token for account "+a);d(b)}).done()};this.getNpTicketCookie=function(){var a=this.getMslStore().getNpTicket();return b(a,["algorithm","npTicket"])};this.isNpTicketFake=function(){var a=this.getMslStore().getNpTicket();return b(a,["algorithm","npTicketFake"])};this.generateNpTicket=function(a,b){var d=this;X.attempt(function(){if("npticket"!=nrdp.webcrypto.authenticationType)throw Error("Not npticket authentication type");
a&&(x.warn("Dropping existing NP-Ticket"),d.getMslStore().setNpTicket(null));return d._mslContext._generateNPTicket()}).then(function(){return d.getNpTicketCookie()},function(a){x.error("Failed to make new NP-Ticket : "+a.toString())}).then(function(a){b&&b(a)}).done()};this.resetMslContext=function(){x.warn("MSL Context has been reset and it will no longer function properly");this._mslContext=new O(this)};this.getMslContext=function(){return this._mslContext};this.getBackupTokens=function(a){this.getMslStore().getBackupTokens(this._mslContext,
a)};this.dropBackupTokens=function(){return this.getMslStore().dropBackupTokens()};this.setUserProvider=function(a){x.info("Setting MSL user provider to",a.name);this._userProvider=a};this.getUserProvider=function(){this._userProvider||(this._userProvider=new u);return this._userProvider};ha(Pa,this)}var na=U("../../nrdjs_modules/nf-console"),x=new na("MSL"),X=U("../../nrdjs_modules/nf-promise"),ha=U("nf-mixin"),Pa=U("nf-events").EventEmitter,Z=U("nf-underscore");Va(k);Sc(k.subtle);Nb(Fb.LEGACY);
u.prototype.getCurrentUserId=function(){};u.prototype.getCurrentUserLanguages=function(){};u.prototype.getUserAuthToken=function(a){};u.prototype.userDataReauth=function(a){};var Oa={name:"AES-CBC"},Ea={name:"HMAC",params:{hash:"SHA-256"}},ga={name:"AES-KW"};P.prototype.load=function(){var a=this.name;x.log("Loading from",a);return y().then(function(b){if(!b)throw"Disk store context does not exist";return new X(function(d,c){b.read(nrdp.storage.NO_DEVICE_ACCOUNT,"msl-backup-tokens",-1,-1,function(b){var f;
if(!b.success)return c("Disk store context 'read' failed");b=b.value;if(!b)return c("Disk store context read returned and empty value");b=la(b);if(!b)return c("UTF8 conversion of value returned an empty string");f=JSON.parse(b);if(!f||!Z.isObject(f))return c("Loaded data from "+a+" is falsy or not an object");d([b,f])})})})};P.prototype["delete"]=function(){x.log("Deleting from",this.name);return y().then(function(a){if(a)return new X(function(b,d){a.remove(nrdp.storage.NO_DEVICE_ACCOUNT,"msl-backup-tokens",
function(a){if(!a.success)return d("Disk store context 'remove' failed");b()})})})};P.prototype.save=function(a){var b=this.name;x.log("Saving to",b);return E().then(function(d){return new X(function(c,f){d.create(nrdp.storage.NO_DEVICE_ACCOUNT,"msl-backup-tokens",sa(a),function(a){if(!a.success)return f("Disk store context 'create' failed");x.log("Finished saving to",b);c()})})}).fail(function(a){x.warn("Failed to save to",b,":",a)})};ub=function(a){return X.attempt(function(){return(new da(a))._prepare()})}})();
Nb(Fb.LEGACY);ub.TimeoutError=A;ub.MslException=v;ub.MslEncodingException=f;ub.MslIoException=ua;ub.MslCryptoException=d;ub.MslConstants$ResponseCode=c;ea.exports=ub},{"../../nrdjs_modules/nf-console":15,"../../nrdjs_modules/nf-promise":17,"nf-events":10,"nf-mixin":11,"nf-streaming-config":12,"nf-underscore":13}],3:[function(U,ea,ra){ea.exports={env:["env","prod"],debug:["debug",function(){return!(!nrdp.debug&&!nrdp.log.haveTracing)}],tturl:["tturl",""],useLicenseCache:[["uselc","useLicenseCache"],
!0],lc_use_std:["lc_use_std",!1],ldl_expiration_ms:[["ldl_expiration_ms","licenseCacheExpirationMs"],6E5],ldl_purge_percent:["ldl_purge_percent",25],check_instr:["check_instr",!1],nologcheck:["nologcheck",!1],hblog:["hblog",!1],logblob_post_url:["logblob_post_url",""],npticket_interval:["npticket_interval",144E5],nopbr:["nopbr",!1],log64:["log64",!1],nccp_post_url:["nccp_post_url",""],license_offset:["license_offset",0],swex:["swex",!1],awex:["awex",!1],noss:["noss",!1],trace_msl_requests:["trace_msl_requests",
!1],trace_msl_service_tokens:["trace_msl_service_tokens",!1],trace_msl_store:["trace_msl_store",!1],mslFallbackTimer:["mslFallbackTimer",!0],noverify:["noverify",!1],unauth:["unauth",!1],compress:["compress",""],mslClear:["mslClear",!1],nccp_version:["nccp_version","3.1"],nccp_url:["nccp_url",""],apiHost:["apiHost",""],mslBackupTokens:["mslBackupTokens",!0],useMediaDiskCache:["useMediaDiskCache",!1]}},{}],4:[function(U,ea,ra){function K(b){var g;if(b&&A.isObject(b)){g=b.streamingLabels;try{A.isString(g)&&
(a.trace("subConfigs:",g),g=JSON.parse(g))}catch(h){a.warn("Failed to parse streamingLabels:",h.toString())}g&&A.isObject(g)&&(Pa={},pa=b,A.each(g,function(b,g){var h="'"+g+"'",k=b;try{A.isString(k)||(k=JSON.stringify(k)),k=JSON.parse(k)}catch(q){a.warn("Failed to parse config labeled",h,":",q.toString());return}k&&A.isObject(k)?(a.trace("Found config labeled",h),Pa[g]=k):a.warn("Labeled config",h,"is not an object")}))}}function q(b){var g=b.userId,h,k;b.streamingConfig?D.resolve().then(function(){a.info("Streaming config for",
g,"has already been fetched by profiles!");nrdp.setConfigData("streaming",b.streamingConfig);ya()}).done():(b.fetchConfig&&(a.info("Fetching config for 'userChanged' event :",b),sa()),h=nrdp.storage.getItem(g,"_config_"),a.dump("Saved config for",g,"is",h),h?A.isObject(h)?ha.persistConfig?A.each(h,function(b,g){b&&g&&A.isObject(b)&&A.isString(g)?(a.trace('Restoring saved config "'+g+'"'),b.configRestored=!0,nrdp.setConfigData(g,b)):(a.log("Skipping bad entry in saved config"),k||(k="has a bad entry"))}):
k="persistConfig is false":k="it is not an object":a.trace("No saved config"),k&&(a.warn("Deleting saved config :",k),nrdp.storage.removeItem(g,"_config_")))}function y(b){b&&(na.clear(),a.log("Attaching to user provider",b.name),na.on(b,"userChanged",q))}function E(){function b(a){return a&&A.isObject(a)?Object.keys(a).sort().reduce(function(b,g){b[g]=a[g];return b},{}):a}function g(q){var A=q.name;q=q.data;var y="streaming"===A,E=q&&q.configRestored,D=0;h.isDebug()&&a.dump('NRDP "'+A+'" config changed',
b(q));y&&("nrdp.error"===q.groupName&&a.error("Streaming config service returned defaults because of a server-side error"),K(q),D+=ha.set(q,!0,a),D+=ha.override({haveStreamingConfig:!0},!1,a),k(E?"(persisted)":"(provided)"));D&&ha.dump(a,!1);!E&&ha.persistConfig&&"undefined"!==typeof nrdjs&&(E=nrdjs.userProvider.getCurrentUserId())&&(a.trace("Saving config for",E),y=nrdp.storage.getItem(E,"_config_")||{},y[A]=q,nrdp.storage.setItem(E,"_config_",y))}var q=nrdp.device.SDKVersion&&nrdp.device.SDKVersion.components&&
nrdp.device.SDKVersion.components.nrdapp,y="string"==typeof q&&(0===q.indexOf("2014.1")||2014>parseInt(q.substr(0,4),10));if(ha.ignoreSetConfigData)a.warn("Will ignore setConfigData");else if(y){a.warn("NRDAPP version is",q,': overriding nrdp.setConfigData because there is no "configChanged" event');var E=nrdp.setConfigData.bind(nrdp);nrdp.setConfigData=function(a,b){E(a,b);g({name:a,data:b})}}else nrdp.addEventListener("configChanged",g)}function g(b,g){var h;if(Sa)return a.trace("Config loader already initialized"),
ha;if(nrdp.isReady){Sa=!0;a.info("Initializing config loader");ha.declare(la);h=(nrdp.gibbon.location.split("?",2)[1]||"").split("&").filter(function(a){return 0===a.indexOf("env=")||0===a.indexOf("nrdjsOptions=")}).reduce(function(a,b){var g=b.indexOf("=");a[b.substr(0,g)]=decodeURIComponent(b.substr(g+1));return a},{});h.env&&ha.set({env:h.env});h.nrdjsOptions&&(a.trace('Setting query parameter overrides using : "'+h.nrdjsOptions+'"'),ha.override(h.nrdjsOptions,!0,a));g&&(a.trace("Using initial values :",
g),ha.override(g,!0,a));if(h=nrdp.options.js_opts)a.trace('Setting command-line overrides using : "'+h+'"'),ha.override(h,!0,a);E();y(b);ha.dump(a,!1);return ha}a.fatal("Cannot initialize config when NRDP is not ready")}function b(){}var h=U("./nrdjs_modules/nf-console"),a=new h("CONFIG"),A=U("nf-underscore"),D=U("./nrdjs_modules/nf-promise");ra=U("nf-events").EventListenerGroup;var ha=U("nf-streaming-config"),la=U("./command-line-options");U=U("./config-request");var sa=U.fetchConfig,ya=U.setNetworkingConfig;
ha.declare({haveStreamingConfig:["haveStreamingConfig",!1],persistConfig:["persistConfig",!0],configRestored:["configRestored",!1],ignoreSetConfigData:["ignoreSetConfigData",!1],streamingConfigWarnTimeout:["streamingConfigWarnTimeout",15E3]});var k,P=(new D(function(b){var g=ha.streamingConfigWarnTimeout,h=setTimeout(function(){ha.ignoreSetConfigData||a.error("Have not received streaming config in",g,"ms")},g);k=function(a){A.isNull(h)||(clearTimeout(h),h=null);b(a)}})).then(function(b){a.warn("Streaming config arrived",
b);return ha}),Pa,pa,na=new ra(a),Sa;b.prototype.initialize=function(a,b){return g(a,b)};var ga;b.prototype.setConfigLabel=function(b){var g,h;h="'"+(b||"master")+"'";if(b===ga)return a.trace("Already on config",h),!0;if(Pa){if(b){g=Pa[b];if(!g){a.warn("No config labeled",h);return}g=JSON.parse(JSON.stringify(g));A.each(pa,function(a,b){g.hasOwnProperty(b)||(g[b]=a)})}else g=pa;a.trace("Switching to config labeled",h);ga=b;ha.reset();g.configRestored=!0;nrdp.setConfigData("streaming",g);return!0}a.trace("No labeled configs")};
b.prototype.getLabeledConfig=function(b){var g=b&&Pa&&Pa[b];b&&a.trace(g?"Returning labeled config for label":"No labeled config for label",b);return ha.copy(g)};b.setUserProvider=function(a){y(a)};b.afterStreamingConfigArrives=function(a){return A.isFunction(a)?P.then(a).done():P};ea.exports=b},{"./command-line-options":3,"./config-request":5,"./nrdjs_modules/nf-console":15,"./nrdjs_modules/nf-promise":17,"nf-events":10,"nf-streaming-config":12,"nf-underscore":13}],5:[function(U,ea,ra){function K(){if(!(nrdp.device.capability.videoProfiles||
[]).some(function(a){return b[a]}))return g.trace("Device does not support any UltraHD profiles"),!1;var a=nrdp.device.activeVideoOutput,a=(a=a&&a[0])&&a.hdcpVersion||-1;if(!(-1===a||22<=a))return g.trace("Active video output is not HDCP 2.2"),!1;if(E.isFunction(nrdjs.isConnectedTo4k30)&&nrdjs.isConnectedTo4k30())return g.trace("Is connected to 4K30"),!1;g.trace("Device supports UltraHD and it is enabled");return!0}function q(){var a=nrdp.device,b=a.SDKVersion.components;return{device_type:a.ESNPrefix,
sdk_version:b&&b.nrdapp||a.SDKVersion.version,nrdjs:nrdjs.version,sw_version:a.softwareVersion,is4k:K()}}function y(){var a=nrdp.device.SDKVersion.components&&nrdp.device.SDKVersion.components.sdk;a&&E.isString(a)&&0===a.indexOf("4.0.2")&&nrdp.setConfigData("networking",{disk_cache:"0"})}var E=U("nf-underscore"),g=new (U("./nrdjs_modules/nf-console"))("CONFIG"),b={"hevc-main-L50-dash-cenc":!0,"hevc-main10-L50-dash-cenc":!0,"hevc-main-L50-L51-dash-cenc-tl":!0,"hevc-main10-L50-L51-dash-cenc-tl":!0},
h;ea.exports={fetchConfig:function(){var a;"undefined"===typeof nrdjs?g.info("No NRDJS, skipping streaming config fetch"):(a=nrdjs.userProvider.getCurrentUserId()||null,E.isUndefined(h)||a!==h?(h=a,g.error("Fetching config for",a,": it should have been fetched by profiles"),g.info("NRDJS fetching streaming config for",a,void 0),nrdjs.apiClient.config(q(),function(b){b.success&&b.config?(g.info("NRDJS fetched streaming config for",a),nrdp.setConfigData("streaming",b.config)):(g.error("Failed to fetch streaming config :",
b),h=void 0)}),y()):g.info("Skipping config fetch, since it is for the same user we already fetched :",a))},getRequestParameters:q,setNetworkingConfig:y}},{"./nrdjs_modules/nf-console":15,"nf-underscore":13}],6:[function(U,ea,ra){function K(a){return!!(a&&la.isString(a)&&a.length)}function q(a){return!(!a||!la.isObject(a))}function y(a,b){this.reason=this.name=a;this.message=b;this.stack=null}function E(a){return q(a)&&a instanceof y}function g(a,b){var g=ha(a);return E(g)&&g.reason===b}function b(a,
b,g,h,q,A){var E,D;if(la.isNumber(a)&&la.isNumber(b))throw a===nrdp.network.ERRORGROUP.HTTP_ERROR||0===a&&0===b?(E="http-error",D="[HTTP-"+g+"]"):(E="network-error",D="[NETWORK-"+a+"-"+b,Object.keys(nrdp.network.ERRORGROUP).some(function(b){if(nrdp.network.ERRORGROUP[b]===a)return D+="-"+b,!0}),Object.keys(nrdp.network.ERRORCODE).some(function(a){if(nrdp.network.ERRORCODE[a]===b)return D+="-"+a,!0}),D+="]"),K(h)&&(D+=" "+h),K(q)&&(D+=" '"+q+"'"),K(A)&&(D+=" ("+A+")"),new y(E,D);}function h(a){var g,
A;if(q(a.mslError))return h(a.mslError);b(a.errorGroup,a.errorCode,a.httpCode,null,a.url,a.serverIp);if(q(a.error))return h(a.error);g=a.responseCode;if(la.isNumber(g)&&(ya.some(function(a){if(a[0]===g)return A=a[1],!0}),K(A)))throw a="[MSL-"+g+"-"+a.internalCode+"] "+a.message,new y(A,a);}function a(a){var b=a.actionId||a.actionID,g,h;if(la.isNumber(b)&&(sa.some(function(a){if(a[0]===b)return g=a[1],!0}),K(g)))throw h="[FAKE-NCCP-"+b,la.isNumber(a.code)&&(h+="-"+a.code),h+="]",K(a.message)&&(h+=
" "+a.message),K(a.transaction)&&(h+=" ("+a.transaction+")"),new y(g,h);}function A(a){var b=a.transaction,g=a.type,h=a.stack;if("reportNetworkingError"===a.origin&&"NETWORK_ERROR"===a.result)throw a="",h&&la.isArray(h)&&h.length&&(a="["+h.map(function(a){return(K(a.errorcode)?a.errorcode:"<unknown>")+(a.ascode?"("+a.ascode+")":"")}).join("/"),a+="]"),a.length&&(a+=" "),new y("network-error",a+("("+b+","+g+")"));}function D(g){if(!E(g)&&q(g)&&(h(g),b(g.errorgroup,g.errorcode,g.statusCode,g.errorString,
g.url,g.serverIp),a(g),A(g),K(g.bladeRunnerError)))throw g="[BR] "+g.bladeRunnerError,new y("transient-failure",g);throw g;}function ha(a){if(E(a))return a;try{D(a)}catch(b){if(E(b))return b}}var la=U("nf-underscore"),sa=[[1,"permanent-failure"],[2,"transient-failure"],[3,"display-error"],[4,"device-reauth"],[5,"expired"],[6,"ignored"],[7,"ignored"],[8,"invalid-user-credentials"],[9,"display-error"],[10,"ignored"],[11,"ignored"],[12,"user-reauth"],[13,"reset-device"],[14,"ignored"]],ya=[[1,"permanent-failure"],
[2,"transient-failure"],[3,"device-reauth"],[4,"user-reauth"],[5,"msl-key-exchange-required"],[6,"invalid-device-credentials"],[7,"invalid-user-credentials"],[8,"expired"],[9,"msl-replayed"],[10,"sso-invalid-token"]];y.prototype=Error();ea.exports={ReasonError:y,toReason:D,toReasonNoThrow:ha,toString:function(a){var b=ha(a);if(b)return b.toString();if(q(a)&&la.isFunction(a.toString))return a.toString();try{return JSON.stringify(a)}catch(g){return"Failed to stringify error"}},hasReason:g,isNetworkError:function(a){return g(a,
"network-error")},REASON_HTTP_ERROR:"http-error",REASON_NETWORK_ERROR:"network-error",REASON_PERMANENT_FAILURE:"permanent-failure",REASON_TRANSIENT_FAILURE:"transient-failure",REASON_DEVICE_REAUTH:"device-reauth",REASON_USER_REAUTH:"user-reauth",REASON_MSL_KEYX_REQUIRED:"msl-key-exchange-required",REASON_INVALID_DEVICE_CREDENTIALS:"invalid-device-credentials",REASON_INVALID_USER_CREDENTIALS:"invalid-user-credentials",REASON_EXPIRED:"expired",REASON_MSL_REPLAYED:"msl-replayed",REASON_SSO_INVALID_TOKEN:"sso-invalid-token",
REASON_SSO_GET_TOKEN_FAILED:"sso-get-token-failed",REASON_DISPLAY_ERROR:"display-error",REASON_IGNORED:"ignored",REASON_RESET_DEVICE:"reset-device",REASON_UNSUPPORTED_VERSION:"unsupported-version"}},{"nf-underscore":13}],7:[function(U,ea,ra){function K(){this._events=this._events||{};this._maxListeners=this._maxListeners||void 0}function q(q){return"function"===typeof q}function y(q){return"object"===typeof q&&null!==q}ea.exports=K;K.EventEmitter=K;K.prototype._events=void 0;K.prototype._maxListeners=
void 0;K.defaultMaxListeners=10;K.prototype.setMaxListeners=function(q){if("number"!==typeof q||0>q||isNaN(q))throw TypeError("n must be a positive number");this._maxListeners=q;return this};K.prototype.emit=function(E){var g,b,h,a;this._events||(this._events={});if("error"===E&&(!this._events.error||y(this._events.error)&&!this._events.error.length)){g=arguments[1];if(g instanceof Error)throw g;b=Error('Uncaught, unspecified "error" event. ('+g+")");b.context=g;throw b;}b=this._events[E];if(void 0===
b)return!1;if(q(b))switch(arguments.length){case 1:b.call(this);break;case 2:b.call(this,arguments[1]);break;case 3:b.call(this,arguments[1],arguments[2]);break;default:g=Array.prototype.slice.call(arguments,1),b.apply(this,g)}else if(y(b))for(g=Array.prototype.slice.call(arguments,1),a=b.slice(),b=a.length,h=0;h<b;h++)a[h].apply(this,g);return!0};K.prototype.addListener=function(E,g){var b;if(!q(g))throw TypeError("listener must be a function");this._events||(this._events={});this._events.newListener&&
this.emit("newListener",E,q(g.listener)?g.listener:g);this._events[E]?y(this._events[E])?this._events[E].push(g):this._events[E]=[this._events[E],g]:this._events[E]=g;y(this._events[E])&&!this._events[E].warned&&(b=void 0!==this._maxListeners?this._maxListeners:K.defaultMaxListeners)&&0<b&&this._events[E].length>b&&(this._events[E].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[E].length),
"function"===typeof console.trace&&console.trace());return this};K.prototype.on=K.prototype.addListener;K.prototype.once=function(y,g){function b(){this.removeListener(y,b);h||(h=!0,g.apply(this,arguments))}if(!q(g))throw TypeError("listener must be a function");var h=!1;b.listener=g;this.on(y,b);return this};K.prototype.removeListener=function(E,g){var b,h,a;if(!q(g))throw TypeError("listener must be a function");if(!this._events||!this._events[E])return this;b=this._events[E];a=b.length;h=-1;if(b===
g||q(b.listener)&&b.listener===g)delete this._events[E],this._events.removeListener&&this.emit("removeListener",E,g);else if(y(b)){for(;0<a--;)if(b[a]===g||b[a].listener&&b[a].listener===g){h=a;break}if(0>h)return this;1===b.length?(b.length=0,delete this._events[E]):b.splice(h,1);this._events.removeListener&&this.emit("removeListener",E,g)}return this};K.prototype.removeAllListeners=function(y){var g;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events=
{}:this._events[y]&&delete this._events[y],this;if(0===arguments.length){for(g in this._events)"removeListener"!==g&&this.removeAllListeners(g);this.removeAllListeners("removeListener");this._events={};return this}g=this._events[y];if(q(g))this.removeListener(y,g);else if(g)for(;g.length;)this.removeListener(y,g[g.length-1]);delete this._events[y];return this};K.prototype.listeners=function(y){return this._events&&this._events[y]?q(this._events[y])?[this._events[y]]:this._events[y].slice():[]};K.prototype.listenerCount=
function(y){if(this._events){y=this._events[y];if(q(y))return 1;if(y)return y.length}return 0};K.listenerCount=function(q,g){return q.listenerCount(g)}},{}],8:[function(U,ea,ra){function K(q,E){var g;if(void 0===E||"function"!==typeof E||"string"!==typeof q)throw new TypeError("EventEmitter: addEventListener requires a string and a function as arguments");if(void 0===this._listeners)return this._listeners={},this._listeners[q]=[E],!0;g=this._listeners[q];return void 0===g?(this._listeners[q]=[E],
!0):0>g.indexOf(E)?(g.push(E),!0):!1}function q(q,E){var g=this._listeners?this._listeners[q]:void 0;if(!g)return!1;g.forEach(function(b){b(E)});return!0}ea.exports={addEventListener:K,on:K,removeEventListener:function(q,E){var g,b;if(void 0===E||"function"!==typeof E||"string"!==typeof q)throw new TypeError("EventEmitter: removeEventListener requires a string and a function as arguments");if(void 0===this._listeners)return!1;b=this._listeners[q];if(void 0===b)return!1;g=b.indexOf(E);if(0>g)return!1;
if(1===b.length)return delete this._listeners[q],!0;b.splice(g,1);return!0},callEventListeners:q,emit:q,removeAllListeners:function(q){this._listeners&&(void 0===q?delete this._listeners:delete this._listeners[q]);return this}}},{}],9:[function(U,ea,ra){function K(q,E,g,b){q.trace(":",g,":",b);E(b)}function q(q){this.listeners=[];this.console=q}q.prototype.constructor=q;q.prototype.addEventListener=function(q,E,g,b){g=b?g.bind(b):g;b=!1;if(q){this.console&&(g=K.bind(null,this.console,g,E));if("function"===
typeof q.addEventListener)b=q.addEventListener(E,g);else if("function"===typeof q.addListener)b=q.addListener(E,g);else throw Error("Emitter does not have a function to add listeners for '"+E+"'");this.listeners.push([q,E,g])}return b};q.prototype.on=q.prototype.addEventListener;q.prototype.clear=function(){var q=this.listeners.length;this.listeners.forEach(function(q){var g=q[0],b=q[1];q=q[2];"function"===typeof g.removeEventListener?g.removeEventListener(b,q):"function"===typeof g.removeListener&&
g.removeListener(b,q)});this.listeners=[];this.console&&this.console.trace("removed",q,"listener(s)")};ea.exports=q},{}],10:[function(U,ea,ra){ea.exports={EventEmitter:U("./event_emitter.js"),EventListenerGroup:U("./event_listener_group.js")}},{"./event_emitter.js":8,"./event_listener_group.js":9}],11:[function(U,ea,ra){ea.exports=function(K,q){for(var y in K)K.hasOwnProperty(y)&&(q[y]=K[y]);return q}},{}],12:[function(U,ea,ra){function K(a){return a.split(",").reduce(function(a,b){var g=b.split("="),
h=g[0],g=g.slice(1).join("=");h&&h.length&&(a[h]=g||!0);return a},{})}function q(a){return a&&"object"===typeof a?JSON.stringify(a):"string"===typeof a?'"'+a+'"':""+a}function y(a,b,g){if("string"===typeof a)return y.call(this,K(a),b,g);var A=0;Object.keys(a).forEach(function(y){var E=ha[y],K=a[y],Y;if(E){if(Y=la[y]||ya[typeof h[E]])try{K=Y(K)}catch(L){g&&g.error("Failed to convert value '"+K+"' for config '"+y+"' : "+L.toString());return}Y=D[E];this[E]=K;D[E]!==Y&&(g&&g.trace("Config changed for '"+
y+"' from "+q(Y)+" ("+typeof Y+") to "+q(K)+" ("+typeof K+")"),++A)}else b?(E=(E=sa[y])?E.filter(function(a){return a[0]!==this},this):[],E.push([this,K]),sa[y]=E):g&&g.error("Attempt to change undeclared config option '"+y+"'")},this);A&&D.emit("changed");return A}function E(){return Object.keys(ha).reduce(function(a,b){var g=ha[b],h=a[g];h?(h.push(b),a[g]=h.sort(function(a,b){return b.length-a.length})):a[g]=[b];return a},{})}function g(a,b){return a.hasOwnProperty(b)?q(a[b]):void 0}function b(a,
b){return"undefined"===typeof a?b:a}ra=U("nf-mixin");U=U("nf-events").EventEmitter;var h={},a=Object.create(h),A=Object.create(a),D=Object.create(A),ha={},la={},sa={};D.declare=function(a){Object.keys(a).forEach(function(b){var g=a[b],q=g[0],A=g[1],D=g[2];if(h.hasOwnProperty(b))throw Error("The local configuraion key '"+b+"' is already in use");"string"===typeof q&&(q=[q]);q.forEach(function(a){var g;if(ha.hasOwnProperty(a))throw Error("The configuration value '"+a+"' has been declared more than once");
h.hasOwnProperty(b)||("function"===typeof A&&(A=A()),h[b]=A);ha[a]=b;"function"===typeof D&&(la[a]=D);if(g=sa[a])g.forEach(function(b){var g=b[0],h={};h[a]=b[1];y.call(g,h,!1)}),delete sa[a]})});return D};var ya={object:function(a){return"object"==typeof a?a:JSON.parse(""+a)},"boolean":function(a){return"boolean"==typeof a?a:!("0"===""+a||"false"===(""+a).toLowerCase())},number:function(a){if("number"==typeof a)return a;a=parseFloat(""+a);if(isNaN(a))throw Error("parseFloat returned NaN");return a}};
D.set=y.bind(a);D.override=y.bind(A);D.dump=function(k,y){function K(){ga&&k&&k.log("===========================================")}var U=Object.keys(sa).sort(),la={},ya=E(),ga;y=b(y,!0);Object.keys(ha).sort().forEach(function(E){E=ha[E];var L,U,sa;!la[E]&&(la[E]=!0,U=g(a,E),sa=g(A,E),y||"undefined"!==typeof U||"undefined"!==typeof sa)&&(L=ya[E].join(","),L+=" = "+q(D[E])+" ("+typeof D[E]+") [",L+=b(sa,"<unset>")+",",L+=b(U,"<unset>")+",",L+=g(h,E)+"]",ga||(ga=!0,k&&k.log("Current config values"),
K()),k&&k.log(L))});(y||U.length)&&k&&k.log("<undeclared> :",U);K()};D.copy=function(a){var b={},g={};Object.keys(ha).forEach(function(a){a=ha[a];g[a]||(g[a]=!0,b[a]=D[a])});a&&y.call(b,a);return b};D.persistent=function(){var b=E();return Object.getOwnPropertyNames(a).reduce(function(g,h){g[b[h][0]]=a[h];return g},{})};D.reset=function(){Object.keys(a).forEach(function(b){delete a[b]})};D._listeners={};ra(U,D);ea.exports=Object.freeze(D)},{"nf-events":10,"nf-mixin":11}],13:[function(U,ea,ra){var K=
{isNumber:function(q){return"number"===typeof q},isObject:function(q){return"object"===typeof q},isString:function(q){return"string"===typeof q},isUndefined:function(q){return"undefined"===typeof q},isBoolean:function(q){return"boolean"===typeof q},isFunction:function(q){return"function"===typeof q},isNull:function(q){return null===q},isArray:function(q){return"[object Array]"===Object.prototype.toString.call(q)},isFinite:function(q){return isFinite(q)&&!isNaN(parseFloat(q))},has:function(q,y){return null!==
q&&"undefined"!==typeof q&&Object.prototype.hasOwnProperty.call(q,y)},pairs:function(q){var y,E=[];if(!K.isObject(q))throw new TypeError("Object.pairs called on non-object");for(y in q)q.hasOwnProperty(y)&&E.push([y,q[y]]);return E}};K.each=K.forEach=function(q,y,E){if(null===q||"undefined"===typeof q)return q;if(q.length===+q.length)for(var g=0,b=q.length;g<b;g++)y.call(E,q[g],g,q);else for(g in q)K.has(q,g)&&y.call(E,q[g],g,q);return q};ea.exports=K},{}],14:[function(U,ea,ra){(function(K){"function"===
typeof bootstrap?bootstrap("promise",K):"object"===typeof ra?ea.exports=K():"function"===typeof define&&define.amd?define(K):"undefined"!==typeof ses?ses.ok()&&(ses.makeQ=K):Q=K()})(function(){function K(a){return function(){return cb.apply(a,arguments)}}function q(a,b){if(L&&b.stack&&"object"===typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf("From previous event:")){for(var c=[],g=b;g;g=g.source)g.stack&&c.unshift(g.stack);c.unshift(a.stack);for(var c=c.join("\nFrom previous event:\n").split("\n"),
g=[],h=0;h<c.length;++h){var k=c[h],q;if(q=y(k)){var A=q[1];q=q[0]===Qa&&A>=Oa&&A<=v}else q=!1;q||(q=k,q=-1!==q.indexOf("(module.js:")||-1!==q.indexOf("(node.js:"));q||!k||g.push(k)}c=g.join("\n");a.stack=c}}function y(a){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);if(b||(b=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a)))return[b[1],Number(b[2])];if(a=/.*@(.+):(\d+)$/.exec(a))return[a[1],Number(a[2])]}function E(){if(L)try{throw Error();}catch(a){var b=a.stack.split("\n"),b=0<b[0].indexOf("@")?b[1]:b[2];if(b=
y(b))return Qa=b[0],b[1]}}function g(a){return la(a)?a:sa(a)?pa(a):ea(a)}function b(){function a(b){k=b;v.source=b;Ia(c,function(a,d){ka(function(){b.promiseDispatch.apply(b,d)})},void 0);h=c=void 0}var c=[],h=[],k,q=Ua(b.prototype),v=Ua(A.prototype);v.promiseDispatch=function(a,b,d){var g=va(arguments);c?(c.push(g),"when"===b&&d[1]&&h.push(d[1])):ka(function(){k.promiseDispatch.apply(k,g)})};v.valueOf=function(){if(c)return v;var a=U(k);la(a)&&(k=a);return a};v.inspect=function(){return k?k.inspect():
{state:"pending"}};if(g.longStackSupport&&L)try{throw Error();}catch(y){v.stack=y.stack.substring(y.stack.indexOf("\n")+1)}q.promise=v;q.resolve=function(b){k||a(g(b))};q.fulfill=function(b){k||a(ea(b))};q.reject=function(b){k||a(P(b))};q.notify=function(a){k||Ia(h,function(b,d){ka(function(){d(a)})},void 0)};return q}function h(a){if("function"!==typeof a)throw new TypeError("resolver must be a function.");var c=b();try{a(c.resolve,c.reject,c.notify)}catch(g){c.reject(g)}return c.promise}function a(a){return h(function(b,
c){for(var h=0,k=a.length;h<k;h++)g(a[h]).then(b,c)})}function A(a,b,c){void 0===b&&(b=function(a){return P(Error("Promise does not support operation: "+a))});void 0===c&&(c=function(){return{state:"unknown"}});var g=Ua(A.prototype);g.promiseDispatch=function(c,h,k){var u;try{u=a[h]?a[h].apply(g,k):b.call(g,h,k)}catch(q){u=P(q)}c&&c(u)};if(g.inspect=c){var h=c();"rejected"===h.state&&(g.exception=h.reason);g.valueOf=function(){var a=c();return"pending"===a.state||"rejected"===a.state?g:a.value}}return g}
function D(a,b,c,h){return g(a).then(b,c,h)}function U(a){if(la(a)){var b=a.inspect();if("fulfilled"===b.state)return b.value}return a}function la(a){return a===Object(a)&&"function"===typeof a.promiseDispatch&&"function"===typeof a.inspect}function sa(a){return a===Object(a)&&"function"===typeof a.then}function ya(){Wa.length=0;Va.length=0;Ta||(Ta=!0)}function k(a,b){Ta&&(Va.push(a),b&&"undefined"!==typeof b.stack?Wa.push(b.stack):Wa.push("(no stack) "+b))}function P(a){var b=A({when:function(b){if(b&&
Ta){var c=Eb(Va,this);-1!==c&&(Va.splice(c,1),Wa.splice(c,1))}return b?b(a):this}},function(){return this},function(){return{state:"rejected",reason:a}});k(b,a);return b}function ea(a){return A({when:function(){return a},get:function(b){return a[b]},set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return null===b||void 0===b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return c(a)}},void 0,function(){return{state:"fulfilled",
value:a}})}function pa(a){var c=b();ka(function(){try{a.then(c.resolve,c.reject,c.notify)}catch(b){c.reject(b)}});return c.promise}function na(a,b,c){return g(a).spread(b,c)}function ra(a,b,c){return g(a).dispatch(b,c)}function ga(a){return D(a,function(a){var d=0,c=b();Ia(a,function(b,g,h){var k;la(g)&&"fulfilled"===(k=g.inspect()).state?a[h]=k.value:(++d,D(g,function(b){a[h]=b;0===--d&&c.resolve(a)},c.reject,function(a){c.notify({index:h,value:a})}))},void 0);0===d&&c.resolve(a);return c.promise})}
function Y(a){return D(a,function(a){a=db(a,g);return D(ga(db(a,function(a){return D(a,vb,vb)})),function(){return a})})}var L=!1;try{throw Error();}catch(d){L=!!d.stack}var Oa=E(),Qa,vb=function(){},ka=function(){function a(){for(;b.next;){b=b.next;var c=b.task;b.task=void 0;var h=b.domain;h&&(b.domain=void 0,h.enter());try{c()}catch(u){if(k)throw h&&h.exit(),setTimeout(a,0),h&&h.enter(),u;setTimeout(function(){throw u;},0)}h&&h.exit()}g=!1}var b={task:void 0,next:null},c=b,g=!1,h=void 0,k=!1;ka=
function(a){c=c.next={task:a,domain:k&&process.domain,next:null};g||(g=!0,h())};if("undefined"!==typeof process&&process.nextTick)k=!0,h=function(){process.nextTick(a)};else if("function"===typeof setImmediate)h="undefined"!==typeof window?setImmediate.bind(window,a):function(){setImmediate(a)};else if("undefined"!==typeof MessageChannel){var q=new MessageChannel;q.port1.onmessage=function(){h=v;q.port1.onmessage=a;a()};var v=function(){q.port2.postMessage(0)},h=function(){setTimeout(a,0);v()}}else h=
function(){setTimeout(a,0)};return ka}(),cb=Function.call,va=K(Array.prototype.slice),Ia=K(Array.prototype.reduce||function(a,b){var c=0,g=this.length;if(1===arguments.length){do{if(c in this){b=this[c++];break}if(++c>=g)throw new TypeError;}while(1)}for(;c<g;c++)c in this&&(b=a(b,this[c],c));return b}),Eb=K(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),db=K(Array.prototype.map||function(a,b){var c=this,g=[];Ia(c,function(h,k,q){g.push(a.call(b,
k,q,c))},void 0);return g}),Ua=Object.create||function(a){function b(){}b.prototype=a;return new b},wb=K(Object.prototype.hasOwnProperty),c=Object.keys||function(a){var b=[],c;for(c in a)wb(a,c)&&b.push(c);return b},M=K(Object.prototype.toString),N;N="undefined"!==typeof ReturnValue?ReturnValue:function(a){this.value=a};g.resolve=g;g.nextTick=ka;g.longStackSupport=!1;g.defer=b;b.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):2<arguments.length?a.resolve(va(arguments,
1)):a.resolve(c)}};g.Promise=h;g.promise=h;h.race=a;h.all=ga;h.reject=P;h.resolve=g;g.passByCopy=function(a){return a};A.prototype.passByCopy=function(){return this};g.join=function(a,b){return g(a).join(b)};A.prototype.join=function(a){return g([this,a]).spread(function(a,b){if(a===b)return a;throw Error("Can't join: not the same: "+a+" "+b);})};g.race=a;A.prototype.race=function(){return this.then(g.race)};g.makePromise=A;A.prototype.toString=function(){return"[object Promise]"};A.prototype.then=
function(a,c,h){function k(b){try{return"function"===typeof a?a(b):b}catch(c){return P(c)}}function v(a){if("function"===typeof c){q(a,A);try{return c(a)}catch(b){return P(b)}}return P(a)}var A=this,y=b(),D=!1;ka(function(){A.promiseDispatch(function(a){D||(D=!0,y.resolve(k(a)))},"when",[function(a){D||(D=!0,y.resolve(v(a)))}])});A.promiseDispatch(void 0,"when",[void 0,function(a){var b,d=!1;try{b="function"===typeof h?h(a):a}catch(c){if(d=!0,g.onerror)g.onerror(c);else throw c;}d||y.notify(b)}]);
return y.promise};g.when=D;A.prototype.thenResolve=function(a){return this.then(function(){return a})};g.thenResolve=function(a,b){return g(a).thenResolve(b)};A.prototype.thenReject=function(a){return this.then(function(){throw a;})};g.thenReject=function(a,b){return g(a).thenReject(b)};g.nearer=U;g.isPromise=la;g.isPromiseAlike=sa;g.isPending=function(a){return la(a)&&"pending"===a.inspect().state};A.prototype.isPending=function(){return"pending"===this.inspect().state};g.isFulfilled=function(a){return!la(a)||
"fulfilled"===a.inspect().state};A.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state};g.isRejected=function(a){return la(a)&&"rejected"===a.inspect().state};A.prototype.isRejected=function(){return"rejected"===this.inspect().state};var Wa=[],Va=[],Ta=!0;g.resetUnhandledRejections=ya;g.getUnhandledReasons=function(){return Wa.slice()};g.stopUnhandledRejectionTracking=function(){ya();Ta=!1};ya();g.reject=P;g.fulfill=ea;g.master=function(a){return A({isDef:function(){}},function(b,
c){return ra(a,b,c)},function(){return g(a).inspect()})};g.spread=na;A.prototype.spread=function(a,b){return this.all().then(function(b){return a.apply(void 0,b)},b)};g.async=function(a){return function(){function b(a,d){var f;if("undefined"===typeof StopIteration){try{f=c[a](d)}catch(k){return P(k)}return f.done?f.value:D(f.value,g,h)}try{f=c[a](d)}catch(k){return"[object StopIteration]"===M(k)||k instanceof N?k.value:P(k)}return D(f,g,h)}var c=a.apply(this,arguments),g=b.bind(b,"next"),h=b.bind(b,
"throw");return g()}};g.spawn=function(a){g.done(g.async(a)())};g["return"]=function(a){throw new N(a);};g.promised=function(a){return function(){return na([this,ga(arguments)],function(b,c){return a.apply(b,c)})}};g.dispatch=ra;A.prototype.dispatch=function(a,c){var g=this,h=b();ka(function(){g.promiseDispatch(h.resolve,a,c)});return h.promise};g.get=function(a,b){return g(a).dispatch("get",[b])};A.prototype.get=function(a){return this.dispatch("get",[a])};g.set=function(a,b,c){return g(a).dispatch("set",
[b,c])};A.prototype.set=function(a,b){return this.dispatch("set",[a,b])};g.del=g["delete"]=function(a,b){return g(a).dispatch("delete",[b])};A.prototype.del=A.prototype["delete"]=function(a){return this.dispatch("delete",[a])};g.mapply=g.post=function(a,b,c){return g(a).dispatch("post",[b,c])};A.prototype.mapply=A.prototype.post=function(a,b){return this.dispatch("post",[a,b])};g.send=g.mcall=g.invoke=function(a,b){return g(a).dispatch("post",[b,va(arguments,2)])};A.prototype.send=A.prototype.mcall=
A.prototype.invoke=function(a){return this.dispatch("post",[a,va(arguments,1)])};g.fapply=function(a,b){return g(a).dispatch("apply",[void 0,b])};A.prototype.fapply=function(a){return this.dispatch("apply",[void 0,a])};g["try"]=g.fcall=function(a){return g(a).dispatch("apply",[void 0,va(arguments,1)])};A.prototype.fcall=function(){return this.dispatch("apply",[void 0,va(arguments)])};g.fbind=function(a){var b=g(a),c=va(arguments,1);return function(){return b.dispatch("apply",[this,c.concat(va(arguments))])}};
A.prototype.fbind=function(){var a=this,b=va(arguments);return function(){return a.dispatch("apply",[this,b.concat(va(arguments))])}};g.keys=function(a){return g(a).dispatch("keys",[])};A.prototype.keys=function(){return this.dispatch("keys",[])};g.all=ga;A.prototype.all=function(){return ga(this)};g.allResolved=function(a,b,c){return function(){"undefined"!==typeof console&&"function"===typeof console.warn&&console.warn(b+" is deprecated, use "+c+" instead.",Error("").stack);return a.apply(a,arguments)}}(Y,
"allResolved","allSettled");A.prototype.allResolved=function(){return Y(this)};g.allSettled=function(a){return g(a).allSettled()};A.prototype.allSettled=function(){return this.then(function(a){return ga(db(a,function(a){function b(){return a.inspect()}a=g(a);return a.then(b,b)}))})};g.fail=g["catch"]=function(a,b){return g(a).then(void 0,b)};A.prototype.fail=A.prototype["catch"]=function(a){return this.then(void 0,a)};g.progress=function(a,b){return g(a).then(void 0,void 0,b)};A.prototype.progress=
function(a){return this.then(void 0,void 0,a)};g.fin=g["finally"]=function(a,b){return g(a)["finally"](b)};A.prototype.fin=A.prototype["finally"]=function(a){a=g(a);return this.then(function(b){return a.fcall().then(function(){return b})},function(b){return a.fcall().then(function(){throw b;})})};g.done=function(a,b,c,h){return g(a).done(b,c,h)};A.prototype.done=function(a,b,c){var h=function(a){ka(function(){q(a,k);if(g.onerror)g.onerror(a);else throw a;})},k=a||b||c?this.then(a,b,c):this;"object"===
typeof process&&process&&process.domain&&(h=process.domain.bind(h));k.then(void 0,h)};g.timeout=function(a,b,c){return g(a).timeout(b,c)};A.prototype.timeout=function(a,c){var g=b(),h=setTimeout(function(){g.reject(Error(c||"Timed out after "+a+" ms"))},a);this.then(function(a){clearTimeout(h);g.resolve(a)},function(a){clearTimeout(h);g.reject(a)},g.notify);return g.promise};g.delay=function(a,b){void 0===b&&(b=a,a=void 0);return g(a).delay(b)};A.prototype.delay=function(a){return this.then(function(c){var g=
b();setTimeout(function(){g.resolve(c)},a);return g.promise})};g.nfapply=function(a,b){return g(a).nfapply(b)};A.prototype.nfapply=function(a){var c=b();a=va(a);a.push(c.makeNodeResolver());this.fapply(a).fail(c.reject);return c.promise};g.nfcall=function(a){var b=va(arguments,1);return g(a).nfapply(b)};A.prototype.nfcall=function(){var a=va(arguments),c=b();a.push(c.makeNodeResolver());this.fapply(a).fail(c.reject);return c.promise};g.nfbind=g.denodeify=function(a){var c=va(arguments,1);return function(){var h=
c.concat(va(arguments)),k=b();h.push(k.makeNodeResolver());g(a).fapply(h).fail(k.reject);return k.promise}};A.prototype.nfbind=A.prototype.denodeify=function(){var a=va(arguments);a.unshift(this);return g.denodeify.apply(void 0,a)};g.nbind=function(a,c){var h=va(arguments,2);return function(){var k=h.concat(va(arguments)),q=b();k.push(q.makeNodeResolver());g(function(){return a.apply(c,arguments)}).fapply(k).fail(q.reject);return q.promise}};A.prototype.nbind=function(){var a=va(arguments,0);a.unshift(this);
return g.nbind.apply(void 0,a)};g.nmapply=g.npost=function(a,b,c){return g(a).npost(b,c)};A.prototype.nmapply=A.prototype.npost=function(a,c){var g=va(c||[]),h=b();g.push(h.makeNodeResolver());this.dispatch("post",[a,g]).fail(h.reject);return h.promise};g.nsend=g.nmcall=g.ninvoke=function(a,c){var h=va(arguments,2),k=b();h.push(k.makeNodeResolver());g(a).dispatch("post",[c,h]).fail(k.reject);return k.promise};A.prototype.nsend=A.prototype.nmcall=A.prototype.ninvoke=function(a){var c=va(arguments,
1),g=b();c.push(g.makeNodeResolver());this.dispatch("post",[a,c]).fail(g.reject);return g.promise};g.nodeify=function(a,b){return g(a).nodeify(b)};A.prototype.nodeify=function(a){if(a)this.then(function(b){ka(function(){a(null,b)})},function(b){ka(function(){a(b)})});else return this};var v=E();return g})},{}],15:[function(U,ea,ra){function K(a,b){var g=[];return JSON.stringify(a,function(a,b){if("object"===typeof b&&null!==b){if(-1!==g.indexOf(b))return"<cycle>";g.push(b)}return b},b?" ":void 0)}
function q(a,b,g){var h=b.length,q=a.length?""+a.join(" ")+" ":"",y=g?"":q,k;for(a=0;a<h;++a)if(k=b[a],a&&y.length&&(y+=" "),"object"===typeof k)if(null===k)y+="null";else if(k instanceof Error)y+=k.toString()+(k.stack?"\n"+k.stack:"")+"\n";else try{y=g?y+("\n"+JSON.stringify(k,null,"  ")):y+JSON.stringify(k)}catch(E){y=g?y+("\n"+K(k,!0)):y+K(k)}else y+=k;g&&(b=y.split("\n"),y="",b.forEach(function(a){y+=q+a+"\n"}));return y}function y(b,g,q,y){this._traceArea=b||"CONSOLE";this._logger=y||a||h;this._prefix=
[];"function"===typeof this._logger.createArea?(this._groups=g=g?g+"|nrdjs":"nrdjs",this._logger.createArea(this._traceArea,g)):this._prefix.push("("+b+")");Array.isArray(q)?this._prefix=q:q&&"string"===typeof q&&this._prefix.push(q)}var E,g=!1,b=!0;U=function(){};var h={info:U,warn:U,error:U,trace:U},a;"undefined"!==typeof nrdp&&nrdp.log&&(a={trace:nrdp.log.trace.bind(nrdp.log),log:nrdp.log.debug.bind(nrdp.log),info:nrdp.log.info.bind(nrdp.log),warn:nrdp.log.warn.bind(nrdp.log),error:nrdp.log.error.bind(nrdp.log),
fatal:nrdp.log.fatal.bind(nrdp.log),createArea:nrdp.log.createArea?nrdp.log.createArea.bind(nrdp.log):null},E=function(){!g&&nrdp.isReady&&(g=!0,b=nrdp.debug||nrdp.log.haveTracing,E=null)});y.setDebug=function(a){b=!!a;E=null};y.isDebug=function(){E&&E();return b};y.stringify=function(){return q("",arguments,!1)};y.prototype.info=function(){this._logger.info(q(this._prefix,arguments),this._traceArea)};y.prototype.error=function(){this._logger.error(q(this._prefix,arguments),this._traceArea)};y.prototype.warn=
function(){this._logger.warn(q(this._prefix,arguments),this._traceArea)};y.prototype.trace=function(){var a=this._logger;E&&E();(b||a.alwaysTrace)&&a.trace(q(this._prefix,arguments),this._traceArea)};y.prototype.log=function(){var a=this._logger;a.log&&(E&&E(),(b||a.alwaysTrace)&&a.log(q(this._prefix,arguments),this._traceArea))};y.prototype.debug=y.prototype.log;y.prototype.fatal=function(){var a=this._logger;a.fatal&&a.fatal(q(this._prefix,arguments),this._traceArea)};y.prototype.dump=function(){var a=
this._logger;E&&E();(b||a.alwaysTrace)&&a.trace(q(this._prefix,arguments,!0),this._traceArea)};y.prototype.createSubConsole=function(a){return new y(this._traceArea,this._groups,this._prefix.concat(a),this._logger)};ea.exports=y},{}],16:[function(U,ea,ra){function K(){}var q=U("../nf-promise");ea.exports=function(y,E,g){var b=y.console&&y.console.log.bind(y.console)||K,h=y.states;return function A(g,y,K){var U=E[g],ea=U&&U[0];y&&b(y,"undefined"===typeof K?"":K);if(!g)return b("*| END  ","undefined"===
typeof K?"":K),q.resolve(K);if(!U)return q.reject(Error("No state named "+g));b(">| ENTER",g);h&&h.push(g);if("function"!==typeof ea)return q.reject(Error("No entry function for state "+g));ea=ea.bind(this,K);return(new q(function(b){b(ea())})).then(A.bind(this,U[1]," | YES  "),A.bind(this,U[2]||U[1]," | NO   "))}.call(y,g||"start")}},{"../nf-promise":17}],17:[function(U,ea,ra){if("object"===typeof process&&process.browser)throw Error("The global 'process' shouldn't be defined");ea.exports=function(){var K=
U("q"),q=function(q){var E=K.defer(),g=E.resolve.bind(E),b=E.reject.bind(E);try{q(g,b)}catch(h){b(h)}return E.promise};q.attempt=function(q){return K.fcall(q)};q.resolve=function(q){return K(q)};q.reject=function(q){return K.reject(q)};q.all=function(q){return K.all(q)};K.stopUnhandledRejectionTracking();return q}()},{q:14}]},{},[1]);
